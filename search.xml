<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title></title>
    <url>/2024/10/19/hello-world/</url>
    <content><![CDATA[<hr>
<hr>
<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title></title>
    <url>/2024/12/24/articles/md%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>插入图片<br><img src="/JDBC/p1.png" class="lazyload" data-srcset="/JDBC/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<ul>
<li>小点</li>
</ul>
<p>**加粗</p>
<p>&#x3D;&#x3D;标记&#x3D;&#x3D;</p>
<p>#标签</p>
<pre><code>Tab 
</code></pre>
<p><font color=red>红色的字</font></p>
<table>
<thead>
<tr>
<th>表头</th>
<th>表头</th>
</tr>
</thead>
<tbody><tr>
<td>单元格</td>
<td>单元格</td>
</tr>
<tr>
<td>单元格</td>
<td>单元格</td>
</tr>
</tbody></table>
]]></content>
  </entry>
  <entry>
    <title></title>
    <url>/2024/09/14/articles/JavaScript/text/</url>
    <content><![CDATA[<h1 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h1><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>JavaScript是一门世界上流行的脚本编程语言，用来实现网页上的交互，实时更新内容等。</p>
<p>JavaScript的创建者因不喜欢Java，只想应付公司的任务，因此只花了十天时间就把JavaScript创建出来了。</p>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>每个语言都有其独特之处，身边人也经常会开玩笑的说“我们精通各种语言的Hello World”。</p>
<p>JavaScript和CSS一样，都可以直接在HTML文件里面搭个标签，在标签里面写语言。</p>
<p><strong>方法一：内标签写</strong><br><img src="/img%5Cp1.png" class="lazyload" data-srcset="/img%5Cp1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"><br>与Java相同，在写JavaScript时不要忘记每一行命令后的分号。<br>注释也和Java中使用的一样。</p>
<p><strong>方法二：外部引用</strong><br>首先，先创建一个JavaScript文件，里面只需写需要的JavaScript语句，然后再在HTML文件中引入进来即可。<br>注意，使用script标签必须成对出现，尽量不要用自闭合。<br><img src="/img%5Cp3.png" class="lazyload" data-srcset="/img%5Cp3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<p>运行结果：<br><img src="/img%5Cp2.png" class="lazyload" data-srcset="/img%5Cp2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><p>JavaScript和一门弱类型语言，跟python或者其他解释型语言一样，无需强调其变量类型。</p>
<p><img src="/img%5Cp4.png" class="lazyload" data-srcset="/img%5Cp4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<p>JavaScript语法与Java基本吻合，也是严格区分大小写，但JavaScript不强制限定语句末一定要使用分号，如果有两条语句，其中没有分号，则视为一条语句，一般使用上省略一两个分号对代码没有太大影响，但依然建议写上分号。</p>
<h4 id="浏览器调试"><a href="#浏览器调试" class="headerlink" title="浏览器调试"></a>浏览器调试</h4><p>在浏览器上打开文件后，可以点击F12打开审查元素，在源代码那里可以看到自己的代码并进行调试。</p>
<p><img src="/img%5Cp5.png" class="lazyload" data-srcset="/img%5Cp5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h2 id="简单数据类型"><a href="#简单数据类型" class="headerlink" title="简单数据类型"></a>简单数据类型</h2><h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><p>JS和Java的命名规则一样，用字母数字下划线和<code>$</code>组成的变量名，不可以用数字开头，可以用中文。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var 变量名 = 值</span><br></pre></td></tr></table></figure>

<h4 id="number"><a href="#number" class="headerlink" title="number"></a>number</h4><p>js不区分整数和小数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">123      //整数</span><br><span class="line">123.4    //小数</span><br><span class="line">-1.234   //负数</span><br><span class="line">1.23e4   //科学计数法</span><br><span class="line">除此之外还有</span><br><span class="line">NaN      //Not a number</span><br><span class="line">Infinity //表示无穷大，数据太大JavaScript处理不来</span><br></pre></td></tr></table></figure>
<h4 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=      //赋值</span><br><span class="line">==     //等于(类型不一样，值一样，判断为true)</span><br><span class="line">===    //绝对等于(类型一样，值一样，判断为true)</span><br><span class="line">一般情况下尽量使用绝对等于</span><br></pre></td></tr></table></figure>
<p>上面提到的NaN与所有数值都不相等，包括自己，只能通过<code>isNaN</code>来判断NaN才为true<br><img src="/img%5Cp6.png" class="lazyload" data-srcset="/img%5Cp6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<p>尽量避免使用浮点数进行运算，存在精度丢失问题</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">console.log((1/3) === (1-2/3))</span><br><span class="line">答案为false</span><br><span class="line">但我们可以使用绝对值来比较</span><br><span class="line">Math.abs(1/3 - (1-2/3)) &lt; 0.000000000001</span><br></pre></td></tr></table></figure>

<h4 id="Null和undefined"><a href="#Null和undefined" class="headerlink" title="Null和undefined"></a>Null和undefined</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">null     //空</span><br><span class="line">undefined//未定义</span><br></pre></td></tr></table></figure>

<h4 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h4><p>一般在Java中数组每个元素的类型必须一致，但在JS中可以不用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var a = [1,2,3,4,&#x27;Hello&#x27;,null,false];</span><br></pre></td></tr></table></figure>
<p>数组越界会显示undefined</p>
<h4 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h4><p>在Java中对象是new出来的，但在JS中生成或定义基本上都是使用var，每个属性之间使用逗号隔开，最后一个属性后不需要加逗号。</p>
<p>对象是大括号，数组是中括号。</p>
<p><img src="/img%5Cp7.png" class="lazyload" data-srcset="/img%5Cp7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"><br><img src="/img%5Cp8.png" class="lazyload" data-srcset="/img%5Cp8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h2 id="严格检查模式"><a href="#严格检查模式" class="headerlink" title="严格检查模式"></a>严格检查模式</h2><p>在我们书写代码时，会发现有时候不严谨的写法依然不会报错而导致无法运行。</p>
<p>例如在代码中直接写上 <code>i = 1</code> 如同python一样，但这时候i定义成是全局变量，以至于在其他JS文件中依然可以调用到这个变量，因此我们得想办法约束一下自己代码书写的严谨性。</p>
<p>我们在第一行写上 <code>&quot;use strict&quot;</code> (引号不能丢) __严格检查模式__，开启后如果出现以上 <code>i = 1</code> 的写法会直接报错，提升了代码的严谨性。</p>
<p><strong>严格检查模式</strong> 一般写在JS文件 (或者标签内) 的第一行写上，在其他地方写上在运行文件的时发现错误会报错，但在浏览器里调试中不会发生报错。</p>
<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p>JS字符串可以用 <strong>单引号</strong> 或者 <strong>双引号</strong> 包裹，如果想输出引号，我们可以使用 ‘ <strong>\</strong> ‘ 转义符来进行转义引号。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">常用的转义符:</span><br><span class="line">\&#x27;</span><br><span class="line">\&quot;</span><br><span class="line">\t      # 等效于tab键</span><br><span class="line">\u4e2d  # &#x27;中&#x27;，Unicode字符，一般为\u####</span><br><span class="line">\x41    # &#x27;A&#x27;，ASCLL字符</span><br></pre></td></tr></table></figure>

<h4 id="多行字符串编写"><a href="#多行字符串编写" class="headerlink" title="多行字符串编写"></a>多行字符串编写</h4><p>如果希望进行多行字符串编写，我们可以使用两个 <code>`</code>  包裹起来</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var 变量名 = `</span><br><span class="line">        内容</span><br><span class="line">        内容</span><br><span class="line">        .....</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<p>或者我们在希望换行的位置打上换行符 <code>\n</code> 进行换行</p>
<h4 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h4><p>在JS里，字符串拼接最常见有两种方式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var a = &quot;abc&quot;;</span><br><span class="line">var b = &quot;cba&quot;;</span><br><span class="line">方式一：</span><br><span class="line">    用加号来拼接字符串</span><br><span class="line">    console.log(&quot;abc&quot;+&quot;cba&quot;);    # abccba</span><br><span class="line">    console.log(a+b);            # abccba</span><br><span class="line">方式二：</span><br><span class="line">    在字符串中穿插 &#x27;$&#123;变量名&#125;&#x27;</span><br><span class="line">    console.log(`早上好！$&#123;a&#125;`)   # 早上好！abc </span><br><span class="line">                                 # 注意，括号内使用的是 ` 号</span><br></pre></td></tr></table></figure>

<h4 id="字符串长度"><a href="#字符串长度" class="headerlink" title="字符串长度"></a>字符串长度</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var a = &quot;abc&quot;;</span><br><span class="line">console.log(abc.length);   # 3</span><br></pre></td></tr></table></figure>

<h4 id="字符串的可变性"><a href="#字符串的可变性" class="headerlink" title="字符串的可变性"></a>字符串的可变性</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="string">&quot;abcdef&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a[<span class="number">1</span>]);         # b</span><br><span class="line">a[<span class="number">1</span>] = <span class="string">&#x27;b&#x27;</span>;                # 这里尝试把<span class="string">&#x27;b&#x27;</span>赋值给a[<span class="number">1</span>]</span><br><span class="line">                           # 没有显示报错，赋值完成</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a[<span class="number">1</span>])          # a</span><br><span class="line">                           # 发现虽然赋值完成，但值没有改变，赋值失败</span><br></pre></td></tr></table></figure>
<p><img src="/img%5Cp9.png" class="lazyload" data-srcset="/img%5Cp9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h4 id="字符串截取"><a href="#字符串截取" class="headerlink" title="字符串截取"></a>字符串截取</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var a = &quot;abcdef&quot;;</span><br><span class="line">console.log(a.subString(1))      # bcdef   从下标1开始一直到最后</span><br><span class="line">console.log(a.subString(1,3))    # bc      从下标1开始，到下标3结束(不包括下标3)</span><br><span class="line">字符串截取是&#x27;[)&#x27;包左不包右</span><br><span class="line">注意，当 &#x27;.&#x27;后面有括号说明是方法而不是属性</span><br></pre></td></tr></table></figure>

<h2 id="数组-1"><a href="#数组-1" class="headerlink" title="数组"></a>数组</h2><p>数组Array可以包含任意的数据类型</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr01 = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>]; # 可以通过数组下标进行取值和赋值 </span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr01);              # [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line">arr01[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr01);              # <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br></pre></td></tr></table></figure>

<h4 id="长度"><a href="#长度" class="headerlink" title="长度"></a>长度</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">arr01.length</span><br></pre></td></tr></table></figure>
<p>注意，我们可以给<code>arr01.length</code>进行赋值，赋值后会改变数组的长度，如果赋的值大于原来，则以<code>empty</code>补全，如果赋的值小于原来，则超过的下标元素丢失，一般不建议去修改数组长度。</p>
<h4 id="indexof"><a href="#indexof" class="headerlink" title="indexof()"></a>indexof()</h4><p>我们可以用indexof()通过元素获得第一个元素出现的下标</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">arr01.indexof(1)</span><br></pre></td></tr></table></figure>
<p>注意：字符串1和数字1是不一样的</p>
<h4 id="slice"><a href="#slice" class="headerlink" title="slice()"></a>slice()</h4><p>slice()用来截取数组的一部分，返回一个新的数组</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">数组名.slice(3)     # 从下标3开始到最后</span><br><span class="line">数组名.slice(1,3)   # 从下表1开始到下标3结束，不包括下标3，类似于String中的subString()</span><br></pre></td></tr></table></figure>

<h4 id="push-、pop-尾部"><a href="#push-、pop-尾部" class="headerlink" title="push()、pop()尾部"></a>push()、pop()尾部</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">push()   压入到尾部</span><br><span class="line">pop()    从尾部弹出一个元素</span><br></pre></td></tr></table></figure>

<h4 id="unshift-、shift-头部"><a href="#unshift-、shift-头部" class="headerlink" title="unshift()、shift()头部"></a>unshift()、shift()头部</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">unshift()   压入到头部</span><br><span class="line">、shift()    从头部弹出一个元素</span><br></pre></td></tr></table></figure>

<h4 id="排序sort"><a href="#排序sort" class="headerlink" title="排序sort()"></a>排序sort()</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[&#x27;B&#x27;,&#x27;A&#x27;,&#x27;C&#x27;];</span><br><span class="line">arr.sort();</span><br><span class="line">[&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;]</span><br></pre></td></tr></table></figure>

<h4 id="元素反转reverse"><a href="#元素反转reverse" class="headerlink" title="元素反转reverse()"></a>元素反转reverse()</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;];</span><br><span class="line">arr.reverse();</span><br><span class="line">[&#x27;C&#x27;,&#x27;B&#x27;,&#x27;A&#x27;]</span><br></pre></td></tr></table></figure>

<h4 id="数组拼接concat"><a href="#数组拼接concat" class="headerlink" title="数组拼接concat()"></a>数组拼接concat()</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># [&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;];</span><br><span class="line">arr.concat([1,2,3]);</span><br><span class="line"># [&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;,1,2,3];</span><br><span class="line">console.log(arr);</span><br><span class="line"># [&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;]</span><br></pre></td></tr></table></figure>
<p>注意：concat()并没有修改数组，而是返回一个新的数组</p>
<h4 id="连接符join"><a href="#连接符join" class="headerlink" title="连接符join()"></a>连接符join()</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;];</span><br><span class="line">arr.join(&#x27;-&#x27;);</span><br><span class="line">&quot;A-B-C&quot;</span><br></pre></td></tr></table></figure>

<h2 id="对象-1"><a href="#对象-1" class="headerlink" title="对象"></a>对象</h2><h4 id="定义对象"><a href="#定义对象" class="headerlink" title="定义对象"></a>定义对象</h4><p>在JS中，对象就是由若干个键值对组成的<br>JS中所有的键都是字符串，值可以是任意类型！</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var 类名 = &#123;</span><br><span class="line">    属性名:值,</span><br><span class="line">    属性名:值,</span><br><span class="line">    属性名:值,</span><br><span class="line">    属性名:值</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义对象中每个属性用逗号隔开，最后一个属性不加逗号</p>
<h4 id="对象赋值"><a href="#对象赋值" class="headerlink" title="对象赋值"></a>对象赋值</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">对象名.属性名 = 值;</span><br></pre></td></tr></table></figure>
<p>注意，使用一个不存在的属性不会报错</p>
<h4 id="动态的删减属性"><a href="#动态的删减属性" class="headerlink" title="动态的删减属性"></a>动态的删减属性</h4><p>通过delete删除对象的属性</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">delete 对象名.属性名</span><br></pre></td></tr></table></figure>
<p><img src="/img%5Cp10.png" class="lazyload" data-srcset="/img%5Cp10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h4 id="动态的添加属性"><a href="#动态的添加属性" class="headerlink" title="动态的添加属性"></a>动态的添加属性</h4><p>直接给想要添加的属性名赋值即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">对象名.属性名 = 值</span><br></pre></td></tr></table></figure>
<p><img src="/img%5Cp11.png" class="lazyload" data-srcset="/img%5Cp11.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h4 id="判断属性值是否在这个对象中"><a href="#判断属性值是否在这个对象中" class="headerlink" title="判断属性值是否在这个对象中"></a>判断属性值是否在这个对象中</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">属性名 in 对象名</span><br></pre></td></tr></table></figure>
<p>注意：JS中属性名都为字符串，判断时要加上引号<br><img src="/img%5Cp12.png" class="lazyload" data-srcset="/img%5Cp12.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<p>我们在Java中对象一般都会设一个toString方法，在JS检查属性值时会发现，toString也在本对象中，这是因为继承性，JS和Java一样，对象都是默认继承object，属性也会一同继承下来。<br><img src="/img%5Cp13.png" class="lazyload" data-srcset="/img%5Cp13.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h4 id="hasOwnProperty-NaN"><a href="#hasOwnProperty-NaN" class="headerlink" title="hasOwnProperty()"></a>hasOwnProperty()</h4><p>如果我们只想看本对象中，不想看到继承下来的属性，我们可以使用hasOwnProperty()</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">对象名.hasOwnProperty(属性名)</span><br></pre></td></tr></table></figure>

<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><p>个人认为本质上和Java的流程判断没区别</p>
<h4 id="if判断"><a href="#if判断" class="headerlink" title="if判断"></a>if判断</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> age = <span class="number">18</span>;</span><br><span class="line"><span class="keyword">if</span>(age &gt; <span class="number">18</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;成年了&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(age === <span class="number">18</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;刚成年&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;未成年&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="while判断"><a href="#while判断" class="headerlink" title="while判断"></a>while判断</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(a &lt; <span class="number">100</span>)&#123;</span><br><span class="line">    a = a + <span class="number">1</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line">    b = b + <span class="number">1</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b);</span><br><span class="line">&#125;<span class="keyword">while</span>(b &lt; <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<h4 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="for-in-循环"><a href="#for-in-循环" class="headerlink" title="for in 循环"></a>for in 循环</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line"># <span class="keyword">for</span>(<span class="keyword">var</span> 下标 <span class="keyword">in</span> 容器)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> num <span class="keyword">in</span> arr)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(arr[num]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="for-of-循环"><a href="#for-of-循环" class="headerlink" title="for of 循环"></a>for of 循环</h4><p>for of和上面的for in 相似，for in产生的变量是下标，for of产生的变量是数值<br>但是for of不会遍历出手动添加的值，但for in会</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">for(var num of arr)&#123;</span><br><span class="line">    console.log(num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="forEach循环"><a href="#forEach循环" class="headerlink" title="forEach循环"></a>forEach循环</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var age = [1,23,4,5,6,7,8];</span><br><span class="line">age.forEach(function (value)&#123;</span><br><span class="line">    console.log(value);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="Map-和-Set"><a href="#Map-和-Set" class="headerlink" title="Map 和 Set"></a>Map 和 Set</h2><h4 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h4><p>JS里和Java里Map使用方法一样，键是唯一的，值不是唯一的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>([[<span class="string">&quot;tom&quot;</span>,<span class="number">99</span>],[<span class="string">&quot;jerry&quot;</span>,<span class="number">98</span>],[<span class="string">&quot;alice&quot;</span>,<span class="number">95</span>],[<span class="string">&quot;bob&quot;</span>,<span class="number">96</span>]]);</span><br><span class="line"><span class="comment">// get方法通过键来找到值</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(map.<span class="title function_">get</span>(<span class="string">&quot;tom&quot;</span>));</span><br><span class="line"><span class="comment">// set方法添加或者修改键值对</span></span><br><span class="line">map.<span class="title function_">set</span>(<span class="string">&quot;hhhhh&quot;</span>,<span class="number">100</span>);</span><br><span class="line"><span class="comment">// delete方法删除键值对</span></span><br><span class="line">map.<span class="title function_">delete</span>(<span class="string">&quot;tom&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>个人感觉JS里面Map和上面提到的对象很相似，都是多对键值对，但不同处在于对象的键只能是字符串，而Map的键可以是任意类型</p>
<p>可以通过for of来遍历</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>([[<span class="string">&quot;tom&quot;</span>,<span class="number">99</span>],[<span class="string">&quot;jerry&quot;</span>,<span class="number">98</span>],[<span class="string">&quot;alice&quot;</span>,<span class="number">95</span>],[<span class="string">&quot;bob&quot;</span>,<span class="number">96</span>]]);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> x <span class="keyword">of</span> map)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h4><p>Set：无序不重复的集合<br>无序并不是说没有顺序，而是说没有像数组一样的索引</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> set = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>]) </span><br><span class="line">set.<span class="title function_">add</span>(<span class="number">2</span>);                          <span class="comment">//添加元素</span></span><br><span class="line">set.<span class="title function_">delete</span>(<span class="number">1</span>);                       <span class="comment">//删除元素</span></span><br><span class="line">set.<span class="title function_">has</span>(<span class="number">3</span>);                          <span class="comment">//判断是否包含</span></span><br></pre></td></tr></table></figure>
<p>Set也可以通过for of来遍历</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var set = new Set([1,2,3,3,3,3,3,3]) </span><br><span class="line">for(var x of set)&#123;</span><br><span class="line">    console.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h4 id="函数的定义"><a href="#函数的定义" class="headerlink" title="函数的定义"></a>函数的定义</h4><p>__方式__：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">MyAbs</span>(<span class="params">x</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(x &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟其他语言一样，执行到 <code>return</code> 即代表函数结束，无法运行 <code>return</code> 后面的代码<br>如果没有执行 <code>return</code> ，函数执行完也会返回结果 <code>undefined</code></p>
<p>__方式二__：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var MyAdd = function(a,b)&#123;</span><br><span class="line">    return a+b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>function(a,b){…}是一个匿名函数。可以把结果赋值，通过被赋值名来调用函数</p>
<p><strong>方式一和方式二等价</strong></p>
<h4 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">函数名(参数1,参数2,参数3....)</span><br></pre></td></tr></table></figure>
<p>在调用函数的时候会发现一件事，你可以传任意多个参数，不会报错</p>
<p>如果我们只想接收一个参数，传多个参数就是非法调用，这种情况我们可以使用 <code>arguments</code> </p>
<p>例如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">MyAdd</span> = <span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">arguments</span>.<span class="property">length</span> !== <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&quot;Not a Number&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img%5Cp14.png" class="lazyload" data-srcset="/img%5Cp14.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"><br><code>arguments</code> 是参数接收值的数组，每个方法内都有，用来存储每个方法的接收值</p>
<h4 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h4><p><code>rest</code><br>用数组来接收函数体已经定义的参数之外的参数<br>例如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">abbb</span>(<span class="params">a,b,...rest</span>)&#123;</span><br><span class="line">    函数体.....</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">abbb</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>)       # 调用函数，传参</span><br><span class="line">                         # a === <span class="number">1</span></span><br><span class="line">                         # b === <span class="number">2</span></span><br><span class="line">                         rest = [<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>]</span><br></pre></td></tr></table></figure>
<p>rest参数只能写在参数最后，前面必须要有<code>...</code>表示</p>
<h2 id="变量的作用域"><a href="#变量的作用域" class="headerlink" title="变量的作用域"></a>变量的作用域</h2><h4 id="this"><a href="#this" class="headerlink" title="this"></a>this</h4><p>JS里，如果我们在函数外和函数内都定义了一个同名的变量，我们将如何区分</p>
<p>首先，JS和Java一样，遇到相同的变量名时会优先调用最近的(最近原则)，在函数里面调用，则会优先调用到函数里面的变量，如果希望调用函数外的，我们可以用关键字this</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">20</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;====================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line"><span class="title function_">test</span>();</span><br><span class="line">a = <span class="number">30</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line"><span class="title function_">test</span>();</span><br></pre></td></tr></table></figure>
<p><img src="/img%5Cp15.png" class="lazyload" data-srcset="/img%5Cp15.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h4 id="var和let"><a href="#var和let" class="headerlink" title="var和let"></a>var和let</h4><p>在之前写代码时会发现，我们无论在变量或者是函数前，都会加一个var或者let，var和let有什么区别呢？</p>
<p>一开始我也分不清楚，后来查资料也懵懵懂懂，后来多写几行代码就有更深一点的领悟。</p>
<p>var 一般是用在全局作用域，而let用在局部作用域，什么是作用域，个人见解，每一个 <code>&#123;&#125;</code> 花括号括起来就是一个作用域<br>比如上面的this中的代码，我们在函数外部和函数内部都定义一个全局变量a，我们在函数内是能通过this或者window来调用到函数外的a<br>注：window只能调用全局变量，无法调用局部变量<br>但是如果我们用的是let定义的局部变量，我们会发现在函数内也无法调用到函数外的a</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = <span class="number">20</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span>.<span class="property">a</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;====================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line"><span class="title function_">test</span>();</span><br><span class="line">a = <span class="number">30</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line"><span class="title function_">test</span>();</span><br></pre></td></tr></table></figure>
<p><img src="/img%5Cp17.png" class="lazyload" data-srcset="/img%5Cp17.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h4 id="常量const"><a href="#常量const" class="headerlink" title="常量const"></a>常量const</h4><p>有变量肯定也有常量，我们在编写代码的时候也希望有些值不允许被改变</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">const 变量名 = 值</span><br></pre></td></tr></table></figure>
<p>用const修饰后的变量名是不允许被修改的</p>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>函数定义在对象外就是函数，定义在对象内就是方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> hh = &#123;</span><br><span class="line">       name : <span class="string">&quot;hs&quot;</span>,</span><br><span class="line">       ahe : <span class="number">18</span>,</span><br><span class="line">       birth : <span class="number">2005</span>,</span><br><span class="line">       <span class="comment">// 方法</span></span><br><span class="line">       age : <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>() - <span class="variable language_">this</span>.<span class="property">birth</span>;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 属性</span></span><br><span class="line">hh.<span class="property">name</span>;</span><br><span class="line"><span class="comment">// 方法</span></span><br><span class="line">hh.<span class="title function_">age</span>();</span><br></pre></td></tr></table></figure>

<h4 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h4><p>apply感觉像是Java里的反射，在JS中任何方法都用apply的属性</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">方法名.apply(对象名,参数)      # 参数用数组装，没有参数就传[]</span><br></pre></td></tr></table></figure>
<p>例如</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getAge</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>() - <span class="variable language_">this</span>.<span class="property">birth</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> hh = &#123;</span><br><span class="line">    name : <span class="string">&quot;hs&quot;</span>,</span><br><span class="line">    ahe : <span class="number">18</span>,</span><br><span class="line">    birth : <span class="number">2005</span>,</span><br><span class="line">    age : getAge</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以用 hh.age()，也可以用 getAge.apply(hh,[])</p>
<h2 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h2><h4 id="JSON是什么"><a href="#JSON是什么" class="headerlink" title="JSON是什么"></a>JSON是什么</h4><p>JSON（JavaScript Object Notation，JavaScript对象表示法）<br>JSON是一种常用的数据格式，在电子数据交换中有多种用途，包括与服务器之间的Web应用程序的数据交换。其简洁和清晰的层次结构有效地提升了网络传输效率，使其成为理想的数据交换语言。其文件通常使用扩展名.json。</p>
<h4 id="JSON字符串和JS对象的转换"><a href="#JSON字符串和JS对象的转换" class="headerlink" title="JSON字符串和JS对象的转换"></a>JSON字符串和JS对象的转换</h4><p>格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">对象和方法用  &#123;&#125;</span><br><span class="line">数组用       []</span><br><span class="line">键值对用     key:value</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">            <span class="attr">age</span>: <span class="number">30</span>,</span><br><span class="line">            <span class="attr">city</span>: <span class="string">&quot;New York&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对象转换为JSON字符串</span></span><br><span class="line">        <span class="keyword">var</span> json = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(person);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(json)</span><br><span class="line">        <span class="comment">// JSON字符串转换为对象</span></span><br><span class="line">        <span class="keyword">var</span> obj =<span class="title class_">JSON</span>.<span class="title function_">parse</span>(json);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(obj)</span><br><span class="line">        <span class="comment">// 也可以用 JSON.parse(&#x27;&#123;&quot;name&quot;:&quot;John&quot;,&quot;age&quot;:30,&quot;city&quot;:&quot;New York&quot;&#125;&#x27;)</span></span><br></pre></td></tr></table></figure>
<p><img src="/img%5Cp18.png" class="lazyload" data-srcset="/img%5Cp18.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h2 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h2><p>在其他语言中，说起对象就想起类，类是模板，对象是实体，继承等等<br>在之前JS里还没有继承，但是有这个概念，于是出现了原型</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">A对象.__proto__ = B对象</span><br><span class="line">A对象的原型是B对象</span><br><span class="line">于是乎A对象就能使用B对象里面的属性</span><br></pre></td></tr></table></figure>

<h4 id="class"><a href="#class" class="headerlink" title="class"></a>class</h4><p>在ES6版本后，加入了一个新的关键字<code>class</code><br>跟Java的区别在于构造器，在JS的class里，构造器是 <code>constructor</code> </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">person01</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name, age</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span> = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span> + <span class="string">&quot; is running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> xiaoming = <span class="keyword">new</span> <span class="title function_">person01</span>(<span class="string">&quot;xiaoming&quot;</span>, <span class="number">25</span>);</span><br><span class="line"><span class="keyword">var</span> xiaohong = <span class="keyword">new</span> <span class="title function_">person01</span>(<span class="string">&quot;xiaohong&quot;</span>, <span class="number">20</span>);</span><br></pre></td></tr></table></figure>
<p>而且，在类里面构建的方法不需要在方法名前面加var</p>
<h4 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> 子类名 extend 父类名&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">参数</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">person02</span> <span class="keyword">extends</span> <span class="title class_ inherited__">person01</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name, age, sex</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(name, age);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sex</span> = sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">sayHello</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello, my name is &quot;</span> + <span class="variable language_">this</span>.<span class="property">name</span> + <span class="string">&quot; and I am a &quot;</span> + <span class="variable language_">this</span>.<span class="property">sex</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以在浏览器调试中看到其实所谓的继承还是原型，我们能看到原型链，原型的尽头还是object<br><img src="/img%5Cp19.png" class="lazyload" data-srcset="/img%5Cp19.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
<h2 id="操作BOM对象"><a href="#操作BOM对象" class="headerlink" title="操作BOM对象"></a>操作BOM对象</h2><p>BOM：Browser Object Model（浏览器对象模型）<br>类似的还有一个叫 <code>DOM</code> : 是将HTML文档中的各个元素封装成一个对象，而 <code>BOM</code> 则是将一个浏览器的各个组成部分封装成对象供调用使用。</p>
<p>JavaScript诞生的目的就是为了能够在浏览器上运行</p>
<h4 id="window"><a href="#window" class="headerlink" title="window"></a>window</h4><p>window对象代表着浏览器窗口</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">alert</span>(<span class="number">1</span>)</span><br><span class="line"><span class="literal">undefined</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">innerHeight</span></span><br><span class="line"><span class="number">358</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">innerWidth</span></span><br><span class="line"><span class="number">1659</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">outerWidth</span></span><br><span class="line"><span class="number">1707</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">outerWidth</span></span><br><span class="line"><span class="number">1707</span></span><br></pre></td></tr></table></figure>

<h4 id="navigator"><a href="#navigator" class="headerlink" title="navigator"></a>navigator</h4><p>navigator对象代表浏览器的信息</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">appName    # 浏览器的官方名称。通常是<span class="string">&quot;Netscape&quot;</span>，</span><br><span class="line">           # 这是因为<span class="title class_">Netscape</span>是第一个支持<span class="title class_">JavaScript</span>的浏览器。</span><br><span class="line">appVersion # 提供了浏览器版本信息</span><br><span class="line">userAgent  # 浏览器的用户代理字符串</span><br><span class="line">platform   # 运行浏览器的操作系统平台</span><br></pre></td></tr></table></figure>
<p>一般不建议使用 <code>navigator</code> 对象，因为里面的信息会被人为修改</p>
<h4 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h4><p>screen代表屏幕尺寸</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">screen.<span class="property">width</span></span><br><span class="line"><span class="number">1707</span> px</span><br><span class="line">screen.<span class="property">height</span></span><br><span class="line"><span class="number">960</span> px</span><br></pre></td></tr></table></figure>

<h4 id="location"><a href="#location" class="headerlink" title="location"></a>location</h4><p>location代表当前网页的URL信息</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="attr">host</span>: <span class="string">&quot;ntp.msn.cn&quot;</span></span><br><span class="line"><span class="attr">protocol</span>: <span class="string">&quot;https:&quot;</span></span><br><span class="line"><span class="attr">reload</span>: ƒ <span class="title function_">reload</span>()    <span class="comment">// 刷新网页</span></span><br></pre></td></tr></table></figure>

<h4 id="document"><a href="#document" class="headerlink" title="document"></a>document</h4><p>document代表当前的页面，HTML，DOC文档树</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">title</span></span><br><span class="line"><span class="string">&#x27;新建标签页&#x27;</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">&#x27;呵帅&#x27;</span></span><br><span class="line"><span class="string">&#x27;呵帅&#x27;</span></span><br></pre></td></tr></table></figure>
<p>cookie劫持原理，引了一个含有获取cookie的文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 获取cookie</span><br><span class="line">document.cookie</span><br></pre></td></tr></table></figure>

<h4 id="history"><a href="#history" class="headerlink" title="history"></a>history</h4><p>history代表浏览器的历史记录</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 后退</span></span><br><span class="line">history.<span class="title function_">back</span>()</span><br><span class="line"><span class="comment">// 前进</span></span><br><span class="line">history.<span class="title function_">forward</span>()</span><br></pre></td></tr></table></figure>

<h2 id="操作DOM对象"><a href="#操作DOM对象" class="headerlink" title="操作DOM对象"></a>操作DOM对象</h2><p>DOM：文档对象模型</p>
<p>浏览器网页就是一个DOM树形结构，我们只需要做<br>1、更新：更新DOM节点<br>2、遍历：遍历每个DOM节点<br>3、删除：删除DOM节点<br>4、增加：增加DOM节点</p>
<p>乍一看像前端版的增删改查</p>
<h4 id="获取DOM节点"><a href="#获取DOM节点" class="headerlink" title="获取DOM节点"></a>获取DOM节点</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;father&quot;</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>标题<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p1&quot;</span>&gt;</span>段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;p2&quot;</span>&gt;</span>段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">//对应CSS选择器</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> h1 =<span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;h1&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> p = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;p&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;div&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> father = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;father&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> p2 = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;p2&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> p1 =<span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;p1&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>可以用 <code>getElementsByName</code> 通过属性名，或者 <code>getElementById</code> 通过选择器</p>
<h4 id="更新节点"><a href="#更新节点" class="headerlink" title="更新节点"></a>更新节点</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div id = &#x27;id1&#x27;&gt;</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var id1 = documents.getElementById(&#x27;id1&#x27;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>操作文本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id1.innerText=&#x27;123456&#x27;;</span><br><span class="line">id1.innerHTML=&#x27;&lt;strong&gt;123&lt;/strong&gt;&#x27;</span><br><span class="line"></span><br><span class="line">innerText和innerHTML的区别：</span><br><span class="line">innerText修改文本的值</span><br><span class="line">innerHTML可以解析HTML语句</span><br></pre></td></tr></table></figure>
<p>操作JS</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id1.style.color = &#x27;red&#x27;</span><br><span class="line">&#x27;red&#x27;</span><br><span class="line">id1.style.fontSize = &#x27;20px&#x27;</span><br><span class="line">&#x27;20px&#x27;</span><br><span class="line">id1.style.padding = &#x27;30px&#x27;</span><br><span class="line">&#x27;30px&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h4><p>删除节点得先获取父节点，然后通过父节点删除</p>
<p>方法一</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;father&quot;</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>标题<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p1&quot;</span>&gt;</span>段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;p2&quot;</span>&gt;</span>段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> p1 = documents.<span class="title function_">getElementById</span>(<span class="string">&#x27;p1&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> father = p1.<span class="property">parentElement</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    father.<span class="title function_">removeChild</span>(p1)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>方法二</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;father&quot;</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>标题<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p1&quot;</span>&gt;</span>段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;p2&quot;</span>&gt;</span>段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    father.removeChild(father.children[0]);</span></span><br><span class="line"><span class="language-xml">    father.removeChild(father.children[0]);</span></span><br><span class="line"><span class="language-xml">    father.removeChild(father.children[0]);</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>注意：每次删除的时候，children都是在变化的</p>
<h2 id="表单"><a href="#表单" class="headerlink" title="表单"></a>表单</h2><h4 id="获取表单的值"><a href="#获取表单的值" class="headerlink" title="获取表单的值"></a>获取表单的值</h4><p>表单有很多种：<br>文本框、下拉框、选项框、密码框、隐藏框等等</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;p&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>输入内容:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span> <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">&lt;p&gt;</span><br><span class="line">    &lt;span&gt;性别:&lt;/span&gt;</span><br><span class="line">    &lt;input type=&quot;radio&quot; value=&quot;man&quot; name=&quot;sex&quot; id=&quot;boy&quot;&gt; 男</span><br><span class="line">    &lt;input type=&quot;radio&quot; value=&quot;woman&quot; name=&quot;sex&quot; id=&quot;girl&quot;&gt; 女</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var input_text = document.getElementById(&#x27;input&#x27;);</span><br><span class="line">    var boy_radio = document.getElementById(&#x27;boy&#x27;);</span><br><span class="line">    var girl_radio = document.getElementById(&#x27;girl&#x27;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>文本框我们会取其<code>document</code>然后用<code>.value</code>获得值<br>如果是选项框一般则会用 <code>.check</code>来判断是否被选择</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">input_text.value</span><br><span class="line">&#x27;123456&#x27;</span><br><span class="line">input_text.value = 456789</span><br><span class="line">456789</span><br><span class="line">boy_radio.value</span><br><span class="line">&#x27;man&#x27;</span><br><span class="line">girl_radio.value</span><br><span class="line">&#x27;woman&#x27;</span><br><span class="line">boy_radio.checked</span><br><span class="line">true</span><br><span class="line">girl_radio.checked</span><br><span class="line">false</span><br></pre></td></tr></table></figure>

<h4 id="表单提交验证及加密"><a href="#表单提交验证及加密" class="headerlink" title="表单提交验证及加密"></a>表单提交验证及加密</h4><p>在<code>button</code>中我们可以自定义按下按钮的触发效果</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;p&gt;</span><br><span class="line">    请输入用户名：&lt;input type=<span class="string">&quot;text&quot;</span> id=<span class="string">&quot;username&quot;</span> name=<span class="string">&quot;username&quot;</span> placeholder=<span class="string">&quot;请输入用户名&quot;</span>&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    请输入密码 ：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入密码&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!--绑定事件 onclick--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;submit()&quot;</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">function</span> <span class="title function_">submit</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">var</span> username = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;username&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">var</span> password = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;password&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">console</span>.<span class="title function_">log</span>(username.<span class="property">value</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">console</span>.<span class="title function_">log</span>(password.<span class="property">value</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>在平时使用的时候都是输入完按下提交按钮，数据就会被提交到数据库上面，但这样还是有一点隐患，非常容易被抓包，导致数据都被明文曝光，我们可以使用MD5加密</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">document名.value = md5(document名.value)</span><br></pre></td></tr></table></figure>
<p>世上没有不透风的强，再怎么加密依然有曝光的风险，平时项目中建议在后端进行加密，不要在前端做加密</p>
<h2 id="jQuery"><a href="#jQuery" class="headerlink" title="jQuery"></a>jQuery</h2><h4 id="jQuery下载"><a href="#jQuery下载" class="headerlink" title="jQuery下载"></a>jQuery下载</h4><p>目前jQuery官网直接打开不是文件而是原码<br>我们在官网上点开 <code>download</code><br><img src="/img%5Cp20.png" class="lazyload" data-srcset="/img%5Cp20.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"><br>点击 <code>download jQuery</code><br><img src="/img%5Cp21.png" class="lazyload" data-srcset="/img%5Cp21.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"><br>然后我们会发现一整个网页都是字符，不要怀疑自己，这就是官网<br><img src="/img%5Cp22.png" class="lazyload" data-srcset="/img%5Cp22.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"><br>方法一：<br>我们在项目的位置新建一个 <code>.txt</code> 文件，把网页的内容 <code>Ctrl+a</code> 全部复制到txt文件内，修改后缀为 <code>.js</code> 然后倒入进项目里</p>
<p>方法二：<br>右键另存为，就是一个 <code>.js</code> 文件了</p>
<p>或者，我们在网上查找jQuery的CDN，直接搜索就行，引入在线CND，就不需要去官网下载了</p>
<h4 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script scr=&quot;lib/jquery-3.5.1.min.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/img%5Cp23.png" class="lazyload" data-srcset="/img%5Cp23.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"><br>直接在<code>head</code>最下面插入导入语句</p>
<h4 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h4><p>在网页上画一个小块，当鼠标在块中时可以显示鼠标在块内的坐标</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">        <span class="selector-id">#div1</span> &#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">            <span class="attribute">width</span>: <span class="number">500px</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">            <span class="attribute">height</span>:<span class="number">500px</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">            <span class="attribute">border</span>: <span class="number">1px</span> solid red;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;span1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;div1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        移动区域</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span> (<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            $(<span class="string">&quot;#div1&quot;</span>).<span class="title function_">mousemove</span>(<span class="keyword">function</span> (<span class="params">e</span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                $(<span class="string">&quot;#span1&quot;</span>).<span class="title function_">text</span>(<span class="string">&quot;x&quot;</span>+e.<span class="property">pageX</span>+<span class="string">&quot;y&quot;</span>+e.<span class="property">pageY</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>效果：<br><img src="/img%5Cp24.png" class="lazyload" data-srcset="/img%5Cp24.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张图片" title="可选的标题"></p>
]]></content>
  </entry>
  <entry>
    <title></title>
    <url>/2025/01/12/articles/%E9%81%87%E5%88%B0%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3%E4%B8%8D%E4%BA%86/</url>
    <content><![CDATA[<h1 id="遇到报错，实在解决不了，就降低版本"><a href="#遇到报错，实在解决不了，就降低版本" class="headerlink" title="遇到报错，实在解决不了，就降低版本"></a>遇到报错，实在解决不了，就降低版本</h1>]]></content>
  </entry>
  <entry>
    <title></title>
    <url>/2024/09/11/articles/MySQL/MySQL/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>JDBC学习笔记</title>
    <url>/2024/09/05/articles/JDBC/JDBC/</url>
    <content><![CDATA[<h1 id="了解一下JDBC"><a href="#了解一下JDBC" class="headerlink" title="了解一下JDBC"></a>了解一下JDBC</h1><p>JDBC（Java Database Connectivity）是Java语言中用来规范客户端程序如何访问数据库的应用程序接口，它定义了一系列的接口，为各种数据库的访问提供了统一的操作方式。</p>
<h2 id="为什么我们会用到JDBC？"><a href="#为什么我们会用到JDBC？" class="headerlink" title="为什么我们会用到JDBC？"></a>为什么我们会用到JDBC？</h2><p>一般来说，数据库与应用程序无法直接链接，我们需要一个驱动，作为应用和数据库直接的桥梁，但是每个厂商之间的驱动是不相同的，MySQL有MySQL的驱动，Oracle有Oracle的驱动，我们不可能每使用一种数据库就去安装他的驱动，太过麻烦。<br><img src="/JDBC/p1.png" class="lazyload" data-srcset="/JDBC/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="p1"><br>JDBC是让Java应用程序连接到不同的数据库管理系统(如MySQL、Oracle等)，执行SQL查询和更新，以及处理结果集。<br>驱动的安装就不需要我们亲自去做了，我们只需要掌握JDBC的语法，即可在Java中使用数据库了。<br><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="p1"></p>
<h2 id="使用JDBC之前的工作"><a href="#使用JDBC之前的工作" class="headerlink" title="使用JDBC之前的工作"></a>使用JDBC之前的工作</h2><p>首先，在使用JDBC之前，我们需要先去下载jar包，我是去Maven仓库下载的<br>Maven仓库下载地址：<a href="https://mvnrepository.com/artifact/mysql/mysql-connector-java">https://mvnrepository.com/artifact/mysql/mysql-connector-java</a><br>下载后，我们需要导入驱动jar包<br>我们在项目内新建一个文件夹，用来存放jar包，后面需要添加的jar包也可以存放在内，把下载的jar包复制进文件内，打开IntelliJ IDEA<br><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="p1"><br>我们在项目内可以看到我们复制进来的jar包，但此时不算导入成功，我们需要右键，点击<code>Add as Library</code>，点击ok，可以展开的话就是导入成功了</p>
<h2 id="第一个JDBC程序"><a href="#第一个JDBC程序" class="headerlink" title="第一个JDBC程序"></a>第一个JDBC程序</h2><h3 id="查询数据库"><a href="#查询数据库" class="headerlink" title="查询数据库"></a>查询数据库</h3><p>JDBC有六个步骤，我们随后在Java程序里写编程的时候按照这六步来写即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、加载驱动</span><br><span class="line">2、用户信息和url</span><br><span class="line">3、创造链接</span><br><span class="line">4、执行sql语句的对象</span><br><span class="line">5、执行sql语句，并查看返回的结果</span><br><span class="line">6、释放链接</span><br></pre></td></tr></table></figure>
<p>我们先准备一份有内容的数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE jdbcStudy;</span><br><span class="line"></span><br><span class="line">USE jdbcStudy;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `users`(</span><br><span class="line">	id INT PRIMARY KEY,</span><br><span class="line">	NAME VARCHAR(40),</span><br><span class="line">	PASSWORD VARCHAR(40),</span><br><span class="line">	email VARCHAR(60),</span><br><span class="line">	birthday DATE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO `users`(id,NAME,PASSWORD,email,birthday)</span><br><span class="line">VALUES(1,&#x27;zhansan&#x27;,&#x27;123456&#x27;,&#x27;zs@qq.com&#x27;,&#x27;2000-1-1&#x27;),</span><br><span class="line">(2,&#x27;lisi&#x27;,&#x27;123456&#x27;,&#x27;lisi@qq.com&#x27;,&#x27;2001-1-1&#x27;),</span><br><span class="line">(3,&#x27;wangwu&#x27;,&#x27;123456&#x27;,&#x27;wangwu@qq.com&#x27;,&#x27;2002-1-1&#x27;)</span><br></pre></td></tr></table></figure>
<p>然后，我们再打开IntelliJ IDEA，新建一个Java程序<br><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="p1"><br>代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package JDBC;</span><br><span class="line"></span><br><span class="line">import java.sql.*;</span><br><span class="line"></span><br><span class="line">public class JDBCtest &#123;</span><br><span class="line">    public static void main(String[] args) throws ClassNotFoundException, SQLException &#123;</span><br><span class="line">        //JDBC</span><br><span class="line"></span><br><span class="line">        //1、加载驱动</span><br><span class="line">        Class.forName(&quot;com.mysql.jdbc.Driver&quot;); //模板格式</span><br><span class="line"></span><br><span class="line">        //2、用户信息和url</span><br><span class="line">        String url = &quot;jdbc:mysql://localhost:3306/jdbcstudy;</span><br><span class="line">        String user = &quot;root&quot;;</span><br><span class="line">        String password = &quot;123456&quot;;</span><br><span class="line"></span><br><span class="line">        //3、创造链接</span><br><span class="line">        Connection connection = DriverManager.getConnection(url, user, password);//这里返回的connection对象代表数据库</span><br><span class="line"></span><br><span class="line">        //4、执行sql语句的对象</span><br><span class="line">        Statement statement = connection.createStatement();</span><br><span class="line"></span><br><span class="line">        //5、执行sql语句，并查看返回的结果</span><br><span class="line">        String sql = &quot;SELECT * FROM users&quot;;</span><br><span class="line">        ResultSet resultSet = statement.executeQuery(sql);//返回的结果集</span><br><span class="line">        while (resultSet.next())&#123;</span><br><span class="line">            System.out.print(&quot;id=&quot;+resultSet.getObject(&quot;id&quot;));</span><br><span class="line">            System.out.print(&quot; name=&quot;+resultSet.getObject(&quot;NAME&quot;));</span><br><span class="line">            System.out.print(&quot; password=&quot;+resultSet.getObject(&quot;PASSWORD&quot;));</span><br><span class="line">            System.out.print(&quot; email=&quot;+resultSet.getObject(&quot;email&quot;));</span><br><span class="line">            System.out.println(&quot; birth=&quot;+resultSet.getObject(&quot;birthday&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        //6、释放链接</span><br><span class="line">        resultSet.close();</span><br><span class="line">        statement.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下，虽然有红色小字，但不影响程序的运行<br><img src="/p5.png" class="lazyload" data-srcset="/p5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="p"></p>
<h3 id="修改信息-增加信息-删除信息"><a href="#修改信息-增加信息-删除信息" class="headerlink" title="修改信息|增加信息|删除信息"></a>修改信息|增加信息|删除信息</h3><p>我们使用executeUpdate(String sql)来完成添加|删除信息<br>添加信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Statement statement = connection.createStatement();</span><br><span class="line">String sql = &quot;insert into user(...)values(...)&quot;;</span><br><span class="line">int num = statement.executeUpdate(sql);</span><br><span class="line">if (num &gt; 0)&#123;</span><br><span class="line">    System.out.println(&quot;插入成功！&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>删除信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Statement statement = connection.createStatement();</span><br><span class="line">String sql = &quot;delete from user where ...&quot;;</span><br><span class="line">int num = statement.executeUpdate(sql);</span><br><span class="line">if (num &gt; 0)&#123;</span><br><span class="line">    System.out.println(&quot;删除成功！&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改信息同上，只需要改变sql里面的语句即可</p>
<h2 id="简化步骤"><a href="#简化步骤" class="headerlink" title="简化步骤"></a>简化步骤</h2><p>上面的方法看着很简便，但如果数据一多就特别麻烦，所以我们需要把方法提取出来<br>首先，我们构建一个文件<code>db.properties</code>用来保留登录信息，在文件中写入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">driver=com.mysql.jdbc.Driver</span><br><span class="line">url=jdbc:mysql://localhost:3306/jdbcstudy</span><br><span class="line">username=root</span><br><span class="line">password=123456</span><br></pre></td></tr></table></figure>
<p>然后再构建一个java文件，用来存放方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package JDBCtest2;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.sql.*;</span><br><span class="line">import java.util.Properties;</span><br><span class="line"></span><br><span class="line">public class test2 &#123;</span><br><span class="line"></span><br><span class="line">    private static String driver = null;</span><br><span class="line">    private static String url = null;</span><br><span class="line">    private static String user = null;</span><br><span class="line">    private static String password = null;</span><br><span class="line">static &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        InputStream in = test2.class.getClassLoader().getResourceAsStream(&quot;db.properties&quot;);</span><br><span class="line">        Properties properties = new Properties();</span><br><span class="line">        properties.load(in);</span><br><span class="line">        driver = properties.getProperty(&quot;driver&quot;);</span><br><span class="line">        url = properties.getProperty(&quot;url&quot;);</span><br><span class="line">        user = properties.getProperty(&quot;username&quot;);</span><br><span class="line">        password = properties.getProperty(&quot;password&quot;);</span><br><span class="line"></span><br><span class="line">        //1、驱动只需要加载一次</span><br><span class="line">        Class.forName(driver);</span><br><span class="line"></span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//获取链接</span><br><span class="line">public static Connection getConnection() throws SQLException &#123;</span><br><span class="line">    return DriverManager.getConnection(url, user, password);</span><br><span class="line">&#125;</span><br><span class="line">//释放资源</span><br><span class="line">public static void release(Connection conn, Statement st, ResultSet rs) &#123;</span><br><span class="line">    if (rs!= null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            rs.close();</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (st!= null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            st.close();</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (conn != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            conn.close();</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法就提取出来了，我们实验一下<br><img src="/JDBC/p6.png" class="lazyload" data-srcset="/JDBC/p6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="p"><br>运行结果，成功插入<br><img src="/p7.png" class="lazyload" data-srcset="/p7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="p"><br><img src="/p8.png" class="lazyload" data-srcset="/p8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="p"></p>
<h2 id="PreparedStatement对象"><a href="#PreparedStatement对象" class="headerlink" title="PreparedStatement对象"></a>PreparedStatement对象</h2><p>PreparedStatement对象可以有效防止<a href="https://baike.baidu.com/item/sql%E6%B3%A8%E5%85%A5/150289?fr=ge_ala" title="百度搜索">SQL注入</a>，并且运行时效率更高。<br>防止SQL注入的原理：把转递进来的参数当作字符，假设其中存在转义字符，会被直接转义，比如说<code>&quot;</code>会被认为是引号，而不是其他。<br><img src="/p9.png" class="lazyload" data-srcset="/p9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="p"><br>代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.sql.Connection;</span><br><span class="line">import java.sql.PreparedStatement;</span><br><span class="line">import java.sql.SQLException;</span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">public class insertTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Connection conn = null;</span><br><span class="line">        PreparedStatement pst = null;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            conn = test2.getConnection();</span><br><span class="line">            // 与之前的区别：</span><br><span class="line">            // 使用？占位符来代替参数</span><br><span class="line">            String sql = &quot;insert into users(id, NAME, PASSWORD, email, birthday) values(?, ?, ?, ?, ?)&quot;;</span><br><span class="line"></span><br><span class="line">            pst = conn.prepareStatement(sql);//预编译sql语句，但不执行</span><br><span class="line"></span><br><span class="line">            //手动给参数赋值，</span><br><span class="line">            // 第一个参数代表着第几个问号，第二个参数代表着参数值</span><br><span class="line">            pst.setInt(1, 5);</span><br><span class="line">            pst.setString(2, &quot;John&quot;);</span><br><span class="line">            pst.setString(3, &quot;123456&quot;);</span><br><span class="line">            pst.setString(4, &quot;john@qq.com&quot;);</span><br><span class="line">            // java.sql.Date是数据库的日期类型，需要用java.util.Date转换</span><br><span class="line">            //         new Date().getTime()获取时间戳</span><br><span class="line">            pst.setDate(5, new java.sql.Date(new Date().getTime()));</span><br><span class="line"></span><br><span class="line">            int i = pst.executeUpdate();</span><br><span class="line"></span><br><span class="line">            if (i &gt; 0) &#123;</span><br><span class="line">                System.out.println(&quot;Insert success!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>成功插入<br><img src="/p10.png" class="lazyload" data-srcset="/p10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="p"><br>其余删改查和这个差不多，删和改只需要把sql语句和参数变一下，查就把sql语句和<code>executeUpdate</code>变成<code>executeQuery</code>即可</p>
]]></content>
  </entry>
  <entry>
    <title></title>
    <url>/2024/10/06/articles/Mybatis/test2/</url>
    <content><![CDATA[<h1 id="Mybatis的小笔记"><a href="#Mybatis的小笔记" class="headerlink" title="Mybatis的小笔记"></a>Mybatis的小笔记</h1><h2 id="association-与-collection"><a href="#association-与-collection" class="headerlink" title="association 与 collection"></a>association 与 collection</h2><h3 id="association"><a href="#association" class="headerlink" title="association"></a>association</h3><p>用于一对一或多对一，当一个对象包含另一个对象作为其属性时，可以使用association<br>例如：一个User类有一个Address类的属性，表示用户有一个地址</p>
<h3 id="collection"><a href="#collection" class="headerlink" title="collection"></a>collection</h3><p>用于一对多，当一个对象包含多个相同类型的对象作为其属性时，可以使用collection<br>例如：一个User类有一个Order列表的属性，表示一个用户可以有多个订单</p>
<h2 id="javaType-与-ofType"><a href="#javaType-与-ofType" class="headerlink" title="javaType 与 ofType"></a>javaType 与 ofType</h2><p>在MyBatis的映射文件中，javaType和ofType是两个经常与association和collection元素一起使用的属性，它们用于指定映射的目标类型，但它们的使用场景和含义有所不同。</p>
<p>javaType：用来指定实体类（JavaBean）中属性的类型<br>ofType：用来指定映射容器里面实体类（JavaBean）中的类型，泛型中的约束类型</p>
]]></content>
  </entry>
  <entry>
    <title>Mybatis学习记录</title>
    <url>/2024/09/20/articles/Mybatis/Mybatis/</url>
    <content><![CDATA[<h1 id="Mybatis"><a href="#Mybatis" class="headerlink" title="Mybatis"></a>Mybatis</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Mybatis是一个持久层的框架，支持自定义 SQL、存储过程以及高级映射。MyBatis 免除了几乎所有的 JDBC 代码以及设置参数和获取结果集的工作。可以使用XML或注解来配置和映射原始类型、接口和Java对象作为数据库中的记录。</p>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>帮助文档</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://mybatis.org/mybatis-3/zh_CN/index.html</span><br></pre></td></tr></table></figure>
<p>1、maven仓库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.mybatis/mybatis --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.5.16&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2、GitHub</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://github.com/mybatis/mybatis-3/releases</span><br></pre></td></tr></table></figure>

<h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><p>搭建好一个环境特别麻烦，做错一步就搭建失败报错<br>跟着官方文档一步步来：<a href="https://mybatis.org/mybatis-3/zh_CN/getting-started.html">https://mybatis.org/mybatis-3/zh_CN/getting-started.html</a></p>
<h3 id="1、搭建数据库"><a href="#1、搭建数据库" class="headerlink" title="1、搭建数据库"></a>1、搭建数据库</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create database mybatis_lean;</span><br><span class="line"></span><br><span class="line">use mybatis_lean;</span><br><span class="line"></span><br><span class="line">create table user(</span><br><span class="line">    id int not null primary key,</span><br><span class="line">    name varchar(20) default null,</span><br><span class="line">    pwd varchar(20) default null</span><br><span class="line">)engine=INNODB default charset=utf8;</span><br><span class="line"></span><br><span class="line">insert into user values(1,&#x27;zhangsan&#x27;,&#x27;123456&#x27;),(2,&#x27;lisi&#x27;,&#x27;123456&#x27;),(3,&#x27;wangwu&#x27;,&#x27;123456&#x27;);</span><br></pre></td></tr></table></figure>
<h3 id="2、新建一个maven项目"><a href="#2、新建一个maven项目" class="headerlink" title="2、新建一个maven项目"></a>2、新建一个maven项目</h3><p><img src="/imag%5Cp1.png" class="lazyload" data-srcset="/imag%5Cp1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是图片" title="Magic Gardens"></p>
<h4 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h4><p>在<code>pom.xml</code>文件中导入所需要的依赖以及配置resource来防止资源导出失败</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>MybatisStudy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>mybatisStudy-01<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--    导入依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        mysql--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        mybatis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        junit--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意，在<code>.xml</code>文件中尽量不要使用中文注释</p>
<h3 id="3、在原项目下新建一个maven项目"><a href="#3、在原项目下新建一个maven项目" class="headerlink" title="3、在原项目下新建一个maven项目"></a>3、在原项目下新建一个maven项目</h3><p>父级项目下创建一个子项目，子项目的<code>.xml</code>就不需要再配置了，方便我们以后使用</p>
<h4 id="创建resource下的文件"><a href="#创建resource下的文件" class="headerlink" title="创建resource下的文件"></a>创建resource下的文件</h4><p>在子项目下的resource文件下创建一个<code>mybatis-config.xml</code>文件(叫什么无所谓，但但是尽量统一方便查看)<br>配置文件：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">  <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;org/mybatis/example/BlogMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>把上面的 <code>$&#123;driver&#125;、$&#123;url&#125;、$&#123;username&#125;、$&#123;password&#125;</code> 都做修改</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">driver配置驱动，一般为：com.mysql.jdbc.Driver</span><br><span class="line">url数据库的url，在idea里面打开已经配置好的数据库查看</span><br><span class="line">username：数据库的用户名</span><br><span class="line">password：数据库的密码</span><br></pre></td></tr></table></figure>
<h4 id="新建一个包"><a href="#新建一个包" class="headerlink" title="新建一个包"></a>新建一个包</h4><p>新建三个包，包名分别为dao、utils、pojo</p>
<h5 id="utils包"><a href="#utils包" class="headerlink" title="utils包"></a>utils包</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://mybatis.org/mybatis-3/zh_CN/getting-started.html</span><br><span class="line">原文档的话：</span><br><span class="line">每个基于 MyBatis 的应用都是以一个 SqlSessionFactory 的实例为核心的。</span><br><span class="line">SqlSessionFactory 的实例可以通过 SqlSessionFactoryBuilder 获得。</span><br><span class="line">而 SqlSessionFactoryBuilder 则可以从 XML 配置文件或一个预先配置的 Configuration</span><br><span class="line">实例来构建出 SqlSessionFactory 实例。</span><br></pre></td></tr></table></figure>
<p>在包内新建一个名为 <code>MybatisUtils</code> 的java类，用来获取SqlSessionFactory</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line">        <span class="comment">//获取sqlSessionFactory对象</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 没有解析，背就行了</span></span><br><span class="line">            <span class="comment">// 死代码</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="string">&quot;mybatis-config.xml&quot;</span>;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(resource);</span><br><span class="line">            sqlSessionFactory = <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取SqlSession</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title function_">getSqlSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.openSession();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="pojo包"><a href="#pojo包" class="headerlink" title="pojo包"></a>pojo包</h5><p>编写一个实体类的对象user</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String pwd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(<span class="type">int</span> id, String name, String pwd)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.pwd = pwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPwd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPwd</span><span class="params">(String pwd)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pwd = pwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, pwd=&#x27;&quot;</span> + pwd + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="dao包"><a href="#dao包" class="headerlink" title="dao包"></a>dao包</h5><p>在dao包下新建一个接口UserDao</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.Dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    List&lt;User&gt; <span class="title function_">getUserList</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在dao包下新建一个<code>UserMapper.xml</code><br>配置User的Mapper</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;org.example.Dao.UserDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserList&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        select * from mybatis_lean.user</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>搭建完以上步骤后，在test文件夹下新建一个 <code>UserDaoTest</code> Java类文件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.example.Dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> org.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.example.utils.MybatisUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得sqlSession对象</span></span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MybatisUtils.getSqlSession();</span><br><span class="line">        <span class="type">UserDao</span> <span class="variable">mapper</span> <span class="operator">=</span> sqlSession.getMapper(UserDao.class);</span><br><span class="line">        List&lt;User&gt; userList = mapper.getUserList();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (User user : userList) &#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">        sqlSession.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：<br><img src="/imag%5Cp2.png" class="lazyload" data-srcset="/imag%5Cp2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是图片" title="Magic Gardens"><br>target文件夹是用来存放项目构建后的文件和目录、jar包、war包、编译的class文件，都是maven构建时生成的。<br>运行成功后查看左边的target文件下的<code>classes</code>文件夹，里面的内容与你项目的内容一致</p>
<h2 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h2><p>添加增删改查就在我们搭建的环境基础下改几个地方就行</p>
<p>首先来看Dao下的配置文件<code>UserMapper.xml</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">在mapper标签里面有这么几个参数:</span><br><span class="line">    namespace：指的是方法所在的接口包名</span><br><span class="line">    id：所调用的方法名</span><br><span class="line">    resultType：方法返回的类型</span><br><span class="line">    parameterType：方法参数的类型</span><br></pre></td></tr></table></figure>
<p><img src="/imag%5Cp3.png" class="lazyload" data-srcset="/imag%5Cp3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是图片" title="Magic Gardens"><br>用select标签标起来的就是我们所需要的sql命令<br>添加新的sql命令时，我们先需要在<code>UserDao</code>接口上新增方法，然后在配置文件里面的mapper标签里使用select标签，id换成新的方法名，resultType换成返回的参数，parameterType设置成方法参数的类型<br>如果没有参数和返回值resultType和parameterType可以不写</p>
<h3 id="样例：查"><a href="#样例：查" class="headerlink" title="样例：查"></a>样例：查</h3><p>首先在接口文件上填上方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User <span class="title function_">getUserById</span><span class="params">(<span class="type">int</span> id)</span>;</span><br></pre></td></tr></table></figure>
<p>然后新增配置文件<br>xml可以识别数据库里面的字段名，如果有参数我们使用<code>#&#123;字段名&#125;</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserById&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        select * from mybatis_lean.user where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最后就可以在Test测试了，步骤和之前一样<br>先用<code>MybatisUtils.getSqlSession</code>获取SqlSession，然后在获得接口<code>getMapper</code>，在mapper里面调用方法即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MybatisUtils.getSqlSession();</span><br><span class="line"></span><br><span class="line">        <span class="type">UserDao</span> <span class="variable">mapper</span> <span class="operator">=</span> sqlSession.getMapper(UserDao.class);</span><br><span class="line">        mapper.updateUser(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">3</span>, <span class="string">&quot;tom&quot;</span>, <span class="string">&quot;123123&quot;</span>));</span><br><span class="line"></span><br><span class="line">        sqlSession.commit();</span><br><span class="line">        sqlSession.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="增删改查代码"><a href="#增删改查代码" class="headerlink" title="增删改查代码"></a>增删改查代码</h3><p>查：getUserById<br>增：insertUser<br>删：deleteUser<br>改：updateUser</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;org.example.Dao.UserDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserList&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        select * from mybatis_lean.user</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserById&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        select * from mybatis_lean.user where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;insertUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;org.example.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        insert into mybatis_lean.user values (#&#123;id&#125;, #&#123;name&#125;, #&#123;pwd&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;deleteUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">        delete from mybatis_lean.user where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;updateUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;org.example.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        update mybatis_lean.user set name = #&#123;name&#125;, pwd = #&#123;pwd&#125; where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意：配置文件里面不要用中文</p>
<p>接口文件：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.Dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    List&lt;User&gt; <span class="title function_">getUserList</span><span class="params">()</span>;</span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteUser</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="模糊匹配"><a href="#模糊匹配" class="headerlink" title="模糊匹配"></a>模糊匹配</h2><p>我们使用数据库大多数指令都是查询，但有时候我们会忘记我们查询目标的全称，这时候我们就可以使用模糊比配<br>首先，模糊匹配有两种常用的通配符”<code>%</code>“和”<code>_</code>“</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;%&quot; 百分号通配符: 表示任何字符出现0次或者多次</span><br><span class="line">例如：%李%        # 查找带有&quot;李&quot;的字符串，无论&quot;李&quot;出现在字符串的哪里</span><br><span class="line">&quot;_&quot; 下划线通配符:表示只能匹配单个字符。当然，也可以使用多个&quot;_&quot;</span><br><span class="line">例如：李__        # 查找开头是&quot;李&quot;，长度为3的字符串</span><br></pre></td></tr></table></figure>
<p>使用关键字<code>like</code>即为模糊匹配</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User <span class="title function_">getUserLikeName</span><span class="params">(String value)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserLikeName&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;String&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        select * from mybatis_lean.user where name like &quot;%&quot;#&#123;value&#125;&quot;%&quot;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用模糊匹配时要注意防范<a href="https://blog.csdn.net/weixin_45840241/article/details/139106947">SQL注入</a></p>
<h2 id="配置解析"><a href="#配置解析" class="headerlink" title="配置解析"></a>配置解析</h2><h3 id="核心配置文件"><a href="#核心配置文件" class="headerlink" title="核心配置文件"></a>核心配置文件</h3><p>一般用到mybatis的配置文件官方都建议命名为<code>mybatis-config.xml</code>，当然也可以不接受这个建议</p>
<p>配置文件里面有一下几个组成部分</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">configuration（配置）</span><br><span class="line">properties（属性）</span><br><span class="line">settings（设置）</span><br><span class="line">typeAliases（类型别名）</span><br><span class="line">typeHandlers（类型处理器）</span><br><span class="line">objectFactory（对象工厂）</span><br><span class="line">plugins（插件）</span><br><span class="line">environments（环境配置）</span><br><span class="line">environment（环境变量）</span><br><span class="line">transactionManager（事务管理器）</span><br><span class="line">dataSource（数据源）</span><br><span class="line">databaseIdProvider（数据库厂商标识）</span><br><span class="line">mappers（映射器）</span><br></pre></td></tr></table></figure>
<p>先后顺序是：<br>properties，settings，typeAliases，typeHandlers，objectfactory，objectwrapperfactory，<br>reflectorFactory，plugins，environments，databaseldProvider，mappers</p>
<h4 id="事务管理器-transactionManager"><a href="#事务管理器-transactionManager" class="headerlink" title="事务管理器 transactionManager"></a>事务管理器 transactionManager</h4><p>在 MyBatis 中有两种类型的事务管理器：JDBC 和 MANAGED(基本不用)<br>Mybatis 默认的事务管理器是 JDBC</p>
<p>JDBC – 这个配置直接使用了 JDBC 的提交和回滚功能，它依赖从数据源获得的连接来管理事务作用域。默认情况下，为了与某些驱动程序兼容，它在关闭连接时启用自动提交</p>
<p>MANAGED - 等价于 EJB (Enterprise Java Beans)， 这个配置几乎没做什么。它从不提交或回滚一个连接，而是让容器来管理事务的整个生命周期（比如 JEE 应用服务器的上下文）</p>
<h4 id="数据源-dataSource"><a href="#数据源-dataSource" class="headerlink" title="数据源 dataSource"></a>数据源 dataSource</h4><p>dataSource 元素使用标准的 JDBC 数据源接口来配置 JDBC 连接对象的资源。<br>有三种内建的数据源类型：UNPOOLED、POOLED 和 JNDI<br>Mybatis默认数据源是POOLED</p>
<p>POOLED 可以理解成数据池，可以理解成 new 了一块空间出来，用完可以回收，即使数据传输完毕，这块空间也不会解散，只有等到代码跑完了才会自动解散。<br>JNDI – 这个数据源实现是为了能在如 EJB 或应用服务器这类容器中使用</p>
<h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><p>我们可以通过 <code>properties</code> 属性来实现引用配置文件<br>这些属性可以在外部进行配置，并可以进行动态替换。你既可以在典型的 Java 属性文件中配置这些属性，也可以在 properties 元素的子元素中设置。</p>
<p>我们在 <code>resource</code> 文件夹下新建一个 <code>dp.properties</code> 文件，里面写入替换的值<br>例如：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">driver</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://localhost:3306/mybatis_lean?allowPublicKeyRetrieval=true&amp;useSSL=false&amp;useUnicode=true&amp;characteEncoding=UTF8</span></span><br><span class="line"><span class="attr">username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure>
<p>然后回到 <code>mybatis-config.xml</code> 文件，编写 properties 标签</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;dp.properties&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后修改 environment </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意：properties 标签必须在 configuration 里的最上面，先解释 properties 标签</p>
<p>当然，我们也可以在 mybatis-config.xml 里面改变值，但如果内部文件和外部文件都有动态配置的属性值，先运行内部的，后运行的外部会覆盖内部</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;dp.properties&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="类型别名-typeAliases"><a href="#类型别名-typeAliases" class="headerlink" title="类型别名 typeAliases"></a>类型别名 typeAliases</h4><p>类型别名可为 Java 类型设置一个缩写名字。它仅用于 XML 配置，意在降低冗余的全限定类名书写。<br>在 configuration 的书写顺序为第三位<br>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;typeAliases&gt;</span><br><span class="line">        &lt;typeAlias alias=&quot;User&quot; type=&quot;org.example.pojo.User&quot;/&gt;</span><br><span class="line">&lt;/typeAliases&gt;</span><br><span class="line">上面这种配置可以让 org.example.pojo.User 替换成 User</span><br><span class="line"></span><br><span class="line">也可以指定一个包名，MyBatis 会在包名下面搜索需要的 Java Bean</span><br><span class="line">&lt;typeAliases&gt;</span><br><span class="line">        &lt;package name=&quot;org.example.pojo&quot;/&gt;</span><br><span class="line">&lt;/typeAliases&gt;</span><br><span class="line">如果我们指定的包名 org.example.pojo 中的 JavaBean 没有注释，会使用类名的首字母小写作</span><br><span class="line">为别名</span><br><span class="line">我们也可以作注释</span><br><span class="line">@Alias(&quot;hhhh&quot;)</span><br><span class="line">public class User &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">如上， hhhh 则作为此 JavaBean的类型别名</span><br></pre></td></tr></table></figure>

<h4 id="映射器-mappers"><a href="#映射器-mappers" class="headerlink" title="映射器 mappers"></a>映射器 mappers</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">方式一：</span><br><span class="line">&lt;mappers&gt;</span><br><span class="line">    &lt;mapper resource=&quot;org/example/Dao/UserMapper.xml&quot;/</span><br><span class="line">&lt;/mappers&gt;</span><br><span class="line">方式二：</span><br><span class="line">&lt;mappers&gt;</span><br><span class="line">    &lt;mapper class=&quot;org.example.Dao.UserMapper&quot;/&gt;</span><br><span class="line">&lt;/mappers&gt;</span><br><span class="line">方式三：</span><br><span class="line">&lt;mappers&gt;</span><br><span class="line">    &lt;package name=&quot;org.example.Dao&quot;/&gt;</span><br><span class="line">&lt;/mappers&gt;</span><br></pre></td></tr></table></figure>

<h3 id="作用域和生命周期"><a href="#作用域和生命周期" class="headerlink" title="作用域和生命周期"></a>作用域和生命周期</h3><p><img src="/imag%5Cp4.png" class="lazyload" data-srcset="/imag%5Cp4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是图片" title="Magic Gardens"><br>SqlSessionFactoryBuilder<br>SqlSessionFactory 创建完 SqlSessionFactory 就不再需要它了。 因此最佳作用域是方法作用域（也就是局部方法变量）。 你可以重用 SqlSessionFactoryBuilder 来创建多个 SqlSessionFactory 实例，但最好不要一直保留着它，以保证所有的 XML 解析资源可以被释放给更重要的事情。</p>
<p>SqlSessionFactory<br>SqlSessionFactory 一旦被创建就应该在应用的运行期间一直存在，没有任何理由丢弃它或重新创建另一个实例。因此 SqlSessionFactory 的最佳作用域是应用作用域。可以把 SqlSessionFactory 看作一个资源池，一直都存在，只需要创建 SqlSession 和回收 SqlSession。</p>
<p>SqlSession<br>SqlSession 的实例不是线程安全的，因此是不能被共享的，所以它的最佳的作用域是请求或方法作用域。绝对不能将 SqlSession 实例的引用放在一个类的静态域，甚至一个类的实例变量也不行。可以看作资源池里面的资源，每次用完都要被回收，以便于下次使用。</p>
<h3 id="结果映射-resultMap"><a href="#结果映射-resultMap" class="headerlink" title="结果映射 resultMap"></a>结果映射 resultMap</h3><p>resultMap 元素是 MyBatis 中最重要最强大的元素。它可以让你从 90% 的 JDBC ResultSets 数据提取代码中解放出来，并在一些情形下允许你进行一些 JDBC 不支持的操作</p>
<p>让我们想象一个场景，多个人做一个项目，当做 JavaBean 的人与做数据库的不是同一个人，在起名上有一定的不同，我们无法做到将 JavaBean 或者数据库的字段名修改，这时我们就可以使用 resultMap</p>
<p>例如，我们数据库上有三个字段：”id”,”name”,”pwd”；JavaBean 中有三个参数：”id”,”name”,”password”，这时我们就不能用上面的 <code>resultType</code><br>我们在 mapper 标签里面加上：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;resultMap id=&quot;UserMap&quot; type=&quot;org.example.pojo.User2&quot;&gt;</span><br><span class="line">    &lt;result property=&quot;id&quot; column=&quot;id&quot;/&gt;</span><br><span class="line">    &lt;result property=&quot;name&quot; column=&quot;name&quot;/&gt;</span><br><span class="line">    &lt;result property=&quot;password&quot; column=&quot;pwd&quot;/&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br></pre></td></tr></table></figure>
<p><code>column</code> 是数据库里面的字段名，<code>property</code> 是 JavaBean 里面的参数名，如果参数名和字段名相同时可以省略不写<br>然后把 resultType 修改成 resultMap</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;select id=&quot;getUserById&quot; parameterType=&quot;int&quot; resultMap=&quot;UserMap&quot;&gt;</span><br><span class="line">    select * from mybatis_lean.user where id = #&#123;id&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><h3 id="日志工厂"><a href="#日志工厂" class="headerlink" title="日志工厂"></a>日志工厂</h3><p>日志在我们平时运维或者查找报错中非常实用，我们只需要在日志中查看是哪部分出问题</p>
<p>在官方文档中，我们可以查看到如何开启日志，以及日志的种类<br><img src="/imag%5Cp5.png" class="lazyload" data-srcset="/imag%5Cp5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是图片" title="Magic Gardens"><br>SLF4J<br>LOG4J（3.5.9 起废弃）<br>LOG4J2<br>JDK_LOGGING<br>COMMONS_LOGGING<br>STDOUT_LOGGING<br>NO_LOGGING</p>
<h3 id="STDOUT-LOGGING"><a href="#STDOUT-LOGGING" class="headerlink" title="STDOUT_LOGGING"></a>STDOUT_LOGGING</h3><p>STDOUT_LOGGING 是标准日志输出，不需要再注入其他依赖，直接就能跑起来</p>
<p>在 setting 标签里面配置（注意 setting 的位置）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;setting name=&quot;logImpl&quot; value=&quot;STDOUT_LOGGING&quot;/&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure>
<p>配置好后运行代码<br><img src="/imag%5Cp6.png" class="lazyload" data-srcset="/imag%5Cp6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是图片" title="Magic Gardens"></p>
<h3 id="Log4j"><a href="#Log4j" class="headerlink" title="Log4j"></a>Log4j</h3><p>Log4j 在2021年12月8号被爆出堪称 <strong>史诗级核弹</strong> 漏洞，学习 Log4j 的原因很简单，因为使用的人多，例如 Apache Struts2、Apache Solr、Apache Druid、Apache Flink等，都用了 Log4j 或者 Log4j2</p>
<p>Log4j 是 Apache 的一个开源项目，通过使用 Log4j，我们可以控制日志信息输送的目的地是控制台、文件、GUI组件，我们可以控制每条日志的输出格式；只需要通过一个配置文件就可以灵活的配置，而不需要修改任何代码</p>
<p>第一步，先得导入 Log4j 的依赖<br><a href="https://mvnrepository.com/artifact/log4j/log4j/1.2.17">https://mvnrepository.com/artifact/log4j/log4j/1.2.17</a></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">&lt;!--</span> <span class="string">https://mvnrepository.com/artifact/log4j/log4j --&gt;</span></span><br><span class="line"><span class="attr">&lt;dependency&gt;</span></span><br><span class="line">    <span class="attr">&lt;groupId&gt;log4j&lt;/groupId&gt;</span></span><br><span class="line">    <span class="attr">&lt;artifactId&gt;log4j&lt;/artifactId&gt;</span></span><br><span class="line">    <span class="attr">&lt;version&gt;1.2.17&lt;/version&gt;</span></span><br><span class="line"><span class="attr">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步，创建 Log4j 的配置文件</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">log4j.rootLogger</span>=<span class="string">DEBUG,console,file</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log4j.appender.console</span> = <span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="attr">log4j.appender.console.Target</span> = <span class="string">System.out</span></span><br><span class="line"><span class="attr">log4j.appender.console.Threshold</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="attr">log4j.appender.console.layout</span> = <span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="attr">log4j.appender.console.layout.ConversionPattern</span>=<span class="string">[%c]-%m%n</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log4j.appender.file</span> = <span class="string">org.apache.log4j.RollingFileAppender</span></span><br><span class="line"><span class="attr">log4j.appender.file.File</span>=<span class="string">./log/StudyLog4j.log</span></span><br><span class="line"><span class="attr">log4j.appender.file.MaxFileSize</span>=<span class="string">10mb</span></span><br><span class="line"><span class="attr">log4j.appender.file.Threshold</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="attr">log4j.appender.file.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="attr">log4j.appender.file.layout.ConversionPattern</span>=<span class="string">[%p][%d&#123;yy-MM-dd&#125;][%c]%m%n</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log4j.logger.org.mybatis</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="attr">log4j.logger.java.sql</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="attr">log4j.logger.java.sql.Statement</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="attr">log4j.logger.java.sql.ResultSet</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="attr">log4j.logger.java.sql.PreparedStatement</span>=<span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

<p>第三步，生成 日志对象Logger，参数为当前类的 class 对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> Logger.getLogger(UserMapperTest.class);</span><br></pre></td></tr></table></figure>

<p>第四步，使用 Log4j</p>
<p>三个级别，info、debug 和 error</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">logger.info(<span class="string">&quot;info:测试使用Log4j记录日志&quot;</span>);</span><br><span class="line">logger.debug(<span class="string">&quot;debug:测试使用Log4j记录日志&quot;</span>);</span><br><span class="line">logger.error(<span class="string">&quot;error:测试使用Log4j记录日志&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>结果：<br><img src="/imag%5Cp7.png" class="lazyload" data-srcset="/imag%5Cp7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是图片" title="Magic Gardens"></p>
<h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><h3 id="limit-实现分页"><a href="#limit-实现分页" class="headerlink" title="limit 实现分页"></a>limit 实现分页</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">语法：</span><br><span class="line">select * from 表名 limit startIndex,pageSize;</span><br></pre></td></tr></table></figure>

<p>与之前的一样，在 UserMapper 接口里面声明新方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;User&gt; <span class="title function_">getUserByLimit</span><span class="params">(Map&lt;String, Integer&gt; map)</span>;</span><br></pre></td></tr></table></figure>
<p>然后再 UserMapper.xml 里定义</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserByLimit&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.User&quot;</span>&gt;</span></span><br><span class="line">    select * from mybatis_lean.user limit #&#123;startIndex&#125;,#&#123;pageSize&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最后就可以测试了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MybatisUtils.getSqlSession();</span><br><span class="line"><span class="type">UserMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line"></span><br><span class="line">HashMap&lt;String, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;startIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line">map.put(<span class="string">&quot;pageSize&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">List&lt;User&gt; userByLimit = mapper.getUserByLimit(map);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (User user : userByLimit) &#123;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sqlSession.close();</span><br></pre></td></tr></table></figure>

<h3 id="RowBounds-实现分页"><a href="#RowBounds-实现分页" class="headerlink" title="RowBounds 实现分页"></a>RowBounds 实现分页</h3><p>limit 分页是物理分页，Rowbounds 分页是逻辑分页，Rowbounds 因为要把全部数据都跑一遍，效率比较慢，不推荐使用。</p>
<p>Rowbounds 可以通过 java 代码来实现</p>
<p>第一步，在接口里声明</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;User&gt; <span class="title function_">getUserByRowBounds</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>第二部，在 xml 文件里定义</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserByRowBounds&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.User&quot;</span>&gt;</span></span><br><span class="line">    select * from mybatis_lean.user</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>第三步，使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUserByRowBounds</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MybatisUtils.getSqlSession();</span><br><span class="line"></span><br><span class="line">    <span class="type">RowBounds</span> <span class="variable">rowBounds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RowBounds</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; User = sqlSession.selectList(<span class="string">&quot;org.example.Dao.UserMapper.getUserByRowBounds&quot;</span>,<span class="literal">null</span>,rowBounds);</span><br><span class="line">    <span class="keyword">for</span> (org.example.pojo.User user : User) &#123;</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sqlSession.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个 RowBounds 对象时，两个参数分别为初始索引和长度</p>
<h3 id="插件实现分页"><a href="#插件实现分页" class="headerlink" title="插件实现分页"></a>插件实现分页</h3><p><a href="https://pagehelper.github.io/#:~:text=MyBatis%20%E5%88%86%E9%A1%B5">https://pagehelper.github.io/#:~:text=MyBatis%20%E5%88%86%E9%A1%B5</a><br>我们可以使用第三方插件进行分页，例如：PageHelper，这里不做过多的介绍，用到再了解。</p>
<h2 id="使用注解开发"><a href="#使用注解开发" class="headerlink" title="使用注解开发"></a>使用注解开发</h2><p>ok，前面的配置文件编写已经特别熟练了<br>但是，通通白学，接下来是特别简单，步骤没有这么繁琐的注解开发</p>
<p>我们可以把配置文件删了，只需要一个接口文件，在接口文件里面声明的方法的头上写上注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;select * from user&quot;)</span></span><br><span class="line">List&lt;User&gt; <span class="title function_">getUser</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>然后在类像之前一样里面正常使用，不需要搞配置文件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelect</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MybatisUtils.getSqlSession();</span><br><span class="line"></span><br><span class="line">    <span class="type">UserMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line">    List&lt;User&gt; user = mapper.getUser();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (User user1 : user) &#123;</span><br><span class="line">        System.out.println(user1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sqlSession.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用注解来映射简单语句会使代码显得更加简洁，但对于稍微复杂一点的语句，Java 注解不仅力不从心，还会让你本就复杂的 SQL 语句更加混乱不堪。 因此，如果你需要做一些很复杂的操作，最好用 XML 来映射语句。</p>
<h3 id="用注解开发做增删改查"><a href="#用注解开发做增删改查" class="headerlink" title="用注解开发做增删改查"></a>用注解开发做增删改查</h3><p>只需要变动接口文件 UserMapper ，配置文件 <code>UserMapper.xml</code> 可以删去</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;select * from user&quot;)</span></span><br><span class="line">List&lt;User&gt; <span class="title function_">getUser</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;insert into user values(#&#123;id&#125;,#&#123;name&#125;,#&#123;pwd&#125;)&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;delete from user where id=#&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteUser</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;update user set name=#&#123;name&#125;,pwd=#&#123;pwd&#125; where id=#&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select * from user where id=#&#123;id&#125;&quot;)</span></span><br><span class="line">User <span class="title function_">getUserById</span><span class="params">(<span class="type">int</span> id)</span>;</span><br></pre></td></tr></table></figure>
<p>我们在删除方法 deleteUser 的参数框里写了一个 @Param(“id”) ，当我们使用注解开发时，如果有基本类型参数，尽量在每一个参数前加上 @Param(“”)</p>
<p>以 deleteUser(@Param(“id”) int id) 为例，如果我们把后面的 id 改成其他比如 id2 ，代码正常运行，但如果我们改 @Param(“id”) 改成 为  @Param(“id2”) 则会报错，这时因为我们在SQL中引用的就是 @Param(“”) 中定义的属性名，外面的 id 变成一个形参，形参叫什么都无所谓</p>
<p>如果把 @Select 改成其他，例如 @Update 代码，则需要手动提交<br>或者我们在 MybatisUtils 类里面把</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">openSession里的参数填 <span class="literal">true</span></span><br><span class="line"><span class="keyword">return</span> sqlSessionFactory.openSession(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title function_">getSqlSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.openSession();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="联合查询"><a href="#联合查询" class="headerlink" title="联合查询"></a>联合查询</h2><h3 id="多对一"><a href="#多对一" class="headerlink" title="多对一"></a>多对一</h3><p>假设环境，我们希望查询所有学生的信息，包括学生元素下的老师信息（学生的老师）<br>1、创建表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `teacher` (</span><br><span class="line">  `id` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> teacher(`id`, `name`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;秦老师&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `student` (</span><br><span class="line">  `id` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tid` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `fktid` (`tid`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `fktid` <span class="keyword">FOREIGN</span> KEY (`tid`) <span class="keyword">REFERENCES</span> `teacher` (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8<span class="keyword">INSERT</span> <span class="keyword">INTO</span> `student` (`id`, `name`, `tid`) <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;小明&#x27;</span>, <span class="string">&#x27;1&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student <span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;小红&#x27;</span>, <span class="string">&#x27;1&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student <span class="keyword">VALUES</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;小张&#x27;</span>, <span class="string">&#x27;1&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student <span class="keyword">VALUES</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;小李&#x27;</span>, <span class="string">&#x27;1&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student <span class="keyword">VALUES</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;小王&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>2、创建接口<br>在 Dao 包下创建接口文件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.Dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StudentMapper</span> &#123;</span><br><span class="line">    List&lt;Student&gt; <span class="title function_">getStudent</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>3、配置文件<br>在 resource 下创建一个文件，路径与接口文件路径一致</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;org.example.Dao.StudentMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getStudent&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;StudentTeacher&quot;</span>&gt;</span></span><br><span class="line">        select * from mybatis_lean.student</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;StudentTeacher&quot;</span> <span class="attr">type</span>=<span class="string">&quot;org.example.pojo.Student&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">column</span>=<span class="string">&quot;tid&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;org.example.pojo.Teacher&quot;</span> <span class="attr">select</span>=<span class="string">&quot;getTeacher&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getTeacher&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.Teacher&quot;</span>&gt;</span></span><br><span class="line">        select * from mybatis_lean.teacher where id = #&#123;tid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>resultMap 是用来定义数据库查询结果到Java对象的映射关系<br>如上：<br>在 resultMap 里<code>association</code>的作用是通过 getTeacher 来筛选出老师，然后进行匹配</p>
<p>运行结果：<br><img src="/imag%5Cp8.png" class="lazyload" data-srcset="/imag%5Cp8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是图片" title="Magic Gardens"></p>
<h3 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h3><p>假设环境，我们希望查询所老师的信息，包括老师元素下的学生信息</p>
<h4 id="按照结果嵌套"><a href="#按照结果嵌套" class="headerlink" title="按照结果嵌套"></a>按照结果嵌套</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Teacher&gt; <span class="title function_">getTeachers</span><span class="params">(<span class="meta">@Param(&quot;tid&quot;)</span> <span class="type">int</span> id)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getTeachers&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;TeacherStudent&quot;</span>&gt;</span></span><br><span class="line">    select s.id sid, s.name sname, t.name tname, t.id tid</span><br><span class="line">    from mybatis_lean.student s, mybatis_lean.teacher t</span><br><span class="line">    where s.tid = t.id</span><br><span class="line">    and t.id = #&#123;tid&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;TeacherStudent&quot;</span> <span class="attr">type</span>=<span class="string">&quot;org.example.pojo.Teacher&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;tid&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;tname&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;students&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;org.example.pojo.Student&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sid&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sname&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;tid&quot;</span> <span class="attr">column</span>=<span class="string">&quot;tid&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="按照查询嵌套"><a href="#按照查询嵌套" class="headerlink" title="按照查询嵌套"></a>按照查询嵌套</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getTeachers&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;TeacherStudent&quot;</span>&gt;</span></span><br><span class="line">    select * from mybatis_lean.teacher where id = #&#123;tid&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;TeacherStudent&quot;</span> <span class="attr">type</span>=<span class="string">&quot;org.example.pojo.Teacher&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;students&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;ArrayList&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">ofType</span>=<span class="string">&quot;org.example.pojo.Student&quot;</span> <span class="attr">select</span>=<span class="string">&quot;getStudentByTId&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getStudentByTId&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.Student&quot;</span>&gt;</span></span><br><span class="line">    select * from mybatis_lean.student where id = #&#123;tid&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="动态SQL"><a href="#动态SQL" class="headerlink" title="动态SQL"></a>动态SQL</h2><p>动态SQL是指根据不同条件生成不同的SQL语句</p>
<h3 id="创建环境"><a href="#创建环境" class="headerlink" title="创建环境"></a>创建环境</h3><p>这里主要展示表格和 JavaBean 实体类</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `blog`(</span><br><span class="line">`id` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;博客id&#x27;</span>,</span><br><span class="line">`title` <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;博客标题&#x27;</span>,</span><br><span class="line">`author` <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;博客作者&#x27;</span>,</span><br><span class="line">`create_time` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">`views` <span class="type">INT</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;浏览量&#x27;</span></span><br><span class="line">)ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Blog</span><span class="params">(String id, String title, String author, Date createTime, <span class="type">int</span> views)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.id = id;</span><br><span class="line">    <span class="built_in">this</span>.title = title;</span><br><span class="line">    <span class="built_in">this</span>.author = author;</span><br><span class="line">    <span class="built_in">this</span>.createTime = createTime;</span><br><span class="line">    <span class="built_in">this</span>.views = views;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IF"><a href="#IF" class="headerlink" title="IF"></a>IF</h3><p>假设条件，以上面为例，我们需要用一条 SQL 语句来实现，如果我们传的参数有 title 或者 author ，则返回含有参数的数据，如果参数没有，则返回全部数据</p>
<p>这时候，就体现到动态规划的好处了<br>首先，我们先编写接口方法，我们需要拿一个 map 来装数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Blog&gt; <span class="title function_">queryBlog</span><span class="params">(Map map)</span>;</span><br></pre></td></tr></table></figure>
<p>然后就是最重要的配置文件了</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryBlog&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.Blog&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span> &gt;</span></span><br><span class="line">    select * from mybatis_lean.blog where 1=1</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;title != null&quot;</span>&gt;</span></span><br><span class="line">        and title = #&#123;title&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;author != null&quot;</span>&gt;</span></span><br><span class="line">        and author = #&#123;author&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如上所示，想要完成开头提到的需求，那我们必不可少的需要判断来处理 <code>&lt;if test=&quot;&quot;&gt;</code> 这个当成固定格式就行了，因为那你每次使用 IF 的时候都少不了 <code>test=&quot;&quot;</code><br>test 里面装的就是我们的判断条件了，当然，我们也可以嵌套判断</p>
<p>为什么 where 后面要跟一个 <code>1=1</code> 呢，其实不跟也可以，但是我们需要在每一个 IF 判断里面的开头写上 where 那就显得太麻烦了，加上一个 <code>1=1</code> 也丝毫不会影响原来的语句</p>
<h3 id="where"><a href="#where" class="headerlink" title="where"></a>where</h3><p>或者，我们也可以使用 <code>&lt;where&gt;</code> 标签， <code>&lt;where&gt;</code> 标签可以自动检查后面跟随的子语句前有没有 AND 或者 OR，例如： </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryBlog&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.Blog&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span> &gt;</span></span><br><span class="line">    select * from mybatis_lean.blog where </span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;title != null&quot;</span>&gt;</span></span><br><span class="line">            title = #&#123;title&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;author != null&quot;</span>&gt;</span></span><br><span class="line">            and author = #&#123;author&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如上，最理想的情况是第一个和第二个都满足，程序继续运行，但是，如果只满足第二个而不满足第一个，我们会发现 where 后面直接跟 and ，这怎么看都是错的，我们的 <code>&lt;where&gt;</code> 标签就可以判断后面的子语句前是否有 AND 或 OR ，如果发现及删去，如果 IF 一个都不满足，后面没有跟子语句了， <code>&lt;where&gt;</code> 标签就会把 where 删去</p>
<h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><p><code>set</code> 标签和 <code>where</code> 标签差不多，但是可以每一个条件都满足， <code>set</code> 标签是用于 <code>update</code> 语句里面的，例如：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateBlog&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">    update mybatis_lean.blog</span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;title != null&quot;</span>&gt;</span></span><br><span class="line">            title = #&#123;title&#125;,</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;author != null&quot;</span>&gt;</span></span><br><span class="line">                author = #&#123;author&#125;,</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们需要更新当 <code>id</code> 等于我们所传的 <code>id</code> ，这时我们唯一一个需要确定的条件，标签里面的两个条件 <code>title</code> 和 <code>author</code> 不输入也不会报错<br><code>set</code> 标签主要的功能是如果有子语句，那么将会在最前面加上（或删除） <code>set</code> ，然后在每一个需要子语句加逗号的子语句后面加上（或删除）逗号</p>
<h3 id="choose"><a href="#choose" class="headerlink" title="choose"></a>choose</h3><p>choose 的选择是互斥的，满足了第一个就不会去看后面的判断</p>
<p>choose 与 when 和 otherwise 搭配<br>当 when 条件满足时进入 when 里的子语句，如果有多个 when 都满足条件，只进入第一个，otherwise 是当所有 when 条件都没有满足时则进入，相当于是 Java 里 if 的 else</p>
<p>假设，我们现在需要一个方法，当我们传的参数有 title 并且不为空，则从表格里查找出所在一行；如果没有传 title 而是传了 author ，我们也需要找出 author ；如果都没有传，我们需要把表格所有内容返回</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryBlogChoose&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.Blog&quot;</span>&gt;</span></span><br><span class="line">    select * from mybatis_lean.blog where</span><br><span class="line">    <span class="tag">&lt;<span class="name">choose</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;title != null&quot;</span>&gt;</span></span><br><span class="line">            title = #&#123;title&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;author != null&quot;</span>&gt;</span></span><br><span class="line">            author = #&#123;author&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">otherwise</span>&gt;</span></span><br><span class="line">            1=1</span><br><span class="line">        <span class="tag">&lt;/<span class="name">otherwise</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">choose</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="sql"><a href="#sql" class="headerlink" title="sql"></a>sql</h3><p>上面的配置文件里面，我们会发现有很多地方的有杂糅，每个标签里面都有相同的地方，为了减少代码杂糅，我们可以使用 <code>sql</code> 标签，把相同的地方提出来<br>以上面为例，我们会发现 <code>if</code> 标签里面的 <code>title</code> 和 <code>author</code> ，我们使用的频率很大，那么我们就可以使用 <code>sql</code> 标签提出来 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;if-title-author&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;title != null&quot;</span>&gt;</span></span><br><span class="line">        title = #&#123;title&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;author != null&quot;</span>&gt;</span></span><br><span class="line">        and author = #&#123;author&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>提取后需要用 <code>include</code> 标签来使用</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryBlog&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.Blog&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span> &gt;</span></span><br><span class="line">    select * from mybatis_lean.blog</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;if-title-author&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h3><p>动态 SQL 的另一个常见使用场景是对集合进行遍历（尤其是在构建 IN 条件语句的时候）<br><img src="/%5Cimag%5Cp10.png" class="lazyload" data-srcset="/%5Cimag%5Cp10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="替代文字" title="可选的标题"></p>
<p>案例：我们现在需要一个方法，需要返回我们传的 ID 所对应的信息</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryBlogById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;org.example.pojo.Blog&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">    select * from mybatis_lean.blog</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;or&quot;</span>&gt;</span></span><br><span class="line">            id = #&#123;id&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>mybatis 为了提高数据库性能和减少数据压力提供一级缓存和二级缓存</p>
<h3 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a>一级缓存</h3><p>一级缓存是 SqlSession 级别的缓存，作用域是同一个 SqlSession ，在同一个 sqlSession 中连续两次执行相同的sql语句，第一次执行完毕会将数据写到缓存，第二次会从缓存中获取数据将不再从数据库查询，从而提高查询效率。当一个sqlSession结束后该sqlSession中的一级缓存也就不存在了。</p>
<p>Mybatis默认开启一级缓存</p>
<p>一级缓存只是相对于同一个 SqlSession 而言。所以在参数和 SQL 完全一样的情况下，我们使用同一个 SqlSession 对象调用一个 Mapper 方法，往往只执行一次 SQL ，因为使用 SelSession 第一次查询后，MyBatis会将其放在缓存中，以后再查询的时候，如果没有声明需要刷新，并且缓存没有超时的情况下，SqlSession都会取出当前缓存的数据，而不会再次发送SQL到数据库。</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 通过ID来查询</span></span><br><span class="line">User <span class="title function_">selectById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">int</span> id)</span>;</span><br><span class="line"><span class="comment">// 更新数据</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">updateUser</span><span class="params">(User user)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MybatisUtils.getSqlSession();</span><br><span class="line"></span><br><span class="line"><span class="type">UserMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> mapper.selectById(<span class="number">1</span>);</span><br><span class="line">System.out.println(user);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;==============================&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> mapper.selectById(<span class="number">1</span>);</span><br><span class="line">System.out.println(user2);</span><br><span class="line"></span><br><span class="line">sqlSession.close();</span><br></pre></td></tr></table></figure>
<p><img src="/%5Cimag%5Cp11.png" class="lazyload" data-srcset="/%5Cimag%5Cp11.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="替代文字" title="可选的标题"><br>我们会发现，明明查询语句跑了两遍，但日志里面却只跑了一边，第二次进行查询语句的时候并没有想第一次一样在数据库中查找，而是第一次跑完的记录存在缓存里面，第二次直接在缓存里面读取</p>
<p>样例二：<br>我们在两次查询语句中插入一条修改语句，缓存是否还能够使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MybatisUtils.getSqlSession();</span><br><span class="line"></span><br><span class="line"><span class="type">UserMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> mapper.selectById(<span class="number">1</span>);</span><br><span class="line">System.out.println(user);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;==============================&quot;</span>);</span><br><span class="line"></span><br><span class="line">mapper.updateUser(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">5</span>, <span class="string">&quot;Lily&quot;</span>, <span class="string">&quot;202020&quot;</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;==============================&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> mapper.selectById(<span class="number">1</span>);</span><br><span class="line">System.out.println(user2);</span><br><span class="line"></span><br><span class="line">sqlSession.close();</span><br></pre></td></tr></table></figure>
<p>运行结果：<br><img src="/%5Cimag%5Cp12.png" class="lazyload" data-srcset="/%5Cimag%5Cp12.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="替代文字" title="可选的标题"></p>
<p>通过日志我们可得知，三条语句都进入了数据库中查找</p>
<h3 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h3><p>二级缓存也叫全局缓存，二级缓存是基于 namespace ，一个命名空间对应着一个二级缓存<br>开启二级缓存后，释放完一个 sqlsession 后，一级缓存将会存入二级缓存内，重新开启一个相同 mapper 将会读取二级缓存 </p>
<p>1、开启全局缓存</p>
<p>在 mybatis-config.xml 下的 setting 标签内加入</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;cacheEnabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、在 Mapper 文件里面开启</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span> <span class="attr">eviction</span>=<span class="string">&quot;FIFO&quot;</span> <span class="attr">flushInterval</span>=<span class="string">&quot;60000&quot;</span> <span class="attr">size</span>=<span class="string">&quot;512&quot;</span> <span class="attr">readOnly</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>注：FIFO (first in first out)</p>
]]></content>
  </entry>
  <entry>
    <title>SpringFramework学习笔记</title>
    <url>/2024/12/20/articles/Spring/SpringLeaning/</url>
    <content><![CDATA[<h2 id="所需基本依赖"><a href="#所需基本依赖" class="headerlink" title="所需基本依赖"></a>所需基本依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="配置文件注册bean"><a href="#配置文件注册bean" class="headerlink" title="配置文件注册bean"></a>配置文件注册bean</h1><h2 id="配置文件基础模板"><a href="#配置文件基础模板" class="headerlink" title="配置文件基础模板"></a>配置文件基础模板</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans  </span></span></span><br><span class="line"><span class="string"><span class="tag">       https://www.springframework.org/schema/beans/spring-beans.xsd       http://www.springframework.org/schema/context       https://www.springframework.org/schema/context/spring-context.xsd       http://www.springframework.org/schema/aop       https://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用配置文件注册一个bean最简单的方式，参数为 null</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.HelloWorld&quot;</span>/&gt;</span>  </span><br></pre></td></tr></table></figure>
</li>
<li><p>如果 bean 需要传入参数，并且希望是通过有参构造来创建</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.HelloWorld&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;message&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Hello World!&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果bean需要传入参数，并且希望是通过无参构造来创建</p>
</li>
<li><p>property 里的参数同上</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.HelloWorld&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;message&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Hello World!&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="关于配置文件注册bean"><a href="#关于配置文件注册bean" class="headerlink" title="关于配置文件注册bean"></a>关于配置文件注册bean</h2><ul>
<li>赋值的原理是通过类中的set注入</li>
<li>id 相当于一个变量名，class 是类文件路径来源，还可以加个 name 作为 别名，注意 &#x3D;&#x3D;id 开头小写&#x3D;&#x3D;</li>
<li>有参构造和无参构造中的 name 是参数名， value 是默认传入的值</li>
<li>&#x3D;&#x3D;constructor-arg通过有参构造创建，创建对象的同时赋值&#x3D;&#x3D;  </li>
<li>&#x3D;&#x3D;property通过无参构造创建，创建对象后，再通过set方法赋值&#x3D;&#x3D;</li>
</ul>
<h2 id="导入其他配置文件里的内容"><a href="#导入其他配置文件里的内容" class="headerlink" title="导入其他配置文件里的内容"></a>导入其他配置文件里的内容</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;其他Spring配置文件.xml&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>导入的配置文件和本身共有注册 bean，优先用自己的</p>
<h2 id="赋值方法"><a href="#赋值方法" class="headerlink" title="赋值方法"></a>赋值方法</h2><h3 id="1、下标赋值"><a href="#1、下标赋值" class="headerlink" title="1、下标赋值"></a>1、下标赋值</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.HelloWorld&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Hello World!&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2、通过类型赋值"><a href="#2、通过类型赋值" class="headerlink" title="2、通过类型赋值"></a>2、通过类型赋值</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.HelloWorld&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Hello World!&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>缺陷：</p>
<h3 id="3、通过参数名赋值"><a href="#3、通过参数名赋值" class="headerlink" title="3、通过参数名赋值"></a>3、通过参数名赋值</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.HelloWorld&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;message&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Hello World!&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="获取bean"><a href="#获取bean" class="headerlink" title="获取bean"></a>获取bean</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;Spring配置文件.xml&quot;</span>);</span><br><span class="line">类 变量名 = context.getBean(<span class="string">&quot;beanID&quot;</span>, 类.class);</span><br></pre></td></tr></table></figure>

<h1 id="Autowired"><a href="#Autowired" class="headerlink" title="Autowired"></a>Autowired</h1><p>自动装填<br>@Autowired 先判断byType，再判断byName</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">People</span> &#123;  </span><br><span class="line">    <span class="comment">// 等价于@Nullable，对象可以为null  </span></span><br><span class="line">    <span class="meta">@Autowired(required = false)</span>  </span><br><span class="line">    <span class="keyword">private</span> Cat cat;  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="comment">// @Autowired 先判断byType，再判断byName  </span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;dog&quot;)</span>  </span><br><span class="line">    <span class="comment">// 如果自动装配的环境比较复杂，无法通过一个@Autowired完成时，就要使用@Qualifer(value = &quot;***&quot;)指定bean名  </span></span><br><span class="line">    <span class="keyword">private</span> Dog dog;  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="按照原本的配置方式"><a href="#按照原本的配置方式" class="headerlink" title="按照原本的配置方式"></a>按照原本的配置方式</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;people&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.People&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cat&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;cat&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dog&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dog&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;呵帅&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="使用Autowired自动装配"><a href="#使用Autowired自动装配" class="headerlink" title="使用Autowired自动装配"></a>使用Autowired自动装配</h2><h3 id="开启注解的支持"><a href="#开启注解的支持" class="headerlink" title="开启注解的支持"></a>开启注解的支持</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="注册bean"><a href="#注册bean" class="headerlink" title="注册bean"></a>注册bean</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;people&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.People&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byName&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;呵帅&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们使用完Autowired自动装配后，就可以不在配置文件里面配置参数对象<br>但是有几点需要注意：</p>
<ul>
<li>byName:按照属性名自动装配，和对象中set注入方法中的属性名一致  </li>
<li>byType:按照属性类型自动装配，和对象中的set方法里的属性类型一致</li>
<li>使用byType必须保证类型全局唯一，否则会报错  </li>
<li>使用byName必须保证属性名全局唯一，否则会报错</li>
</ul>
<h3 id="修改自动装配方式"><a href="#修改自动装配方式" class="headerlink" title="修改自动装配方式"></a>修改自动装配方式</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;people&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.People&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byName&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;呵帅&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>把 autowire 里面的参数修改成 byName 或者 byType 即可，默认为 byType</p>
<h1 id="依赖注入DI（Dependecy-Injection）"><a href="#依赖注入DI（Dependecy-Injection）" class="headerlink" title="依赖注入DI（Dependecy Injection）"></a>依赖注入DI（Dependecy Injection）</h1><ul>
<li><strong>依赖注入是从应用程序的角度在描述，应用程序依赖容器创建并注入它所需要的外部资源</strong></li>
</ul>
<h2 id="注入方式"><a href="#注入方式" class="headerlink" title="注入方式"></a>注入方式</h2><ul>
<li><p>**第一种，普通值注入，value</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;John&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**第二种，引用注入，ref</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;address&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;address&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**第三种，数组注入，array</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;friends&quot;</span> &gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Jane<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Tom<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Mary<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**第四种，键值对，map</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cards&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;身份证&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456789012345678&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;银行卡&quot;</span> <span class="attr">value</span>=<span class="string">&quot;987654321098765432&quot;</span>/&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;信用卡&quot;</span> <span class="attr">value</span>=<span class="string">&quot;54444&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**第五种，list注入，list</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;courses&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>Java<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>Python<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>C++<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>**第六种，set注入，set</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;interests&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>篮球<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>足球<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>乒乓球<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><h3 id="P-命名空间"><a href="#P-命名空间" class="headerlink" title="P 命名空间"></a>P 命名空间</h3><ul>
<li>**spring中的p命名空间就是为了更加方便的使用set方法注入属性内容，可以直接注入属性值，property</li>
<li>首先我们需要引入对应这个p命名空间的xml约束<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>举个例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按照我们原来的写法应该是这么写</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;User&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.User&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;呵帅&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>改用P命名空间后是这样</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.User&quot;</span> <span class="attr">p:name</span>=<span class="string">&quot;呵帅&quot;</span> <span class="attr">p:age</span>=<span class="string">&quot;18&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;singleton&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>设置代理模式：scope，默认scope是singleton单例模式</li>
<li>单例模式只允许创建一个实例，后续通过id获取的都是同一个实例</li>
<li>原型模式prototype，允许创建多个实例，每次获取都是新的实例</li>
</ul>
<h3 id="C-命名空间"><a href="#C-命名空间" class="headerlink" title="C 命名空间"></a>C 命名空间</h3><ul>
<li><p>**spring中的c命名空间就是为了更加方便的使用有参构造方法注入，通过构造器注入，constructor-arg</p>
</li>
<li><p>c命名空间注入，通过构造器注入，constructor-arg</p>
</li>
<li><p>首先我们需要引入对应这个p命名空间的xml约束</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">xmlns:c=&quot;http://www.springframework.org/schema/c&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>**通过使用名称的方式</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.User&quot;</span> <span class="attr">c:name</span>=<span class="string">&quot;呵帅2&quot;</span> <span class="attr">c:age</span>=<span class="string">&quot;18&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**通过使用索引的方式</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.pojo.User&quot;</span> <span class="attr">c:_0</span>=<span class="string">&quot;呵帅2&quot;</span> <span class="attr">c:_1</span>=<span class="string">&quot;18&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="mybatis"><a href="#mybatis" class="headerlink" title="mybatis"></a>mybatis</h1><ul>
<li>DataSource：使用Spring的数据源代替mybatis的配置 c3p0 dbcp druid这是使用Spring提供的JDBC：org.springframework.jdbc.datasourceDataSource</li>
<li>使用Spring的数据源代替mybatis的配置 c3p0 dbcp druid这是使用Spring提供的JDBC：org.springframework.jdbc.datasource</li>
</ul>
<h2 id="添加maven"><a href="#添加maven" class="headerlink" title="添加maven"></a>添加maven</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.13.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--Spring操作数据库还需要一个spring-jdbc的依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.13.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.mybatis/mybatis-spring --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.36<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置文件mybatis"><a href="#配置文件mybatis" class="headerlink" title="配置文件mybatis"></a>配置文件mybatis</h2><p>需要使用的文件<br><img src="/p-1.png" class="lazyload" data-srcset="/p-1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans  </span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd        http://www.springframework.org/schema/aop        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!--DataSource：使用Spring的数据源代替mybatis的配置 c3p0 dbcp druid    这是使用Spring提供的JDBC：org.springframework.jdbc.datasource  </span></span><br><span class="line"><span class="comment">    --&gt;</span>    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis_lean&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Abc123&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--sqlSessionFactory--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--绑定mybatis配置文件--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapperLocations&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:org/example/mapper/*.xml&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--SqlSessionTemplate：就是我们之前使用的sqlSession   Template：模板--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSession&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--只能使用构造器注入，这是因为没有set方法--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>resource&#x2F;applicationContext.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans  </span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd        http://www.springframework.org/schema/aop        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;spring-dao.xml&quot;</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userMapper&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.mapper.UserMapperImpl&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSession&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlSession&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userMapper2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.mapper.UserMapperImpl2&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>org&#x2F;example&#x2F;mapper&#x2F;UserMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span>  </span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>  </span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;org.example.mapper.UserMapper&quot;</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectUser&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;user&quot;</span>&gt;</span>  </span><br><span class="line">        SELECT * FROM mybatis_lean.user;  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;addUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;user&quot;</span>&gt;</span>  </span><br><span class="line">        insert into mybatis_lean.user (id, name, pwd) values (#&#123;id&#125;, #&#123;name&#125;, #&#123;pwd&#125;);  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span>&gt;</span>  </span><br><span class="line">        delete from mybatis_lean.user where id = #&#123;id&#125;;  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="注解开发mybatis"><a href="#注解开发mybatis" class="headerlink" title="注解开发mybatis"></a>注解开发mybatis</h2><p>需要使用的文件</p>
<p><img src="/p-2.png" class="lazyload" data-srcset="/p-2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>可以清晰的看出，少了很多不必要的文件</p>
<p>用类 MyConfiguration.class 文件代替配置文件 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.pooled.PooledDataSource;  </span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;  </span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@ComponentScan(&quot;org.example.service&quot;)</span>  </span><br><span class="line"><span class="meta">@MapperScan(&quot;org.example.mapper&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfiguration</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PooledDataSource</span>(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>, <span class="string">&quot;jdbc:mysql://localhost:3306/mybatis_lean&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;Abc123&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactoryBean <span class="title function_">sqlSessionFactoryBean</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();  </span><br><span class="line">        bean.setDataSource(dataSource());  </span><br><span class="line">        <span class="keyword">return</span> bean;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mapper 层接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.mapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;  </span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;  </span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;  </span><br><span class="line"><span class="keyword">import</span> org.example.User;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;  </span><br><span class="line">    <span class="meta">@Select(&quot;select * from user&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">selectUser</span><span class="params">()</span>;  </span><br><span class="line">    <span class="meta">@Insert(&quot;insert into user(id, name, pwd) VALUES(#&#123;id&#125;, #&#123;name&#125;, #&#123;pwd&#125;)&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addUser</span><span class="params">(User user)</span>;  </span><br><span class="line">    <span class="meta">@Delete(&quot;delete from user where id=#&#123;id&#125;&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteUser</span><span class="params">(<span class="type">int</span> id)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service 层接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.service;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.example.User;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">selectUser</span><span class="params">()</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addUser</span><span class="params">(User user)</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteUser</span><span class="params">(<span class="type">int</span> id)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service 层实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.service;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.example.User;  </span><br><span class="line"><span class="keyword">import</span> org.example.mapper.UserMapper;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    UserMapper mapper;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">selectUser</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> mapper.selectUser();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addUser</span><span class="params">(User user)</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> mapper.addUser(user);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteUser</span><span class="params">(<span class="type">int</span> id)</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> mapper.deleteUser(id);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><p>简单来说就是就是在运行期间加些事件进去</p>
<h2 id="方式一：使用原生的Spring-API接口"><a href="#方式一：使用原生的Spring-API接口" class="headerlink" title="方式一：使用原生的Spring API接口"></a>方式一：使用原生的Spring API接口</h2><ul>
<li>**配置aop：需要导入aop的命名空间</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--配置切入点  expression：表达式，execution(要执行的位置 修饰词 返回值，列名 方法名 参数)--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pointcut&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* org.example.service..userServiceImpl.*(..))&quot;</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!--执行环绕增强--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--相当于将log这个类切入到pointcut上--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;log&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;afterLog&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>实现 AfterReturningAdvice</p>
<ul>
<li>在方法执行后运行<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.Log;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.AfterReturningAdvice;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AfterLog</span> <span class="keyword">implements</span> <span class="title class_">AfterReturningAdvice</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterReturning</span><span class="params">(Object returnValue, Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;执行力&quot;</span> + method.getName() + <span class="string">&quot;方法后，返回值为：&quot;</span> + returnValue);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>实现 MethodBeforeAdvice</p>
<ul>
<li>在方法执行前运行<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.Log;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.MethodBeforeAdvice;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">log</span> <span class="keyword">implements</span> <span class="title class_">MethodBeforeAdvice</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="comment">// method：要执行的目标对象的方法  </span></span><br><span class="line">    <span class="comment">// args：目标对象方法的参数  </span></span><br><span class="line">    <span class="comment">// target：目标对象  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable &#123;  </span><br><span class="line">        System.out.println(target.getClass().getName() + <span class="string">&quot;的&quot;</span> + method.getName() + <span class="string">&quot;被执行了&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="方式二：自定义类"><a href="#方式二：自定义类" class="headerlink" title="方式二：自定义类"></a>方式二：自定义类</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;diy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.example.diy.DiyPointCut&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--自定义切面，ref 要引用的类--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;diy&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--切入点--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pointcut&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* org.example.service.userServiceImpl.*(..))&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!--通知--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">&quot;before&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">&quot;after&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自定义的类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.diy;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiyPointCut</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;==========方法执行前===========&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;==========方法执行后===========&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="方式三：使用注解开发"><a href="#方式三：使用注解开发" class="headerlink" title="方式三：使用注解开发"></a>方式三：使用注解开发</h2><ul>
<li>开启注解支持  JDK（默认 expose-proxy&#x3D;”false”）  cglib（expose-proxy&#x3D;”true”）</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">expose-proxy</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.diy;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;  </span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;  </span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;  </span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;  </span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//使用注解方式实现AOP  </span></span><br><span class="line">  </span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">// 标注这个类是一个切面  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationPointCut</span> &#123;  </span><br><span class="line">    <span class="meta">@Before(&quot;execution(* org.example.service.userServiceImpl.*(..))&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;====方法执行前====&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@After(&quot;execution(* org.example.service.userServiceImpl.*(..))&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;====方法执行后====&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Around(&quot;execution(* org.example.service.userServiceImpl.*(..))&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">around</span><span class="params">(ProceedingJoinPoint pj)</span> <span class="keyword">throws</span> Throwable &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;方法执行前&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 执行方法  </span></span><br><span class="line">        pj.proceed();  </span><br><span class="line">  </span><br><span class="line">        System.out.println(<span class="string">&quot;方法执行后&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调用运行"><a href="#调用运行" class="headerlink" title="调用运行"></a>调用运行</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.example.service.userService;  </span><br><span class="line"><span class="keyword">import</span> org.example.service.userServiceImpl;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;applicationContext.xml&quot;</span>);  </span><br><span class="line">        <span class="comment">//动态代理代理的是接口  </span></span><br><span class="line">        <span class="type">userService</span> <span class="variable">userService</span> <span class="operator">=</span> context.getBean(<span class="string">&quot;userService&quot;</span>, userService.class);  </span><br><span class="line">  </span><br><span class="line">        userService.add();  </span><br><span class="line">        userService.select();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>SpringBoot学习笔记</title>
    <url>/2025/01/25/articles/SpringBoot/SpringBoot/</url>
    <content><![CDATA[<h1 id="体验SpringBoot"><a href="#体验SpringBoot" class="headerlink" title="体验SpringBoot"></a>体验SpringBoot</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>所有的SpringBoot依赖都是以starter的形式命名的，之后我们需要导入其他模块也是导入 <code>spring boot-starter-xxxx</code> 这种名称格式的依赖。</p>
<p>SpringBoot为我们提供了包含内置Tomcat服务器的Web模块，我们只需要导入依赖就能直接运行服务器<br>把原来的</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>换成</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/SpringBoot/p1.png" class="lazyload" data-srcset="/SpringBoot/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br>点击启动后可以看到已经启动了内置的 tomcat</p>
<p>在浏览器上打开 <code>localhost:8080</code> 可以访问<br><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br>可以看到成功响应了404页面，相比之前的大量配置，可以说方便了很多，我们到目前为止仅仅是导入了一个依赖，就可以做到直接启动我们的Web服务器并正常访问</p>
<p>SpringBoot支持自动包妇描，我们不需要编写任何配置，直接在任意路径(但是不能跑到主类所在包外面去了)下创建的组件(如Controller、Service、Component、Configuration等)都可以生效</p>
<p>比如创建一个Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@ResponseBody</span>  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们不需要扫描，直接启动<br><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>包括一个对象现在也可以直接以JSON形式返回给客户端，无需任何配置，如果启动不成功或者页面没有显示，请检查Lombok是否有正确启动（我用的时候就是没有找到构造方法和getter&#x2F;setter，推测原因是Lombok）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@ResponseBody</span>  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">index</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="number">1</span>, <span class="string">&quot;呵帅&quot;</span>, <span class="string">&quot;男&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="常用模块整合"><a href="#常用模块整合" class="headerlink" title="常用模块整合"></a>常用模块整合</h2><p>spring-boot-starter-web包含了以下依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>里面包含了以下内容</p>
<ul>
<li>spring-boot-starter 基础依赖starter</li>
<li>spring-boot-starter-json 配置JSON转换的starter</li>
<li>spring-boot-starter-tomcat 内置Tomcat服务器</li>
<li>spring-web、spring-webmvc 之前mvc的内容</li>
</ul>
<p>如果需要像之前一样添加WebMvc配置类，方法是一样的，直接创建</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//只需要添加Configuration用于注册配置类，不需要其他任何注解，已经自动配置好了  </span></span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfiguration</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;  </span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">HandlerInterceptor</span>() &#123;  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">                System.out.println(<span class="string">&quot;请求被拦截&quot;</span>);  </span><br><span class="line">                <span class="keyword">return</span> HandlerInterceptor.<span class="built_in">super</span>.preHandle(request, response, handler);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样security也是一样的，首先添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>导入完依赖直接启动<br><img src="/p5.png" class="lazyload" data-srcset="/p5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>我们没有进行任何配置，而是对应的Starter帮助我们完成了默认的配置，并且在启动时，就已经帮助我们配置了一个随机密码的用户可以直接登录使用（Username是user）<br><img src="/SpringBoot/p6.png" class="lazyload" data-srcset="/SpringBoot/p6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>如果需要额外进行配置，只需要添加配置类即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.SecurityFilterChain;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="keyword">return</span> http  </span><br><span class="line">                .authorizeHttpRequests(auth -&gt; &#123;  </span><br><span class="line">                    auth.anyRequest().authenticated();  </span><br><span class="line">                &#125;)  </span><br><span class="line">                .formLogin(conf -&gt; &#123;  </span><br><span class="line">                    conf.loginPage(<span class="string">&quot;/login&quot;</span>);  </span><br><span class="line">                    conf.loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>);  </span><br><span class="line">                    conf.defaultSuccessUrl(<span class="string">&quot;/&quot;</span>);  </span><br><span class="line">                    conf.permitAll();  </span><br><span class="line">                &#125;)  </span><br><span class="line">                .build();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的，我们也可以快速整合之前使用的模版引擎，比如Thymeleaf框架，直接上对应的Starter即可</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="自定义运行器"><a href="#自定义运行器" class="headerlink" title="自定义运行器"></a>自定义运行器</h2><p>在项目中，可能会遇到这样一个问题:我们需要在项目启动完成之后，紧接着执行一段代码，我们可以编写自定义的ApplicationRunner，会在项目启动完成后执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestRunner</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;自定义执行&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然也可以使用CommandLineRunner，它也支持使用@Order或是实现Ordered接口来支持优先级执行</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>虽然SpringBoot快捷开发确实很方便，不过我们发现有些东西还是需要我们自己来编写配置才可以，不然SpringBoot项目无法正常启动。我们可以直接在application.properties 中进行配置编写，它是整个SpringBoot的配置文件，比如要修改服务器的默认端口:</p>
<p><img src="/p7.png" class="lazyload" data-srcset="/p7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>这些配置其实都是各种Starter提供的，部分配置在Starter中具有默认值，我们即使不配置也会使用默认值，比如这里的8080就是我们服务器的默认端口，我们也可以手动修改它，来变成我们需要的。</p>
<p>除了配置已经存在的选项，我们也可以添加自定义的配置，来方便我们程序中使用，比如我们这里创建一个测试数据:</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">test.hello</span>=<span class="string">8080</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.hello&#125;&quot;)</span>  </span><br><span class="line">    String hello;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/login&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(hello);  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件除了使用 <code>properties</code> 格式以外，还有一种叫做 <code>yaml</code> 格式，它的语法如下</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">一级目录:</span></span><br><span class="line">	<span class="string">二级目录:</span></span><br><span class="line">		<span class="string">三级目录1:值</span></span><br><span class="line">		<span class="string">三级目录2:值</span></span><br><span class="line">		<span class="string">三级目录List:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">元素1</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">元素2</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">元素3</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到，每一级目录都是通过缩进(不能使用Tab，只能使用空格)区分，并且键和值之间需要添加冒号+空格来表示</p>
<p>例如:</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span>  </span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span>  </span><br><span class="line"><span class="attr">Spring:</span>  </span><br><span class="line">  <span class="attr">datasource:</span>  </span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test</span>  </span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span>  </span><br><span class="line">    <span class="attr">password:</span> <span class="string">Abc123</span>  </span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<p>注意如果你的数据库密码是以0开头或者0x开头会被默认转义为八进制和十六进制,要用引号把密码引起来</p>
<h3 id="常见的配置项"><a href="#常见的配置项" class="headerlink" title="常见的配置项"></a>常见的配置项</h3><p>SpringSecurity和SpringBootMvc配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="comment"># Spring Mvc相关配置  </span></span><br><span class="line">  <span class="attr">mvc:</span>  </span><br><span class="line">    <span class="attr">static-path-pattern:</span> <span class="string">/static/**</span>  <span class="comment"># 静态资源访问路径  </span></span><br><span class="line">  <span class="comment"># Spring Security相关配置  </span></span><br><span class="line">  <span class="attr">security:</span>  </span><br><span class="line">    <span class="attr">filter:</span>  </span><br><span class="line">      <span class="attr">order:</span> <span class="number">-100</span>  <span class="comment"># 过滤优先级，数字越小优先级越高  </span></span><br><span class="line">    <span class="attr">user:</span>  </span><br><span class="line">      <span class="attr">name:</span> <span class="string">&#x27;admin&#x27;</span>  <span class="comment"># 登录用户名  </span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&#x27;123456&#x27;</span>  <span class="comment"># 登录密码  </span></span><br><span class="line">      <span class="attr">roles:</span>   <span class="comment"># 登录用户角色  </span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">admin</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="string">user</span></span><br></pre></td></tr></table></figure>

<h2 id="mybatis"><a href="#mybatis" class="headerlink" title="mybatis"></a>mybatis</h2><p>整合Mybatis需要把本身的驱动加上</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span>  </span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span>  </span><br><span class="line"><span class="attr">Spring:</span>  </span><br><span class="line">  <span class="attr">datasource:</span>  </span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test</span>  </span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span>  </span><br><span class="line">    <span class="attr">password:</span> <span class="string">Abc123</span>  </span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<p>这里我们接续来测试一下MyBatis的配置，想要在SpringBoot中使用Mybatis也很简单，不需要进行任何配置，我们直接编写Mapper即可<br>直接为需要注册为Mapper的接口添加 @Mapper 注解，来表示这个接口作为Mapper使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;  </span><br><span class="line">    <span class="meta">@Select(&quot;select * from test where id = #&#123;id&#125;&quot;)</span>  </span><br><span class="line">    User <span class="title function_">findUserById</span><span class="params">(<span class="type">int</span> id)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Resource</span>  </span><br><span class="line">UserMapper mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResponseBody</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">test</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> mapper.findUserById(<span class="number">1</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：<strong>如果运行失败，检查是否是maven依赖版本不兼容</strong></p>
<h2 id="打包运行"><a href="#打包运行" class="headerlink" title="打包运行"></a>打包运行</h2><p>我们可以使用maven工具</p>
<p><img src="/p8.png" class="lazyload" data-srcset="/p8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>然后在当前目录下的命令行中输入：<code>java -jar 包名.jar</code></p>
<h3 id="GraalVM"><a href="#GraalVM" class="headerlink" title="GraalVM"></a>GraalVM</h3><p>我们SpringBoot项目除了打包为传统的Jar包基于JVM运行之外，我们也可以将其直接编译为操作系统原生的程序来进行使用(这样会大幅提升程序的运行效率，但是由于编译为操作系统原生程序，这将无法支持跨平台)</p>
<p>具体内容：<a href="https://zhuanlan.zhihu.com/p/106555993">十分钟带你了解 Oracle 最新的 JVM 技術——GraalVM - 知乎</a></p>
<p><strong>还未广泛运用，了解为主</strong></p>
<h2 id="日志系统"><a href="#日志系统" class="headerlink" title="日志系统"></a>日志系统</h2><p>我们在之前学习SSM时，如果不配置日志，就会报错，但是到了SpringBoot阶段之后日志打印得也非常统一，不会出现这个问题</p>
<h3 id="日志门面和日志实现"><a href="#日志门面和日志实现" class="headerlink" title="日志门面和日志实现"></a>日志门面和日志实现</h3><p>日志门面，如Slf4j，是把不同的日志系统的实现进行了具体的抽象化，只提供了统一的日志使用接口，使用时只需要按照其提供的接口方法进行调用即可，由于它只是一个接口，并不是一个具体的可以直接单独使用的日志框架，所以最终日志的格式、记录级别、输出方式等都要通过接口绑定的具体的日志系统来实现，这些具体的日志系统就有lqg4j、logback、java.util.logging等，它们才实现了具体的日志系统的功能。<br>日志门面和日志实现就像JDBC和数据库驱动一样，一个是画大饼的，一个是真的去做饼的。</p>
<p>SpringBoot为了统一日志框架的使用，做了这些事情</p>
<ul>
<li>直接将其他依赖以前的日志框架剔除</li>
<li>导入对应日志框架的Slf4i中间包</li>
<li>导入自己官方指定的日志实现，并作为Slf4j的日志实现层</li>
</ul>
<p>日志级别从低到高分为TRACE&lt;DEBUG&lt;INFO&lt;WARN&lt;ERROR&lt;FATAL， SpringBoot默认只会打印INFO以上级别的信息</p>
<p>如果想要输出日志信息像之前JUL一样就行了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span>  </span><br><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;  </span><br><span class="line"><span class="meta">@PostConstruct</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;  </span><br><span class="line">        log.info(<span class="string">&quot;日志信息&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置-logback日志"><a href="#配置-logback日志" class="headerlink" title="配置 logback日志"></a>配置 logback日志</h3><p>和JUL一样，Logback也能实现定制化，我们可以编写对应的配置文件，SpringBoot推荐将配置文件名称命名为表示这是SpringBoot下Logback专用的配置，可以使用SpringBoot 的高级Profile功能，它的内容类似于这样:<code>logback-spring.xml</code></p>
<p>最外层由 configuration 包裹，一旦编写，那么就会替换默认的配置，所以如果内部什么都不写的话，那么会导致我们的SpringBoot项目没有配置任何日志输出方式，控制台也不会打印日志。<br>在org&#x2F;springframework&#x2F;boot&#x2F;logging&#x2F;logback&#x2F;defaults.xml 中已经帮我们把日志的输出格式定义好了，我们只需要设置对应的appender 即可:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--  导入其他配置文件，作为预设  --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">&quot;org/springframework/boot/logging/logback/defaults.xml&quot;</span> /&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE_LOG_PATTERN&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%clr(%d&#123;$&#123;LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd&#125;&#125;)&#123;faint&#125; %clr([%X&#123;reqId&#125;])&#123;faint&#125; %clr($&#123;LOG_LEVEL_PATTERN:-%5p&#125;)&#123;&#125; %clr($&#123;PID:-&#125;)&#123;magenta&#125; %clr(--- %esb()&#123;APPLICATION_NAME&#125;%esb&#123;APPLICATION_GROUP&#125;[%15.15t] $&#123;LOG_CORRELATION_PATTERN:-&#125;)&#123;faint&#125;%clr(%-40.40logger&#123;39&#125;)&#123;cyan&#125; %clr(:)&#123;faint&#125; %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&quot;</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!--  Appender作为日志打印器配置，这里命名随意  --&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--  ch.qos.logback.core.ConsoleAppender是专用于控制台的Appender  --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span>            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;CONSOLE_LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>$&#123;CONSOLE_LOG_CHARSET&#125;<span class="tag">&lt;/<span class="name">charset</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span>    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--  ch.qos.logback.core.rolling.RollingFileAppender用于文件日志记录，它支持滚动  --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span>            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;FILE_LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>$&#123;FILE_LOG_CHARSET&#125;<span class="tag">&lt;/<span class="name">charset</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span>        <span class="comment">&lt;!--  自定义滚动策略，防止日志文件无限变大，也就是日志文件写到什么时候为止，重新创建一个新的日志文件开始写  --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;</span>&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!--  文件保存位置以及文件命名规则，这里用到了%d&#123;yyyy-MM-dd&#125;表示当前日期，%i表示这一天的第N个日志  --&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>log/%d&#123;yyyy-MM-dd&#125;-spring-%i.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!--  到期自动清理日志文件  --&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">cleanHistoryOnStart</span>&gt;</span>true<span class="tag">&lt;/<span class="name">cleanHistoryOnStart</span>&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!--  最大日志保留时间  --&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>7<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!--  最大单个日志文件大小  --&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span>    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--  指定日志输出级别，以及启用的Appender，这里就使用了我们上面的ConsoleAppender  --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置完，运行就会生成一个日志文件</p>
<p>比如我们现在需要记录是哪个用户访问我们网站的日志，只要是此用户访问我们网站，都会在日志中携带该用户的ID，我们希望每条日志中都携带这样一段信息文本，而官方提供的字段无法实现此功能，这时就需要使用MDC机制“Mapped Diagnostic Context”（映射诊断上下文）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span>  </span><br><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span>  </span><br><span class="line">    <span class="meta">@ResponseBody</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(HttpSession session)</span> &#123;  </span><br><span class="line">        MDC.put(<span class="string">&quot;reqId&quot;</span>, session.getId());  </span><br><span class="line">        log.info(<span class="string">&quot;访问了一次测试接口&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义Banner展示"><a href="#自定义Banner展示" class="headerlink" title="自定义Banner展示"></a>自定义Banner展示</h3><p>可以直接来配置文件所在目录下创建一个名为<code>banner.txt</code>的文本文档，内容随便</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">$&#123;AnsiColor.yellow&#125;  </span><br><span class="line">//                          _ooOoo_                               //  </span><br><span class="line">//                         o8888888o                              //  </span><br><span class="line">//                         88&quot; . &quot;88                              //  </span><br><span class="line">//                         (| ^_^ |)                              //  </span><br><span class="line">//                         O\  =  /O                              //  </span><br><span class="line">//                      ____/`---&#x27;\____                           //  </span><br><span class="line">//                    .&#x27;  \\|     |//  `.                         //  </span><br><span class="line">//                   /  \\|||  :  |||//  \                        //  </span><br><span class="line">//                  /  _||||| -:- |||||-  \                       //  </span><br><span class="line">//                  |   | \\\  -  /// |   |                       //  </span><br><span class="line">//                  | \_|  &#x27;&#x27;\---/&#x27;&#x27;  |   |                       //  </span><br><span class="line">//                  \  .-\__  `-`  ___/-. /                       //  </span><br><span class="line">//                ___`. .&#x27;  /--.--\  `. . ___                     //  </span><br><span class="line">//              .&quot;&quot; &#x27;&lt;  `.___\_&lt;|&gt;_/___.&#x27;  &gt;&#x27;&quot;&quot;.                  //  </span><br><span class="line">//            | | :  `- \`.;`\ _ /`;.`/ - ` : | |                 //  </span><br><span class="line">//            \  \ `-.   \_ __\ /__ _/   .-` /  /                 //  </span><br><span class="line">//      ========`-.____`-.___\_____/___.-`____.-&#x27;========         //  </span><br><span class="line">//                           `=---=&#x27;                              //  </span><br><span class="line">//      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^        //  </span><br><span class="line">//             佛祖保佑          永无BUG         永不修改             //  </span><br><span class="line">$&#123;AnsiColor.black&#125;</span><br></pre></td></tr></table></figure>

<p>可以使用在线生成网站进行生成自己的个性Banner：<a href="https://www.bootschool.net/ascii">https://www.bootschool.net/ascii</a></p>
<p>切换颜色</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">$&#123;AnsiColor.BRIGHT_GREEN&#125; //绿色</span><br></pre></td></tr></table></figure>

<p>常用配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">$&#123;AnsiColor.YELLOW&#125; 当前 Spring Boot 版本：$&#123;spring-boot.version&#125;</span><br></pre></td></tr></table></figure>

<h2 id="多环境配置"><a href="#多环境配置" class="headerlink" title="多环境配置"></a>多环境配置</h2><p>在日常开发中，我们项目会有多个环境。不同的环境下，可能我们的配置文件也存在不同，但是我们不可能切换环境的时候又去重新写一次配置文件，所以我们可以将多个环境的配置文件提前写好，进行自由切换。</p>
<p>SpringBoot给我们提供了一种方式，在 <code>application.yml</code>下，我们可以通过配置文件指定</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p>我们分别创建两个环境的配置文件，<code>application-dev.yml</code>和<code>application-prod.yml</code>分别表示开发环境和生产环境的配置文件，比如开发环境我们使用的服务器端口为8080，而生产环境下可能就需要设置为80或是443端口，那么这个时候就需要不同环境下的配置文件进行区分：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server: port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server: port:</span> <span class="number">8888</span></span><br></pre></td></tr></table></figure>

<p>SpringBoot自带的Logback日志系统也是支持多环境配置的，比如我们想在开发环境下输出日志到控制台，而生产环境下只需要输出到文件即可，这时就需要进行环境配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">&quot;dev&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">&quot;prod&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们希望生产环境中不要打包开发环境下的配置文件呢，打包的问题就只能找Maven解决了，Maven也可以设置多环境：<br>在 <code>pom.xml</code> 中 project 里任意位置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--分别设置开发，生产环境--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 开发环境 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">environment</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 生产环境 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>prod<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>false<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">environment</span>&gt;</span>prod<span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>pom.xml</code> 中的 build 中</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--排除配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--先排除所有的配置文件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--使用通配符，当然可以定义多个exclude标签进行排除--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>application*.yml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--根据激活条件引入打包所需的配置和文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--引入所需环境的配置文件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>application.yml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--根据maven选择环境导入配置文件--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>application-$&#123;environment&#125;.yml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接着，我们可以直接将Maven中的<code>environment</code>属性，传递给SpringBoot的配置文件，在构建时替换为对应的值：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">&#x27;@environment@&#x27;</span>  <span class="comment">#注意YAML配置文件需要加单引号，否则会报错</span></span><br></pre></td></tr></table></figure>

<p><strong>注意切换环境之后要重新加载一下Maven项目，不然不会生效！</strong></p>
<h2 id="常用框架"><a href="#常用框架" class="headerlink" title="常用框架"></a>常用框架</h2><h3 id="邮件发送模块"><a href="#邮件发送模块" class="headerlink" title="邮件发送模块"></a>邮件发送模块</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>比较常用的协议有两种：</p>
<ol>
<li>SMTP协议（主要用于发送邮件 Simple Mail Transfer Protocol）</li>
<li>POP3协议（主要用于接收邮件 Post Office Protocol 3）</li>
</ol>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="attr">mail:</span>  </span><br><span class="line">    <span class="attr">host:</span> <span class="string">去百度搜索该邮箱的smtp</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">邮箱</span>  </span><br><span class="line">    <span class="attr">password:</span> <span class="string">密码（并非账号的密码）</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span>  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Demo1ApplicationTests</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    JavaMailSender sender;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="comment">//SimpleMailMessage是一个比较简易的邮件封装，支持设置一些比较简单内容  </span></span><br><span class="line">        <span class="type">SimpleMailMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleMailMessage</span>();  </span><br><span class="line">        <span class="comment">//设置邮件标题  </span></span><br><span class="line">        message.setSubject(<span class="string">&quot;【广东白云学院教务处】关于近期学校对您的处分决定&quot;</span>);  </span><br><span class="line">        <span class="comment">//设置邮件内容  </span></span><br><span class="line">        message.setText(<span class="string">&quot;同学您好，完美校园数据显示您在本学期以来在本校食堂消费超过503次，积累消费金额超过3000元，您已被评为“校园大饭桶”，特此通知予以嘉奖。奖品将在3月1日西校区一品堂门口发放，感谢您对学校餐厅工作的支持！&quot;</span>);  </span><br><span class="line">        <span class="comment">//设置邮件发送给谁，可以多个，这里就发给你的QQ邮箱  </span></span><br><span class="line">        message.setTo(<span class="string">&quot;邮箱@qq.com&quot;</span>);  </span><br><span class="line">        <span class="comment">//邮件发送者，这里要与配置文件中的保持一致  </span></span><br><span class="line">        message.setFrom(<span class="string">&quot;发送的邮箱@qq.cn&quot;</span>);  </span><br><span class="line">          </span><br><span class="line">        sender.send(message);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要添加附件等更多功能，可以使用MimeMessageHelper来帮助我们完成</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> <span class="keyword">throws</span> MessagingException &#123;</span><br><span class="line">      <span class="comment">//创建一个MimeMessage</span></span><br><span class="line">    <span class="type">MimeMessage</span> <span class="variable">message</span> <span class="operator">=</span> sender.createMimeMessage();</span><br><span class="line">      <span class="comment">//使用MimeMessageHelper来帮我们修改MimeMessage中的信息</span></span><br><span class="line">    <span class="type">MimeMessageHelper</span> <span class="variable">helper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessageHelper</span>(message, <span class="literal">true</span>);</span><br><span class="line">    helper.setSubject(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">    helper.setText(<span class="string">&quot;lbwnb&quot;</span>);</span><br><span class="line">    helper.setTo(<span class="string">&quot;你的QQ号@qq.com&quot;</span>);</span><br><span class="line">    helper.setFrom(<span class="string">&quot;发送的邮箱@163.com&quot;</span>);</span><br><span class="line">      <span class="comment">//发送修改好的MimeMessage</span></span><br><span class="line">    sender.send(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="接口规则校验"><a href="#接口规则校验" class="headerlink" title="接口规则校验"></a>接口规则校验</h3><p><strong>所需依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如下面代码所示，我们要将接收到的字符串作切割，但是如果接收的字符串长度不满足切割条件时，或者说用户没有按照我们所设想来传参，那么就会直接报错</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/submit&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">submit</span><span class="params">(String username,</span></span><br><span class="line"><span class="params">                     String password)</span>&#123;</span><br><span class="line">    System.out.println(username.substring(<span class="number">3</span>));</span><br><span class="line">    System.out.println(password.substring(<span class="number">2</span>, <span class="number">10</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;请求成功!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是最简单的解决方法是做个判断：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/submit&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">submit</span><span class="params">(String username,</span></span><br><span class="line"><span class="params">                     String password)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(username.length() &gt; <span class="number">3</span> &amp;&amp; password.length() &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        System.out.println(username.substring(<span class="number">3</span>));</span><br><span class="line">        System.out.println(password.substring(<span class="number">2</span>, <span class="number">10</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;请求成功!&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;请求失败&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然这样就能直接解决问题，但是如果我们的每一个接口都需要这样去进行配置就太麻烦了，Springboot 为我们提供了很方便的接口校验框架，我们可以使用注解开发完成全部接口的校验：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Validated</span>   <span class="comment">//首先在Controller上开启接口校验</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/submit&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">submit</span><span class="params">(<span class="meta">@Length(min = 3)</span> String username,  //使用<span class="meta">@Length</span>注解一步到位</span></span><br><span class="line"><span class="params">                         <span class="meta">@Length(min = 10)</span> String password)</span>&#123;</span><br><span class="line">        System.out.println(username.substring(<span class="number">3</span>));</span><br><span class="line">        System.out.println(password.substring(<span class="number">2</span>, <span class="number">10</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;请求成功!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过这样依然会抛出一个异常，我们可以稍微处理一下，这里我们可以直接使用之前在SSM阶段中学习的异常处理Controller来自行处理这类异常：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidationController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(ConstraintViolationException.class)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">error</span><span class="params">(ValidationException e)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();   <span class="comment">//出现异常直接返回消息</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>验证注解</th>
<th>验证的数据类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@AssertFalse</td>
<td>Boolean,boolean</td>
<td>值必须是false</td>
</tr>
<tr>
<td>@AssertTrue</td>
<td>Boolean,boolean</td>
<td>值必须是true</td>
</tr>
<tr>
<td>@NotNull</td>
<td>任意类型</td>
<td>值不能是null</td>
</tr>
<tr>
<td>@Null</td>
<td>任意类型</td>
<td>值必须是null</td>
</tr>
<tr>
<td>@Min</td>
<td>BigDecimal、BigInteger、byte、short、int、long、double 以及任何Number或CharSequence子类型</td>
<td>大于等于@Min指定的值</td>
</tr>
<tr>
<td>@Max</td>
<td>同上</td>
<td>小于等于@Max指定的值</td>
</tr>
<tr>
<td>@DecimalMin</td>
<td>同上</td>
<td>大于等于@DecimalMin指定的值（超高精度）</td>
</tr>
<tr>
<td>@DecimalMax</td>
<td>同上</td>
<td>小于等于@DecimalMax指定的值（超高精度）</td>
</tr>
<tr>
<td>@Digits</td>
<td>同上</td>
<td>限制整数位数和小数位数上限</td>
</tr>
<tr>
<td>@Size</td>
<td>字符串、Collection、Map、数组等</td>
<td>长度在指定区间之内，如字符串长度、集合大小等</td>
</tr>
<tr>
<td>@Past</td>
<td>如 java.util.Date, java.util.Calendar 等日期类型</td>
<td>值必须比当前时间早</td>
</tr>
<tr>
<td>@Future</td>
<td>同上</td>
<td>值必须比当前时间晚</td>
</tr>
<tr>
<td>@NotBlank</td>
<td>CharSequence及其子类</td>
<td>值不为空，在比较时会去除字符串的首位空格</td>
</tr>
<tr>
<td>@Length</td>
<td>CharSequence及其子类</td>
<td>字符串长度在指定区间内</td>
</tr>
<tr>
<td>@NotEmpty</td>
<td>CharSequence及其子类、Collection、Map、数组</td>
<td>值不为null且长度不为空（字符串长度不为0，集合大小不为0）</td>
</tr>
<tr>
<td>@Range</td>
<td>BigDecimal、BigInteger、CharSequence、byte、short、int、long 以及原子类型和包装类型</td>
<td>值在指定区间内</td>
</tr>
<tr>
<td>@Email</td>
<td>CharSequence及其子类</td>
<td>值必须是邮件格式</td>
</tr>
<tr>
<td>@Pattern</td>
<td>CharSequence及其子类</td>
<td>值需要与指定的正则表达式匹配</td>
</tr>
<tr>
<td>@Valid</td>
<td>任何非原子类型</td>
<td>用于验证对象属性</td>
</tr>
</tbody></table>
<p>此时接口是以对象形式接收前端发送的表单数据的，这个时候就没办法向上面一样编写对应的校验规则了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="meta">@Length(min = 3)</span>   <span class="comment">//只需要在对应的字段上添加校验的注解即可</span></span><br><span class="line">    String username;</span><br><span class="line">    <span class="meta">@Length(min = 10)</span></span><br><span class="line">    String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/submit&quot;)</span>  <span class="comment">//在参数上添加@Valid注解表示需要验证</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">submit</span><span class="params">(<span class="meta">@Valid</span> Account account)</span>&#123;</span><br><span class="line">    System.out.println(account.getUsername().substring(<span class="number">3</span>));</span><br><span class="line">    System.out.println(account.getPassword().substring(<span class="number">2</span>, <span class="number">10</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;请求成功!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后修改之前的错误处理，对于实体类接收参数的验证，会抛出<code>MethodArgumentNotValidException </code>异常也加进去</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@ExceptionHandler(&#123;ConstraintViolationException.class, MethodArgumentNotValidException.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">error</span><span class="params">(Exception e)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(e <span class="keyword">instanceof</span> ConstraintViolationException exception) &#123;</span><br><span class="line">        <span class="keyword">return</span> exception.getMessage();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> MethodArgumentNotValidException exception)&#123;</span><br><span class="line">        <span class="keyword">if</span> (exception.getFieldError() == <span class="literal">null</span>) <span class="keyword">return</span> <span class="string">&quot;未知错误&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> exception.getFieldError().getDefaultMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;未知错误&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="接口文档生成（肥肠豪用）"><a href="#接口文档生成（肥肠豪用）" class="headerlink" title="接口文档生成（肥肠豪用）"></a>接口文档生成（肥肠豪用）</h3><p><strong>所需依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springdoc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springdoc-openapi-starter-webmvc-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Swagger的主要功能如下：</p>
<ul>
<li>支持 API 自动生成同步的在线文档：使用 Swagger 后可以直接通过代码生成文档，不再需要自己手动编写接口文档了，对程序员来说非常方便，可以节约写文档的时间去学习新技术。</li>
<li>提供 Web 页面在线测试 API：光有文档还不够，Swagger 生成的文档还支持在线测试。参数和格式都定好了，直接在界面上输入参数对应的值即可在线测试接口。</li>
</ul>
<p>结合Spring框架（Spring-doc，官网：<code>https://springdoc.org/</code><br>Swagger可以很轻松地利用注解以及扫描机制，来快速生成在线文档，以实现当我们项目启动之后，前端开发人员就可以打开Swagger提供的前端页面，查看和测试接口。</p>
<p>项目启动之后，我们可以直接访问：<code>http://localhost:8080/swagger-ui/index.html</code> 就可以看到开发文档了</p>
<p>修改Swagger的UI界面</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OpenAPI <span class="title function_">springDocOpenAPI</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OpenAPI</span>().info(<span class="keyword">new</span> <span class="title class_">Info</span>()</span><br><span class="line">                .title(<span class="string">&quot;图书管理系统 - 在线API接口文档&quot;</span>)   <span class="comment">//设置API文档网站标题</span></span><br><span class="line">                .description(<span class="string">&quot;这是一个图书管理系统的后端API文档，欢迎前端人员查阅！&quot;</span>) <span class="comment">//网站介绍</span></span><br><span class="line">                .version(<span class="string">&quot;2.0&quot;</span>)   <span class="comment">//当前API版本</span></span><br><span class="line">                .license(<span class="keyword">new</span> <span class="title class_">License</span>().name(<span class="string">&quot;我的B站个人主页&quot;</span>)  <span class="comment">//遵循的协议，这里拿来写其他的也行</span></span><br><span class="line">                        .url(<span class="string">&quot;https://space.bilibili.com/288205652&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为Controller编写API描述信息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//使用@Tag注解来添加Controller描述信息</span></span><br><span class="line"><span class="meta">@Tag(name = &quot;账户验证相关&quot;, description = &quot;包括用户登录、注册、验证码请求等操作。&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以直接在类名称上面添加<code>@Tag</code>注解，并填写相关信息，来为当前的Controller设置描述信息。接着我们可以为所有的请求映射配置描述信息：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiResponses(&#123;</span></span><br><span class="line"><span class="meta">       @ApiResponse(responseCode = &quot;200&quot;, description = &quot;测试成功&quot;),</span></span><br><span class="line"><span class="meta">       @ApiResponse(responseCode = &quot;500&quot;, description = &quot;测试失败&quot;)   //不同返回状态码描述</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@Operation(summary = &quot;请求用户数据测试接口&quot;)</span>   <span class="comment">//接口功能描述</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="comment">//请求参数描述和样例</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@Parameter(description = &quot;测试文本数据&quot;, example = &quot;KFCvivo50&quot;)</span> <span class="meta">@RequestParam</span> String text)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于那些不需要展示在文档中的接口，我们也可以将其忽略掉：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Hidden</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于实体类，我们也可以编写对应的API接口文档：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Schema(description = &quot;用户信息实体类&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Schema(description = &quot;用户编号&quot;)</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="meta">@Schema(description = &quot;用户名称&quot;)</span></span><br><span class="line">    String name;</span><br><span class="line">    <span class="meta">@Schema(description = &quot;用户邮箱&quot;)</span></span><br><span class="line">    String email;</span><br><span class="line">    <span class="meta">@Schema(description = &quot;用户密码&quot;)</span></span><br><span class="line">    String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过，这种文档只适合在开发环境下生成，如果是生产环境，我们需要关闭文档：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">springdoc:</span><br><span class="line">  api-docs:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>


<h1 id="数据交互"><a href="#数据交互" class="headerlink" title="数据交互"></a>数据交互</h1><h2 id="JDBC交互框架"><a href="#JDBC交互框架" class="headerlink" title="JDBC交互框架"></a>JDBC交互框架</h2><p>所需依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="attr">datasource:</span>  </span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test</span>  </span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span>  </span><br><span class="line">    <span class="attr">password:</span> <span class="string">Abc123</span>  </span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<p>spring-jdbc 把所有的增删改查都加入到一个模板类里，并且已经注册好了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Resource</span>  </span><br><span class="line">JdbcTemplate template;</span><br></pre></td></tr></table></figure>

<p>通过 template 调用已经封装好的方法，现在我们可以只写 SQL 语句了，相当于省略掉了 mapper</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    Map&lt;String, Object&gt; map = template.queryForMap(<span class="string">&quot;select * from user where id = ?&quot;</span>, id);</span><br><span class="line">    System.out.println(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以自定义</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    String name;</span><br><span class="line">    String email;</span><br><span class="line">    String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> template.queryForObject(<span class="string">&quot;select * from user where id = ?&quot;</span>,</span><br><span class="line">        (r, i) -&gt; <span class="keyword">new</span> <span class="title class_">User</span>(r.getInt(<span class="number">1</span>), r.getString(<span class="number">2</span>), r.getString(<span class="number">3</span>), r.getString(<span class="number">4</span>)), <span class="number">1</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="简单封装"><a href="#简单封装" class="headerlink" title="简单封装"></a>简单封装</h3><p>对于一些插入操作，Spring JDBC为我们提供了更方便的SimpleJdbcInsert工具，比如我们的表是采用自增的ID，那么它支持插入后返回自动生成的ID</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    DataSource source;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">      	<span class="comment">//这个类需要自己创建对象</span></span><br><span class="line">        <span class="type">SimpleJdbcInsert</span> <span class="variable">simple</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleJdbcInsert</span>(source)</span><br><span class="line">                .withTableName(<span class="string">&quot;user&quot;</span>)   <span class="comment">//设置要操作的表名称</span></span><br><span class="line">                .usingGeneratedKeyColumns(<span class="string">&quot;id&quot;</span>);    <span class="comment">//设置自增主键列</span></span><br><span class="line">        Map&lt;String, Object&gt; user = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);  <span class="comment">//插入操作需要传入一个Map作为数据</span></span><br><span class="line">        user.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;bob&quot;</span>);</span><br><span class="line">        user.put(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;112233@qq.com&quot;</span>);</span><br><span class="line">        user.put(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="type">Number</span> <span class="variable">number</span> <span class="operator">=</span> simple.executeAndReturnKey(user);   <span class="comment">//最后得到的Numver就是得到的自增主键</span></span><br><span class="line">        System.out.println(number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="JPA框架"><a href="#JPA框架" class="headerlink" title="JPA框架"></a>JPA框架</h2><p>官网：<a href="https://spring.io/projects/spring-data-jpa">https://spring.io/projects/spring-data-jpa</a></p>
<p>而实现JPA规范的框架一般最常用的就是<code>Hibernate</code></p>
<p>所需依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用JPA快速上手"><a href="#使用JPA快速上手" class="headerlink" title="使用JPA快速上手"></a>使用JPA快速上手</h3><p>我们通过注解形式，在属性上添加数据库映射关系</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span>   <span class="comment">//表示这个类是一个实体类</span></span><br><span class="line"><span class="meta">@Table(name = &quot;account&quot;)</span>    <span class="comment">//对应的数据库中表名称</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>   <span class="comment">//生成策略，这里配置为自增</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;)</span>    <span class="comment">//对应表中id这一列</span></span><br><span class="line">    <span class="meta">@Id</span>     <span class="comment">//此属性为主键</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;username&quot;)</span>   <span class="comment">//对应表中username这一列</span></span><br><span class="line">    String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;password&quot;)</span>   <span class="comment">//对应表中password这一列</span></span><br><span class="line">    String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改配置文件，把日志打印打开</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="comment">#开启SQL语句执行日志信息</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="comment">#配置为检查数据库表结构，没有时会自动创建</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">update</span></span><br></pre></td></tr></table></figure>

<p><code>ddl-auto</code>属性用于设置自动表定义，可以实现自动在数据库中为我们创建一个表，表的结构会根据我们定义的实体类决定，它有以下几种：</p>
<ul>
<li><code>none</code>: 不执行任何操作，数据库表结构需要手动创建。</li>
<li><code>create</code>: 框架在每次运行时都会删除所有表，并重新创建。</li>
<li><code>create-drop</code>: 框架在每次运行时都会删除所有表，然后再创建，但在程序结束时会再次删除所有表。</li>
<li><code>update</code>: 框架会检查数据库表结构，如果与实体类定义不匹配，则会做相应的修改，以保持它们的一致性。</li>
<li><code>validate</code>: 框架会检查数据库表结构与实体类定义是否匹配，如果不匹配，则会抛出异常。</li>
</ul>
<p>创建一个Repository接口来继承 <code>JpaRepository</code> 泛型，第一个参数是实体类，第二个是主键的类型 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Account, Integer&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接调用方法即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line">AccountRepository repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Account</span> <span class="variable">account</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>();</span><br><span class="line">    account.setUsername(<span class="string">&quot;小红&quot;</span>);</span><br><span class="line">    account.setPassword(<span class="string">&quot;1234567&quot;</span>);</span><br><span class="line">    System.out.println(repository.save(account).getId());   <span class="comment">//使用save来快速插入数据，并且会返回插入的对象，如果存在自增ID，对象的自增id属性会自动被赋值，这就很方便了</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="方法名称拼接自定义SQL"><a href="#方法名称拼接自定义SQL" class="headerlink" title="方法名称拼接自定义SQL"></a>方法名称拼接自定义SQL</h3><p>超级帅，只需要在我们创建 <code>AccountRepository</code> 上通过方法名称的拼接来实现条件判断</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>方法名称示例</th>
<th>执行的语句</th>
</tr>
</thead>
<tbody><tr>
<td>Distinct</td>
<td>findDistinctByLastnameAndFirstname</td>
<td><code>select distinct … where x.lastname = ?1 and x.firstname = ?2</code></td>
</tr>
<tr>
<td>And</td>
<td>findByLastnameAndFirstname</td>
<td><code>… where x.lastname = ?1 and x.firstname = ?2</code></td>
</tr>
<tr>
<td>Or</td>
<td>findByLastnameOrFirstname</td>
<td><code>… where x.lastname = ?1 or x.firstname = ?2</code></td>
</tr>
<tr>
<td>Is，Equals</td>
<td>findByFirstname, findByFirstnameIs, findByFirstnameEquals</td>
<td><code>… where x.firstname = ?1</code></td>
</tr>
<tr>
<td>Between</td>
<td>findByStartDateBetween</td>
<td><code>… where x.startDate between ?1 and ?2</code></td>
</tr>
<tr>
<td>LessThan</td>
<td>findByAgeLessThan</td>
<td><code>… where x.age &lt; ?1</code></td>
</tr>
<tr>
<td>LessThanEqual</td>
<td>findByAgeLessThanEqual</td>
<td><code>… where x.age &lt;= ?1</code></td>
</tr>
<tr>
<td>GreaterThan</td>
<td>findByAgeGreaterThan</td>
<td><code>… where x.age &gt; ?1</code></td>
</tr>
<tr>
<td>GreaterThanEqual</td>
<td>findByAgeGreaterThanEqual</td>
<td><code>… where x.age &gt;= ?1</code></td>
</tr>
<tr>
<td>After</td>
<td>findByStartDateAfter</td>
<td><code>… where x.startDate &gt; ?1</code></td>
</tr>
<tr>
<td>Before</td>
<td>findByStartDateBefore</td>
<td><code>… where x.startDate &lt; ?1</code></td>
</tr>
<tr>
<td>IsNull，Null</td>
<td>findByAge(Is)Null</td>
<td><code>… where x.age is null</code></td>
</tr>
<tr>
<td>IsNotNull，NotNull</td>
<td>findByAge(Is)NotNull</td>
<td><code>… where x.age not null</code></td>
</tr>
<tr>
<td>Like</td>
<td>findByFirstnameLike</td>
<td><code>… where x.firstname like ?1</code></td>
</tr>
<tr>
<td>NotLike</td>
<td>findByFirstnameNotLike</td>
<td><code>… where x.firstname not like ?1</code></td>
</tr>
<tr>
<td>StartingWith</td>
<td>findByFirstnameStartingWith</td>
<td><code>… where x.firstname like ?1（参数与附加%绑定）</code></td>
</tr>
<tr>
<td>EndingWith</td>
<td>findByFirstnameEndingWith</td>
<td><code>… where x.firstname like ?1（参数与前缀%绑定）</code></td>
</tr>
<tr>
<td>Containing</td>
<td>findByFirstnameContaining</td>
<td><code>… where x.firstname like ?1（参数绑定以%包装）</code></td>
</tr>
<tr>
<td>OrderBy</td>
<td>findByAgeOrderByLastnameDesc</td>
<td><code>… where x.age = ?1 order by x.lastname desc</code></td>
</tr>
<tr>
<td>Not</td>
<td>findByLastnameNot</td>
<td><code>… where x.lastname &lt;&gt; ?1</code></td>
</tr>
<tr>
<td>In</td>
<td>findByAgeIn(Collection<Age> ages)</td>
<td><code>… where x.age in ?1</code></td>
</tr>
<tr>
<td>NotIn</td>
<td>findByAgeNotIn(Collection<Age> ages)</td>
<td><code>… where x.age not in ?1</code></td>
</tr>
<tr>
<td>True</td>
<td>findByActiveTrue</td>
<td><code>… where x.active = true</code></td>
</tr>
<tr>
<td>False</td>
<td>findByActiveFalse</td>
<td><code>… where x.active = false</code></td>
</tr>
<tr>
<td>IgnoreCase</td>
<td>findByFirstnameIgnoreCase</td>
<td><code>… where UPPER(x.firstname) = UPPER(?1)</code></td>
</tr>
</tbody></table>
<p>比如我们想要实现根据用户名模糊匹配查找用户、根据大于这个ID并且降序查询、通过用户名和ID查询、判断数据库中是否存在某个ID的用户：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Account, Integer&gt; &#123;</span><br><span class="line">    Account <span class="title function_">findAccountByUsernameLike</span><span class="params">(String str)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;Account&gt; <span class="title function_">findAccountsByIdGreaterThanOrderByIdDesc</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    Account <span class="title function_">findAccountByUsernameAndId</span><span class="params">(String username, <span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">existsAccountById</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Demo2ApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    AccountRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(repository.findAccountByUsernameLike(<span class="string">&quot;%es%&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">        System.out.println(repository.findAccountsByIdGreaterThanOrderByIdDesc(<span class="number">0</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">        System.out.println(repository.findAccountByUsernameAndId(<span class="string">&quot;test&quot;</span>, <span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">        System.out.println(repository.existsAccountById(<span class="number">1</span>));</span><br><span class="line">        System.out.println(repository.existsAccountById(<span class="number">10</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意自定义条件操作的方法名称一定要遵循规则，不然会出现异常：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Caused by: org.springframework.data.repository.query.QueryCreationException: Could not create query <span class="keyword">for</span> public abstract  ...</span><br></pre></td></tr></table></figure>

<h3 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h3><h4 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;users_detail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountDetail</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;)</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;address&quot;)</span></span><br><span class="line">    String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;email&quot;)</span></span><br><span class="line">    String email;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;phone&quot;)</span></span><br><span class="line">    String phone;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;real_name&quot;)</span></span><br><span class="line">    String realName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;)</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;username&quot;)</span></span><br><span class="line">    String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;password&quot;)</span></span><br><span class="line">    String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;detail_id&quot;)</span>   <span class="comment">//指定存储外键的字段名称</span></span><br><span class="line">    <span class="meta">@OneToOne</span>    <span class="comment">//声明为一对一关系</span></span><br><span class="line">    AccountDetail detail;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>添加数据时，利用实体类之间的关联信息，一次性添加两张表的数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JoinColumn(name = &quot;detail_id&quot;)</span></span><br><span class="line"><span class="meta">@OneToOne(fetch = FetchType.LAZY, cascade = CascadeType.ALL)</span> <span class="comment">//设置关联操作为ALL</span></span><br><span class="line">AccountDetail detail;</span><br></pre></td></tr></table></figure>

<ul>
<li>ALL：所有操作都进行关联操作</li>
<li>PERSIST：插入操作时才进行关联操作</li>
<li>REMOVE：删除操作时才进行关联操作</li>
<li>MERGE：修改操作时才进行关联操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">addAccount</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Account</span> <span class="variable">account</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>();</span><br><span class="line">    account.setUsername(<span class="string">&quot;Nike&quot;</span>);</span><br><span class="line">    account.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">    <span class="type">AccountDetail</span> <span class="variable">detail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccountDetail</span>();</span><br><span class="line">    detail.setAddress(<span class="string">&quot;翻斗大街&quot;</span>);</span><br><span class="line">    detail.setPhone(<span class="string">&quot;1234567890&quot;</span>);</span><br><span class="line">    detail.setEmail(<span class="string">&quot;123456@qq.com&quot;</span>);</span><br><span class="line">    detail.setRealName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">  	account.setDetail(detail);</span><br><span class="line">    account = repository.save(account);</span><br><span class="line">    System.out.println(<span class="string">&quot;插入时，自动生成的主键ID为：&quot;</span>+account.getId()+<span class="string">&quot;，外键ID为：&quot;</span>+account.getDetail().getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;users_score&quot;)</span>   <span class="comment">//成绩表，注意只存成绩，不存学科信息，学科信息id做外键</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Score</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;)</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToOne</span>   <span class="comment">//一对一对应到学科上</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;cid&quot;)</span></span><br><span class="line">    Subject subject;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;socre&quot;)</span></span><br><span class="line">    <span class="type">double</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;uid&quot;)</span></span><br><span class="line">    <span class="type">int</span> uid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;subjects&quot;)</span>   <span class="comment">//学科信息表</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Subject</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;cid&quot;)</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="type">int</span> cid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;name&quot;)</span></span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;teacher&quot;)</span></span><br><span class="line">    String teacher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;time&quot;)</span></span><br><span class="line">    <span class="type">int</span> time;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;account&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;)</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;username&quot;)</span></span><br><span class="line">    String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;password&quot;)</span></span><br><span class="line">    String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToOne(fetch = FetchType.LAZY, cascade = CascadeType.ALL)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;detail_id&quot;)</span></span><br><span class="line">    AccountDetail detail;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;uid&quot;)</span>  <span class="comment">//注意这里的name指的是Score表中的uid字段对应的就是当前的主键，会将uid外键设置为当前的主键</span></span><br><span class="line">    <span class="meta">@OneToMany(fetch = FetchType.LAZY, cascade = CascadeType.REMOVE)</span>   <span class="comment">//在移除Account时，一并移除所有的成绩信息，依然使用懒加载</span></span><br><span class="line">    List&lt;Score&gt; scoreList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ManyToMany(fetch = FetchType.LAZY)</span>   <span class="comment">//多对多场景</span></span><br><span class="line"><span class="meta">@JoinTable(name = &quot;teach_relation&quot;,     //多对多中间关联表</span></span><br><span class="line"><span class="meta">        joinColumns = @JoinColumn(name = &quot;cid&quot;),    //当前实体主键在关联表中的字段名称</span></span><br><span class="line"><span class="meta">        inverseJoinColumns = @JoinColumn(name = &quot;tid&quot;)   //教师实体主键在关联表中的字段名称</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line">List&lt;Teacher&gt; teacher;</span><br></pre></td></tr></table></figure>

<h3 id="JPQL自定义SQL语句"><a href="#JPQL自定义SQL语句" class="headerlink" title="JPQL自定义SQL语句"></a>JPQL自定义SQL语句</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Account, Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>    <span class="comment">//DML操作需要事务环境，可以不在这里声明，但是调用时一定要处于事务环境下</span></span><br><span class="line">    <span class="meta">@Modifying</span>     <span class="comment">//表示这是一个DML操作</span></span><br><span class="line">    <span class="meta">@Query(&quot;update Account set password = ?2 where id = ?1&quot;)</span> <span class="comment">//这里操作的是一个实体类对应的表，参数使用?代表，后面接第n个参数</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updatePasswordById</span><span class="params">(<span class="type">int</span> id, String newPassword)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query(value = &quot;update users set password = :pwd where username = :name&quot;, nativeQuery = true)</span> <span class="comment">//使用原生SQL，和Mybatis一样，这里使用 :名称 表示参数，当然也可以继续用上面那种方式。</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">updatePasswordByUsername</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String username,   //我们可以使用<span class="meta">@Param</span>指定名称</span></span><br><span class="line"><span class="params">                             <span class="meta">@Param(&quot;pwd&quot;)</span> String newPassword)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="MybatisPlus框架"><a href="#MybatisPlus框架" class="headerlink" title="MybatisPlus框架"></a>MybatisPlus框架</h2><p>所需依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-spring-boot3-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.10.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-extension<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>数据源</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">Abc123</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<p>开启日志打印</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>
<h3 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h3><p>实体类，可以直接映射到数据库中的表</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(&quot;user&quot;)</span>  <span class="comment">//对应的表名</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span>   <span class="comment">//对应的主键</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="meta">@TableField(&quot;name&quot;)</span>   <span class="comment">//对应的字段</span></span><br><span class="line">    String name;</span><br><span class="line">    <span class="meta">@TableField(&quot;email&quot;)</span></span><br><span class="line">    String email;</span><br><span class="line">    <span class="meta">@TableField(&quot;password&quot;)</span></span><br><span class="line">    String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟 mybatis 一样，需要一个 mapper</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">  	<span class="comment">//使用方式与JPA极其相似，同样是继承一个基础的模版Mapper</span></span><br><span class="line">  	<span class="comment">//这个模版里面提供了预设的大量方法直接使用，跟JPA如出一辙</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DemoApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    UserMapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(mapper.selectById(<span class="number">1</span>));  <span class="comment">//同样可以直接selectById，非常快速方便</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="条件构造器"><a href="#条件构造器" class="headerlink" title="条件构造器"></a>条件构造器</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();    <span class="comment">//复杂查询可以使用QueryWrapper来完成</span></span><br><span class="line">  	wrapper</span><br><span class="line">            .select(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;email&quot;</span>, <span class="string">&quot;password&quot;</span>)    <span class="comment">//可以自定义选择哪些字段</span></span><br><span class="line">            .ge(<span class="string">&quot;id&quot;</span>, <span class="number">2</span>)     			<span class="comment">//选择判断id大于等于1的所有数据</span></span><br><span class="line">            .orderByDesc(<span class="string">&quot;id&quot;</span>);   <span class="comment">//根据id字段进行降序排序</span></span><br><span class="line">    System.out.println(mapper.selectList(wrapper));   <span class="comment">//Mapper同样支持使用QueryWrapper进行查询</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>等同于</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select id,name,email,password from user where id &gt;= 2 order by id desc</span><br></pre></td></tr></table></figure>


<p>支持批处理操作，我们可以一次性删除多个指定ID的用户：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    mapper.deleteByIds(List.of(<span class="number">1</span>, <span class="number">3</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    UpdateWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;&gt;();</span><br><span class="line">    wrapper</span><br><span class="line">            .set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;lbw&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    System.out.println(mapper.update(<span class="literal">null</span>, wrapper));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h4><p>先配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">paginationInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">      	<span class="comment">//添加分页拦截器到MybatisPlusInterceptor中</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//这里我们将用户表分2页，并获取第一页的数据</span></span><br><span class="line">    Page&lt;User&gt; page = mapper.selectPage(Page.of(<span class="number">1</span>, <span class="number">2</span>), Wrappers.emptyWrapper());</span><br><span class="line">    System.out.println(page.getRecords());   <span class="comment">//获取分页之后的数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Lambda表达式"><a href="#Lambda表达式" class="headerlink" title="Lambda表达式"></a>Lambda表达式</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;User&gt; wrapper = Wrappers</span><br><span class="line">                .&lt;User&gt;lambdaQuery()</span><br><span class="line">                .eq(User::getId, <span class="number">2</span>)   <span class="comment">//比如我们需要选择id为2的用户，前面传入方法引用，后面比的值</span></span><br><span class="line">                .select(User::getName, User::getId);   <span class="comment">//比如我们只需要选择name和id，那就传入对应的get方法引用</span></span><br><span class="line">        System.out.println(mapper.selectOne(wrapper));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="代码生成器"><a href="#代码生成器" class="headerlink" title="代码生成器"></a>代码生成器</h3><p>依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.velocity<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>velocity-engine-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.FastAutoGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.DataSourceConfig;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Demo4ApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    DataSource DataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        FastAutoGenerator</span><br><span class="line">                .create(<span class="keyword">new</span> <span class="title class_">DataSourceConfig</span>.Builder(DataSource))</span><br><span class="line">                .globalConfig(builder -&gt; &#123;</span><br><span class="line">                    builder.author(<span class="string">&quot;hs&quot;</span>);</span><br><span class="line">                    builder.commentDate(<span class="string">&quot;2024-01-01&quot;</span>);</span><br><span class="line">                    builder.outputDir(<span class="string">&quot;src/main/java&quot;</span>);</span><br><span class="line">                &#125;)</span><br><span class="line">                .packageConfig(builder -&gt; builder.parent(<span class="string">&quot;com.example&quot;</span>))</span><br><span class="line">                .strategyConfig(builder -&gt; &#123;</span><br><span class="line">                    builder</span><br><span class="line">                            .mapperBuilder()</span><br><span class="line">                            .mapperAnnotation(Mapper.class)</span><br><span class="line">                            .build();</span><br><span class="line">                &#125;)</span><br><span class="line">                .execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="前后端分离"><a href="#前后端分离" class="headerlink" title="前后端分离"></a>前后端分离</h1><h2 id="基于-session-的分离"><a href="#基于-session-的分离" class="headerlink" title="基于 session 的分离"></a>基于 session 的分离</h2><p>前后端分离，需要前端与后端各占一个服务器</p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><ul>
<li><strong>创建前端文件</strong></li>
</ul>
<p>勾选上spring web<br><img src="/p9.png" class="lazyload" data-srcset="/p9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>在resources里创建一个web目录，把所有web相关的文件塞进去，然后修改配置文件</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">static-locations:</span> <span class="string">classpath:/web</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>创建后端文件</strong></li>
</ul>
<p>把右下角看到的依赖都勾选上<br><img src="/p10.png" class="lazyload" data-srcset="/p10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>后端文件的resources中只需要保留一个配置文件即可，因为前端已经占用了8080端口，我们这里需要改成其他端口</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span>  </span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span>  </span><br><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="attr">datasource:</span>  </span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test</span>  </span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span>  </span><br><span class="line">    <span class="attr">password:</span> <span class="string">Abc123</span>  </span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<h3 id="实现登录授权和跨域处理"><a href="#实现登录授权和跨域处理" class="headerlink" title="实现登录授权和跨域处理"></a>实现登录授权和跨域处理</h3><p>还是跟之前security一样</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> http</span><br><span class="line">                .authorizeHttpRequests(conf -&gt; &#123;</span><br><span class="line">                    conf.anyRequest().authenticated();</span><br><span class="line">                &#125;)</span><br><span class="line">                .formLogin(conf -&gt; &#123;</span><br><span class="line">                  	<span class="comment">//一般分离之后，为了统一规范接口，使用 /api/模块/功能 的形式命名接口</span></span><br><span class="line">                    conf.loginProcessingUrl(<span class="string">&quot;/api/auth/login&quot;</span>);</span><br><span class="line">                    conf.permitAll();</span><br><span class="line">                &#125;)</span><br><span class="line">                .csrf(AbstractHttpConfigurer::disable)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>手动设置SuccessHandler和FailureHandler来实现让SpringSecurity在登录成功之后返回一个JSON数据给前端而不是默认的重定向：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="keyword">return</span> http</span><br><span class="line">			...</span><br><span class="line">			.formLogin(conf -&gt; &#123;</span><br><span class="line">				conf.loginProcessingUrl(<span class="string">&quot;/api/auth/login&quot;</span>);</span><br><span class="line">				<span class="comment">//使用自定义的成功失败处理器</span></span><br><span class="line">				conf.failureHandler(<span class="built_in">this</span>::onAuthenticationFailure);</span><br><span class="line">				conf.successHandler(<span class="built_in">this</span>::onAuthenticationSuccess);</span><br><span class="line">				conf.permitAll();</span><br><span class="line">			&#125;)</span><br><span class="line">			...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//自定义成功失败处理器</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">							 HttpServletResponse response,</span></span><br><span class="line"><span class="params">							 AuthenticationException exception)</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">							 HttpServletResponse response, </span></span><br><span class="line"><span class="params">							 Authentication authentication)</span> &#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>REST应答一般使用的格式为JSON，这里我们创建一个实体类来装载响应数据，两种写法：</p>
<ul>
<li>1、基本写法：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestBean</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="type">int</span> code;</span><br><span class="line">    T data;</span><br><span class="line">    String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">RestBean</span><span class="params">(<span class="type">int</span> code, T data, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestBean&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestBean</span>&lt;&gt;(<span class="number">200</span>, data, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestBean&lt;T&gt; <span class="title function_">failure</span><span class="params">(<span class="type">int</span> code, String message)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestBean</span>&lt;&gt;(code, <span class="literal">null</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">asJsonString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONObject</span><br><span class="line">                .from(<span class="built_in">this</span>, JSONWriter.Feature.WriteNulls)</span><br><span class="line">                .toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
或者</li>
<li>2、JDK的新特性：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">RestBean</span>&lt;T&gt; (<span class="type">int</span> code, T data, String message) &#123;</span><br><span class="line">		<span class="comment">//写几个工具方法，用于快速创建RestBean对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestBean&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestBean</span>&lt;&gt;(<span class="number">200</span>, data, <span class="string">&quot;请求成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestBean&lt;T&gt; <span class="title function_">failure</span><span class="params">(<span class="type">int</span> code, String message)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestBean</span>&lt;&gt;(code, <span class="literal">null</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestBean&lt;T&gt; <span class="title function_">failure</span><span class="params">(<span class="type">int</span> code)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> failure(code, <span class="string">&quot;请求失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//将当前对象转换为JSON格式的字符串用于返回</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">asJsonString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONObject.toJSONString(<span class="built_in">this</span>, JSONWriter.Feature.WriteNulls);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>把handler补充完</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                 HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                 AuthenticationException exception)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        writer.write(RestBean.failure(<span class="number">401</span>, exception.getMessage()).asJsonString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                 HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                 Authentication authentication)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        writer.write(RestBean.success(authentication.getName()).asJsonString());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们在发起登录请求时，前端得到了一个跨域请求错误，这是因为我们前端的站点和后端站点不一致导致的，我们只需要告诉浏览器那些站点发出的请求是安全的即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> http</span><br><span class="line">            ...</span><br><span class="line">            .cors(conf -&gt; &#123;</span><br><span class="line">                <span class="type">CorsConfiguration</span> <span class="variable">cors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">              	<span class="comment">//添加前端站点地址，这样就可以告诉浏览器信任了</span></span><br><span class="line">              	cors.addAllowedOrigin(<span class="string">&quot;http://localhost:8080&quot;</span>);</span><br><span class="line">                <span class="comment">//虽然也可以像这样允许所有 cors.addAllowedOriginPattern(&quot;*&quot;);</span></span><br><span class="line">              	<span class="comment">//但是这样并不安全，我们应该只许可给我们信任的站点</span></span><br><span class="line">                cors.setAllowCredentials(<span class="literal">true</span>);  <span class="comment">//允许跨域请求中携带Cookie</span></span><br><span class="line">                cors.addAllowedHeader(<span class="string">&quot;*&quot;</span>);   <span class="comment">//其他的也可以配置，为了方便这里就 * 了</span></span><br><span class="line">                cors.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">                cors.addExposedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">                <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">                source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, cors);  <span class="comment">//直接针对于所有地址生效</span></span><br><span class="line">                conf.configurationSource(source);</span><br><span class="line">            &#125;)</span><br><span class="line">            ...</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SecurityConfiguration</code> 最终代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.entity.RestBean;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.SecurityFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> http</span><br><span class="line">                .authorizeHttpRequests(conf -&gt; &#123;</span><br><span class="line">                    conf.anyRequest().authenticated();</span><br><span class="line">                &#125;)</span><br><span class="line">                .formLogin(conf -&gt; &#123;</span><br><span class="line">                    <span class="comment">//一般分离之后，为了统一规范接口，使用 /api/模块/功能 的形式命名接口</span></span><br><span class="line">                    conf.loginProcessingUrl(<span class="string">&quot;/api/auth/login&quot;</span>);</span><br><span class="line">                    conf.successHandler(<span class="built_in">this</span>::onAuthenticationSuccess);</span><br><span class="line">                    conf.failureHandler(<span class="built_in">this</span>::onAuthenticationFailure);</span><br><span class="line">                    conf.permitAll();</span><br><span class="line">                &#125;)</span><br><span class="line">                .csrf(AbstractHttpConfigurer::disable)</span><br><span class="line">                .cors(conf -&gt; &#123;</span><br><span class="line">                    <span class="type">CorsConfiguration</span> <span class="variable">cors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">                    <span class="comment">//添加前端站点地址，这样就可以告诉浏览器信任了</span></span><br><span class="line">                    cors.addAllowedOrigin(<span class="string">&quot;http://localhost:8080&quot;</span>);</span><br><span class="line">                    <span class="comment">//虽然也可以像这样允许所有 cors.addAllowedOriginPattern(&quot;*&quot;);</span></span><br><span class="line">                    <span class="comment">//但是这样并不安全，我们应该只许可给我们信任的站点</span></span><br><span class="line">                    cors.setAllowCredentials(<span class="literal">true</span>);  <span class="comment">//允许跨域请求中携带Cookie</span></span><br><span class="line">                    cors.addAllowedHeader(<span class="string">&quot;*&quot;</span>);   <span class="comment">//其他的也可以配置，为了方便这里就 * 了</span></span><br><span class="line">                    cors.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">                    cors.addExposedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">                    <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">                    source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, cors);  <span class="comment">//直接针对于所有地址生效</span></span><br><span class="line">                    conf.configurationSource(source);</span><br><span class="line">                &#125;)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//自定义成功失败处理器</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                 HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                 AuthenticationException exception)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        writer.write(RestBean.failure(<span class="number">401</span>, exception.getMessage()).asJsonString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                 HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                 Authentication authentication)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        writer.write(RestBean.success(authentication.getName()).asJsonString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实体类最终代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">RestBean</span>&lt;T&gt; (<span class="type">int</span> code, T data, String message) &#123;</span><br><span class="line">    <span class="comment">//写几个工具方法，用于快速创建RestBean对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestBean&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestBean</span>&lt;&gt;(<span class="number">200</span>, data, <span class="string">&quot;请求成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestBean&lt;T&gt; <span class="title function_">failure</span><span class="params">(<span class="type">int</span> code, String message)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestBean</span>&lt;&gt;(code, <span class="literal">null</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestBean&lt;T&gt; <span class="title function_">failure</span><span class="params">(<span class="type">int</span> code)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> failure(code, <span class="string">&quot;请求失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将当前对象转换为JSON格式的字符串用于返回</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">asJsonString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONObject.toJSONString(<span class="built_in">this</span>, JSONWriter.Feature.WriteNulls);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p>一个JWT令牌由3部分组成:标头(Header)、有效载荷(Payload)和签名(Signature)。</p>
<p>依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="快速体验"><a href="#快速体验" class="headerlink" title="快速体验"></a>快速体验</h3><p>生成一个JWT令牌</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtKey</span> <span class="operator">=</span> <span class="string">&quot;abcdefghijklmn&quot;</span>;                 <span class="comment">//使用一个JWT秘钥进行加密</span></span><br><span class="line">        <span class="type">Algorithm</span> <span class="variable">algorithm</span> <span class="operator">=</span> Algorithm.HMAC256(jwtKey);  <span class="comment">//创建HMAC256加密算法对象</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> JWT.create()</span><br><span class="line">                .withClaim(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>)   <span class="comment">//向令牌中塞入自定义的数据</span></span><br><span class="line">                .withClaim(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;lbw&quot;</span>)</span><br><span class="line">                .withClaim(<span class="string">&quot;role&quot;</span>, <span class="string">&quot;nb&quot;</span>)</span><br><span class="line">                .withExpiresAt(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2024</span>, Calendar.FEBRUARY, <span class="number">1</span>))  <span class="comment">//JWT令牌的失效时间</span></span><br><span class="line">                .withIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>())   <span class="comment">//JWT令牌的签发时间</span></span><br><span class="line">                .sign(algorithm);    <span class="comment">//使用上面的加密算法进行加密，完成签名</span></span><br><span class="line">        System.out.println(jwtToken);   <span class="comment">//得到最终的JWT令牌</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到的令牌为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoibmIiLCJuYW1lIjoibGJ3IiwiaWQiOjEsImV4cCI6NjE2NjQ4NjA4MDAsImlhdCI6MTc0MDA2OTA0N30.1IJCxw3HUmOy2qbEw--6Qnz5fub6dbnIv-u2GmZQam0</span><br></pre></td></tr></table></figure>

<p>还原代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> <span class="string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoibmIiLCJuYW1lIjoibGJ3IiwiaWQiOjEsImV4cCI6NjE2NjQ4NjA4MDAsImlhdCI6MTY5MDEzMTQ3OH0.KUuGKM0OynL_DEUnRIETDBlmGjoqbt_5dP2r21ZDE1s&quot;</span>;</span><br><span class="line">        String[] split = jwtToken.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; split.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> split[i];</span><br><span class="line">            <span class="type">byte</span>[] decode = Base64.getDecoder().decode(s);</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(decode));</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解码后：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;&#125;</span><br><span class="line">&#123;&quot;role&quot;:&quot;nb&quot;,&quot;name&quot;:&quot;lbw&quot;,&quot;id&quot;:1,&quot;exp&quot;:61664860800,&quot;iat&quot;:1740069366&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SpringSecurity-实现-JWT-校验"><a href="#SpringSecurity-实现-JWT-校验" class="headerlink" title="SpringSecurity 实现 JWT 校验"></a>SpringSecurity 实现 JWT 校验</h3><p>首先先创建处理JWT令牌的工具类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtils</span> &#123;</span><br><span class="line">  	<span class="comment">//Jwt秘钥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;abcdefghijklmn&quot;</span>;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//根据用户信息创建Jwt令牌</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createJwt</span><span class="params">(UserDetails user)</span>&#123;</span><br><span class="line">        <span class="type">Algorithm</span> <span class="variable">algorithm</span> <span class="operator">=</span> Algorithm.HMAC256(key);</span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> calendar.getTime();</span><br><span class="line">        calendar.add(Calendar.SECOND, <span class="number">3600</span> * <span class="number">24</span> * <span class="number">7</span>);</span><br><span class="line">        <span class="keyword">return</span> JWT.create()</span><br><span class="line">                .withClaim(<span class="string">&quot;name&quot;</span>, user.getUsername())  <span class="comment">//配置JWT自定义信息</span></span><br><span class="line">                .withClaim(<span class="string">&quot;authorities&quot;</span>, user.getAuthorities().stream().map(GrantedAuthority::getAuthority).toList())</span><br><span class="line">                .withExpiresAt(calendar.getTime())  <span class="comment">//设置过期时间</span></span><br><span class="line">                .withIssuedAt(now)    <span class="comment">//设置创建创建时间</span></span><br><span class="line">                .sign(algorithm);   <span class="comment">//最终签名</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//根据Jwt验证并解析用户信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserDetails <span class="title function_">resolveJwt</span><span class="params">(String token)</span>&#123;</span><br><span class="line">        <span class="type">Algorithm</span> <span class="variable">algorithm</span> <span class="operator">=</span> Algorithm.HMAC256(key);</span><br><span class="line">        <span class="type">JWTVerifier</span> <span class="variable">jwtVerifier</span> <span class="operator">=</span> JWT.require(algorithm).build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DecodedJWT</span> <span class="variable">verify</span> <span class="operator">=</span> jwtVerifier.verify(token);  <span class="comment">//对JWT令牌进行验证，看看是否被修改</span></span><br><span class="line">            Map&lt;String, Claim&gt; claims = verify.getClaims();  <span class="comment">//获取令牌中内容</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().after(claims.get(<span class="string">&quot;exp&quot;</span>).asDate())) <span class="comment">//如果是过期令牌则返回null</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              	<span class="comment">//重新组装为UserDetails对象，包括用户名、授权信息等</span></span><br><span class="line">                <span class="keyword">return</span> User</span><br><span class="line">                        .withUsername(claims.get(<span class="string">&quot;name&quot;</span>).asString())</span><br><span class="line">                        .password(<span class="string">&quot;&quot;</span>)</span><br><span class="line">                        .authorities(claims.get(<span class="string">&quot;authorities&quot;</span>).asArray(String.class))</span><br><span class="line">                        .build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JWTVerificationException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再编写 JwtAuthenticationFilter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;  </span><br><span class="line"><span class="comment">//继承OncePerRequestFilter表示每次请求过滤一次，用于快速编写JWT校验规则</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">      	<span class="comment">//首先从Header中取出JWT</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authorization</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">      	<span class="comment">//判断是否包含JWT且格式正确</span></span><br><span class="line">        <span class="keyword">if</span> (authorization != <span class="literal">null</span> &amp;&amp; authorization.startsWith(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> authorization.substring(<span class="number">7</span>);	</span><br><span class="line">          	<span class="comment">//开始解析成UserDetails对象，如果得到的是null说明解析失败，JWT有问题</span></span><br><span class="line">            <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> JwtUtils.resolveJwt(token);</span><br><span class="line">            <span class="keyword">if</span>(user != <span class="literal">null</span>) &#123;</span><br><span class="line">              	<span class="comment">//验证没有问题，那么就可以开始创建Authentication了，这里我们跟默认情况保持一致</span></span><br><span class="line">              	<span class="comment">//使用UsernamePasswordAuthenticationToken作为实体，填写相关用户信息进去</span></span><br><span class="line">                <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authentication</span> <span class="operator">=</span></span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user, <span class="literal">null</span>, user.getAuthorities());</span><br><span class="line">                authentication.setDetails(<span class="keyword">new</span> <span class="title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));</span><br><span class="line">              	<span class="comment">//然后直接把配置好的Authentication塞给SecurityContext表示已经完成验证</span></span><br><span class="line">                SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">//最后放行，继续下一个过滤器</span></span><br><span class="line">      	<span class="comment">//可能各位小伙伴会好奇，要是没验证成功不是应该拦截吗？这个其实没有关系的</span></span><br><span class="line">      	<span class="comment">//因为如果没有验证失败上面是不会给SecurityContext设置Authentication的，后面直接就被拦截掉了</span></span><br><span class="line">      	<span class="comment">//而且有可能用户发起的是用户名密码登录请求，这种情况也要放行的，不然怎么登录，所以说直接放行就好</span></span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后再修改 <code>SecurityConfiguration</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.example.entity.RestBean;  </span><br><span class="line"><span class="keyword">import</span> com.example.filter.JwtAuthenticationFilter;  </span><br><span class="line"><span class="keyword">import</span> com.example.util.JwtUtils;  </span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.AccessDeniedException;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.SecurityFilterChain;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="keyword">return</span> http  </span><br><span class="line">                .authorizeHttpRequests(conf -&gt; &#123;  </span><br><span class="line">                    conf.anyRequest().authenticated();  </span><br><span class="line">                &#125;)  </span><br><span class="line">                .formLogin(conf -&gt; &#123;  </span><br><span class="line">                    <span class="comment">//一般分离之后，为了统一规范接口，使用 /api/模块/功能 的形式命名接口  </span></span><br><span class="line">                    conf.loginProcessingUrl(<span class="string">&quot;/api/auth/login&quot;</span>);  </span><br><span class="line">                    conf.successHandler(<span class="built_in">this</span>::handleProcess);  </span><br><span class="line">                    conf.failureHandler(<span class="built_in">this</span>::handleProcess);  </span><br><span class="line">                    conf.permitAll();  </span><br><span class="line">                &#125;)  </span><br><span class="line">                .csrf(AbstractHttpConfigurer::disable)  </span><br><span class="line">                .cors(conf -&gt; &#123;  </span><br><span class="line">                    <span class="type">CorsConfiguration</span> <span class="variable">cors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();  </span><br><span class="line">                    <span class="comment">//添加前端站点地址，这样就可以告诉浏览器信任了  </span></span><br><span class="line">                    cors.addAllowedOrigin(<span class="string">&quot;http://localhost:8080&quot;</span>);  </span><br><span class="line">                    <span class="comment">//虽然也可以像这样允许所有 cors.addAllowedOriginPattern(&quot;*&quot;);                    //但是这样并不安全，我们应该只许可给我们信任的站点  </span></span><br><span class="line">                    cors.setAllowCredentials(<span class="literal">true</span>);  <span class="comment">//允许跨域请求中携带Cookie  </span></span><br><span class="line">                    cors.addAllowedHeader(<span class="string">&quot;*&quot;</span>);   <span class="comment">//其他的也可以配置，为了方便这里就 * 了  </span></span><br><span class="line">                    cors.addAllowedMethod(<span class="string">&quot;*&quot;</span>);  </span><br><span class="line">                    cors.addExposedHeader(<span class="string">&quot;*&quot;</span>);  </span><br><span class="line">                    <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();  </span><br><span class="line">                    source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, cors);  <span class="comment">//直接针对于所有地址生效  </span></span><br><span class="line">                    conf.configurationSource(source);  </span><br><span class="line">                &#125;)  </span><br><span class="line">                .exceptionHandling(conf -&gt; &#123;  </span><br><span class="line">                    <span class="comment">//配置授权相关异常处理器  </span></span><br><span class="line">                    conf.accessDeniedHandler(<span class="built_in">this</span>::handleProcess);  </span><br><span class="line">                    <span class="comment">//配置验证相关异常的处理器  </span></span><br><span class="line">                    conf.authenticationEntryPoint(<span class="built_in">this</span>::onAuthenticationFailure);  </span><br><span class="line">                &#125;)  </span><br><span class="line">                .sessionManagement(conf -&gt; conf.sessionCreationPolicy(SessionCreationPolicy.STATELESS))  </span><br><span class="line">                .addFilterBefore(<span class="keyword">new</span> <span class="title class_">JwtAuthenticationFilter</span>(), UsernamePasswordAuthenticationFilter.class)  </span><br><span class="line">                .build();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//自定义成功失败处理器  </span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request,  </span></span><br><span class="line"><span class="params">                                 HttpServletResponse response,  </span></span><br><span class="line"><span class="params">                                 AuthenticationException exception)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);  </span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();  </span><br><span class="line">        writer.write(RestBean.failure(<span class="number">401</span>, exception.getMessage()).asJsonString());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request,  </span></span><br><span class="line"><span class="params">                                 HttpServletResponse response,  </span></span><br><span class="line"><span class="params">                                 Authentication authentication)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);  </span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();  </span><br><span class="line">        writer.write(RestBean.success(authentication.getName()).asJsonString());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleProcess</span><span class="params">(HttpServletRequest request,  </span></span><br><span class="line"><span class="params">                               HttpServletResponse response,  </span></span><br><span class="line"><span class="params">                               Object exceptionOrAuthentication)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);  </span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();  </span><br><span class="line">        <span class="keyword">if</span>(exceptionOrAuthentication <span class="keyword">instanceof</span> AccessDeniedException exception) &#123;  </span><br><span class="line">            writer.write(RestBean.failure(<span class="number">403</span>, exception.getMessage()).asJsonString());  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(exceptionOrAuthentication <span class="keyword">instanceof</span> Exception exception) &#123;  </span><br><span class="line">            writer.write(RestBean.failure(<span class="number">401</span>, exception.getMessage()).asJsonString());  </span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(exceptionOrAuthentication <span class="keyword">instanceof</span> Authentication authentication)&#123;  </span><br><span class="line">            <span class="comment">//不过这里需要注意，在登录成功的时候需要返回我们生成的JWT令牌，这样客户端下次访问就可以携带这个令牌了，令牌过期之后就需要重新登录才可以  </span></span><br><span class="line">            writer.write(RestBean.success(JwtUtils.createJwt((User) authentication.getPrincipal())).asJsonString());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>












]]></content>
  </entry>
  <entry>
    <title>SpringMVC学习笔记</title>
    <url>/2024/12/24/articles/SpringMVC/SpringMVC/</url>
    <content><![CDATA[<h2 id="所需依赖"><a href="#所需依赖" class="headerlink" title="所需依赖"></a>所需依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>5.9.2<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="HelloMVC"><a href="#HelloMVC" class="headerlink" title="HelloMVC"></a>HelloMVC</h1><p><img src="/p-1.png" class="lazyload" data-srcset="/p-1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<ul>
<li><p>web.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://jakarta.ee/xml/ns/jakartaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;https://jakarta.ee/xml/ns/jakartaee https://jakarta.ee/xml/ns/jakartaee/web-app_5_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;5.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc-servlet.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>自动扫描包，让指定包下的注解生效，有IOC容器统一管理</p>
</li>
</ul>
<p>springmvc-servlet.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.example.controller&quot;</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span> <span class="attr">id</span>=<span class="string">&quot;internalResourceViewResolver&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>hello.jsp</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;  </span><br><span class="line">&lt;html&gt;  </span><br><span class="line">&lt;head&gt;  </span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;  </span><br><span class="line">&lt;/head&gt;  </span><br><span class="line">&lt;body&gt;  </span><br><span class="line">$&#123;msg&#125;  </span><br><span class="line">&lt;/body&gt;  </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>ControllerTest.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="meta">@RequestMapping(&quot;/c&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ControllerTest</span> &#123;  </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/h1&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test1</span><span class="params">(Model model)</span> &#123;  </span><br><span class="line">  </span><br><span class="line">        model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;Controller Test&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;  <span class="comment">//会被视图解析器处理，找到WEB-INF/jsp/hello.jsp</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RestFul-风格"><a href="#RestFul-风格" class="headerlink" title="RestFul 风格"></a>RestFul 风格</h1><p>**RestFul风格会允许我们将参数通过URL拼接传送到服务端</p>
<p>比如这里我们的URL可以填<br><code>http://localhost:8080/add/13/18</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestFulController</span> &#123;  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/add/&#123;a&#125;/&#123;b&#125;&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test1</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> a, <span class="meta">@PathVariable</span> <span class="type">int</span> b, Model model)</span>&#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> a + b;  </span><br><span class="line">  </span><br><span class="line">        model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;result is &quot;</span> + result);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>**当然，我们也可以通过RestFul风格来传对象，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/t1&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test1</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name, Model model)</span> &#123;  </span><br><span class="line">        <span class="comment">// 接受前端参数  </span></span><br><span class="line">        System.out.println(<span class="string">&quot;前端接收的参数为&quot;</span> + name);  </span><br><span class="line">        <span class="comment">// 将返回的结果赋给前端  </span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;msg&quot;</span>, name);  </span><br><span class="line">        <span class="comment">// 视图跳转  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/t2&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test2</span><span class="params">(User user, Model model)</span> &#123;  </span><br><span class="line">        model.addAttribute(<span class="string">&quot;msg&quot;</span>, user);  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们输入<code>http://localhost:8080/mvc/user/t2?id=1&amp;name=&quot;呵帅&quot;&amp;age=18)</code>也可以成功传值</p>
<p>这里有一篇博客讲的很清楚<br><a href="https://blog.csdn.net/zzvar/article/details/118164133">RESTful 风格（详细介绍 + 案例实现）_resultful风格开发-CSDN博客</a></p>
<h1 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;javascript&quot;</span>&gt;</span><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> user = &#123;  </span></span><br><span class="line"><span class="language-javascript">            <span class="attr">name</span>: <span class="string">&quot;hs&quot;</span>,  </span></span><br><span class="line"><span class="language-javascript">            <span class="attr">age</span>: <span class="number">18</span>,  </span></span><br><span class="line"><span class="language-javascript">            <span class="attr">sex</span>: <span class="string">&quot;男&quot;</span>  </span></span><br><span class="line"><span class="language-javascript">        &#125;;  </span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> jsonStr = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user);  </span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(jsonStr);  </span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> obj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(jsonStr);  </span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(obj);  </span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>utils<br>用json对象表示法来返回一个时间给页面</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.utils;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationFeature;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;  </span><br><span class="line"><span class="keyword">import</span> java.util.Date;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsonUtils</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getJson</span><span class="params">(Object o)</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> getJson(o, <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getJson</span><span class="params">(Object o, String dateFormat)</span> &#123;  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">  </span><br><span class="line">        mapper.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, <span class="literal">false</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(dateFormat);  </span><br><span class="line">        mapper.setDateFormat(sdf);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">return</span> mapper.writeValueAsString(o);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;  </span><br><span class="line"><span class="keyword">import</span> com.example.utils.JsonUtils;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonGenerator;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;  </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;  </span><br><span class="line"><span class="keyword">import</span> java.util.Date;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/j1&quot;)</span>  </span><br><span class="line">    <span class="meta">@ResponseBody</span> <span class="comment">// 不会走视图解析器，直接返回一个字符串  </span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;hs&quot;</span>, <span class="number">18</span>, <span class="string">&quot;男&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> JsonUtils.getJson(user);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/j2&quot;)</span>  </span><br><span class="line">    <span class="meta">@ResponseBody</span> <span class="comment">// 不会走视图解析器，直接返回一个字符串  </span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException &#123;  </span><br><span class="line">  </span><br><span class="line">        ArrayList&lt;User&gt; arr = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;呵帅1&quot;</span>, <span class="number">18</span>, <span class="string">&quot;男&quot;</span>);  </span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;呵帅2&quot;</span>, <span class="number">18</span>, <span class="string">&quot;男&quot;</span>);  </span><br><span class="line">        <span class="type">User</span> <span class="variable">user3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;呵帅3&quot;</span>, <span class="number">18</span>, <span class="string">&quot;男&quot;</span>);  </span><br><span class="line">        <span class="type">User</span> <span class="variable">user4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;呵帅4&quot;</span>, <span class="number">18</span>, <span class="string">&quot;男&quot;</span>);  </span><br><span class="line">        <span class="type">User</span> <span class="variable">user5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;呵帅5&quot;</span>, <span class="number">18</span>, <span class="string">&quot;男&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        arr.add(user);  </span><br><span class="line">        arr.add(user2);  </span><br><span class="line">        arr.add(user3);  </span><br><span class="line">        arr.add(user4);  </span><br><span class="line">        arr.add(user5);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> JsonUtils.getJson(arr);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/j3&quot;)</span>  </span><br><span class="line">    <span class="meta">@ResponseBody</span> <span class="comment">// 不会走视图解析器，直接返回一个字符串  </span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test3</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> JsonUtils.getJson(date);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ModelAndView"><a href="#ModelAndView" class="headerlink" title="ModelAndView"></a>ModelAndView</h1><h2 id="固定模板"><a href="#固定模板" class="headerlink" title="固定模板"></a>固定模板</h2><p>两个config</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainInitializer</span> <span class="keyword">extends</span> <span class="title class_">AbstractAnnotationConfigDispatcherServletInitializer</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;WebConfiguration.class&#125;;   <span class="comment">//基本的Spring配置类，一般用于业务层配置  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>];  <span class="comment">//配置DispatcherServlet的配置类、主要用于Controller等配置，这里为了教学简单，就不分这么详细了，只使用上面的基本配置类  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/&quot;</span>&#125;;    <span class="comment">//匹配路径，与上面一致  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.example.interceptor.MainInterceptor;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;  </span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.spring6.SpringTemplateEngine;  </span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver;  </span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.spring6.view.ThymeleafViewResolver;  </span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresolver.ITemplateResolver;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@EnableWebMvc</span>   <span class="comment">//快速配置SpringMvc注解，如果不添加此注解会导致后续无法通过实现WebMvcConfigurer接口进行自定义配置  </span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.example.controller&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfiguration</span> &#123;  </span><br><span class="line">    <span class="comment">//我们需要使用ThymeleafViewResolver作为视图解析器，并解析我们的HTML页面  </span></span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> ThymeleafViewResolver <span class="title function_">thymeleafViewResolver</span><span class="params">(SpringTemplateEngine springTemplateEngine)</span>&#123;  </span><br><span class="line">        <span class="type">ThymeleafViewResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThymeleafViewResolver</span>();  </span><br><span class="line">        resolver.setOrder(<span class="number">1</span>);   <span class="comment">//可以存在多个视图解析器，并且可以为他们设定解析顺序  </span></span><br><span class="line">        resolver.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);   <span class="comment">//编码格式是重中之重  </span></span><br><span class="line">        resolver.setTemplateEngine(springTemplateEngine);   <span class="comment">//和之前JavaWeb阶段一样，需要使用模板引擎进行解析，所以这里也需要设定一下模板引擎  </span></span><br><span class="line">        <span class="keyword">return</span> resolver;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//配置模板解析器  </span></span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> SpringResourceTemplateResolver <span class="title function_">templateResolver</span><span class="params">()</span>&#123;  </span><br><span class="line">        <span class="type">SpringResourceTemplateResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringResourceTemplateResolver</span>();  </span><br><span class="line">        resolver.setSuffix(<span class="string">&quot;.html&quot;</span>);   <span class="comment">//需要解析的后缀名称  </span></span><br><span class="line">        resolver.setPrefix(<span class="string">&quot;classpath:&quot;</span>);   <span class="comment">//需要解析的HTML页面文件存放的位置，默认是webapp目录下，如果是类路径下需要添加classpath:前缀  </span></span><br><span class="line">        <span class="keyword">return</span> resolver;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//配置模板引擎Bean  </span></span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> SpringTemplateEngine <span class="title function_">springTemplateEngine</span><span class="params">(ITemplateResolver resolver)</span>&#123;  </span><br><span class="line">        <span class="type">SpringTemplateEngine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringTemplateEngine</span>();  </span><br><span class="line">        engine.setTemplateResolver(resolver);   <span class="comment">//模板解析器，默认即可  </span></span><br><span class="line">        <span class="keyword">return</span> engine;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="返回错误信息给页面"><a href="#返回错误信息给页面" class="headerlink" title="返回错误信息给页面"></a>返回错误信息给页面</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@ControllerAdvice</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">error</span><span class="params">(Exception e, Model model)</span> &#123;  </span><br><span class="line">        e.printStackTrace();  </span><br><span class="line">        model.addAttribute(<span class="string">&quot;e&quot;</span>, e);  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取cookie的方法"><a href="#获取cookie的方法" class="headerlink" title="获取cookie的方法"></a>获取cookie的方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test2&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">index2</span><span class="params">(<span class="meta">@CookieValue(&quot;JSESSIONID&quot;)</span> String id)</span> &#123;  </span><br><span class="line">    System.out.println(id);  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.interceptor;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;处理前&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;处理后&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;完成后&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码是一个Spring框架中的拦截器（Interceptor）实现示例。拦截器是Spring MVC中处理请求的组件之一，它可以在请求的多个不同阶段执行自定义逻辑。这个<code>MainInterceptor</code>类实现了<code>HandlerInterceptor</code>接口，并重写了其中的三个方法，分别对应请求处理的不同阶段：</p>
<ol>
<li><code>preHandle</code>：在请求处理之前调用（Controller方法调用之前）。</li>
<li><code>postHandle</code>：在请求处理之后调用，但在视图被渲染之前（Controller方法调用之后）。</li>
<li><code>afterCompletion</code>：在请求处理之后调用，当所有的请求处理工作完成之后，也就是在DispatcherServlet渲染了对应的视图之后调用。</li>
<li>具体到这个<code>MainInterceptor</code>类：</li>
</ol>
<ul>
<li><code>preHandle</code>方法中，打印了”处理前”，并返回<code>true</code>，表示请求可以继续向下执行。</li>
<li><code>postHandle</code>方法中，打印了”处理后”，这个方法可以修改ModelAndView对象，但在这个示例中并没有进行任何操作。</li>
<li><code>afterCompletion</code>方法中，打印了”完成后”，这个方法用于进行资源清理工作。</li>
</ul>
<p>这个拦截器可以被注册到Spring MVC的配置中，以便在请求处理过程中自动调用。注册拦截器通常在Spring的配置类中通过<code>WebMvcConfigurer</code>接口的<code>addInterceptors</code>方法完成。</p>
<h1 id="SpringSecurity"><a href="#SpringSecurity" class="headerlink" title="SpringSecurity"></a>SpringSecurity</h1><h2 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h2><p>**导入 maven 依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置 SecurityInitializer ，与MVC一样，需要一个初始化器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.init;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.context.AbstractSecurityWebApplicationInitializer;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityInitializer</span> <span class="keyword">extends</span> <span class="title class_">AbstractSecurityWebApplicationInitializer</span> &#123;  </span><br><span class="line">      <span class="comment">// 这里会自动注册一个Filter，SpringSecurity底层就是依靠N个过滤器实现的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们创建一个配置类用于配置SpringSecurity</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@EnableWebSecurity</span> <span class="comment">// 开启 WebSecurity 相关功能  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建完 SecurityConfiguration 配置类后需要修改 MainInitializer 中的 getRootConfigClasses</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;WebConfiguration.class, SecurityConfiguration.class&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><p>在Spring Security中，认证（Authentication）是确定用户身份的过程。它是Spring Security提供的安全功能的核心部分，用于验证用户是否为他们声称的那个人。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@EnableWebSecurity</span> <span class="comment">// 开启 WebSecurity 相关功能  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> User  </span><br><span class="line">                .withDefaultPasswordEncoder()  </span><br><span class="line">                .username(<span class="string">&quot;hs&quot;</span>)  </span><br><span class="line">                .password(<span class="string">&quot;123456&quot;</span>)  </span><br><span class="line">                .build();  </span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">admin</span> <span class="operator">=</span> User  </span><br><span class="line">                .withDefaultPasswordEncoder()  </span><br><span class="line">                .username(<span class="string">&quot;admin&quot;</span>)  </span><br><span class="line">                .password(<span class="string">&quot;123456&quot;</span>)  </span><br><span class="line">                .build();  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>(user, admin);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BCrypt加密工具"><a href="#BCrypt加密工具" class="headerlink" title="BCrypt加密工具"></a>BCrypt加密工具</h3><p>在我们上面配置用户信息的时候发现 withDefaultPasswordEncoder 是已经被弃用的，因为用这种方式来存储密码并不安全。</p>
<p>这是因为SpringSecurity的密码校验建议使用加密算法将密码进行加密（或者说使用Hash处理）后将用户提供的密码与加密后的密码进行比较，而不是使用原文来进行匹配。</p>
<p>因此，我们在配置用户信息的时候，可以使用官方提供的BCrypt加密工具：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@EnableWebSecurity</span> <span class="comment">// 开启 WebSecurity 相关功能  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//这里将BCryptPasswordEncoder直接注册为Bean，Security会自动进行选择  </span></span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">(PasswordEncoder encoder)</span> &#123;  </span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> User  </span><br><span class="line">                .withUsername(<span class="string">&quot;hs&quot;</span>)  </span><br><span class="line">                .password(encoder.encode(<span class="string">&quot;123456&quot;</span>))  </span><br><span class="line">                .build();  </span><br><span class="line">        System.out.println(encoder.encode(<span class="string">&quot;123456&quot;</span>));  </span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">admin</span> <span class="operator">=</span> User  </span><br><span class="line">                .withUsername(<span class="string">&quot;admin&quot;</span>)  </span><br><span class="line">                .password(encoder.encode(<span class="string">&quot;123456&quot;</span>))  </span><br><span class="line">                .build();  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>(user, admin);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>替换后，首先最直观的体验是没有黄线警告了，然后我们正常在登录页面输入账号密码，我们在程序中可以插入print看看加密后的密码是怎么样的：<br><img src="/p-2-1.png" class="lazyload" data-srcset="/p-2-1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>第一次登录：$2a$10$PWLZcJqEFGmDWdz6OxQaLuTP&#x2F;nwi2KEZ1TwVNN3GqcuVJkcELalAG<br>第二次登录：$2a$10$BZpxArIf6yP.xfYVE7MywuPLH46m6UsmTWeOkd6RGDE0BoTnhSmE6</p>
<p>我们会发现两次登录加密后的密码都不一样，这加密强在自己都不知道加密后是怎么样的</p>
<h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><p>从现在开始，我们的网站不需要再自己编写登录模块了，这里我们可以直接去掉，只留下主页面：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;  </span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpSession;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@ResponseBody</span>  </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/pay&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> JSONObject <span class="title function_">pay</span><span class="params">(<span class="meta">@RequestParam</span> String account, HttpSession session)</span> &#123;  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        <span class="keyword">if</span>(session.getAttribute(<span class="string">&quot;login&quot;</span>) != <span class="literal">null</span>)&#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;转账给&quot;</span> + account + <span class="string">&quot;成功，交易已完成&quot;</span>);  </span><br><span class="line">            jsonObject.put(<span class="string">&quot;success&quot;</span>, <span class="literal">true</span>);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;转账给&quot;</span> + account + <span class="string">&quot;未成功，用户未登录&quot;</span>);  </span><br><span class="line">            jsonObject.put(<span class="string">&quot;success&quot;</span>, <span class="literal">false</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> jsonObject;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//处理首页或是登录界面跳转  </span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完成后即可通过上面配置的账号密码进行登录<br><img src="/p-2.png" class="lazyload" data-srcset="/p-2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h3 id="403"><a href="#403" class="headerlink" title="403"></a>403</h3><p>但是在页面中会发现，我们所有的Post请求都被403了<br><img src="/p-3.png" class="lazyload" data-srcset="/p-3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>这是因为SpringSecurity自带了csrf防护，需求我们在POST请求中携带页面中的csrfToken才可以，否则一律进行拦截操作，这里我们可以将其嵌入到页面中，随便找一个地方添加以下内容：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">th:id</span>=<span class="string">&quot;$&#123;_csrf.getParameterName()&#125;&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;_csrf.token&#125;&quot;</span> <span class="attr">hidden</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>目前完整index.html：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>白马银行 - 首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/axios@1.1.2/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>        转账账号：  </span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;account&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">label</span>&gt;</span>    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">th:id</span>=<span class="string">&quot;$&#123;_csrf.getParameterName()&#125;&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;_csrf.token&#125;&quot;</span> <span class="attr">hidden</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;pay()&quot;</span>&gt;</span>立即转账<span class="tag">&lt;/<span class="name">button</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">pay</span>(<span class="params"></span>) &#123;  </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> account = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;account&quot;</span>).<span class="property">value</span>  </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> _csrf = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;_csrf&quot;</span>).<span class="property">value</span>  </span></span><br><span class="line"><span class="language-javascript">        axios.<span class="title function_">post</span>(<span class="string">&#x27;/mvc/pay&#x27;</span>, &#123; <span class="attr">account</span>: account, <span class="attr">_csrf</span>: _csrf &#125;, &#123;  </span></span><br><span class="line"><span class="language-javascript">            <span class="attr">headers</span>: &#123;  </span></span><br><span class="line"><span class="language-javascript">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>  </span></span><br><span class="line"><span class="language-javascript">            &#125;  </span></span><br><span class="line"><span class="language-javascript">        &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123;data&#125;</span>) =&gt;</span> &#123;  </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span>(data.<span class="property">success</span>)  </span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&quot;转账成功&quot;</span>)  </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">else</span>  </span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&quot;转账失败&quot;</span>)  </span></span><br><span class="line"><span class="language-javascript">        &#125;)  </span></span><br><span class="line"><span class="language-javascript">    &#125;  </span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p><img src="/p-4.png" class="lazyload" data-srcset="/p-4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h2><p>前面我们实现了登录用户功能，但我们会想到，一般来说，用户信息都是存在数据库里的，不可能一个个写在后configuration里面，所有我们需要使用到数据库</p>
<h3 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h3><p>我们使用官方默认提供的可以直接使用的用户和权限表设计，根本不需要我们来建表，直接在DataGrip 中执行以下查询：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create table users(username varchar(50) not null primary key,password varchar(500) not null,enabled boolean not null);</span><br><span class="line">create table authorities (username varchar(50) not null,authority varchar(50) not null,constraint fk_authorities_users foreign key(username) references users(username));</span><br><span class="line">create unique index ix_auth_username on authorities (username,authority);</span><br></pre></td></tr></table></figure>

<p>然后我们需要导入所需的依赖</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">3.5</span><span class="number">.13</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis-spring&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">3.0</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-j&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">8.0</span><span class="number">.31</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">6.0</span><span class="number">.10</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h3 id="基于数据库校验"><a href="#基于数据库校验" class="headerlink" title="基于数据库校验"></a>基于数据库校验</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.pooled.PooledDataSource;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.JdbcUserDetailsManager;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@EnableWebSecurity</span> <span class="comment">// 开启 WebSecurity 相关功能  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//这里将BCryptPasswordEncoder直接注册为Bean，Security会自动进行选择  </span></span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 数据源  </span></span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PooledDataSource</span>(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>,  </span><br><span class="line">                <span class="string">&quot;jdbc:mysql://localhost:3306/springsecurity_study&quot;</span>,  </span><br><span class="line">                <span class="string">&quot;root&quot;</span>,  </span><br><span class="line">                <span class="string">&quot;Abc123&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">(PasswordEncoder encoder, DataSource dataSource)</span> &#123;  </span><br><span class="line">        <span class="type">JdbcUserDetailsManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcUserDetailsManager</span>(dataSource);  </span><br><span class="line">        manager.createUser(User.withUsername(<span class="string">&quot;hs&quot;</span>)  </span><br><span class="line">                .password(encoder.encode(<span class="string">&quot;123456&quot;</span>))  </span><br><span class="line">                .roles(<span class="string">&quot;USER&quot;</span>)  </span><br><span class="line">                .build());  </span><br><span class="line">        <span class="keyword">return</span> manager;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用的是JDBC的JdbcUserDetailsManager，自由度不高，挺死板的<br>重启tomcat可以看到两张表中已经自动添加好对应的数据了：<br><img src="/p-5.png" class="lazyload" data-srcset="/p-5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br><img src="/p-5-2.png" class="lazyload" data-srcset="/p-5-2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><p>通过使用UserDetailsManager对象，我们就能快速执行用户相关的管理操作，比如我们可以直接在网站上添加一个快速重置密码的接口，首先需要配置一下JdbcUserDetailsManager，为其添加一个AuthenticationManager用于原密码的校验：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@EnableWebSecurity</span> <span class="comment">// 开启 WebSecurity 相关功能  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    ......</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//手动创建一个AuthenticationManager用于处理密码校验  </span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">(UserDetailsManager manager,  </span></span><br><span class="line"><span class="params">                                                        PasswordEncoder encoder)</span>&#123;  </span><br><span class="line">        <span class="type">DaoAuthenticationProvider</span> <span class="variable">provider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DaoAuthenticationProvider</span>();  </span><br><span class="line">        provider.setUserDetailsService(manager);  </span><br><span class="line">        provider.setPasswordEncoder(encoder);  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProviderManager</span>(provider);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> UserDetailsManager <span class="title function_">userDetailsService</span><span class="params">(DataSource dataSource,  </span></span><br><span class="line"><span class="params">                                                 PasswordEncoder encoder)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">JdbcUserDetailsManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcUserDetailsManager</span>(dataSource);  </span><br><span class="line">        <span class="comment">//为UserDetailsManager设置AuthenticationManager即可开启重置密码的时的校验  </span></span><br><span class="line">        manager.setAuthenticationManager(authenticationManager(manager, encoder));  </span><br><span class="line">        <span class="keyword">return</span> manager;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    UserDetailsManager manager;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    PasswordEncoder encoder;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@ResponseBody</span>  </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/change-password&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> JSONObject <span class="title function_">changePassword</span><span class="params">(<span class="meta">@RequestParam</span> String oldPassword,  </span></span><br><span class="line"><span class="params">                                     <span class="meta">@RequestParam</span> String newPassword)</span> &#123;  </span><br><span class="line">        manager.changePassword(oldPassword, encoder.encode(newPassword));  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        object.put(<span class="string">&quot;success&quot;</span>, <span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> object;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在index.html中添加修改密码功能</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span></span><br><span class="line">        修改密码：</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;oldPassword&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;旧密码&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;newPassword&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;新密码&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;change()&quot;</span>&gt;</span>修改密码<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">change</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldPassword = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;oldPassword&quot;</span>).<span class="property">value</span></span><br><span class="line">    <span class="keyword">const</span> newPassword = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;newPassword&quot;</span>).<span class="property">value</span></span><br><span class="line">    <span class="keyword">const</span> csrf = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;_csrf&quot;</span>).<span class="property">value</span></span><br><span class="line">    axios.<span class="title function_">post</span>(<span class="string">&#x27;/mvc/change-password&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">oldPassword</span>: oldPassword,</span><br><span class="line">        <span class="attr">newPassword</span>: newPassword,</span><br><span class="line">        <span class="attr">_csrf</span>: csrf</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123;data&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">alert</span>(data.<span class="property">success</span> ? <span class="string">&quot;密码修改成功&quot;</span> : <span class="string">&quot;密码修改失败，请检查原密码是否正确&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种方式虽然能够完成我们所需要的功能，但是太麻烦了，不适合在实际开发中使用。</p>
<h3 id="自定义校验"><a href="#自定义校验" class="headerlink" title="自定义校验"></a>自定义校验</h3><p>大多数，我们并不会用SpringSecurity默认的验证来设计，而是采用自定义的表校验。</p>
<p>首先自行在数据库中创建一个数据表，然后在项目中创建实体类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.entity;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> lombok.Data;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Data</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;  </span><br><span class="line">    <span class="type">int</span> id;  </span><br><span class="line">    String username;  </span><br><span class="line">    String password;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Service中调用数据库查询</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.example.entity.Account;  </span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;  </span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizeService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    UserMapper mapper;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;  </span><br><span class="line">        <span class="type">Account</span> <span class="variable">account</span> <span class="operator">=</span> mapper.findUserByName(username);  </span><br><span class="line">        <span class="keyword">if</span>(account == <span class="literal">null</span>)  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;用户名或密码错误&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> User  </span><br><span class="line">                .withUsername(account.getUsername())  </span><br><span class="line">                .password(account.getPassword())  </span><br><span class="line">                .build();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据用户名查询用户的Mapper接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.example.entity.Account;  </span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;  </span><br><span class="line">    <span class="meta">@Select(&quot;select * from springsecurity_study.user where username = #&#123;username&#125;&quot;)</span>  </span><br><span class="line">    Account <span class="title function_">findUserByName</span><span class="params">(String username)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>别忘记在配置类WebConfiguration上添加相应的包扫描</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@EnableWebMvc</span>  </span><br><span class="line"><span class="meta">@ComponentScans(&#123;  </span></span><br><span class="line"><span class="meta">        @ComponentScan(&quot;com.example.controller&quot;),  </span></span><br><span class="line"><span class="meta">        @ComponentScan(&quot;com.example.service&quot;)  </span></span><br><span class="line"><span class="meta">&#125;)</span>  </span><br><span class="line"><span class="meta">@MapperScan(&quot;com.example.mapper&quot;)</span></span><br></pre></td></tr></table></figure>

<p>最后，在SecurityConfiguration里配置mybatis</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span>  </span><br><span class="line"><span class="keyword">public</span> SqlSessionFactoryBean <span class="title function_">sqlSessionFactoryBean</span><span class="params">(DataSource dataSource)</span>&#123;  </span><br><span class="line">    <span class="type">SqlSessionFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();  </span><br><span class="line">    bean.setDataSource(dataSource);  </span><br><span class="line">    <span class="keyword">return</span> bean;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>**注意：如果运行失败，则降低依赖的版本</p>
<h2 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h2><h3 id="自定义登录界面"><a href="#自定义登录界面" class="headerlink" title="自定义登录界面"></a>自定义登录界面</h3><p>虽然SpringSecurity为我们提供了一个登录界面，但是很多情况下往往都是我们使用自定义的登录界面，这个时候就需要进行更多的配置了，我们还是以之前图书管理系统使用的模版为例。</p>
<p>首先先修改Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过现在依然是默认进入到SpringSecurity默认的登录界面，现在我们来配置自定义的登录界面，将我们的前端模版中的登录页面作为SpringSecurity的默认登录界面。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">  	...</span><br><span class="line">	<span class="meta">@Bean</span>  </span><br><span class="line">	<span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">	    <span class="keyword">return</span> http  </span><br><span class="line">	            <span class="comment">//以下是验证请求拦截和放行配置  </span></span><br><span class="line">	            .authorizeHttpRequests(auth -&gt; &#123;  </span><br><span class="line">	                auth.requestMatchers(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/static/**&quot;</span>));<span class="comment">//静态资源放行  </span></span><br><span class="line">	                auth.anyRequest().authenticated();    <span class="comment">//将所有请求全部拦截，一律需要验证  </span></span><br><span class="line">	            &#125;)  </span><br><span class="line">	            <span class="comment">//以下是表单登录相关配置  </span></span><br><span class="line">	            .formLogin(conf -&gt; &#123;  </span><br><span class="line">	                conf.loginPage(<span class="string">&quot;/login&quot;</span>);   <span class="comment">//将登录页设置为我们自己的登录页面  </span></span><br><span class="line">	                conf.loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>); <span class="comment">//登录表单提交的地址，可以自定义  </span></span><br><span class="line">	                conf.defaultSuccessUrl(<span class="string">&quot;/&quot;</span>);   <span class="comment">//登录成功后跳转的页面  </span></span><br><span class="line">	                conf.permitAll();    <span class="comment">//将登录相关的地址放行，否则未登录的用户连登录界面都进不去  </span></span><br><span class="line">	                <span class="comment">//用户名和密码的表单字段名称，不过默认就是这个，可以不配置，除非有特殊需求  </span></span><br><span class="line">	                conf.usernameParameter(<span class="string">&quot;username&quot;</span>);  </span><br><span class="line">	                conf.passwordParameter(<span class="string">&quot;password&quot;</span>);  </span><br><span class="line">	            &#125;)  </span><br><span class="line">	            .build();  </span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要配置登陆页面的地址和登陆请求发送的地址，这里登陆页面填写为<code>/login</code>，登陆请求地址为<code>/doLogin</code>，登陆页面我们刚刚已经自己编写Controller来实现了，登陆请求提交处理由SpringSecurity提供，只需要写路径就可以了。</p>
<p>**如果页面加载失败没有格式，记得查看是不是没有给静态资源放行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.authorizeHttpRequests(auth -&gt; &#123;</span><br><span class="line">      auth.requestMatchers(<span class="string">&quot;/static/**&quot;</span>).permitAll();   <span class="comment">//将所有的静态资源放行，一定要添加在全部请求拦截之前</span></span><br><span class="line">      auth.anyRequest().authenticated();    <span class="comment">//将所有请求全部拦截，一律需要验证</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="登出按钮和关闭scrf"><a href="#登出按钮和关闭scrf" class="headerlink" title="登出按钮和关闭scrf"></a>登出按钮和关闭scrf</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.logout(conf -&gt; &#123;  </span><br><span class="line">    conf.logoutUrl(<span class="string">&quot;/doLogout&quot;</span>);  </span><br><span class="line">    conf.logoutSuccessUrl(<span class="string">&quot;/login&quot;</span>);  </span><br><span class="line">    conf.permitAll();  </span><br><span class="line">&#125;)  </span><br><span class="line">..csrf(AbstractHttpConfigurer::disable)</span><br></pre></td></tr></table></figure>

<h3 id="记住我"><a href="#记住我" class="headerlink" title="记住我"></a>记住我</h3><p>之前在JavaWeb阶段，使用本地Cookie存储的方式实现了记住我功能，但是这种方式并不安全，同时在代码编写上也比较麻烦</p>
<p>SpringSecurity为我们提供了一种优秀的实现，它为每个已经登陆的浏览器分配一个携带Token的Cookie，并且此Cookie默认会被保留14天，只要我们不清理浏览器的Cookie，那么下次携带此Cookie访问服务器将无需登陆，直接继续使用之前登陆的身份，这样显然比我们之前的写法更加简便。**记得修改前端页面中的表单。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.rememberMe(conf -&gt; &#123;  </span><br><span class="line">    <span class="comment">// conf.alwaysRemember(true);//无论点不点“记住我”，都记住用户  </span></span><br><span class="line">    <span class="comment">// conf.rememberMeParameter(&quot;remember-me&quot;);// 记住我表单字段，默认就是这个，可以不配置  </span></span><br><span class="line">    <span class="comment">// conf.rememberMeCookieName(&quot;xxxx&quot;);// 记住我cookie名称，默认就是这个，可以不配置  </span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>这个Cookie信息的过期时间并不是仅会话，而是默认保存一段时间，当然，由于记住我信息是存放在内存中的，我们需要保证服务器一直处于运行状态，如果关闭服务器的话，记住我信息会全部丢失，因此，如果我们希望记住我能够一直持久化保存，我们就需要进一步进行配置。我们需要创建一个基于JDBC的TokenRepository实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> PersistentTokenRepository <span class="title function_">tokenRepository</span><span class="params">(DataSource dataSource)</span>&#123;</span><br><span class="line">    <span class="type">JdbcTokenRepositoryImpl</span> <span class="variable">repository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenRepositoryImpl</span>();</span><br><span class="line">  	<span class="comment">//在启动时自动在数据库中创建存储记住我信息的表，仅第一次需要，后续不需要</span></span><br><span class="line">    repository.setCreateTableOnStartup(<span class="literal">true</span>);</span><br><span class="line">    repository.setDataSource(dataSource);</span><br><span class="line">    <span class="keyword">return</span> repository;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置持久化存储时间</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.rememberMe(conf -&gt; &#123;</span><br><span class="line">     conf.rememberMeParameter(<span class="string">&quot;remember-me&quot;</span>);</span><br><span class="line">     conf.tokenRepository(repository);      <span class="comment">//设置刚刚的记住我持久化存储库</span></span><br><span class="line">     conf.tokenValiditySeconds(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>);   <span class="comment">//设置记住我有效时间为7天</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h2><p>用户登录后，可能会根据用户当前是身份进行角色划分，每个角色执行不同的功能。</p>
<p>SpringSecurity为我们提供了两种授权方式：</p>
<ul>
<li>基于权限的授权：只要拥有某权限的用户，就可以访问某个路径。</li>
<li>基于角色的授权：根据用户属于哪个角色来决定是否可以访问某个路径。</li>
</ul>
<h3 id="基于角色授权"><a href="#基于角色授权" class="headerlink" title="基于角色授权"></a>基于角色授权</h3><h4 id="配置开发"><a href="#配置开发" class="headerlink" title="配置开发"></a>配置开发</h4><p>现在我们希望创建两个角色，普通用户和管理员，普通用户只能访问index页面，而管理员可以访问任何页面。</p>
<p>首先先修改数据库中的字段，添加一个role字段，接着我们需要配置SpringSecurity，决定哪些角色可以访问哪些页面：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.authorizeHttpRequests(auth -&gt; &#123;</span><br><span class="line">    <span class="comment">//静态资源依然全部可以访问</span></span><br><span class="line">    auth.requestMatchers(<span class="string">&quot;/static/**&quot;</span>).permitAll();</span><br><span class="line">    <span class="comment">//只有具有以下角色的用户才能访问路径&quot;/&quot;</span></span><br><span class="line">    auth.requestMatchers(<span class="string">&quot;/&quot;</span>).hasAnyRole(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    <span class="comment">//其他所有路径必须角色为admin才能访问</span></span><br><span class="line">    auth.anyRequest().hasRole(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改实体类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    String username;</span><br><span class="line">    String password;</span><br><span class="line">    String role;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改我们之前写的获取用户信息：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">    <span class="type">Account</span> <span class="variable">account</span> <span class="operator">=</span> mapper.findUserByName(username);</span><br><span class="line">    <span class="keyword">if</span>(account == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;用户名或密码错误&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> User</span><br><span class="line">            .withUsername(username)</span><br><span class="line">            .password(account.getPassword())</span><br><span class="line">            .roles(account.getRole())   <span class="comment">//添加角色，一个用户可以有一个或多个角色</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后可以实验，只有admin可以访问其他页面，其他用户只能访问index</p>
<h3 id="基于权限授权"><a href="#基于权限授权" class="headerlink" title="基于权限授权"></a>基于权限授权</h3><p>基于权限的授权与角色类似，需要以<code>hasAnyAuthority</code>或<code>hasAuthority</code>进行判断：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.authorizeHttpRequests(auth -&gt; &#123;</span><br><span class="line">    <span class="comment">//静态资源依然全部可以访问</span></span><br><span class="line">    auth.requestMatchers(<span class="string">&quot;/static/**&quot;</span>).permitAll();</span><br><span class="line">    <span class="comment">//基于权限和基于角色其实差别并不大，使用方式是相同的</span></span><br><span class="line">    auth.anyRequest().hasAnyAuthority(<span class="string">&quot;page:index&quot;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这里是index页面运行所有用户访问</p>
<h3 id="注解开发"><a href="#注解开发" class="headerlink" title="注解开发"></a>注解开发</h3><p>首先需要在配置类（这里是在MVC的配置类上添加，因为这里只针对Controller进行过滤，所有的Controller是由MVC配置类进行注册的，如果需要为Service或其他Bean也启用权限判断，则需要在Security的配置类上添加）上开启：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableMethodSecurity</span>   <span class="comment">//开启方法安全校验</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在就可以在想要进行权限校验的方法上添加注解了，通过添加<code>@PreAuthorize</code>注解，在执行之前判断判断权限，如果没有对应的权限或是对应的角色，将无法访问页面。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasAnyRole(&#x27;user&#x27;, &#x27;&#x27;admin)&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的还有<code>@PostAuthorize</code>注解，但是它是在方法执行之后再进行拦截：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostAuthorize(&quot;hasRole(&#x27;user&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;执行了&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了Controller以外，只要是被Spring托管的Bean都可以使用注解形式来控制权限，可以在任意方法上添加这个注解，只要不具备表达式中指定的访问权限，就无法执行方法并且放回403页面。</p>
<h1 id="固定模板-终"><a href="#固定模板-终" class="headerlink" title="固定模板(终)"></a>固定模板(终)</h1><p>MvcConfiguration</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.DefaultServletHandlerConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.spring6.SpringTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.spring6.view.ThymeleafViewResolver;</span><br><span class="line"><span class="keyword">import</span> org.thymeleaf.templateresolver.ITemplateResolver;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfiguration</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ThymeleafViewResolver <span class="title function_">thymeleafViewResolver</span><span class="params">(SpringTemplateEngine springTemplateEngine)</span>&#123;</span><br><span class="line">        <span class="type">ThymeleafViewResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThymeleafViewResolver</span>();</span><br><span class="line">        resolver.setOrder(<span class="number">1</span>);   <span class="comment">//可以存在多个视图解析器，并且可以为他们设定解析顺序</span></span><br><span class="line">        resolver.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);   <span class="comment">//编码格式是重中之重</span></span><br><span class="line">        resolver.setTemplateEngine(springTemplateEngine);   <span class="comment">//和之前JavaWeb阶段一样，需要使用模板引擎进行解析，所以这里也需要设定一下模板引擎</span></span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置模板解析器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SpringResourceTemplateResolver <span class="title function_">templateResolver</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">SpringResourceTemplateResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringResourceTemplateResolver</span>();</span><br><span class="line">        resolver.setSuffix(<span class="string">&quot;.html&quot;</span>);   <span class="comment">//需要解析的后缀名称</span></span><br><span class="line">        resolver.setPrefix(<span class="string">&quot;classpath:/templates/&quot;</span>);   <span class="comment">//需要解析的HTML页面文件存放的位置，默认是webapp目录下，如果是类路径下需要添加classpath:前缀</span></span><br><span class="line">        resolver.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置模板引擎Bean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SpringTemplateEngine <span class="title function_">springTemplateEngine</span><span class="params">(ITemplateResolver resolver)</span>&#123;</span><br><span class="line">        <span class="type">SpringTemplateEngine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringTemplateEngine</span>();</span><br><span class="line">        engine.setTemplateResolver(resolver);   <span class="comment">//模板解析器，默认即可</span></span><br><span class="line">        <span class="keyword">return</span> engine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span>&#123;</span><br><span class="line">        configurer.enable();   <span class="comment">//开启默认Servlet处理</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/static/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/static/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>CompletableFuture异步编排</title>
    <url>/2025/06/23/articles/Substitute%20driver/CompletableFuture%E5%BC%82%E6%AD%A5%E7%BC%96%E6%8E%92/</url>
    <content><![CDATA[<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><ul>
<li><p>CompletableFuture是java.utils.concurrent里的一个类</p>
</li>
<li><p>作用：把串行执行的代码变为并行执行，提高代码执行速度</p>
</li>
</ul>
<h3 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h3><h4 id="创建异步编排对象"><a href="#创建异步编排对象" class="headerlink" title="创建异步编排对象"></a>创建异步编排对象</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable, Executor executor)</span>;</span><br></pre></td></tr></table></figure>



<h4 id="线程串行方法"><a href="#线程串行方法" class="headerlink" title="线程串行方法"></a>线程串行方法</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使线程串行执行，无入参，无返回值</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenRun</span><span class="params">(Runnable action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenRunAsync</span><span class="params">(Runnable action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenRunAsync</span><span class="params">(Runnable action, Executor executor)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使线程串行执行，有入参，无返回值</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenAccept</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenAcceptAsync</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenAcceptAsync</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action, Executor executor)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使线程串行执行，有入参，有返回值</span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApply</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApplyAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApplyAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn, Executor executor)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="多任务组合"><a href="#多任务组合" class="headerlink" title="多任务组合"></a>多任务组合</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">allOf</span><span class="params">(CompletableFuture&lt;?&gt;... cfs)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletableFutureTest5</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//动态获取服务器核数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">processors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">                processors+<span class="number">1</span>, <span class="comment">// 核心线程个数 io:2n ,cpu: n+1  n:内核数据</span></span><br><span class="line">                processors+<span class="number">1</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">10</span>),</span><br><span class="line">                Executors.defaultThreadFactory(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;String&gt; future01 = CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;任务1&quot;</span>, executor);</span><br><span class="line">        CompletableFuture&lt;String&gt; future02 = CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;任务2&quot;</span>, executor);</span><br><span class="line">        CompletableFuture&lt;String&gt; future03 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;任务3&quot;</span>;</span><br><span class="line">        &#125;, executor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 串联起若干个线程任务, 没有返回值</span></span><br><span class="line">        CompletableFuture&lt;Void&gt; all = CompletableFuture.allOf(future01, future02, future03);</span><br><span class="line">        <span class="comment">// 等待所有线程执行完成</span></span><br><span class="line">        <span class="comment">// .join()和.get()都会阻塞并获取线程的执行情况</span></span><br><span class="line">        <span class="comment">// .join()会抛出未经检查的异常，不会强制开发者处理异常 .get()会抛出检查异常，需要开发者处理</span></span><br><span class="line">        all.join();</span><br><span class="line">        all.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>project</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis-plus 组件策略</title>
    <url>/2025/04/18/articles/Substitute%20driver/mybatis-plus%20%E7%BB%84%E4%BB%B6%E7%AD%96%E7%95%A5/</url>
    <content><![CDATA[<h2 id="默认的组件策略-ASSIGN-ID-雪花算法"><a href="#默认的组件策略-ASSIGN-ID-雪花算法" class="headerlink" title="默认的组件策略 ASSIGN_ID 雪花算法"></a>默认的组件策略 ASSIGN_ID 雪花算法</h2><ul>
<li><p>mp有默认的组件策略 <code>ASSIGN_ID</code>，会生成一个唯一的值，包含数字</p>
</li>
<li><p>雪花算法：使用一个64位的长型的数字作为全局唯一ID</p>
</li>
<li><p>表对应类型 bigint 或者 varchar类型</p>
</li>
</ul>
<h2 id="ASSIGN-UUID"><a href="#ASSIGN-UUID" class="headerlink" title="ASSIGN_UUID"></a>ASSIGN_UUID</h2><ul>
<li><p><code>ASSIGN_ID</code> 还有另一个相近的策略 <code>ASSIGN_UUID</code>，生成唯一的uuid值，包含数字和字母</p>
</li>
<li><p>表对应字段的类型 varchar(32) 类型，实体类字段对应 String</p>
</li>
</ul>
<h2 id="自增策略-AUTO"><a href="#自增策略-AUTO" class="headerlink" title="自增策略 AUTO"></a>自增策略 AUTO</h2><ul>
<li><p>想要主键自增需要配置以下操作</p>
<ul>
<li><p>需要创建表的时候给主键设置自增</p>
</li>
<li><p>实体字段种配置 <code>@TableId(type=IdType.AUTO)</code></p>
</li>
</ul>
</li>
</ul>
<h2 id="INPUT"><a href="#INPUT" class="headerlink" title="INPUT"></a>INPUT</h2><ul>
<li>普遍用法是需要自己手动设置主键ID值，有其他复杂用法，但是看着感觉运用不多，需要的时候再做了解</li>
</ul>
]]></content>
      <tags>
        <tag>project</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis常见的几个问题</title>
    <url>/2025/05/08/articles/Substitute%20driver/Redis%E5%B8%B8%E8%A7%81%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h1 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h1><p>当大量缓存在同一时间失效或者过期，亦或者Redis故障宕机时，如果此时有大量用户数据访问，Redis 无法处理，于是全部请求都会直接访问数据库，导致数据库压力剧增，严重会导致数据库宕机，从而出现更严重的问题</p>
<p>常见解决方法：</p>
<ul>
<li>给各数据设置不相同的过期时间，尽量让他们不要在同一时间过期</li>
<li>设置互斥锁，当发现需要查找的数据在Redis中找不到，就加上一个互斥锁，保证一个时间只有规定的次数查询数据库来构建缓存</li>
<li>如果是宕机，那我们可以用熔断来解决，或者是拒绝服务</li>
</ul>
<h1 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h1><p>缓存击穿跟缓存雪崩很相似，可以认为缓存击穿是缓存雪崩其中之一</p>
<p>如果缓存中某个热点数据过期了，此时大量的数据请求访问了该数据，就无法从缓存中读取，直接访问数据库，数据库很容易被高并发的请求冲垮，这就是缓存击穿问题。</p>
<p>常见解决方法：</p>
<ul>
<li>互斥锁方案，保证同一时间只有一个业务线程更新缓存</li>
<li>不给热点数据设置过期时间，由后台异步更新缓存，或者在热点数据准备要过期前，提前通知后台线程更新缓存以及重新设置过期时间；</li>
</ul>
<h1 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h1><p>当用户访问的数据不存在，导致请求在访问缓存时，发现缓存缺失，再去访问数据库时，发现数据库中也没有要访问的数据，那么此时大量的请求都落在数据库中，导致数据库压力骤增</p>
<p>常见解决方法</p>
<ul>
<li>限制非法请求，进行参数校验，对于不合法的参数请求直接抛出异常返回给客户端。</li>
<li>缓存空值或者默认值，当发现缓存穿透的现象时，可以针对查询的数据，在缓存中设置一个空值或者默认值，这样后续请求就可以从缓存中读取到空值或者默认值，返回给应用，使其不会继续查询数据库</li>
<li>使用布隆过滤器，过滤器说数据不存在，那么数据库中一定不会有这个数据。如果说数据存在，并不一定证明数据库中存在这个数据，有误判的几率，只不过几率非常小。（底层是hash，有极小概率误判）</li>
</ul>
]]></content>
      <tags>
        <tag>project</tag>
      </tags>
  </entry>
  <entry>
    <title>分布式事物锁</title>
    <url>/2025/06/07/articles/Substitute%20driver/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E7%89%A9%E9%94%81/</url>
    <content><![CDATA[<h1 id="分布式锁解决司机抢单"><a href="#分布式锁解决司机抢单" class="headerlink" title="分布式锁解决司机抢单"></a>分布式锁解决司机抢单</h1><p>因为上面写的司机抢单并没有考虑并发，类似于电商的超卖问题</p>
<p>**解决方案</p>
<ul>
<li><p><strong>第一种 设置数据库事务的隔离级别</strong>，设置为Serializable，效率低下</p>
</li>
<li><p><strong>第二种 使用乐观锁解决</strong>，通过版本号进行控制</p>
</li>
<li><p><strong>第三种  加锁解决</strong>，学习过synchronized 及lock锁，本地锁，目前微服务架构，分布式部署方式。</p>
</li>
</ul>
<h2 id="本地锁的局限性"><a href="#本地锁的局限性" class="headerlink" title="本地锁的局限性"></a>本地锁的局限性</h2><ul>
<li>我们使用锁一般都是，synchronized 及lock锁，这些都是本地锁，只在当前jvm生效，在微服务里面就是只有当个微服务生效</li>
<li>举例演示<br>TestController<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Tag(name = &quot;测试接口&quot;)</span>  </span><br><span class="line"><span class="meta">@RestController</span>  </span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> TestService testService;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@GetMapping(&quot;testLock&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">testLock</span><span class="params">()</span> &#123;  </span><br><span class="line">        testService.testLock();  </span><br><span class="line">        <span class="keyword">return</span> Result.ok();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>TestServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">TestService</span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="comment">//从redis里面获取数据  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(value)) &#123;  </span><br><span class="line">            <span class="keyword">return</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//把从redis获取数据+1  </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//数据+1之后放回到redis里面  </span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>,String.valueOf(++num));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>测试，模拟200个请求并发过程</p>
</li>
<li><p>在redis添加初始值，num &#x3D; 0</p>
</li>
</ul>
<p>使用测试工具 <code>jmeter</code> 实现功能测试</p>
<p>![[Pasted image 20250605203137.png]]<br>![[Pasted image 20250605203153.png]]</p>
<p>加上锁 synchronized 后是没有问题</p>
<ul>
<li>上面的测试方式是在一个服务内进行的，单机测试，但是如果部署到集群下这个锁不一定会生效</li>
</ul>
<h2 id="实现分布式锁-redis"><a href="#实现分布式锁-redis" class="headerlink" title="实现分布式锁-redis"></a>实现分布式锁-redis</h2><p>设置过期时间，到时间之后自动释放锁</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">//从redis里面获取数据</span></span><br><span class="line">	<span class="comment">//1 获取当前锁  setnx</span></span><br><span class="line">	<span class="type">Boolean</span> <span class="variable">ifAbsent</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, <span class="string">&quot;lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2 如果获取到锁，从redis获取数据 数据+1 放回redis里面</span></span><br><span class="line">	<span class="keyword">if</span>(ifAbsent) &#123;</span><br><span class="line">		<span class="comment">//获取锁成功，执行业务代码</span></span><br><span class="line">		<span class="comment">//1.先从redis中通过key num获取值  key提前手动设置 num 初始值：0</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);</span><br><span class="line">		<span class="comment">//2.如果值为空则非法直接返回即可</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(value)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//3.对num值进行自增加一</span></span><br><span class="line">		<span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value);</span><br><span class="line">		redisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>, String.valueOf(++num));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//3 释放锁</span></span><br><span class="line">		redisTemplate.delete(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">100</span>);</span><br><span class="line">			<span class="built_in">this</span>.testLock();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题：如果锁的删除时间小于事物的执行时间<br>例如：</p>
<ul>
<li>场景：如果业务逻辑执行的时间是7s</li>
<li>index1业务逻辑没执行完，3秒后释放</li>
<li>index2获取到锁，执行业务逻辑，3秒后锁会被自动释放</li>
<li>index3获取到锁，执行业务逻辑</li>
<li>index1业务逻辑完成，开始调用del释放锁，这是释放的是index3的锁，导致index3的业务只执行1s就被别人释放</li>
</ul>
<p>修改后的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//uuid防止误删</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//从redis里面获取数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    <span class="comment">//1 获取当前锁  setnx  + 设置过期时间</span></span><br><span class="line">    <span class="comment">//        Boolean ifAbsent = redisTemplate.opsForValue().setIfAbsent(&quot;lock&quot;, &quot;lock&quot;);</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">ifAbsent</span> <span class="operator">=</span></span><br><span class="line">            redisTemplate.opsForValue()</span><br><span class="line">                    .setIfAbsent(<span class="string">&quot;lock&quot;</span>, uuid,<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 如果获取到锁，从redis获取数据 数据+1 放回redis里面</span></span><br><span class="line">    <span class="keyword">if</span>(ifAbsent) &#123;</span><br><span class="line">        <span class="comment">//获取锁成功，执行业务代码</span></span><br><span class="line">        <span class="comment">//1.先从redis中通过key num获取值  key提前手动设置 num 初始值：0</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);</span><br><span class="line">        <span class="comment">//2.如果值为空则非法直接返回即可</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(value)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.对num值进行自增加一</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value);</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>, String.valueOf(++num));</span><br><span class="line">        <span class="comment">//出现异常</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 释放锁</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redisUuid</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(uuid.equals(redisUuid)) &#123;</span><br><span class="line">            redisTemplate.delete(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            <span class="built_in">this</span>.testLock();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过LUA脚本保证原子性"><a href="#通过LUA脚本保证原子性" class="headerlink" title="通过LUA脚本保证原子性"></a>通过LUA脚本保证原子性</h3><p>通过uuid防止误删，但是还是有问题，不具备原子性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">//从redis里面获取数据</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">	<span class="comment">//1 获取当前锁  setnx  + 设置过期时间</span></span><br><span class="line">	<span class="comment">//        Boolean ifAbsent = redisTemplate.opsForValue().setIfAbsent(&quot;lock&quot;, &quot;lock&quot;);</span></span><br><span class="line">	<span class="type">Boolean</span> <span class="variable">ifAbsent</span> <span class="operator">=</span></span><br><span class="line">			redisTemplate.opsForValue()</span><br><span class="line">					.setIfAbsent(<span class="string">&quot;lock&quot;</span>, uuid,<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2 如果获取到锁，从redis获取数据 数据+1 放回redis里面</span></span><br><span class="line">	<span class="keyword">if</span>(ifAbsent) &#123;</span><br><span class="line">		<span class="comment">//获取锁成功，执行业务代码</span></span><br><span class="line">		<span class="comment">//1.先从redis中通过key num获取值  key提前手动设置 num 初始值：0</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);</span><br><span class="line">		<span class="comment">//2.如果值为空则非法直接返回即可</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(value)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//3.对num值进行自增加一</span></span><br><span class="line">		<span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value);</span><br><span class="line">		redisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>, String.valueOf(++num));</span><br><span class="line">		<span class="comment">//出现异常</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//3 释放锁 lua脚本实现</span></span><br><span class="line">		DefaultRedisScript&lt;Long&gt; redisScript = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">		<span class="comment">// lua脚本</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(\&quot;get\&quot;,KEYS[1]) == ARGV[1]\n&quot;</span> +</span><br><span class="line">				<span class="string">&quot;then\n&quot;</span> +</span><br><span class="line">				<span class="string">&quot;    return redis.call(\&quot;del\&quot;,KEYS[1])\n&quot;</span> +</span><br><span class="line">				<span class="string">&quot;else\n&quot;</span> +</span><br><span class="line">				<span class="string">&quot;    return 0\n&quot;</span> +</span><br><span class="line">				<span class="string">&quot;end&quot;</span>;</span><br><span class="line">		redisScript.setScriptText(script);</span><br><span class="line">		<span class="comment">// 设置返回结果</span></span><br><span class="line">		redisScript.setResultType(Long.class);</span><br><span class="line">		redisTemplate.execute(redisScript, Arrays.asList(<span class="string">&quot;lock&quot;</span>), uuid);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">100</span>);</span><br><span class="line">			<span class="built_in">this</span>.testLock();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>1、加锁</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1. 从Redis中获取锁,set k1 v1 px 20000 nx</span></span><br><span class="line"><span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"><span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.redisTemplate.opsForValue()</span><br><span class="line">      .setIfAbsent(<span class="string">&quot;lock&quot;</span>, uuid, <span class="number">2</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<p>2、使用lua释放锁</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 2. 释放锁 del</span></span><br><span class="line"><span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line"><span class="comment">// 设置lua脚本返回的数据类型</span></span><br><span class="line">DefaultRedisScript&lt;Long&gt; redisScript = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// 设置lua脚本返回类型为Long</span></span><br><span class="line">redisScript.setResultType(Long.class);</span><br><span class="line">redisScript.setScriptText(script);</span><br><span class="line">redisTemplate.execute(redisScript, Arrays.asList(<span class="string">&quot;lock&quot;</span>),uuid);</span><br></pre></td></tr></table></figure>

<p>3、重试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Thread.sleep(<span class="number">500</span>); </span><br><span class="line">testLock();</span><br></pre></td></tr></table></figure>

<p>为了确保分布式锁可用，我们至少要确保锁的实现同时满足以下四个条件：</p>
<p><strong>第一个：互斥性</strong>，在任何时刻，只有一个客户端能持有锁。</p>
<p><strong>第二个：不会发生死锁</strong>，即使有一个客户端在获取锁操作时候崩溃了，也能保证其他客户端能获取到锁。</p>
<p><strong>第三个：解铃还须系铃人</strong>，解锁加锁必须同一个客户端操作。</p>
<p><strong>第四个：加锁和解锁必须具备原子性</strong></p>
<h2 id="实现分布式锁-Redisson"><a href="#实现分布式锁-Redisson" class="headerlink" title="实现分布式锁-Redisson"></a>实现分布式锁-Redisson</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a><strong>引入依赖</strong></h4><p>在common里service-utils引入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="创建Redisson配置类"><a href="#创建Redisson配置类" class="headerlink" title="创建Redisson配置类"></a><strong>创建Redisson配置类</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span>  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.data.redis&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String host;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String password;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String port;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="number">3000</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ADDRESS_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;redis://&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    RedissonClient <span class="title function_">redissonSingle</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.hasText(host))&#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;host is  empty&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">serverConfig</span> <span class="operator">=</span> config.useSingleServer()  </span><br><span class="line">                .setAddress(ADDRESS_PREFIX + <span class="built_in">this</span>.host + <span class="string">&quot;:&quot;</span> + port)  </span><br><span class="line">                .setTimeout(<span class="built_in">this</span>.timeout);  </span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(<span class="built_in">this</span>.password)) &#123;  </span><br><span class="line">            serverConfig.setPassword(<span class="built_in">this</span>.password);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="在业务方法编写加锁和解锁"><a href="#在业务方法编写加锁和解锁" class="headerlink" title="在业务方法编写加锁和解锁"></a><strong>在业务方法编写加锁和解锁</strong></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Redisson实现  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;  </span><br><span class="line"></span><br><span class="line">	<span class="comment">// 通过redisson创建锁对象  </span></span><br><span class="line">	<span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock1&quot;</span>);  </span><br><span class="line"></span><br><span class="line">	<span class="comment">// 尝试获取锁  </span></span><br><span class="line">	<span class="comment">// 阻塞一直等待直到获取到，获取锁之后设置锁的超时时间为10秒，没有参数默认是30秒  </span></span><br><span class="line">	lock.lock(<span class="number">10</span>, TimeUnit.SECONDS);  </span><br><span class="line"></span><br><span class="line">	<span class="comment">// tryLock，设置等待时间为30秒，超时时间为10秒  </span></span><br><span class="line"><span class="comment">//        try &#123;  </span></span><br><span class="line"><span class="comment">//            boolean b = lock.tryLock(30, 10, TimeUnit.SECONDS);  </span></span><br><span class="line"><span class="comment">//        &#125; catch (InterruptedException e) &#123;  </span></span><br><span class="line"><span class="comment">//            throw new RuntimeException(e);  </span></span><br><span class="line"><span class="comment">//        &#125;  </span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//编写业务代码  </span></span><br><span class="line">	<span class="comment">//1.先从redis中通过key num获取值  key提前手动设置 num 初始值：0  </span></span><br><span class="line">	<span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);  </span><br><span class="line">	<span class="comment">//2.如果值为空则非法直接返回即可  </span></span><br><span class="line">	<span class="keyword">if</span> (StringUtils.isBlank(value)) &#123;  </span><br><span class="line">		<span class="keyword">return</span>;  </span><br><span class="line">	&#125;  </span><br><span class="line">	<span class="comment">//3.对num值进行自增加一  </span></span><br><span class="line">	<span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value);  </span><br><span class="line">	redisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>, String.valueOf(++num));  </span><br><span class="line"></span><br><span class="line">	<span class="comment">//释放锁  </span></span><br><span class="line">	lock.unlock();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="看门狗原理"><a href="#看门狗原理" class="headerlink" title="看门狗原理"></a>看门狗原理</h3><p>只要线程加锁成功，就会启动一个<code>watch dog</code>看门狗，它是一个后台进程，每隔十秒检查一下，如果线程还持有锁，那么就会不断延长锁<code>key</code>的生存时间，因此可以解决锁过期释放，业务还没完成的问题</p>
<ul>
<li>若使用 <code>tryLock()</code> 方法并指定了租约时间，则不会启动看门狗</li>
<li>如果我们未指定超时时间，就会使用 <code>lockwatchdogTimeout = 30 * 1000</code></li>
</ul>
]]></content>
      <tags>
        <tag>project</tag>
      </tags>
  </entry>
  <entry>
    <title>莫名其妙的报错</title>
    <url>/2025/05/03/articles/Substitute%20driver/%E8%8E%AB%E5%90%8D%E5%85%B6%E5%A6%99%E7%9A%84%E6%8A%A5%E9%94%99/</url>
    <content><![CDATA[<p>太吓人了可恶，今天写完运行的时候报了两个错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\Desktop\hhsqdmz\Project\Substitute driver\代码\daijia-parent\service-client\service-map-client\src\main\java\com\atguigu\daijia\map\client\MapFeignClient.java:19:5</span><br><span class="line">java: 找不到符号</span><br><span class="line">  符号:   类 Result</span><br><span class="line">  位置: 接口 com.atguigu.daijia.map.client.MapFeignClient</span><br><span class="line"></span><br><span class="line">D:\Desktop\hhsqdmz\Project\Substitute driver\代码\daijia-parent\service-client\service-map-client\src\main\java\com\atguigu\daijia\map\client\MapFeignClient.java:3:40 java: 程序包com.atguigu.daijia.common.result不存在</span><br></pre></td></tr></table></figure>

<p>然后我按照报错原因按个排插，看了半天没发现问题，最后我使用了最原始的方法：回溯</p>
<p>我按照步骤挨个回退，一路删删删，最后发现问题居然是ALT+Enter，快速的加入了一个依赖在最外层父项目，然后那个依赖本身就存在，两个相同的依赖导致出错，并且报错原因和真实原因毫不相关</p>
<p>气煞我也！</p>
]]></content>
      <tags>
        <tag>project</tag>
      </tags>
  </entry>
  <entry>
    <title>规则引擎</title>
    <url>/2025/04/30/articles/Substitute%20driver/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/</url>
    <content><![CDATA[<h1 id="规则引擎概述"><a href="#规则引擎概述" class="headerlink" title="规则引擎概述"></a>规则引擎概述</h1><ul>
<li><p>规则引擎，全称为<strong>业务规则管理系统</strong>，英文名为BRMS</p>
</li>
<li><p>就是把业务里经常变动的代码给抽离出来，接收数据输入，解释业务规则，并根据业务规则做出业务决策</p>
</li>
<li><p>主流产品：drools、VisualRules、iLog</p>
</li>
</ul>
<h1 id="drools"><a href="#drools" class="headerlink" title="drools"></a>drools</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>drools是一款由JBoss组织提供的基于Java语言开发的开源规则引擎，可以将复杂且多变的业务规则从硬编码中解放出来，以规则脚本的形式存放在文件或特定的存储介质中(例如存放在数据库中)，使得业务规则的变更不需要修改项目代码、重启服务器就可以在线上环境立即生效。</p>
<p>drools官网地址：<a href="https://drools.org/">https://drools.org/</a></p>
<p>drools源码下载地址：<a href="https://github.com/kiegroup/drools">https://github.com/kiegroup/drools</a></p>
<h2 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h2><h3 id="创建spring-boot工程"><a href="#创建spring-boot工程" class="headerlink" title="创建spring boot工程"></a>创建spring boot工程</h3><h3 id="引入drools依赖"><a href="#引入drools依赖" class="headerlink" title="引入drools依赖"></a>引入drools依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">drools.version</span>&gt;</span>8.41.0.Final<span class="tag">&lt;/<span class="name">drools.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;drools.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-compiler<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;drools.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-decisiontables<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;drools.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-mvel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;drools.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="创建drools配置类"><a href="#创建drools配置类" class="headerlink" title="创建drools配置类"></a>创建drools配置类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DroolsConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">KieServices</span> <span class="variable">kieServices</span> <span class="operator">=</span> KieServices.Factory.get();</span><br><span class="line">    <span class="comment">//制定规则文件的路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RULES_CUSTOMER_RULES_DRL</span> <span class="operator">=</span> <span class="string">&quot;rules/order.drl&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KieContainer <span class="title function_">kieContainer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//获得Kie容器对象</span></span><br><span class="line">        <span class="type">KieFileSystem</span> <span class="variable">kieFileSystem</span> <span class="operator">=</span> kieServices.newKieFileSystem();</span><br><span class="line">        kieFileSystem.write(ResourceFactory.newClassPathResource(RULES_CUSTOMER_RULES_DRL));</span><br><span class="line"></span><br><span class="line">        <span class="type">KieBuilder</span> <span class="variable">kieBuilder</span> <span class="operator">=</span> kieServices.newKieBuilder(kieFileSystem);</span><br><span class="line">        kieBuilder.buildAll();</span><br><span class="line"></span><br><span class="line">        <span class="type">KieModule</span> <span class="variable">kieModule</span> <span class="operator">=</span> kieBuilder.getKieModule();</span><br><span class="line">        <span class="type">KieContainer</span> <span class="variable">kieContainer</span> <span class="operator">=</span> kieServices.newKieContainer(kieModule.getReleaseId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> kieContainer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>定义了一个 <code>KieContainer</code>的<code>Bean</code> ，<code>KieContainer</code>用于通过加载应用程序的<code>/resources</code>文件夹下的规则文件来构建规则引擎。</p>
</li>
<li><p>创建<code>KieFileSystem</code>实例并配置规则引擎并从应用程序的资源目录加载规则的 <code>DRL</code> 文件。</p>
</li>
<li><p>使用<code>KieBuilder</code>实例来构建 <code>drools</code> 模块。我们可以使用KieSerive单例实例来创建 <code>KieBuilder</code> 实例。</p>
</li>
<li><p>最后，使用 <code>KieService</code> 创建一个 <code>KieContainer</code> 并将其配置为 <code>spring bean</code></p>
</li>
</ul>
<h3 id="创建实体类"><a href="#创建实体类" class="headerlink" title="创建实体类"></a>创建实体类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> amount;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getAmount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAmount</span><span class="params">(<span class="type">double</span> amount)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.amount = amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getScore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> score;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setScore</span><span class="params">(<span class="type">double</span> score)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.score = score;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建规则文件"><a href="#创建规则文件" class="headerlink" title="创建规则文件"></a>创建规则文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.hh.order;</span><br><span class="line">import com.hh.bean.Order</span><br><span class="line"></span><br><span class="line">//规则一：100元以下 不加分</span><br><span class="line">rule &quot;order_rule_1&quot;</span><br><span class="line">    when</span><br><span class="line">        $order:Order(amount &lt; 100)</span><br><span class="line">    then</span><br><span class="line">        $order.setScore(0);</span><br><span class="line">        System.out.println(&quot;成功匹配到规则一：100元以下 不加分&quot;);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">//规则二：100元 - 500元 加100分</span><br><span class="line">rule &quot;order_rule_2&quot;</span><br><span class="line">    when</span><br><span class="line">        $order:Order(amount &gt;= 100 &amp;&amp; amount &lt; 500)</span><br><span class="line">    then</span><br><span class="line">         $order.setScore(100);</span><br><span class="line">         System.out.println(&quot;成功匹配到规则二：100元 - 500元 加100分&quot;);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">//规则三：500元 - 1000元 加500分</span><br><span class="line">rule &quot;order_rule_3&quot;</span><br><span class="line">    when</span><br><span class="line">        $order:Order(amount &gt;= 500 &amp;&amp; amount &lt; 1000)</span><br><span class="line">    then</span><br><span class="line">         $order.setScore(500);</span><br><span class="line">         System.out.println(&quot;成功匹配到规则三：500元 - 1000元 加500分&quot;);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">//规则四：1000元以上 加1000分</span><br><span class="line">rule &quot;order_rule_4&quot;</span><br><span class="line">    when</span><br><span class="line">        $order:Order(amount &gt;= 1000)</span><br><span class="line">    then</span><br><span class="line">         $order.setScore(1000);</span><br><span class="line">         System.out.println(&quot;成功匹配到规则四：1000元以上 加1000分&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DroolsDemosApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KieContainer kieContainer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//从Kie容器对象中获取会话对象</span></span><br><span class="line">        <span class="type">KieSession</span> <span class="variable">session</span> <span class="operator">=</span> kieContainer.newKieSession();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Fact对象，事实对象</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">        order.setAmount(<span class="number">1300</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将Order对象插入到工作内存中</span></span><br><span class="line">        session.insert(order);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//激活规则，由Drools框架自动进行规则匹配，如果规则匹配成功，则执行当前规则</span></span><br><span class="line">        session.fireAllRules();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭会话</span></span><br><span class="line">        session.dispose();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;订单金额：&quot;</span> + order.getAmount() + <span class="string">&quot;，添加积分：&quot;</span> + order.getScore());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用drools规则引擎主要工作就是编写规则文件，在规则文件中定义跟业务相关的业务规则。规则定义好后就需要调用drools提供的API将数据提供给规则引擎进行规则模式匹配，规则引擎会执行匹配成功的规则并将计算的结果返回</li>
<li>使用规则引擎时业务规则可以做到动态管理，可以做到不重启服务情况下做调整</li>
</ul>
<h1 id="规则引擎构成"><a href="#规则引擎构成" class="headerlink" title="规则引擎构成"></a>规则引擎构成</h1><p>drools规则引擎由以下三部分构成：</p>
<ul>
<li>Working Memory（工作内存）</li>
<li>Rule Base（规则库）</li>
<li>Inference Engine（推理引擎）</li>
</ul>
<p>其中Inference Engine（推理引擎）又包括：</p>
<ul>
<li>Pattern Matcher（匹配器）     &#x2F;&#x2F; 具体匹配哪一个规则，由这个完成</li>
<li>Agenda(议程)</li>
<li>Execution Engine（执行引擎）</li>
</ul>
<p><strong>Working Memory</strong>：工作内存，drools规则引擎会从Working Memory中获取数据并和规则文件中定义的规则进行模式匹配，所以我们开发的应用程序只需要将我们的数据插入到Working Memory中即可，例如上面调用kieSession.insert(order)就是将order对象插入到了工作内存中。</p>
<p><strong>Fact</strong>：事实，是指在drools 规则应用当中，将一个<strong>普通的JavaBean插入到Working Memory后的对象</strong>就是Fact对象，例如本案例中的Order对象就属于Fact对象。</p>
<p><strong>Rule Base</strong>：规则库，我们在规则文件中定义的规则都会被加载到规则库中。</p>
<p><strong>Pattern Matcher</strong>：匹配器，将Rule Base中的所有规则与Working Memory中的Fact对象进行模式匹配，匹配成功的规则将被激活并放入Agenda（议程）中。</p>
<p><strong>Agenda</strong>：议程，用于存放通过匹配器进行模式匹配后被激活的规则。</p>
<p><strong>Execution Engine</strong>：执行引擎，执行Agenda中被激活的规则。</p>
<h1 id="Drools-基础语法"><a href="#Drools-基础语法" class="headerlink" title="Drools 基础语法"></a>Drools 基础语法</h1><h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><table>
<thead>
<tr>
<th>关键字</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>package</td>
<td>包名，只限于逻辑上的管理，同一个包名下的查询或者函数可以直接调用</td>
</tr>
<tr>
<td>import</td>
<td>用于导入类或者静态方法</td>
</tr>
<tr>
<td>global</td>
<td>全局变量</td>
</tr>
<tr>
<td>function</td>
<td>自定义函数</td>
</tr>
<tr>
<td>query</td>
<td>查询</td>
</tr>
<tr>
<td>rule end</td>
<td>规则体</td>
</tr>
<tr>
<td>Drools 支持的规则文件除了drl格式，还有Excel文件类型</td>
<td></td>
</tr>
</tbody></table>
<h2 id="规则体语法"><a href="#规则体语法" class="headerlink" title="规则体语法"></a>规则体语法</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rule &quot;ruleName&quot;</span><br><span class="line">    attributes</span><br><span class="line">    when</span><br><span class="line">        LHS </span><br><span class="line">    then</span><br><span class="line">        RHS</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p><strong>rule</strong>：关键字，表示规则开始，参数为规则的唯一名称。</p>
<p><strong>attributes</strong>：规则属性，是rule与when之间的参数，为可选项。</p>
<p><strong>when</strong>：关键字，后面跟规则的条件部分。</p>
<p><strong>LHS</strong>(Left Hand Side)：是规则的条件部分的通用名称。它由零个或多个条件元素组成。<strong>如果LHS为空，则它将被视为始终为true的条件元素</strong>。  （左手边）</p>
<p><strong>then</strong>：关键字，后面跟规则的结果部分。</p>
<p><strong>RHS</strong>(Right Hand Side)：是规则的后果或行动部分的通用名称。 （右手边）</p>
<p><strong>end</strong>：关键字，表示一个规则结束。</p>
<h2 id="Pattern-模式匹配"><a href="#Pattern-模式匹配" class="headerlink" title="Pattern 模式匹配"></a>Pattern 模式匹配</h2><p>Drools中的匹配器可以将Rule Base中的所有规则与Working Memory中的Fact对象进行模式匹配，条件就叫做Pattern</p>
<p><strong>pattern的语法结构为：绑定变量名:Object(Field约束)</strong></p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//规则一：100元以下 不加分</span><br><span class="line">rule &quot;order_rule_1&quot;</span><br><span class="line">    when</span><br><span class="line">        $order:Order(amount &lt; 100)</span><br><span class="line">    then</span><br><span class="line">        $order.setScore(0);</span><br><span class="line">        System.out.println(&quot;成功匹配到规则一：100元以下 不加分&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>通过上面的例子可以知道，匹配的条件为：</p>
<p>1、$order对应对象是一个Order这种类型的Fact对象—–类型约束</p>
<p>2、Fact对象的amount属性值必须小于100——属性约束</p>
<p>以上条件必须同时满足当前规则才有可能被激活。</p>
<h2 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h2><table>
<thead>
<tr>
<th align="left">符号</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">contains</td>
<td align="left">检查一个Fact对象的某个属性值是否包含一个指定的对象值</td>
</tr>
<tr>
<td align="left">not contains</td>
<td align="left">检查一个Fact对象的某个属性值是否不包含一个指定的对象值</td>
</tr>
<tr>
<td align="left">memberOf</td>
<td align="left">判断一个Fact对象的某个属性是否在一个或多个集合中</td>
</tr>
<tr>
<td align="left">not memberOf</td>
<td align="left">判断一个Fact对象的某个属性是否不在一个或多个集合中</td>
</tr>
<tr>
<td align="left">matches</td>
<td align="left">判断一个Fact对象的属性是否与提供的标准的Java正则表达式进行匹配</td>
</tr>
<tr>
<td align="left">not matches</td>
<td align="left">判断一个Fact对象的属性是否不与提供的标准的Java正则表达式进行匹配</td>
</tr>
</tbody></table>
<h2 id="Drools内置方法"><a href="#Drools内置方法" class="headerlink" title="Drools内置方法"></a>Drools内置方法</h2><p>规则文件的<code>RHS</code>部分的主要作用是通过<strong>插入，删除或修改工作内存中的Fact数据</strong>，来达到控制规则引擎执行的目的。Drools提供了一些方法可以用来操作工作内存中的数据，<strong>操作完成后规则引擎会重新进行相关规则的匹配，</strong> 原来没有匹配成功的规则在我们修改数据完成后有可能就会匹配成功了。</p>
<h3 id="修改-update"><a href="#修改-update" class="headerlink" title="修改 update"></a>修改 update</h3><p>update方法的作用是更新工作内存中的数据，并让相关的规则重新匹配。**（要避免死循环）</p>
<p>**要注意 <code>;</code>号</p>
<p>以上面的order为例<br>参数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">order.setAmount(<span class="number">30</span>);</span><br></pre></td></tr></table></figure>
<p>规则：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rule &quot;order_rule&quot;</span><br><span class="line">	when</span><br><span class="line">		$order:Order(amount &lt; 100)</span><br><span class="line">	then</span><br><span class="line">		$order.setAmount(150);</span><br><span class="line">		update($order)</span><br><span class="line">		System.out.println(&quot;成功匹配到规则一：100元以下 不加分&quot;);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule &quot;order_rule2&quot;</span><br><span class="line">	when </span><br><span class="line">		$order:Order(amount &gt;= 100 &amp;&amp; amount &lt;= 500)</span><br><span class="line">	then</span><br><span class="line">		$order.setScore(100);</span><br><span class="line">		System.out.println(&quot;成功匹配到规则二：100元 - 500元 加100分&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>


<h3 id="添加-insert"><a href="#添加-insert" class="headerlink" title="添加 insert"></a>添加 insert</h3><p>insert方法的作用是向工作内存中插入数据，并让相关的规则重新匹配。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rule &quot;order_rule&quot;</span><br><span class="line">	when</span><br><span class="line">		$order:Order(amount &lt; 100)</span><br><span class="line">	then</span><br><span class="line">		Order order = new Order();</span><br><span class="line">		order.setAmount(30);</span><br><span class="line">		insert($order)</span><br><span class="line">		System.out.println(&quot;成功匹配到规则一：100元以下 不加分&quot;);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule &quot;order_rule2&quot;</span><br><span class="line">	when </span><br><span class="line">		$order:Order(amount &gt;= 100 &amp;&amp; amount &lt;= 500)</span><br><span class="line">	then</span><br><span class="line">		$order.setScore(100);</span><br><span class="line">		System.out.println(&quot;成功匹配到规则二：100元 - 500元 加100分&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="删除-retract"><a href="#删除-retract" class="headerlink" title="删除 retract"></a>删除 retract</h3><p>retract方法的作用是删除工作内存中的数据，并让相关的规则重新匹配。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rule &quot;order_rule_1&quot;</span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &lt; 100)</span><br><span class="line">    then</span><br><span class="line">        retract($order)      //retract方法的作用是删除工作内存中的Fact对象，会导致相关规则重新匹配</span><br><span class="line">        System.out.println(&quot;成功匹配到规则一：100元以下 不加分&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="规则属性"><a href="#规则属性" class="headerlink" title="规则属性"></a>规则属性</h2><table>
<thead>
<tr>
<th align="left">属性名</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">salience</td>
<td align="left">指定规则执行优先级</td>
</tr>
<tr>
<td align="left">dialect</td>
<td align="left">指定规则使用的语言类型，取值为java和mvel</td>
</tr>
<tr>
<td align="left">enabled</td>
<td align="left">指定规则是否启用</td>
</tr>
<tr>
<td align="left">date-effective</td>
<td align="left">指定规则生效时间</td>
</tr>
<tr>
<td align="left">date-expires</td>
<td align="left">指定规则失效时间</td>
</tr>
<tr>
<td align="left">activation-group</td>
<td align="left">激活分组，具有相同分组名称的规则只能有一个规则触发</td>
</tr>
<tr>
<td align="left">agenda-group</td>
<td align="left">议程分组，只有获取焦点的组中的规则才有可能触发</td>
</tr>
<tr>
<td align="left">timer</td>
<td align="left">定时器，指定规则触发的时间</td>
</tr>
<tr>
<td align="left">auto-focus</td>
<td align="left">自动获取焦点，一般结合agenda-group一起使用</td>
</tr>
<tr>
<td align="left">no-loop</td>
<td align="left">防止死循环</td>
</tr>
</tbody></table>
<h3 id="salience"><a href="#salience" class="headerlink" title="salience"></a>salience</h3><ul>
<li>salience属性用于指定规则的执行优先级，<strong>取值类型为Integer</strong>。<strong>数值越大越优先执行</strong>。每个规则都有一个默认的执行顺序，<strong>如果不设置salience属性，规则体的执行顺序为由上到下</strong>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.order</span><br><span class="line"></span><br><span class="line">rule &quot;rule_1&quot;</span><br><span class="line">	salience 9</span><br><span class="line">    when</span><br><span class="line">        eval(true)</span><br><span class="line">    then</span><br><span class="line">        System.out.println(&quot;规则rule_1触发&quot;);</span><br><span class="line">end</span><br><span class="line">    </span><br><span class="line">rule &quot;rule_2&quot;</span><br><span class="line">	salience 10</span><br><span class="line">    when</span><br><span class="line">        eval(true)</span><br><span class="line">    then</span><br><span class="line">        System.out.println(&quot;规则rule_2触发&quot;);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule &quot;rule_3&quot;</span><br><span class="line">	salience 7</span><br><span class="line">    when</span><br><span class="line">        eval(true)</span><br><span class="line">    then</span><br><span class="line">        System.out.println(&quot;规则rule_3触发&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h3 id="no-loop"><a href="#no-loop" class="headerlink" title="no-loop"></a>no-loop</h3><ul>
<li><p>no-loop属性用于防止死循环，当规则通过update之类的函数修改了Fact对象时，可能使当前规则再次被激活从而导致死循环。取值类型为Boolean，默认值为false</p>
</li>
<li><p><strong>引擎默认不会重复触发同一规则​</strong><br>​例如这个例子，修改了与规则无关的值然后再次进入相同的规则，规则不会再次触发</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rule &quot;order_rule_1&quot;</span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &lt; 100)</span><br><span class="line">    then</span><br><span class="line">        $order.setScore(0);</span><br><span class="line">        update($order)</span><br><span class="line">        System.out.println(&quot;成功匹配到规则一：100元以下 不加分&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure></li>
</ul>
<p>想要实现死循环应该修改与规则有关的值，如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rule &quot;order_rule_1&quot;</span><br><span class="line">    when</span><br><span class="line">        $order:Order(amount &lt; 100)</span><br><span class="line">    then</span><br><span class="line">        $order.setAmount(0);</span><br><span class="line">        update($order)</span><br><span class="line">        System.out.println(&quot;成功匹配到规则一：100元以下 不加分&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<ul>
<li>避免死循环：<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rule &quot;order_rule_1&quot;</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        $order:Order(amount &lt; 100)</span><br><span class="line">    then</span><br><span class="line">        $order.setAmount(0);</span><br><span class="line">        update($order)</span><br><span class="line">        System.out.println(&quot;成功匹配到规则一：100元以下 不加分&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="高级语法"><a href="#高级语法" class="headerlink" title="高级语法"></a>高级语法</h2><table>
<thead>
<tr>
<th align="left">关键字</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">package</td>
<td align="left">包名，只限于逻辑上的管理，同一个包名下的查询或者函数可以直接调用</td>
</tr>
<tr>
<td align="left">import</td>
<td align="left">用于导入类或者静态方法</td>
</tr>
<tr>
<td align="left">global</td>
<td align="left">全局变量</td>
</tr>
<tr>
<td align="left">function</td>
<td align="left">自定义函数</td>
</tr>
<tr>
<td align="left">query</td>
<td align="left">查询</td>
</tr>
<tr>
<td align="left">rule end</td>
<td align="left">规则体</td>
</tr>
</tbody></table>
<h3 id="global全局变量"><a href="#global全局变量" class="headerlink" title="global全局变量"></a>global全局变量</h3><ul>
<li><p>global关键字用于在规则文件中<strong>定义全局变量</strong>，它可以让应用程序的对象在规则文件中能够被访问。可以用来为规则文件提供数据或服务。</p>
</li>
<li><p>语法结构为：<strong>global 对象类型 对象名称</strong></p>
</li>
<li><p>注意：</p>
<ul>
<li>如果对象类型为<strong>包装类型</strong>时，在一个规则中改变了global的值，那么<strong>只针对当前规则有效</strong>，对其他规则中的global不会有影响。可以理解为它是当前规则代码中的global副本，规则内部修改不会影响全局的使用。</li>
<li>如果对象类型为<strong>集合类型或JavaBean</strong>时，在一个规则中改变了global的值，对java代码和所有规则都有效。</li>
</ul>
</li>
</ul>
<p>规则文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.hh.order</span><br><span class="line">import com.hh.bean.Order</span><br><span class="line"></span><br><span class="line">global com.hh.bean.Order order_global;</span><br><span class="line"></span><br><span class="line">//规则一：100元以下 不加分</span><br><span class="line">rule &quot;order_rule_1&quot;</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        $order:Order(amount &lt; 100)</span><br><span class="line">    then</span><br><span class="line">        order_global.setScore(10);</span><br><span class="line">        update($order)</span><br><span class="line">        System.out.println(&quot;成功匹配到规则一：100元以下 不加分&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>


<p>测试：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test1()&#123;</span><br><span class="line">    //从Kie容器对象中获取会话对象</span><br><span class="line">    KieSession session = kieContainer.newKieSession();</span><br><span class="line"></span><br><span class="line">    //Fact对象，事实对象</span><br><span class="line">    Order order = new Order();</span><br><span class="line">    order.setAmout(30);</span><br><span class="line"></span><br><span class="line">    //全局变量</span><br><span class="line">    Order order2 = new Order();</span><br><span class="line">    session.setGlobal(&quot;order_global&quot;, order2);</span><br><span class="line"></span><br><span class="line">    //将Order对象插入到工作内存中</span><br><span class="line">    session.insert(order);</span><br><span class="line"></span><br><span class="line">    //激活规则，由Drools框架自动进行规则匹配，如果规则匹配成功，则执行当前规则</span><br><span class="line">    session.fireAllRules();</span><br><span class="line">    //关闭会话</span><br><span class="line">    session.dispose();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;订单金额：&quot; + order.getAmout());</span><br><span class="line">    System.out.println(&quot;添加积分：&quot; + order2.getScore());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









































































]]></content>
      <tags>
        <tag>project</tag>
      </tags>
  </entry>
  <entry>
    <title>快速上手xxl-job</title>
    <url>/2025/05/31/articles/Substitute%20driver/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8Bxxl-job/</url>
    <content><![CDATA[<h2 id="XXL-JOB入门案例"><a href="#XXL-JOB入门案例" class="headerlink" title="XXL-JOB入门案例"></a>XXL-JOB入门案例</h2><h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p>下载XXL-JOB示例代码，解压，使用idea打开</p>
<p>**项目组成：</p>
<ul>
<li>admin：调度中心</li>
<li>core：公共依赖</li>
<li>sample<ul>
<li>sample-frameless：不带框架的</li>
<li>sample-springboot：带springboot框架的</li>
</ul>
</li>
</ul>
<h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><p><strong>创建XXL-JOB使用数据库和相关表</strong></p>
<p>在示例代码文件里面doc文件夹下的db里面有相关的sql语句，直接拉到数据库即可</p>
<p>代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#  </span><br><span class="line"># XXL-JOB v2.3.0  </span><br><span class="line"># Copyright (c) 2015-present, xuxueli.  </span><br><span class="line">  </span><br><span class="line">CREATE database if NOT EXISTS `xxl_job` default character set utf8mb4 collate utf8mb4_unicode_ci;  </span><br><span class="line">use `xxl_job`;  </span><br><span class="line">  </span><br><span class="line">SET NAMES utf8mb4;  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE `xxl_job_info` (  </span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `job_group` int(11) NOT NULL COMMENT &#x27;执行器主键ID&#x27;,  </span><br><span class="line">  `job_desc` varchar(255) NOT NULL,  </span><br><span class="line">  `add_time` datetime DEFAULT NULL,  </span><br><span class="line">  `update_time` datetime DEFAULT NULL,  </span><br><span class="line">  `author` varchar(64) DEFAULT NULL COMMENT &#x27;作者&#x27;,  </span><br><span class="line">  `alarm_email` varchar(255) DEFAULT NULL COMMENT &#x27;报警邮件&#x27;,  </span><br><span class="line">  `schedule_type` varchar(50) NOT NULL DEFAULT &#x27;NONE&#x27; COMMENT &#x27;调度类型&#x27;,  </span><br><span class="line">  `schedule_conf` varchar(128) DEFAULT NULL COMMENT &#x27;调度配置，值含义取决于调度类型&#x27;,  </span><br><span class="line">  `misfire_strategy` varchar(50) NOT NULL DEFAULT &#x27;DO_NOTHING&#x27; COMMENT &#x27;调度过期策略&#x27;,  </span><br><span class="line">  `executor_route_strategy` varchar(50) DEFAULT NULL COMMENT &#x27;执行器路由策略&#x27;,  </span><br><span class="line">  `executor_handler` varchar(255) DEFAULT NULL COMMENT &#x27;执行器任务handler&#x27;,  </span><br><span class="line">  `executor_param` varchar(512) DEFAULT NULL COMMENT &#x27;执行器任务参数&#x27;,  </span><br><span class="line">  `executor_block_strategy` varchar(50) DEFAULT NULL COMMENT &#x27;阻塞处理策略&#x27;,  </span><br><span class="line">  `executor_timeout` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;任务执行超时时间，单位秒&#x27;,  </span><br><span class="line">  `executor_fail_retry_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;失败重试次数&#x27;,  </span><br><span class="line">  `glue_type` varchar(50) NOT NULL COMMENT &#x27;GLUE类型&#x27;,  </span><br><span class="line">  `glue_source` mediumtext COMMENT &#x27;GLUE源代码&#x27;,  </span><br><span class="line">  `glue_remark` varchar(128) DEFAULT NULL COMMENT &#x27;GLUE备注&#x27;,  </span><br><span class="line">  `glue_updatetime` datetime DEFAULT NULL COMMENT &#x27;GLUE更新时间&#x27;,  </span><br><span class="line">  `child_jobid` varchar(255) DEFAULT NULL COMMENT &#x27;子任务ID，多个逗号分隔&#x27;,  </span><br><span class="line">  `trigger_status` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;调度状态：0-停止，1-运行&#x27;,  </span><br><span class="line">  `trigger_last_time` bigint(13) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;上次调度时间&#x27;,  </span><br><span class="line">  `trigger_next_time` bigint(13) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;下次调度时间&#x27;,  </span><br><span class="line">  PRIMARY KEY (`id`)  </span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE `xxl_job_log` (  </span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `job_group` int(11) NOT NULL COMMENT &#x27;执行器主键ID&#x27;,  </span><br><span class="line">  `job_id` int(11) NOT NULL COMMENT &#x27;任务，主键ID&#x27;,  </span><br><span class="line">  `executor_address` varchar(255) DEFAULT NULL COMMENT &#x27;执行器地址，本次执行的地址&#x27;,  </span><br><span class="line">  `executor_handler` varchar(255) DEFAULT NULL COMMENT &#x27;执行器任务handler&#x27;,  </span><br><span class="line">  `executor_param` varchar(512) DEFAULT NULL COMMENT &#x27;执行器任务参数&#x27;,  </span><br><span class="line">  `executor_sharding_param` varchar(20) DEFAULT NULL COMMENT &#x27;执行器任务分片参数，格式如 1/2&#x27;,  </span><br><span class="line">  `executor_fail_retry_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;失败重试次数&#x27;,  </span><br><span class="line">  `trigger_time` datetime DEFAULT NULL COMMENT &#x27;调度-时间&#x27;,  </span><br><span class="line">  `trigger_code` int(11) NOT NULL COMMENT &#x27;调度-结果&#x27;,  </span><br><span class="line">  `trigger_msg` text COMMENT &#x27;调度-日志&#x27;,  </span><br><span class="line">  `handle_time` datetime DEFAULT NULL COMMENT &#x27;执行-时间&#x27;,  </span><br><span class="line">  `handle_code` int(11) NOT NULL COMMENT &#x27;执行-状态&#x27;,  </span><br><span class="line">  `handle_msg` text COMMENT &#x27;执行-日志&#x27;,  </span><br><span class="line">  `alarm_status` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;告警状态：0-默认、1-无需告警、2-告警成功、3-告警失败&#x27;,  </span><br><span class="line">  PRIMARY KEY (`id`),  </span><br><span class="line">  KEY `I_trigger_time` (`trigger_time`),  </span><br><span class="line">  KEY `I_handle_code` (`handle_code`)  </span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE `xxl_job_log_report` (  </span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `trigger_day` datetime DEFAULT NULL COMMENT &#x27;调度-时间&#x27;,  </span><br><span class="line">  `running_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;运行中-日志数量&#x27;,  </span><br><span class="line">  `suc_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行成功-日志数量&#x27;,  </span><br><span class="line">  `fail_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行失败-日志数量&#x27;,  </span><br><span class="line">  `update_time` datetime DEFAULT NULL,  </span><br><span class="line">  PRIMARY KEY (`id`),  </span><br><span class="line">  UNIQUE KEY `i_trigger_day` (`trigger_day`) USING BTREE  </span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE `xxl_job_logglue` (  </span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `job_id` int(11) NOT NULL COMMENT &#x27;任务，主键ID&#x27;,  </span><br><span class="line">  `glue_type` varchar(50) DEFAULT NULL COMMENT &#x27;GLUE类型&#x27;,  </span><br><span class="line">  `glue_source` mediumtext COMMENT &#x27;GLUE源代码&#x27;,  </span><br><span class="line">  `glue_remark` varchar(128) NOT NULL COMMENT &#x27;GLUE备注&#x27;,  </span><br><span class="line">  `add_time` datetime DEFAULT NULL,  </span><br><span class="line">  `update_time` datetime DEFAULT NULL,  </span><br><span class="line">  PRIMARY KEY (`id`)  </span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE `xxl_job_registry` (  </span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `registry_group` varchar(50) NOT NULL,  </span><br><span class="line">  `registry_key` varchar(255) NOT NULL,  </span><br><span class="line">  `registry_value` varchar(255) NOT NULL,  </span><br><span class="line">  `update_time` datetime DEFAULT NULL,  </span><br><span class="line">  PRIMARY KEY (`id`),  </span><br><span class="line">  KEY `i_g_k_v` (`registry_group`,`registry_key`,`registry_value`)  </span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE `xxl_job_group` (  </span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `app_name` varchar(64) NOT NULL COMMENT &#x27;执行器AppName&#x27;,  </span><br><span class="line">  `title` varchar(12) NOT NULL COMMENT &#x27;执行器名称&#x27;,  </span><br><span class="line">  `address_type` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行器地址类型：0=自动注册、1=手动录入&#x27;,  </span><br><span class="line">  `address_list` text COMMENT &#x27;执行器地址列表，多地址逗号分隔&#x27;,  </span><br><span class="line">  `update_time` datetime DEFAULT NULL,  </span><br><span class="line">  PRIMARY KEY (`id`)  </span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE `xxl_job_user` (  </span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,  </span><br><span class="line">  `username` varchar(50) NOT NULL COMMENT &#x27;账号&#x27;,  </span><br><span class="line">  `password` varchar(50) NOT NULL COMMENT &#x27;密码&#x27;,  </span><br><span class="line">  `role` tinyint(4) NOT NULL COMMENT &#x27;角色：0-普通用户、1-管理员&#x27;,  </span><br><span class="line">  `permission` varchar(255) DEFAULT NULL COMMENT &#x27;权限：执行器ID列表，多个逗号分割&#x27;,  </span><br><span class="line">  PRIMARY KEY (`id`),  </span><br><span class="line">  UNIQUE KEY `i_username` (`username`) USING BTREE  </span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;  </span><br><span class="line">  </span><br><span class="line">CREATE TABLE `xxl_job_lock` (  </span><br><span class="line">  `lock_name` varchar(50) NOT NULL COMMENT &#x27;锁名称&#x27;,  </span><br><span class="line">  PRIMARY KEY (`lock_name`)  </span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;  </span><br><span class="line">  </span><br><span class="line">INSERT INTO `xxl_job_group`(`id`, `app_name`, `title`, `address_type`, `address_list`, `update_time`) VALUES (1, &#x27;xxl-job-executor-sample&#x27;, &#x27;示例执行器&#x27;, 0, NULL, &#x27;2018-11-03 22:21:31&#x27; );  </span><br><span class="line">INSERT INTO `xxl_job_info`(`id`, `job_group`, `job_desc`, `add_time`, `update_time`, `author`, `alarm_email`, `schedule_type`, `schedule_conf`, `misfire_strategy`, `executor_route_strategy`, `executor_handler`, `executor_param`, `executor_block_strategy`, `executor_timeout`, `executor_fail_retry_count`, `glue_type`, `glue_source`, `glue_remark`, `glue_updatetime`, `child_jobid`) VALUES (1, 1, &#x27;测试任务1&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;XXL&#x27;, &#x27;&#x27;, &#x27;CRON&#x27;, &#x27;0 0 0 * * ? *&#x27;, &#x27;DO_NOTHING&#x27;, &#x27;FIRST&#x27;, &#x27;demoJobHandler&#x27;, &#x27;&#x27;, &#x27;SERIAL_EXECUTION&#x27;, 0, 0, &#x27;BEAN&#x27;, &#x27;&#x27;, &#x27;GLUE代码初始化&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;&#x27;);  </span><br><span class="line">INSERT INTO `xxl_job_user`(`id`, `username`, `password`, `role`, `permission`) VALUES (1, &#x27;admin&#x27;, &#x27;e10adc3949ba59abbe56e057f20f883e&#x27;, 1, NULL);  </span><br><span class="line">INSERT INTO `xxl_job_lock` ( `lock_name`) VALUES ( &#x27;schedule_lock&#x27;);  </span><br><span class="line">  </span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><p><strong>部署调度中心</strong></p>
<ul>
<li>修改xxl-job-admin项目里面配置文件</li>
</ul>
<p>主要修改数据库</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">### xxl-job, datasource</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>启动调度中心</p>
</li>
<li><p>通过路径访问：<a href="http://localhost:8080/xxl-job-admin">http://localhost:8080/xxl-job-admin</a></p>
</li>
<li><p>默认用户名和密码： admin&#x2F;123456</p>
</li>
</ul>
<h3 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h3><p><strong>部署执行器项目</strong></p>
<ul>
<li><p>导入依赖</p>
</li>
<li><p>修改配置文件，把执行器项目放在调度中心进行注册</p>
</li>
<li><p>创建配置类，获取任务调用过程中需要使用的参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxl.job.executor.core.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xxl-job config</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xuxueli 2017-04-28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">        <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li><p>启动执行器项目</p>
</li>
<li><p>注册到调度中心里面</p>
</li>
</ul>
<h3 id="第五步"><a href="#第五步" class="headerlink" title="第五步"></a>第五步</h3><p><strong>开发执行器项目job方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleXxlJob</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SampleXxlJob.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        XxlJobHelper.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            XxlJobHelper.log(<span class="string">&quot;beat at:&quot;</span> + i);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;atguigu....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// default success</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第六步"><a href="#第六步" class="headerlink" title="第六步"></a>第六步</h3><p><strong>创建任务并启动任务</strong></p>
<p>通过图形化界面进行操作<br>新增任务<br>![[Pasted image 20250531154302.png]]</p>
]]></content>
      <tags>
        <tag>project</tag>
      </tags>
  </entry>
  <entry>
    <title>docker学习记录</title>
    <url>/2024/03/16/articles/docker/docker/</url>
    <content><![CDATA[<h1 id="Docker学习记录"><a href="#Docker学习记录" class="headerlink" title="Docker学习记录"></a>Docker学习记录</h1><p>因为在学习MySQL的时候需要用到多台客户端，如果使用VMware来一个个创建就太过于麻烦，因此我在网上冲浪的时候发现了Docker，Docker是一个 <strong>基于go语言</strong> 的开源应用引擎，通过利用Docker的方法来快速交付，测试和部署代码，可以大大减少编写代码和在生产环境中运行代码之间的延迟。</p>
<h2 id="Docker的安装"><a href="#Docker的安装" class="headerlink" title="Docker的安装"></a>Docker的安装</h2><p>因为我用的是centOS，所以我在这里展示的也是centOS的安装方法<br>注：如果没给权限记得在命令前加sudo<br><br><br>首先，如果之前有安装过docker，无论有没有成功，都先删除一遍：</p>
<blockquote>
<p>yum remove docker \</p>
<blockquote>
<blockquote>
<p>docker-client <br>                  docker-client-latest <br>                  docker-common <br>                  docker-latest <br>                  docker-latest-logrotate <br>                  docker-logrotate <br>                  docker-engine</p>
</blockquote>
</blockquote>
</blockquote>
<p>安装依赖，下载 repo 文件：</p>
<blockquote>
<p>yum install -y yum-utils</p>
</blockquote>
<p>设置软件仓库地址（默认是国外的，不建议）：</p>
<blockquote>
<p>yum-config-manager –add-repo <a href="https://download.docker.com/linux/centos/docker-ce.repo">https://download.docker.com/linux/centos/docker-ce.repo</a></p>
</blockquote>
<p>建议使用阿里云的仓库地址，因为比较快:</p>
<blockquote>
<p>yum-config-manager –add-repo <a href="https://mirrors.aliyum.com/docker-ce/linux/centos/docker-ce.repo">https://mirrors.aliyum.com/docker-ce/linux/centos/docker-ce.repo</a></p>
</blockquote>
<p>在安装前建议更新一下yum软件包</p>
<blockquote>
<p>yum makecache fast</p>
</blockquote>
<p>最后在安装docker-ce(ce指的是社区版，免费，也有ee版是企业版，需要付费)：</p>
<blockquote>
<p>yum install docker-ce docker-ce-cli containerd.io<br> docker-buildx-plugin docker-compose-plugin</p>
</blockquote>
<p>Docker的安装就可以了</p>
<h2 id="Docker的信息"><a href="#Docker的信息" class="headerlink" title="Docker的信息"></a>Docker的信息</h2><p>首先，我们先要启动docker</p>
<blockquote>
<p>systemctl start docker </p>
</blockquote>
<p>我们可以通过 <code>docker version</code> 来查询docker的一些版本信息<br>或者可以用 <code>docker info</code> 来查看docker的一些系统级的信息，比如内核，镜像数，容器数等</p>
<h2 id="hello-world"><a href="#hello-world" class="headerlink" title="hello-world"></a>hello-world</h2><p>一切语言或者其他都有hello world，docker也不例外，真就是精通各种hello world了<br>首先，我们先来查看一下目前已有的镜像</p>
<blockquote>
<p>docker images</p>
</blockquote>
<p>不出意外，显示的是下面几个列标题，没有值<br><img src="/./images.png" class="lazyload" data-srcset="/./images.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片" title="图片标题"><br>然后，我们来执行命令</p>
<blockquote>
<p>docker run hello-world</p>
</blockquote>
<p><img src="/./p2.png" class="lazyload" data-srcset="/./p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片" title="图片标题"><br>运行完后会显示一长串的东西，简单来说就是没有找到这个镜像，然后就去pull，去远程拉取一个镜像，如果输出有 <code>Hello from Docker!</code> 则表示成功<br><br><br>但是，如果没有显示上图那一长串的信息，或者是显示 <code>Redirecting to /bin/systemctl stop docker.servic</code>之类的信息，说明拉取镜像失败了，这时候要考虑设备或者网络的问题。<br>我在做这一步的时候也发生了两次错误，一次是把 <code>docker run hello-world</code> 打错成 <code>docker run hello-word</code>了，另一次是因为原来配置的镜像问题，建议使用阿里云的镜像加速器.</p>
<blockquote>
<p>sudo mkdir -p &#x2F;etc&#x2F;docker<br>sudo tee &#x2F;etc&#x2F;docker&#x2F;daemon.json &lt;&lt;-‘EOF’<br>{<br>  “registry-mirrors”: [“<a href="https://wosslmsh.mirror.aliyuncs.com"]">https://wosslmsh.mirror.aliyuncs.com&quot;]</a><br>}<br>EOF<br>sudo systemctl daemon-reload<br>sudo systemctl restart docker</p>
</blockquote>
<p>完成以上步骤后，再使用 <code>docker images</code> 来查看已有的镜像<br><img src="/./p3.png" class="lazyload" data-srcset="/./p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片" title="图片标题"><br>会发现，多一个”hello-world”镜像，这就是我们刚刚执行 <code>docker run hello-world</code>所拉下来的镜像。<br>如果你想卸载某个镜像，你需要执行：</p>
<blockquote>
<p>1、卸载依赖<br>yum remove docker-ce docker-ce-cli containerd.io<br>2、删除资源<br>rm -rf &#x2F;var&#x2F;lib&#x2F;docker<br>&#x2F;var&#x2F;lib&#x2F;docker 是docker的默认工作路径</p>
</blockquote>
<h1 id="Docker的常用命令"><a href="#Docker的常用命令" class="headerlink" title="Docker的常用命令"></a>Docker的常用命令</h1><h2 id="帮助命令"><a href="#帮助命令" class="headerlink" title="帮助命令"></a>帮助命令</h2><blockquote>
<p>docker version  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#查看客户端和服务端的详细版本信息<br>docker info &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #查看docker的系统信息<br>docker –help &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#帮助查询docker的命令</p>
</blockquote>
<p>docker images&nbsp;查看所有本地的主机上的镜像</p>
<blockquote>
<pre>REPOSITORY      TAG       IMAGE ID       CREATED       SIZE
hello-world   latest    feb5d9fea6a5   2 years ago   13.3kB</pre>
<p><strong>解释</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">REPOSITORY  镜像的仓库源</span><br><span class="line">TAG         镜像的标签</span><br><span class="line">IMAGE ID    镜像的ID</span><br><span class="line">CREATED     镜像的创建时间</span><br><span class="line">SIZE&amp;nbsp   镜像的大小</span><br></pre></td></tr></table></figure>
<p><strong>可选项</strong></p>
<blockquote>
<p>-a, –all             #列出所有的可选项<br>  -q, –quiet           #只显示镜像的ID</p>
</blockquote>
<h2 id="镜像命令"><a href="#镜像命令" class="headerlink" title="镜像命令"></a>镜像命令</h2><p><strong>搜索镜像</strong></p>
<blockquote>
<p>docker search 镜像名<br><img src="/./p4.png" class="lazyload" data-srcset="/./p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片" title="图片标题"></p>
</blockquote>
<p>__可选项__，通过收藏来过滤</p>
<blockquote>
<p>–filter&#x3D;STARS&#x3D;1234&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#搜索出来的镜像就是STARS大于1234的<br><img src="/./p5.png" class="lazyload" data-srcset="/./p5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
</blockquote>
<p><strong>下载镜像</strong></p>
<blockquote>
<p>docker pull 镜像名[:tag(版本)]不加默认最新版<br><img src="/./p6.png" class="lazyload" data-srcset="/./p6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>采用的是分层下载，是docker images的核心，联合文件系统，感兴趣可以去搜索了解<br>最后一行是镜像的真实地址docker pull mysql &#x3D; docker pull docker.io&#x2F;library&#x2F;mysql:latest<br><strong>指定版本下载</strong><br>例如：<br><img src="/./p8.png" class="lazyload" data-srcset="/./p8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>我们可以看到，其实我们并没有完完全全的重新下载一份，有重复的文件会直接拿过来用，避免了不必要的麻烦，这就是分层下载的好处之一</p>
</blockquote>
<p>下载完后我我们可以用&#96;&#96;docker images&#96;&#96;&#96;来查看下载的镜像<br><img src="/./p9.png" class="lazyload" data-srcset="/./p9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">一般我们下载的流程是：</span><br><span class="line">1、搜索镜像  search</span><br><span class="line">2、下载镜像  pull</span><br><span class="line">3、运行测试  run</span><br><span class="line">4、进入容器  exec -it</span><br></pre></td></tr></table></figure>

<p><strong>删除镜像</strong></p>
<blockquote>
<p>删除镜像：<code>docker rmi</code><br>rm我们都知道，Linux里删除东西也是用rm，rmi里的i指的是images镜像，删除镜像时我们可以通过ID来删，也可以通过名称来删<br><img src="/./p10.png" class="lazyload" data-srcset="/./p10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>我们也可以加上参数-f来表示完全删除</p>
</blockquote>
<p>如果想要删除多个镜像只需要用空格隔开即可<br><code>docker rmi -f 镜像ID 镜像ID 镜像ID</code><br>如果像全部删除<br><code>docker rmi -f $(docker images -aq)</code></p>
<h2 id="容器命令"><a href="#容器命令" class="headerlink" title="容器命令"></a>容器命令</h2><p><strong>新建容器并启动</strong></p>
<blockquote>
<p>我们有了镜像才可以创建容器，所有学习之前先得下载一个centos的镜像<br><code>docker pull centos</code><br><img src="/./p11.png" class="lazyload" data-srcset="/./p11.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run [可选参数] image</span><br><span class="line"># 参数说明</span><br><span class="line">--name=&quot;Name&quot;    容器的名字，用来区分容器</span><br><span class="line">-d               以后台方式运行</span><br><span class="line">-i/-t            使用交互方式运行，进入容器查看内容</span><br><span class="line">-p               指定容器的端口，主机映射</span><br><span class="line">        -p ip:主机窗口:容器窗口</span><br><span class="line">        -p 主机窗口:容器窗口 （常用）</span><br><span class="line">        -p 容器端口</span><br><span class="line">        (省略-p)容器端口</span><br><span class="line">-P               随机指定端口</span><br></pre></td></tr></table></figure>
<p><strong>启动并进入容器</strong></p>
<blockquote>
<p><img src="/./p12.png" class="lazyload" data-srcset="/./p12.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>从原来的主机名变成容器ID</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@fe9b4298a7e9 /]# ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root</span><br><span class="line">run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">展开后我们会发现是不是跟外面的centOS一样，这就是一个小型的服务器，但是是基础版本，很多命令都还不完善</span><br></pre></td></tr></table></figure>

<p><strong>查看运行的容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">通过docker ps来查看运行的容器</span><br><span class="line">参数：</span><br><span class="line">什么都不加 #列出正在运行的容器</span><br><span class="line">-a        #列出正在运行的容器，带出历史运行过的容器</span><br><span class="line">-n        #显示最近创建的容器</span><br><span class="line">-q        #只显示容器的编号</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/./p14.png" class="lazyload" data-srcset="/./p14.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
<p><strong>退出容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exit                # 直接停止容器并退出，从容器中退到主机</span><br><span class="line">快捷键Ctrl + P + Q   # 容器不停止退出</span><br></pre></td></tr></table></figure>
<p><img src="/./p13.png" class="lazyload" data-srcset="/./p13.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
<p><strong>删除容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker rm 容器ID                 #删除指定的容器，不能删除正在运行的容器，如果需要强制删除 rm -f</span><br><span class="line">docker rm -f $(docker ps -aq)   #删除所有的容器</span><br><span class="line">docker ps -a -q|xargs docker rm #删除所有容器</span><br></pre></td></tr></table></figure>

<p><strong>启动和停止容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker start 容器ID       #启动容器</span><br><span class="line">docker restart 容器ID     #重启容器</span><br><span class="line">docker stop 容器ID        #停止当前运行的容器</span><br><span class="line">docker kill 容器ID        #强制停止当前运行的容器</span><br></pre></td></tr></table></figure>

<h2 id="其他常用命令"><a href="#其他常用命令" class="headerlink" title="其他常用命令"></a>其他常用命令</h2><p><strong>后台启动容器</strong><br><code>docker run -d 镜像名</code></p>
<blockquote>
<p><img src="/./p15.png" class="lazyload" data-srcset="/./p15.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>&nbsp;&nbsp;我们使用后台运行命令启动centOS后，再使用<code>docker ps</code>发现，centOS停止了。<br><dr><br>这是因为docker容器使用后台运行时，就必须要有一个前台进程，如果docker没有发现有前台进程就会自动停止</p>
</blockquote>
<p><strong>查看日志</strong><br><code>docker logs -f -t --tail 容器</code><br>这里我没有成功，我输出的日志是空白的，所以就不做展示了<br><br></p>
<p><strong>查看容器中的进程</strong><br><code>docker top 容器ID</code></p>
<blockquote>
<p><img src="/./p16.png" class="lazyload" data-srcset="/./p16.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br><dr></p>
</blockquote>
<p><strong>查看镜像的元数据</strong><br><code>docker inspect 容器ID</code></p>
<blockquote>
<p>输入后显示很长一串的内容，我这里只截取一部分，但是所截取的内容也分丰富<br><img src="/./p17.png" class="lazyload" data-srcset="/./p17.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br><dr></p>
</blockquote>
<p><strong>进入当前正在运行的容器</strong><br>一般来说，通常容器都是使用后台方式运行，因此我们需要进入当前正在运行的容器的命令<br>方法一：<code>docker exec -it 容器ID bashshell</code></p>
<blockquote>
<p>这里的-it和上面一样，也是交互模式执行<br><img src="/./p18.png" class="lazyload" data-srcset="/./p18.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
</blockquote>
<p>方法二：<code>docker attach 容器ID</code><br>执行当前的代码<br><dr></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">两者的区别</span><br><span class="line">docker exec      # 进入容器后开启一个新的终端，可以在里面操作命令</span><br><span class="line">docker attach    # 进入容器正在执行的终端，不会开启新的进程</span><br></pre></td></tr></table></figure>

<p><strong>从容器内拷贝内容到主机上</strong><br><code>docker cp 容器ID:容器内路径 目的的主机路径</code></p>
<blockquote>
<p><img src="/./p19.png" class="lazyload" data-srcset="/./p19.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
</blockquote>
<h2 id="commit镜像"><a href="#commit镜像" class="headerlink" title="commit镜像"></a>commit镜像</h2><p><code>docker commit</code>命令用于创建一个新的镜像，基于正在运行的容器的当前状态。它允许你捕捉容器所做的更改并将其保存为一个新的镜像，以便以后可以使用该镜像创建相同的容器或与之共享状态<br><dr><br>命令和git原理类似<br><code>docker commit -m=&quot;提交信息描述&quot; -a=&quot;作者&quot; 容器ID 目标镜像名:[TAG(版本标签)]</code><br>案例：</p>
<blockquote>
<p>上文有提到，我们下载的镜像一般都是为删减版，功能不全，这时，我们想要用到tomcat较为完整的功能该怎么办<br>1、先启动一个默认的tomcat<br>2、进入后我们cd到webapps里，发现文件为空<br>3、把文件拷贝进去<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这时我们需要运行代码<code>cp -r webapps.dist/* webapps</code>把webapps.dist里的全部内容拷贝进webapps里即可。<br><img src="/./p20.png" class="lazyload" data-srcset="/./p20.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>4、通过”docker commit”来提交为一个镜像，这就是我们自己修改过的镜像<br><img src="/./p21.png" class="lazyload" data-srcset="/./p21.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
</blockquote>
<h1 id="关于Docker的一些理论知识"><a href="#关于Docker的一些理论知识" class="headerlink" title="关于Docker的一些理论知识"></a>关于Docker的一些理论知识</h1><h2 id="关于镜像"><a href="#关于镜像" class="headerlink" title="关于镜像"></a>关于镜像</h2><p><strong>镜像是什么</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">镜像是一种轻量级、可执行的独立软件包，某种意义上你可以把它理解成我们常用的压缩包，这个压缩包里包含着软件</span><br><span class="line">所需要的内容，例如代码、运行时的环境变量、配置文件等，一打开就是一个软件。</span><br></pre></td></tr></table></figure>
<p><strong>如何可以得到镜像</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、从远程仓库下载</span><br><span class="line">2、朋友拷贝给你</span><br><span class="line">3、自己手动做一个镜像DockerFile</span><br></pre></td></tr></table></figure>

<p><strong>镜像加载原理</strong><br>1、UnionFS（联合文件系统）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">    UnionFS联合文件系统是一个分层、轻量且高性能的文件系统，它支持对文件系统的修改作为一次提交来一层层的</span><br><span class="line">叠加，我们可以想象的到，我们的电脑上现在有了centOS，然后我们在centOS里安装了docker，我们再从docker里安</span><br><span class="line">装了jdk，一直套娃，联合文件系统就会把每一层都记录下来，所以我们上文提到的下载镜像时的分层，就是因为这个。</span><br></pre></td></tr></table></figure>

<p>2、分层</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  我们在下载镜像的时候能够发现，它不像我们平时在其他地方下载一个软件就是一个包，在docker里，一个软件分了</span><br><span class="line">很多层，这提高了使用性和可重复性。</span><br><span class="line">  然而一个软件可以分成两个大层，一个是镜像层，一个是容器层，镜像层和容器层之间有什么关系呢，我们做到命令</span><br><span class="line">都是在容器层上所操作的，无法改变镜像层内，我的理解是，镜像是一个压缩包，而容器是解压后的软件，我们可以改</span><br><span class="line">变软件里的内容，但是无法改变压缩包里的内容。</span><br></pre></td></tr></table></figure>

<h1 id="容器数据卷"><a href="#容器数据卷" class="headerlink" title="容器数据卷"></a>容器数据卷</h1><h2 id="容器数据卷的作用"><a href="#容器数据卷的作用" class="headerlink" title="容器数据卷的作用"></a>容器数据卷的作用</h2><p>我们在docker运行时产生的数据，如果不是通过<code>docker commit</code>来提交的话，等容器删除时数据也会跟着删除，为了能保存数据在Docker中我们使用卷。<br>卷的设计目的就是数据的持久化，完全独立于容器的生存周期，因此Docker不会在容器删除时删除其挂载的数据卷。<br>卷就是目录或文件，存在于一个或多个容器中，由Docker挂载到容器，但卷不属于联合文件系统（Union FileSystem），因此能够绕过联合文件系统提供一些用于持续存储或共享数据的特性:。</p>
<h2 id="使用数据卷"><a href="#使用数据卷" class="headerlink" title="使用数据卷"></a>使用数据卷</h2><blockquote>
<p>方式一：直接使用命令来挂载 -v<br><code>docker run -it -v 主机目录:容器目录</code><br><img src="/./p22.png" class="lazyload" data-srcset="/./p22.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br><img src="/./p23.png" class="lazyload" data-srcset="/./p23.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>现在，容器内和容器外的地址都相连起来了，会发现，两个地方的内容是一致的。<br><br></p>
</blockquote>
<p>如何去验证是否连接到，是否连接对：<code>docker inspect</code></p>
<blockquote>
<p><img src="/./p24.png" class="lazyload" data-srcset="/./p24.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>如果inspect后没有看到Mounts，说明挂载失败了</p>
</blockquote>
<p>在容器内部生成的文件也会映射在外面，同理，外面生成的内容也会映射到里面，停止容器后，外面文件再做修改，也是会映射到里面</p>
<blockquote>
<p><img src="/./p25.png" class="lazyload" data-srcset="/./p25.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br><img src="/./p26.png" class="lazyload" data-srcset="/./p26.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
</blockquote>
<p>&#96;<br><dr><br><dr><br>__小案例__：MySQL同步数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、下载MySQL：docker pull mysql</span><br><span class="line">2、运行容器，做数据挂载：</span><br><span class="line">docker run -d -p 3310:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/</span><br><span class="line">mysql -e MYSQL_ROOT_PASSWORD=123456 --name mysql01 容器ID</span><br><span class="line">注解：</span><br><span class="line">      -d 后台运行</span><br><span class="line">      -p 端口映射</span><br><span class="line">      -v 卷挂载</span><br><span class="line">      -e 环境配置</span><br><span class="line">      --name 容器命名</span><br></pre></td></tr></table></figure>
<blockquote>
<p>让我们来检查一下同步到了吗<br>这是默认data文件里的内容：<br><img src="/./p27.png" class="lazyload" data-srcset="/./p27.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>此时，我们在外部连接上MySQL后，新建一个text数据库，再来看看data里的内容有没有做改变<br><img src="/./p28.png" class="lazyload" data-srcset="/./p28.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>我们能清楚的看到，多了一个text，说明，同步数据成功，就算把容器删除，我们已经存储到本地的数据依然还在，不会丢失，这就实现了容器数据持久化。</p>
</blockquote>
<h2 id="具名和匿名挂载"><a href="#具名和匿名挂载" class="headerlink" title="具名和匿名挂载"></a>具名和匿名挂载</h2><blockquote>
<p># 匿名挂载<br>-v 容器内路径<br><code>docker run -v /容器内需挂载的路径 容器ID</code><br>例如：<code>docker run -P -v /ect/nginx nginx</code><br><dr><br># 查看所有的volume<br><code>docker volume ls</code><br><img src="/./p29.png" class="lazyload" data-srcset="/./p29.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>这种就是匿名挂载，没有指出卷名是什么<br><dr><br>我们平时也可以用具名挂载<br>例如：<code>docker run -v hhhhhh-nginx:/etc/nginx 605c77e624dd</code><br>-v 卷名:容器内的路径<br><img src="/./p30.png" class="lazyload" data-srcset="/./p30.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br><dr><br>然后，我们可以用”<code>docker volume inspect 卷名</code>“来查看卷在主机内所挂载的位置<br><img src="/./p31.png" class="lazyload" data-srcset="/./p31.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>可以看出，所有的docker容器内的卷，没有指定目录的情况下都是在：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volume&#x2F;卷名&#x2F;_data<br>我们可以在主机上进入路径查看文件<br><img src="/./p32.png" class="lazyload" data-srcset="/./p32.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br><dr><br>还有一种是指定路径挂载<br><code>-v /主机路径:容器内路径</code><br>感兴趣的可以去试试，这里就不作展示了</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">总结：</span><br><span class="line">一般来说，我们的挂载方式最常用的有三种：</span><br><span class="line">1、 -v 容器内的路径           # 匿名挂载</span><br><span class="line">2、 -v 卷名:容器内的路径      # 具名挂载</span><br><span class="line">3、 -v /主机地址:容器内的地址 # 指定路径挂载</span><br></pre></td></tr></table></figure>
<p>扩展：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">我们可以通过 -v 容器内路径:ro或者rw 来改变读写权限</span><br><span class="line">ro      # read only  只读</span><br><span class="line">rw      # read write 可读可写</span><br><span class="line">默认是rw</span><br><span class="line">例如：docker run -v hhsqdmz:/容器地址 容器ID</span><br><span class="line"></span><br><span class="line"># 一旦设置了容器权限，容器对我们挂载出来的内容就有了限定</span><br><span class="line">比如你看到有个ro，说明这个路径无法从容器内部做出操作，只能从主机来操作</span><br></pre></td></tr></table></figure>

<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>Dockerfile用来构建docker镜像的构建文件，是一种命令脚本，通过这个脚本可以生成镜像，镜像是一层一层的，脚本是一个个的命令，每个命令都是一层</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、创建一个Dockerfile文件，名字任取</span><br><span class="line">2、编写文件的内容，一个命令对着一层  指令(大写)  参数：</span><br><span class="line">   FROM centos</span><br><span class="line">   VOLUME [&quot;volume1&quot;,&quot;volume2&quot;]</span><br><span class="line">   CMD echo &quot;succeed&quot;</span><br><span class="line">   CMD /bin/bash</span><br><span class="line">3、构造镜像</span><br><span class="line">   &quot;docker build -f 主机路径(编写Dockerfile的路径) -t 镜像名字(任取):TAG(版本号) .(别漏了这里的点)&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/./p33.png" class="lazyload" data-srcset="/./p33.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
<blockquote>
<p>这个容器构建出来后也是可以启动的，启动命令和之前一样<br><img src="/./p34.png" class="lazyload" data-srcset="/./p34.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>这两个卷算是匿名挂载，在外部一定有一个同步的目录，我们可以通过inspect来查看地址<br><img src="/./p35.png" class="lazyload" data-srcset="/./p35.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"></p>
</blockquote>
<p>dockerfile是面向开发的，我们以后要发布项目，做镜像，就要编写dockerfile文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DockerFile：构建文件，定义一切的步骤，源代码</span><br><span class="line">            相当于软件包</span><br><span class="line">DockerImages：通过DockerFile构建生成的镜像，最终发布和运行的产品</span><br><span class="line">            相当于软件</span><br><span class="line">Docker容器：容器就是镜像运行起来提供的服务器</span><br><span class="line">            相当于打开软件后，软件的后台</span><br></pre></td></tr></table></figure>
<dr>

<p>注意事项</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、每个保留关键字（指令）都必须是大写字母</span><br><span class="line">2、执行从上到下顺序执行</span><br><span class="line">3、&#x27;#&#x27;表示注释</span><br><span class="line">4、每一个指令都会创建提交一个新的镜像层</span><br></pre></td></tr></table></figure>

<h3 id="DockerFile的指令"><a href="#DockerFile的指令" class="headerlink" title="DockerFile的指令"></a>DockerFile的指令</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FROM        # 指定基础镜像，一切从这里开始构建</span><br><span class="line">              DockerHub中99%的镜像都是从FROM seach过来的，然后配置所需要的软件来进行构建</span><br><span class="line">MAINTAINER  # 作者是谁：姓名+邮箱</span><br><span class="line">RUN         # 镜像构建的时候需要运行的命令</span><br><span class="line">ADD         # 添加内容，可以理解成加个软件包</span><br><span class="line">COPY        # 类似ADD，将文件拷贝到镜像中</span><br><span class="line">WORKDIR     # 镜像的工作目录</span><br><span class="line">VOLUME      # 挂载卷的目录</span><br><span class="line">ENV         # 构建时设置环境变量</span><br><span class="line">CMD         # 指定容器运行时要运行的命令，只有最后一个生成，可被替代</span><br><span class="line">ENTRYPOINT  # 指定容器运行时要运行的命令，可以追加命令</span><br><span class="line">EXPOSE      # 暴露端口配置，跟上面的-p一样</span><br><span class="line">ONBULID     # 是一个触发指令，当构建一个被继承 DockerFile 时，会运行 ONBULID 指令</span><br></pre></td></tr></table></figure>

<h2 id="数据卷容器"><a href="#数据卷容器" class="headerlink" title="数据卷容器"></a>数据卷容器</h2><p>我们同时启动三个我们上面自己构建的容器centos1、centos2、centos3</p>
<blockquote>
<p>centos1为父容器，centos2是os1的子容器，os3是os2的子容器<br>1、”docker run -it –name centos01 容器ID”<br>2、docker run -it –name centos02 –volumes-from centos01 容器ID<br>3、docker run -it –name centos03 –volumes-from centos02 容器ID<br>我们能在里面找到我们自己构建的两个文件”volume01”和”volume02”<br><img src="/./p34.png" class="lazyload" data-srcset="/./p34.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>我们在centos01里面，进入volume01，touch一个新的文件docker1；然后在centos03里，也是在volume01里，touch一个docker3。<br>然后我们无论在三个容器之间的任意一个容器，都能看见新构建出来的文件<br><img src="/./p36.png" class="lazyload" data-srcset="/./p36.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这是一张本地图片"><br>我们把centos01给exit退出，或者是删除rm都可以，但是，在其他两个容器里面依然能够看到docker1和docker2两个文件，只要其中有一个容器存活，数据就不会丢失</p>
</blockquote>
<p>这种容器之间配置信息的传递，数据卷容器的生命周期一直持续到所有共享的容器都停止为止</p>
<h1 id="Docker网络"><a href="#Docker网络" class="headerlink" title="Docker网络"></a>Docker网络</h1><h2 id="查看网络配置"><a href="#查看网络配置" class="headerlink" title="查看网络配置"></a>查看网络配置</h2><blockquote>
<p>我们每次启动一个docker容器，docker都会给docker容器分配一个ip地址，只要我们安装了docker，就会有一个网卡 docker0，这种叫桥接模式，使用的是evth-pair技术，只要一删除容器ip地址也会跟着消失<br># evth-pair技术就是一对虚拟设备接口，都是成对出现的，一端连着协议，一端互相连接，OpenStac也是运用这个技术<br>查看网络配置命令 “<code>ip addr</code>“</p>
</blockquote>
]]></content>
  </entry>
  <entry>
    <title>MongoDB</title>
    <url>/2025/06/17/articles/Substitute%20driver/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8BMongoDB/</url>
    <content><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><ul>
<li>MongoDB 与传统关系型数据库相比更加简单，架构为key-value结构</li>
<li>MySQL数据库：数据库-表-记录<br>MongoDB      ：数据库-集合-文档（记录）</li>
<li>文档类似于JSON对象，结构成为BSON</li>
</ul>
<h1 id="安装与启动"><a href="#安装与启动" class="headerlink" title="安装与启动"></a>安装与启动</h1><h2 id="1-导入-MongoDB-官方-GPG-密钥"><a href="#1-导入-MongoDB-官方-GPG-密钥" class="headerlink" title="1. 导入 MongoDB 官方 GPG 密钥"></a>1. 导入 MongoDB 官方 GPG 密钥</h2><p>首先需要导入 MongoDB 官方的 GPG 密钥，以便系统能够验证下载包的完整性。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -fsSL https://pgp.mongodb.com/server-7.0.asc | \</span><br><span class="line">   <span class="built_in">sudo</span> gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg \</span><br><span class="line">   --dearmor</span><br></pre></td></tr></table></figure>

<h2 id="2-添加-MongoDB-软件源"><a href="#2-添加-MongoDB-软件源" class="headerlink" title="2. 添加 MongoDB 软件源"></a>2. 添加 MongoDB 软件源</h2><p>将 MongoDB 的软件源添加到系统的源列表中，这样就可以通过包管理器直接下载 MongoDB。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/mongodb-org-7.0.list</span><br></pre></td></tr></table></figure>

<h2 id="3-更新包索引"><a href="#3-更新包索引" class="headerlink" title="3. 更新包索引"></a>3. 更新包索引</h2><p>添加完软件源后，需要更新本地的包索引，让系统知道有哪些新的软件包可以安装。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get update</span><br></pre></td></tr></table></figure>

<h2 id="4-安装-MongoDB-7-0-0"><a href="#4-安装-MongoDB-7-0-0" class="headerlink" title="4. 安装 MongoDB 7.0.0"></a>4. 安装 MongoDB 7.0.0</h2><p>使用包管理器安装指定版本的 MongoDB。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install -y mongodb-org=7.0.0 mongodb-org-database=7.0.0 mongodb-org-server=7.0.0 mongodb-org-shell=7.0.0 mongodb-org-mongos=7.0.0 mongodb-org-tools=7.0.0</span><br></pre></td></tr></table></figure>

<h2 id="5-锁定-MongoDB-版本"><a href="#5-锁定-MongoDB-版本" class="headerlink" title="5. 锁定 MongoDB 版本"></a>5. 锁定 MongoDB 版本</h2><p>为了防止系统自动升级 MongoDB 版本，需要对其进行版本锁定。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mongodb-org hold&quot;</span> | <span class="built_in">sudo</span> dpkg --set-selections</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mongodb-org-database hold&quot;</span> | <span class="built_in">sudo</span> dpkg --set-selections</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mongodb-org-server hold&quot;</span> | <span class="built_in">sudo</span> dpkg --set-selections</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mongodb-org-shell hold&quot;</span> | <span class="built_in">sudo</span> dpkg --set-selections</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mongodb-org-mongos hold&quot;</span> | <span class="built_in">sudo</span> dpkg --set-selections</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mongodb-org-tools hold&quot;</span> | <span class="built_in">sudo</span> dpkg --set-selections</span><br></pre></td></tr></table></figure>

<h2 id="6-启动-MongoDB-服务"><a href="#6-启动-MongoDB-服务" class="headerlink" title="6. 启动 MongoDB 服务"></a>6. 启动 MongoDB 服务</h2><p>安装完成后，启动 MongoDB 服务并设置为开机自启动。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start mongod</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> mongod</span><br></pre></td></tr></table></figure>

<h2 id="7-验证安装结果"><a href="#7-验证安装结果" class="headerlink" title="7. 验证安装结果"></a>7. 验证安装结果</h2><p>通过以下命令检查 MongoDB 服务的运行状态，确认是否安装成功。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl status mongod</span><br></pre></td></tr></table></figure>

<p>Linux进入MongoDB</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mongosh</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show dbs  # 查看数据库</span><br><span class="line">db.version() # 查看版本  </span><br><span class="line">db.getMongo()  # 查看当前db的链接机器地址</span><br><span class="line">db.help()    # 帮助</span><br><span class="line">quit()       # 退出</span><br></pre></td></tr></table></figure>

<h1 id="命令行操作MongoDB"><a href="#命令行操作MongoDB" class="headerlink" title="命令行操作MongoDB"></a>命令行操作MongoDB</h1><h3 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h3><p>创建数据库，如果数据库不存在，则创建数据库，否则切换数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use 库名</span><br></pre></td></tr></table></figure>

<p>查看当前数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.getName()</span><br></pre></td></tr></table></figure>

<p>查看当前数据库状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.stats()</span><br></pre></td></tr></table></figure>

<p>删除当前数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>


<h3 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h3><p>创建集合</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.createCollection(&quot;User&quot;)</span><br></pre></td></tr></table></figure>

<p>删除集合</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.集合名.drop()</span><br></pre></td></tr></table></figure>


<h3 id="文档操作"><a href="#文档操作" class="headerlink" title="文档操作"></a>文档操作</h3><p>注意：</p>
<ul>
<li>MongoDB区分类型和大小写</li>
<li>MongoDB文档不能有重复的键</li>
</ul>
<p>insert，向集合插入一条记录。可以预先使用 <code>createCollection</code> 方法创建，也可以不先创建，直接插入，集合会自动创建</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.集合名.insert(&#123;name:&#x27;zhangsan&#x27;,age:21,sex:true&#125;)</span><br></pre></td></tr></table></figure>

<p>find，查询当前集合中name是zhangsan的数据，空参的话是查询全部</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.集合名.find(&#123;name:zhangsan&#125;)</span><br></pre></td></tr></table></figure>

<p>update，只更新匹配到的第一条记录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.集合名.update(&#123;age:21&#125;,&#123;$set:&#123;name:100&#125;)</span><br></pre></td></tr></table></figure>
<p>更新匹配到的所有记录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.集合名.update(&#123;age:21&#125;,&#123;set:&#123;name:100&#125;&#125;,&#123;multi:true&#125;)</span><br></pre></td></tr></table></figure>

<p>remove，删除一个文档</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.集合名.remove(id)</span><br></pre></td></tr></table></figure>
<p>删除所有文档</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.集合名.remove(&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="SpringBoot整合MongoDB"><a href="#SpringBoot整合MongoDB" class="headerlink" title="SpringBoot整合MongoDB"></a>SpringBoot整合MongoDB</h1><ul>
<li>spring-data-mongodb提供了两种方式</li>
</ul>
<p>第一种 MongoTemplate（更灵活）</p>
<p>第二种 MongoRepository（操作简单）</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>第一步 创建项目，导入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mongo_demo0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--mongodb--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步 创建项目文件</p>
<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">database:</span> <span class="string">daijia</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">47.107</span><span class="number">.42</span><span class="number">.25</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">27017</span></span><br></pre></td></tr></table></figure>

<p>第三步 创建实体类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document(&quot;user&quot;)</span> <span class="comment">//指定mongodb中的集合名字</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> ObjectId id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> Date createDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MongoRepository"><a href="#MongoRepository" class="headerlink" title="MongoRepository"></a>MongoRepository</h2><ul>
<li>添加interface继承MongoRepository</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserRepository</span> <span class="keyword">extends</span> <span class="title class_">MongoRepository</span>&lt;User, ObjectId&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="普通方法"><a href="#普通方法" class="headerlink" title="普通方法"></a>普通方法</h4><ul>
<li>编写测试类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoRepositoryTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;mary&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">30</span>);</span><br><span class="line">        user.setCreateDate(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询所有</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;User&gt; list = userRepository.findAll();</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据id查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindById</span><span class="params">()</span> &#123;</span><br><span class="line">        Optional&lt;User&gt; optional =</span><br><span class="line">                userRepository.findById(<span class="keyword">new</span> <span class="title class_">ObjectId</span>(<span class="string">&quot;666a9a85f5294513720647ff&quot;</span>));</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">present</span> <span class="operator">=</span> optional.isPresent();</span><br><span class="line">        <span class="keyword">if</span>(present) &#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> optional.get();</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//条件查询 + 排序</span></span><br><span class="line">    <span class="comment">// age = 20</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//封装条件</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setAge(<span class="number">20</span>);</span><br><span class="line">        Example&lt;User&gt; example = Example.of(user);</span><br><span class="line"></span><br><span class="line">        <span class="type">Sort</span> <span class="variable">sort</span> <span class="operator">=</span> Sort.by(Sort.Direction.DESC, <span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;User&gt; list = userRepository.findAll(example, sort);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分页查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//第一页从0开始的</span></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageable</span> <span class="operator">=</span> PageRequest.of(<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Page&lt;User&gt; page = userRepository.findAll(pageable);</span><br><span class="line"></span><br><span class="line">        List&lt;User&gt; list = page.getContent();</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//注意：先查询，再更新</span></span><br><span class="line">        Optional&lt;User&gt; optional = userRepository.findById(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ObjectId</span>(<span class="string">&quot;64eee9dff317c823c62b4faf&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span>(optional.isPresent())&#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> optional.get();</span><br><span class="line">            user.setAge(<span class="number">100</span>);</span><br><span class="line">            <span class="comment">//user中包含id，就会执行更新</span></span><br><span class="line">            userRepository.save(user);</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteUser</span><span class="params">()</span>&#123;</span><br><span class="line">        userRepository.deleteById(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ObjectId</span>(<span class="string">&quot;64eee9dff317c823c62b4faf&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="命名方法"><a href="#命名方法" class="headerlink" title="命名方法"></a>命名方法</h4><ul>
<li>MongoRepository也可以<strong>按照规则</strong>在把查询方法创建出来</li>
</ul>
<p>总体规模：</p>
<ul>
<li>查询方法 以  get   |   find   |   read开头</li>
<li>后面街上查询字段名称，满足大驼峰命名</li>
<li>字段查询条件添加关键字，比如like</li>
</ul>
<p>比如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderServiceLocationRepository</span> <span class="keyword">extends</span> <span class="title class_">MongoRepository</span>&lt;OrderServiceLocation, String&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 根据订单id获取位置信息，按照创建时间排序  </span></span><br><span class="line">    List&lt;OrderServiceLocation&gt; <span class="title function_">findByOrderIdOrderByCreateTimeAsc</span><span class="params">(Long orderId)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MongoTemplate"><a href="#MongoTemplate" class="headerlink" title="MongoTemplate"></a>MongoTemplate</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoTemplateTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">20</span>);</span><br><span class="line">        user.setCreateDate(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        mongoTemplate.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询所有</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;User&gt; list = mongoTemplate.findAll(User.class);</span><br><span class="line">        list.forEach(user-&gt;&#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据id查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> mongoTemplate.findById(<span class="string">&quot;666a9b5e9a3653796627bb3c&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//条件查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// where name=? and age=?</span></span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span></span><br><span class="line">                Criteria.where(<span class="string">&quot;name&quot;</span>).is(<span class="string">&quot;test&quot;</span>).and(<span class="string">&quot;age&quot;</span>).is(<span class="number">20</span>);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line"></span><br><span class="line">        List&lt;User&gt; list = mongoTemplate.find(query,User.class);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分页查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// limit 0,2</span></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>();</span><br><span class="line">        List&lt;User&gt; list = mongoTemplate.find(query.skip(<span class="number">0</span>).limit(<span class="number">2</span>), User.class);</span><br><span class="line">        list.forEach(user-&gt;&#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改和删除</span></span><br><span class="line">    <span class="comment">//修改</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">&quot;_id&quot;</span>).is(<span class="string">&quot;64eeeae31711344f35635788&quot;</span>);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line">        <span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">        update.set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        update.set(<span class="string">&quot;age&quot;</span>, <span class="number">99</span>);</span><br><span class="line">        <span class="type">UpdateResult</span> <span class="variable">result</span> <span class="operator">=</span> mongoTemplate.upsert(query, update, User.class);<span class="comment">//改一条</span></span><br><span class="line">        <span class="comment">//UpdateResult result = mongoTemplate.updateMulti(query, update, User.class);//改多条</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> result.getModifiedCount();</span><br><span class="line">        System.out.println(count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRemove</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">&quot;_id&quot;</span>).is(<span class="string">&quot;64eeeae31711344f35635788&quot;</span>);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line">        <span class="type">DeleteResult</span> <span class="variable">result</span> <span class="operator">=</span> mongoTemplate.remove(query, User.class);</span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> result.getDeletedCount();</span><br><span class="line">        System.out.println(count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

































]]></content>
      <tags>
        <tag>project</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM垃圾回收器</title>
    <url>/2025/05/13/articles/%E6%AF%8F%E6%97%A5%E4%B8%80%E7%AF%87/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8/</url>
    <content><![CDATA[<p>**Java分配对象的过程以及新生代和老年代划分的目的</p>
<p>创建一个新的对象实例时，jvm首先会在堆内存分配内存空间，大部分情况下，新对象都会分配到新生代的Eden区，新生代有三个区，一个Eden区和两个survivor区，当Eden区满了以后会进行Minor GC（新生代GC，是指新生代的垃圾收集，一般Eden区满了就执行，非常频繁，回收速度快），在GC的过程中存活的对象会在两个survivor区中进行转移和交换，经过多次GC任然存活的对象会被放入老年代，老年代主要用于存储长期存活的对象或者是大对象。</p>
<p>新生代中如果有比较大的对象比如数组list那些，会直接放入老年代里面。</p>
<p>划分新生代和老年代的主要目的有两个：</p>
<ul>
<li>新生代采用的是一种简单高效的复制算法进行垃圾回收，可以快速完成垃圾回收减少暂停时间，因为大部分对象都是暂时存在的，所有这种策略能够有效处理大量短暂对象的分配和回收</li>
<li>可以针对不同的对象采取不同的回收策略，新生代频繁回收，老年代较少回收，可以减少full GC（全面垃圾收集，清理新生代与老年代以及方法区，full GC通常比Minor GC慢很多，因为full GC涉及到整个栈的回收，并且在GC期间，应用程序的所有线程都会暂停）的频率，提升系统的整体性能</li>
</ul>
<p>**标记清除、复制和标记压缩三种垃圾回收算法的基本原理</p>
<p><strong>标记清除算法：</strong><br>遍历所有可达对象标记为存活的状态，然后遍历堆内存，把没有标记的对象全部视为垃圾进行清理</p>
<ul>
<li>优点<br>  简单，不需要额外的内存空间</li>
<li>缺点<br>  会产生大量的内存碎片，而且效率很低</li>
</ul>
<p><strong>复制算法：</strong><br>把内存分为两个相等的区域，每次只使用其中一个区域，当这个区域满了以后，把存活的对象复制到另一个区域中并且清除原区域的所有对象</p>
<ul>
<li>优点<br>  每次垃圾回收后内存都是连续的，不存在内存碎片</li>
<li>缺点<br>  需要额外的占用内存空间，并且对象频繁复制导致效率问题</li>
</ul>
<p><strong>标记压缩算法：</strong><br>先标记所有可达对象，然后把存活的对象向一端移动，然后直接清理边界外的内存区域，从而消除碎片<br>![[Pasted image 20250513172753.png]]</p>
<ul>
<li>优点<br>  解决标记清除算法所造成的内存碎片问题，相对复制算法减少了内存空间占用</li>
<li>缺点<br>  复杂度高，而且执行效率相对比较低，特别是压缩阶段需要移动对象，可能会引起程序暂停的时间较长</li>
</ul>
<p><strong>serial、Parallel、CMS和G1垃圾回收器的主要特点</strong></p>
<ul>
<li><p>serial GC是串行垃圾回收器，比较适用于单核处理器或者对响应时间要求不高的场景</p>
</li>
<li><p>Parallel基于多线程并行垃圾回收器，适合高吞吐量的服务器应用或者CPU核心数较多的服务器坏境</p>
</li>
<li><p>CMS也是并且垃圾回收，但是他会把垃圾回收分为四个阶段，尽可能减少了STW（系统在执行特定操作时需暂停所有应用程序线程）的时间，比较适用于高交互性的应用，比如web服务器，以及对停顿时间有严格要求但是对吞吐量比较宽松的场景</p>
</li>
<li><p>G1把堆内存划分了多个大小相等的区域，每个区域都可以独立作为新生代和老年代的一部分，通过并行和并发实现垃圾回收，从而减少停顿时间，另外还能根据目标停顿时间来动态调整垃圾回收策略，来满足不同需求，适合低延迟和可预测的垃圾回收停顿时间的应用，比如大规模分布式系统、在线交易系统</p>
</li>
</ul>
]]></content>
      <tags>
        <tag>面试八股文</tag>
      </tags>
  </entry>
  <entry>
    <title>ArrayList 和 LinkedList 的区别</title>
    <url>/2025/05/21/articles/%E6%AF%8F%E6%97%A5%E4%B8%80%E7%AF%87/ArrayList%20%E5%92%8C%20LinkedList%20%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
    <content><![CDATA[<ul>
<li><p>ArrayList基于动态数组实现的非线程安全的集合；LinkedList基于链表实现的非线程安全的集合。</p>
</li>
<li><p>对于随机index访问的get和set方法，一般ArrayList的速度要优于LinkedList。因为ArrayList直接通过数组下标直接找到元素；LinkedList要移动指针遍历每个元素直到找到为止。</p>
</li>
<li><p>新增和删除元素，一般LinkedList的速度要优于ArrayList。因为ArrayList在新增和删除元素时，可能扩容和复制数组；LinkedList实例化对象需要时间外，只需要修改指针即可。</p>
</li>
<li><p>LinkedList集合不支持 高效的随机随机访问（RandomAccess）</p>
</li>
<li><p>ArrayList的空间浪费主要体现在在list列表的结尾预留一定的容量空间，而LinkedList的空间花费则体现在它的每一个元素都需要消耗相当的空间</p>
</li>
</ul>
]]></content>
      <tags>
        <tag>面试八股文</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafka如何避免重复消费问题</title>
    <url>/2025/05/20/articles/%E6%AF%8F%E6%97%A5%E4%B8%80%E7%AF%87/Kafka%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>首先，kafka的块上会储存offset标记，kafka消费者通过offset标记来维护已经消费的数据，消费者每消费完一批数据时会更新offset值，来避免重复消费问题。</p>
<p>默认情况，消费完以后会自动提交offset值避免重复消费，Kafka消费端自动提交的逻辑中默认了5秒的间隔，所以在consumer的消费过程中，如果5秒内被强行kill了或者宕机导致offset没有提交，会导致重复消费问题。</p>
<p>在Kafka里有一种叫Partition Balance机制，就是把多个消费区都负载均衡给consumer消费者，如果消费者在默认的五分钟内没有处理完里面的消费，就会触发ReBalance机制导致offset提交失败，在重启ReBalance后，消费端还是会从之前没有提交offset的位置开始去消费，从而导致重复消费问题，如何去解决也有很多方法：</p>
<ol>
<li>提高消费端的处理性能，避免触发Balance，例如：<ol>
<li>比如采用异步的方法来处理消息，缩短单个信息消费的时长</li>
<li>调整消费处理的超时时间</li>
<li>减少一次性从区中获取数据的条数</li>
</ol>
</li>
<li>针对信息生产md5然后保存在MySQL或者redis里，在处理消息前先去MySQL或者redis里判断是否消费过</li>
</ol>
]]></content>
      <tags>
        <tag>面试八股文</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringApplication.run 执行后的四个阶段</title>
    <url>/2025/05/12/articles/%E6%AF%8F%E6%97%A5%E4%B8%80%E7%AF%87/SpringApplication.run%20%E6%89%A7%E8%A1%8C%E5%90%8E%E7%9A%84%E5%9B%9B%E4%B8%AA%E9%98%B6%E6%AE%B5/</url>
    <content><![CDATA[<p>四阶段分别为：服务构建、环境准备、容器创建和填充容器</p>
<p>服务构建</p>
<ul>
<li>首先把传入的资源加载器、主方法类记录到内存中，然后逐一判断对应的服务类是否存在来确定web服务的类型<ul>
<li>默认是基于servlet的web服务，如tomcat，还有响应式非阻塞服务reactive，如spring-webflux，还有什么都不是的none</li>
</ul>
</li>
<li>确定完选择哪个web服务后就是加载初始化类了，会去读取META-INF&#x2F;spring.factories文件中的注册初始化、上下文初始化和监听器这三个配置</li>
<li>最后是通过运行栈stackTrace判断main方法所在类</li>
</ul>
<p>环境准备</p>
<ul>
<li>先new一个启动上下文 <code>bootstrapContext</code>，然后调用启动注册初始化器中的初始化方法 <code>initialize</code>，但由于没有没默认的初始化器，所以也没初始化什么（这个可以靠手动添加）</li>
<li>将 <code>java.awt.headless</code> 设置为 true，表示缺少显示器、键盘等输出设备也能正常启动</li>
<li>然后启动运行监听器，同时发布启动事件，获取并加载springboot工程配置文件中监听器，就可以做到通过监听事件在启动的流程中加入自定义逻辑</li>
<li>接下来就是组装启动参数，例如根据不同的web服务构造不同的环境（默认是servlet）、坏境变量、jvm系统属性等，把这些信息加载到一个内存集合中，后续调用就无需重新加载了</li>
</ul>
<p>容器创建</p>
<ul>
<li>根据服务类型创建容器（默认servlet）注解配置的servlet-web服务容器<ul>
<li>存放和生产bean实例的Bean工厂</li>
<li>用来解析 <code>@Component</code>、<code>@ComponentScan</code> 等注解的配置类后处理器</li>
<li>用来解析 <code>@AutoWired</code>、<code>@Value</code>等注解的自动注解bean处理器</li>
</ul>
</li>
<li>对容器中的部分属性进行初始化</li>
</ul>
<p>填充容器</p>
<ul>
<li>生产自身提供或者自定义的所有Bean对象，放入容器创建步骤中创建好的容器中，这个过程也叫做自动装配</li>
<li>构造启动web服务器</li>
<li>回调自定义实现的 Runner 接口，来处理执行后定制化的需求</li>
</ul>
]]></content>
      <tags>
        <tag>面试八股文</tag>
      </tags>
  </entry>
  <entry>
    <title>redis主从复制的理解</title>
    <url>/2025/05/22/articles/%E6%AF%8F%E6%97%A5%E4%B8%80%E7%AF%87/redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E7%90%86%E8%A7%A3/</url>
    <content><![CDATA[<p>主从复制本质上就是从一台服务器master上的数据拷贝到另一台服务器slave上，<strong>数据的复制是单向的，只能由主节点到从节点</strong>，redis里提供了全量复制和增量复制两种方法：</p>
<ul>
<li><p>全量复制：一般用于slave新构建的时候，slave会向master发送全量复制请求，然后master会拷贝当前数据快照给slave，slave丢弃旧的数据来加载新的数据，但需要注意<strong>redis并没有采用强一致性，所以会出现数据同步延迟导致数据不一致问题</strong></p>
</li>
<li><p>增量复制：当master节点收到数据改动，master会把变更的数据同步给所有的slave节点，主要原理是master和slave会共同维护一个偏移量offset，用来表示master向slave传递的字节数量，每一次进行增量数据的传递，offset都会对应增加数量</p>
</li>
</ul>
<p>主从连接后master 接收命令，判断runid是否匹配，判定offset是否在复制缓冲区中，runid和offset有一个不满足，执行全量复制</p>
<p><strong>心跳机制</strong>：进入命令传播阶段候，master与slave间需要进行信息交换，使用心跳机制进行维护，实现<strong>双方连接保持在线</strong></p>
<ul>
<li>master会去<code>ping slave</code>，默认每十秒一次，来获取slave最后一次连接时间间隔，一般在0或1为正常</li>
<li>slave会用<code>REPLCONF ACK &#123;offset&#125;</code>，每一秒一次，汇报slave自己的复制偏移量，获取最新的数据变更指令以及判断master是否在线</li>
</ul>
]]></content>
      <tags>
        <tag>面试八股文</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL事物的原理是什么</title>
    <url>/2025/05/10/articles/%E6%AF%8F%E6%97%A5%E4%B8%80%E7%AF%87/MySQL%E4%BA%8B%E7%89%A9%E7%9A%84%E5%8E%9F%E7%90%86%E6%98%AF%E4%BB%80%E4%B9%88/</url>
    <content><![CDATA[<p>MySQL满足ACID的特性，所以MySQL事物的原理就是innodb是如何去实现ACID的特性。</p>
<p>首先A就是原子性，就是要保证DML数据库操作语言要么都成功，要么都失败，都成功好理解，如果都失败就意味着要把原本执行的操作都回滚，所以innodb里面设计了一个undo log表，在事物执行的过程中把执行数据的快照保存在undo log表里，例如执行一个insert语句，在undo log表里就存储一个delete语句，一旦出现错误就直接读取undo log执行反向操作就行了。</p>
<p>其次就是C一致性，表示数据的约束没有得到破坏，这个更多是依靠业务层的保障，数据库里面也提供了像主键约束，唯一约束，字段长度约束等。</p>
<p>I是隔离性，多个并行事物对同一个数据进行操作如何去避免多个事物的干扰导致数据混乱。innodb里面实现了SQL92的标注，提供了四个隔离级别的实现，分别是未提交读、已提交读、可重复读以及串行化。innodb默认实现的是可重复读，并且使用了MVCC解决了脏读和不可重复读的问题，然后使用了行锁或者表锁的方式来解决幻读的问题。</p>
<p>D是持久性，也就是说事物提交后的数据一定是永久化保留，不能因为数据库宕机或者其他原因导致数据变更的失效。理论上说事物提交后直接放在磁盘保存就好了，但是因为随机磁盘IO的效率确实很低，所以innodb设计了Buffer pool缓冲区来进行优化，数据更新的时候先更新缓冲区，然后在合适的时间持久化到磁盘里。但是在这个过程中可能会因为数据库宕机导致数据丢失，因此innodb引入了redo log文件，这个文件存储了数据库变更后的值，我们通过事物进行数据更改的时候，除了修改内存缓冲区里的数据以外，还会被本次修改的值追加到redo log里面，当事物提交的时候直接把redo log里面的日志刷新到磁盘里面进行持久化，一旦数据库宕机在MySQL重启以后可以直接用redo log里面保存的重写日志读取再执行一遍。</p>
<p>因此认为，MySQL事物的原理就是innodb如何实现ACID的特性，用到了MVCC、行锁、表锁、缓冲区、redo log和undo log来实现。</p>
]]></content>
      <tags>
        <tag>面试八股文</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot启动流程</title>
    <url>/2025/05/11/articles/%E6%AF%8F%E6%97%A5%E4%B8%80%E7%AF%87/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<p>首先需要一个加了 <code>@SpringBootApplication</code> 注解的启动类，这个注解本质上就是由 <code>@EnableAutoConfiguration</code> 、<code>@SpringBootConfiguration</code> 和 <code>@ComponentScanner</code> 连起来构成。</p>
<ul>
<li><p><code>@EnableAutoConfiguration</code> 的作用是在启动时自动加载一个类，这个类会将所有符合条件的 <code>@Configuration</code> 配置都进行加载，如果启动类中不需要添加配置内容，也不需要扫描路径，可以将 <code>@SpringBootApplication</code> 换成 <code>@EnableAutoConfiguration</code></p>
</li>
<li><p><code>@SpringBootConfiguration</code> 等同于 <code>@Configuration</code>，就是将这个类标记为配置类，会被加载到容器中</p>
</li>
<li><p><code>@ComponentScanner</code> 就是自动扫描并加载所有符合条件的 Bean</p>
</li>
</ul>
<p>注解完成后，运行的起点就是 <code>SpringApplication.run(类名.class, args)</code>，在 run 开始执行后会经历四个阶段：服务构建、环境准备、容器创建和填充容器</p>
]]></content>
      <tags>
        <tag>面试八股文</tag>
      </tags>
  </entry>
  <entry>
    <title>什么是SpringMVC</title>
    <url>/2025/05/19/articles/%E6%AF%8F%E6%97%A5%E4%B8%80%E7%AF%87/%E4%BB%80%E4%B9%88%E6%98%AFSpringMVC/</url>
    <content><![CDATA[<p>SpringMVC 是属于Spring Framework生态里面的一个模块，是在servlet的基础上构建并且使用了MVC模式涉及的web框架，目的是为了去简化传统的servlet+JSP模式下的web开发方式。<br>其次Spring MVC的架构设计是对Javaweb里面的mvc框架模式做了一些增强和扩展，主要体现在几个方面 ：</p>
<ol>
<li>把传统MVC框架里面的Controller控制器做了拆分，分为了前端控制器DispatcherServlet和后端控制器Controller</li>
<li>把model模型拆分成业务层service和数据访问层Repository</li>
<li>在视图层，可以支持不同的视图，比如Freemark、velocity、JSP等</li>
</ol>
<p>所以，SpringMVC就是为了MVC模式设计的，因此在开发MVC应用时会更加方便灵活</p>
<p>SpringMVC整体工作流程：</p>
<ol>
<li>浏览器请求首先经过核心控制器DispatherServlet，把请求分发到对应的Controller里面</li>
<li>然后等Controller调用业务逻辑进行处理完后返回Model And View</li>
<li>DispatcherServlet去寻找一个或多个ViewResolver视图解析器，找到Model And View指定的视图并且把数据展示到客户端</li>
</ol>
]]></content>
      <tags>
        <tag>面试八股文</tag>
      </tags>
  </entry>
  <entry>
    <title>[object Object]</title>
    <url>/2024/12/20/articles/%E6%A8%A1%E6%9D%BF/123/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>什么是循环依赖</title>
    <url>/2025/05/27/articles/%E6%AF%8F%E6%97%A5%E4%B8%80%E7%AF%87/%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/</url>
    <content><![CDATA[<h2 id="什么是循环依赖"><a href="#什么是循环依赖" class="headerlink" title="什么是循环依赖"></a>什么是循环依赖</h2><p>现在我们有两个类 ClassA 与 ClassB，但他们互相引用，直接或间接依赖对方，例如例如A类里有B的对象，B类中又有A的对象</p>
<pre><code class="java">public class ClassA &#123;
    private ClassB classB;
    // 构造方法、getter 和 setter 等
&#125;

public class ClassB &#123;
    private ClassA classA;
    // 构造方法、getter 和 setter 等
&#125;```

这种依赖不仅限于出现在类上，也可能会出现在包上或者模块上

- **出现在包层面的危害：
    - 增加了代码的耦合度，降低了代码的可维护性和可读性
    - 在编译时可能会出现编译顺序的问题，难以确定先编译哪个包。
    - 在后续的开发和维护过程中，增加了维护的难度和风险。

- **出现在模块层面的危害：
    - 会导致模块之间的边界变得模糊，无法清晰地划分模块的职责。在构建和部署项目时，可能会出现循环加载的问题，影响项目的启动效率和运行性能。

## Spring中的循环依赖

当两个或多个 Bean 之间存在构造器注入的循环依赖时，Spring 无法解决这种依赖关系。例如，`BeanA` 的构造器需要 `BeanB`，而 `BeanB` 的构造器又需要 `BeanA`。Spring 容器在创建这些 Bean 的过程中会陷入死循环，无法确定先创建哪个 Bean，从而抛出 `BeanCurrentlyInCreationException` 或 `BeanCurrentlyInCreationException` 等异常。

解决方法：
- Spring 通过单例 Bean 的提前暴露机制来解决基于 Setter 注入的循环依赖问题
- **创建 BeanA 的壳对象并存入三级缓存** ：当创建 `BeanA` 时，Spring 会先创建一个 `BeanA` 的壳对象（即一个未完全初始化的实例，只是构造函数执行完成，属性还没有填充），并将其存入三级缓存（`SingletonObjects`、`earlySingletonObjects` 和 `singletonFactories` 组成的缓存体系）中的 `singletonFactories`。
    
- **创建 BeanB 并注入依赖** ：接着创建 `BeanB`，在创建 `BeanB` 的过程中，发现 `BeanB` 依赖 `BeanA`，此时 Spring 会尝试从缓存中获取 `BeanA`。虽然 `BeanA` 还没有完全初始化（只是壳对象在 `singletonFactories` 中），但 Spring 会将其从 `singletonFactories` 中取出，放入 `earlySingletonObjects` 中，并将其作为依赖注入到 `BeanB` 中。
    
- **完成 BeanA 的初始化并注入到 BeanB** ：`BeanA` 的壳对象被注入到 `BeanB` 后，Spring 会继续完成 `BeanA` 的初始化（填充属性等操作）。当 `BeanA` 初始化完成后，会将它放入 `SingletonObjects` 中。在后续的操作中，如果 `BeanB` 还需要访问 `BeanA`，可以直接从 `SingletonObjects` 中获取已经完全初始化的 `BeanA`。

## 三级缓存

### 一级缓存（`singletonObjects`）

一级缓存也被称为单例池，存储的是已经完全初始化好的单例 Bean 实例。当需要获取一个单例 Bean 时，Spring 会优先从这个缓存中查找，其数据结构为 `Map&lt;String, Object&gt;`，键是 Bean 的名称，值是对应的 Bean 实例。

### 二级缓存（`singletonFactories`）

当 Bean 实例化完成，但还未完成属性注入和初始化时，会将一个创建该 Bean 代理对象的工厂存入二级缓存。其数据结构为 `Map&lt;String, ObjectFactory&lt;?&gt;&gt;`，键为 Bean 的名称，值是用于创建 Bean 的工厂对象。如果从一级缓存中未找到所需的 Bean，Spring 会尝试从二级缓存中获取对应的工厂对象，并通过该工厂创建 Bean 的早期暴露实例。

### 三级缓存（`earlySingletonObjects`）

三级缓存存储的是提前暴露的单例 Bean 实例，这些 Bean 虽然还未完成全部的初始化流程，但已经可以被引用。通过这个缓存，其他 Bean 在依赖该 Bean 时可以获取到一个早期的实例。其数据结构为 `Map&lt;String, Object&gt;`，键是 Bean 的名称，值是早期暴露的 Bean 实例。如果从二级缓存中获取到工厂对象后，会使用该工厂生成一个早期的 Bean 实例，并将其存入三级缓存中，以便其他 Bean 可以引用。
















</code></pre>
]]></content>
      <tags>
        <tag>面试八股文</tag>
      </tags>
  </entry>
  <entry>
    <title>消息队列</title>
    <url>/2025/02/10/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/</url>
    <content><![CDATA[<h1 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h1><p>（听不懂，不是人听的，内容的很奇怪，像初见，又像告别，又像是重逢，能看懂并且记下来都是神人了）</p>
<p>消息队列（MQ），指保存消息的一个容器，本质是个队列。要想称之为消息队列，这个队列要支持 <strong>高吞吐</strong>、<strong>高并发</strong> 并且 <strong>高可用</strong>。</p>
<h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><h3 id="Kafka-的使用"><a href="#Kafka-的使用" class="headerlink" title="Kafka 的使用"></a>Kafka 的使用</h3><ol>
<li>首先需要创建一个 Kafka 集群；</li>
<li>在这个集群中创建一个 Topic，并且设置好分片数量；</li>
<li>编写生产者逻辑，引入对应语言的 SDK，配置好集群和 Topic 等参数，初始化一个生产者，调用 Send 方法发送消息；</li>
<li>编写消费者逻辑，引入对应语言的 SDK，配置好集群和 Topic 等参数，初始化一个消费者，调用 Poll 方法接收消息。</li>
</ol>
<h3 id="Kafka的原理"><a href="#Kafka的原理" class="headerlink" title="Kafka的原理"></a>Kafka的原理</h3><p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<ul>
<li>Topic : 逻辑队列，不同Topic 可以建立不同的 Topic</li>
<li>Cluster : 物理集群，每个集群中可以建立多个不同的 Topic</li>
<li>Producer : 生产者，负责将业务消息发送到Topic 中</li>
<li>Consumer : 消费者，负责消费 Topic 中的消息</li>
<li>ConsumerGroup : 消费者组，不同组Consumer 消费进度互不干涉</li>
</ul>
<p>这其中还涉及到 Topic 内的 offset(相对位置)，Replica（副本），以及副本分布相关概念：</p>
<ul>
<li>Offset : 消息在 partition 内的相对位置信息，可以理解为唯一D，在 partition 内部严格递增</li>
<li>Replica : 每个分片有多个 Replica，Leader Replica 将会从 ISR(In-Sync Replicas) 中选出，一般分为 Leader 和 Follower，Leader 是主片， Follwer 会异步去同步 Leader，以防 Leader 挂了可以立马补上</li>
</ul>
<h3 id="Kafka-运行流程"><a href="#Kafka-运行流程" class="headerlink" title="Kafka 运行流程"></a>Kafka 运行流程</h3><p>（这里我也没看懂QAQ）</p>
<p>一条消息进入 kafka 处理的流程为： <code>Producer -&gt; Broker -&gt; Consumer</code>，在这三个部分可以分别采取一些方案帮助 Kafka 提高吞吐或者稳定性。</p>
<ul>
<li>Producer 端逻辑<ul>
<li>批量发送<ul>
<li>为了应对大消息量的场景，采取批量发送机制，通过一次性发送多个消息从而减少 I&#x2F;O 次数，加强发送能力</li>
</ul>
</li>
<li>消息压缩<ul>
<li>在消息容量太大，带宽较小，导致发送速度慢的场景下，kafka 提供了消息压缩，通过对消息进行压缩处理减小消息的大小</li>
</ul>
</li>
</ul>
</li>
<li>Broker 端逻辑<ul>
<li>写入<ul>
<li>在存储过程中，kafka 会通过副本生成日志，将日志写入磁盘，而这些日志显然是有时效的，因此根据存入的有效时间存入不同的日志段 LogSegment，此外根据磁盘的结构，采用顺序写的方式进行写入，可以提高写入效率</li>
</ul>
</li>
<li>读取<ul>
<li>Consumer 通过发送 FetchRequest 请求消息数据，Broker 通过索引取出消息，按照时间窗口和信息大小发送给 Consumer</li>
</ul>
</li>
<li>Broker 有两种文件索引方式<ul>
<li>偏移量索引：通过二分法寻找小于目标 offset 的最大文件</li>
<li>时间戳索引：通过二分法找到小于目标时间戳最大的索引位置</li>
</ul>
</li>
<li>数据拷贝<ul>
<li>kafka 拷贝数据的流程不经过用户态空间，而是在读取磁盘后直接将 Read Buffer 中的数据传输到 NIC Buffer，通过 NIC Buffer 直接交付给消费者进程</li>
</ul>
</li>
</ul>
</li>
<li>Consumer 端逻辑<ul>
<li>分配的问题，也就是对于每一个 partition 来讲，该由哪一个 consumer 来消费<ul>
<li>手动分配（low level）：在启动的时候分配任务，哪个 Consumer 负责拉取哪几个 partition，但是万一其中一个 Consumer 宕机，就会导致无法拉取到完全的 partition</li>
<li>自动分配（high level）：对于每一个消费者组，都会选择一个 Broker 作为一个协调者 Coordinator，这个协调者负责分配各个消费者获取 partition 的任务，这使得可以动态调整各个 Consumer 的任务</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Kafka缺点"><a href="#Kafka缺点" class="headerlink" title="Kafka缺点"></a>Kafka缺点</h3><ul>
<li>运维成本高；</li>
<li>负载不均衡，解决方案复杂；</li>
<li>没有自己的缓存，需要依赖外部Cache;</li>
<li>若 Controller 和 Coordinator 与 Broker 在同一个进程中，大量 I&#x2F;O 会导致性能下降。</li>
</ul>
<h2 id="BMQ"><a href="#BMQ" class="headerlink" title="BMQ"></a>BMQ</h2><p>BMQ （Bytedance Message Queue） 是字节跳动出品的消息队列产品，解决了 Kafka 在实际应用中的诸多问题。</p>
<h3 id="BMQ-架构模型"><a href="#BMQ-架构模型" class="headerlink" title="BMQ 架构模型"></a>BMQ 架构模型</h3><p>兼容 Kafka 协议，存算分离，云原生消息队列</p>
<ul>
<li>新增 Proxy 层作为代理；</li>
<li>Coordinator 和 Controller 可以独立部署；</li>
<li>底层新增 HDFS 用于存算分离。</li>
</ul>
<p>Proxy 负责接收所有用户的请求，对于生产请求，Proxy 会将其转发给对应的 Broker；对于消费者相关的请求，例如 commit offset，join group 等，Proxy 会将其转发给对应的 Coordinator；对于读请求 Proxy 会直接处理，并将结果返回给客户端。</p>
<p>BMQ 的 Broker 与 Kafka 的 Broker 略有不同，它主要负责写入请求的处理，其余请求交给了 Proxy 和 Coordinator 处理。</p>
<p>Coordinator 与 Kafka 版本最大的差别在于我们将其从 Broker 中独立，作为单独的进程提供服务。这样的好处是读写流量与消费者协调的资源可以完全隔离，不会互相影响。另外 Coordinator 可以独立扩缩容，以应对不同集群的情况。</p>
<p>Controller 承担组件心跳管理、负载均衡、故障检测及控制命令接入的工作。因为 BMQ 将数据放在分布式存储系统上，因此无需管理数据副本，相较于 Kafka 省去了 ISR 相关的管理。Controller 可以更加专注地关注集群整体流量均衡及故障检测。</p>
<p><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h3 id="BMQ的优点"><a href="#BMQ的优点" class="headerlink" title="BMQ的优点"></a>BMQ的优点</h3><ul>
<li><p><strong>Kafka痛点</strong>：传统Kafka采用分区（Partition）与Broker强绑定的架构，扩容需数据重平衡，导致运维复杂、资源浪费。</p>
</li>
<li><p><strong>BMQ解决方案</strong>：</p>
<ul>
<li><p><strong>Proxy层解耦</strong>：引入无状态Proxy节点处理客户端请求，与存储层分离，实现<strong>动态扩缩容</strong>无需数据迁移。</p>
</li>
<li><p><strong>分布式存储层</strong>：数据持久化采用自研分布式存储系统（如HDFS或对象存储），支持<strong>弹性扩展</strong>，降低存储成本。</p>
</li>
<li><p><strong>自动负载均衡</strong>：Topic分区动态调度至不同存储节点，规避Kafka的”热点分区”问题。</p>
</li>
</ul>
</li>
<li><p><strong>BMQ关键技术</strong>：</p>
<ul>
<li><p><strong>零拷贝优化</strong>：绕过操作系统内核，直接操作存储设备（如SPDK），减少数据拷贝次数。</p>
</li>
<li><p><strong>异步流水线</strong>：写路径采用异步化设计，合并小IO为顺序写入，提升吞吐量。</p>
</li>
<li><p><strong>分层存储</strong>：热数据存内存&#x2F;SSD，冷数据转至廉价HDD或对象存储，平衡成本与性能。</p>
</li>
</ul>
</li>
</ul>
<h3 id="BMQ的读写流程"><a href="#BMQ的读写流程" class="headerlink" title="BMQ的读写流程"></a>BMQ的读写流程</h3><ul>
<li><p>创建Producer和Consumer：在使用BMQ之前，需要创建Producer和Consumer并连接到消息队列服务器。</p>
</li>
<li><p>创建队列：BMQ支持多个队列，可以为不同的消息类型创建不同的队列。</p>
</li>
<li><p>发送消息：生产者将消息发送到指定的队列中，消息会被存储到消息队列中，等待消费者来获取。</p>
</li>
<li><p>获取消息：消费者从队列中获取消息，并进行处理。</p>
</li>
<li><p>确认消息：消费者在处理完消息后，需要向BMQ服务器发送确认消息，告诉服务器已经消费完成。</p>
</li>
</ul>
<h2 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h2><p>（没看懂，但是好像很重要，留住，以后再学）</p>
<p>RocketMQ 以低延时出名，适合用在电商或者一些实时的业务上</p>
<p>官方文档：<a href="https://link.juejin.cn/?target=https://rocketmq.apache.org/docs/" title="https://rocketmq.apache.org/docs/">rocketmq.apache.org&#x2F;docs&#x2F;</a></p>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h3 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h3><p><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>性能优化及自动内存管理</title>
    <url>/2025/02/20/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/16.Go%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%8F%8A%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%8F%8A%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<p>&#x3D;&#x3D;这里主要讲的是Go语言&#x3D;&#x3D;，太概念了，这知识根本不入脑</p>
<h1 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h1><p>提升软件系统处理能力，减少不必要的消耗，充分发掘计算机算力</p>
<h2 id="性能优化的作用"><a href="#性能优化的作用" class="headerlink" title="性能优化的作用"></a>性能优化的作用</h2><ul>
<li>用户体验：带来用户体验的提升 - 让刷抖音更丝滑，让双十一购物不再卡顿</li>
<li>资源高效利用：降低成本，提高效率 - 很小的优化乘以海量机器会是显著的性能提升和成本节约</li>
</ul>
<h2 id="性能优化的层面"><a href="#性能优化的层面" class="headerlink" title="性能优化的层面"></a>性能优化的层面</h2><ul>
<li>业务层优化<ul>
<li>针对特定场景，具体问题，具体分析</li>
<li>容易获得较大性能收益</li>
</ul>
</li>
<li>语言运行时优化<ul>
<li>解决更通用的性能问题</li>
<li>考虑更多场景</li>
<li>Tradeoffs</li>
</ul>
</li>
<li>数据驱动<ul>
<li>自动化性能分析工具 – pprof</li>
<li>依靠数据而非猜测</li>
<li>首先优化最大瓶颈</li>
</ul>
</li>
</ul>
<h2 id="软件质量"><a href="#软件质量" class="headerlink" title="软件质量"></a>软件质量</h2><ul>
<li>软件质量至关重要</li>
<li>在保证接口稳定的前提下改进具体实现</li>
<li>测试用例:覆盖尽可能多的场景，方便回归</li>
<li>文档：做了什么，没做什么，能达到怎样的效果</li>
<li>隔离：通过选项控制是否开启优化</li>
<li>可观测:必要的日志输出</li>
</ul>
<h1 id="自动内存管理"><a href="#自动内存管理" class="headerlink" title="自动内存管理"></a>自动内存管理</h1><ul>
<li>动态内存<ul>
<li>程序在运行时根据需求动态分配的内存：malloc()</li>
</ul>
</li>
<li>自动内存管理(垃圾回收):由程序语言的运行时系统管理动态内存<ul>
<li>避免手动内存管理，专注于实现业务逻辑</li>
<li>保证内存使用的正确性和安全性: double-free problem, use-after-free problem</li>
</ul>
</li>
</ul>
<h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><ul>
<li>Mutator:业务线程，分配新对象，修改对象指向关系</li>
<li>Collector: GC 线程，找到存活对象，回收死亡对象的内存空间</li>
<li>Serial Gc: 只有一个 collector</li>
<li>Parallel Gc: 支持多个 collectors 同时回收的 GC 算法</li>
<li>Concurrent GC: mutator(s)和 collector(s)可以<strong>同时执行</strong><ul>
<li>Collectors 必须感知对象指向关系的改变</li>
</ul>
</li>
</ul>
<h2 id="追踪垃圾回收"><a href="#追踪垃圾回收" class="headerlink" title="追踪垃圾回收"></a>追踪垃圾回收</h2><ul>
<li>对象被回收的条件：指针指向关系不可达的对象</li>
<li>标记根对象<ul>
<li>静态变量、全局变量、常量、线程栈等</li>
</ul>
</li>
<li>标记：找到可达对象<ul>
<li>求指针指向关系的传递闭包：从根对象出发，找到所有可达对象</li>
</ul>
</li>
<li>清理：所有不可达对象<ul>
<li>将存活对象复制到另外的内存空间(Copying GC)</li>
<li>将死亡对象的内存标记为“可分配”(Mark-sweep GC)</li>
<li>移动并整理存活对象(Mark-compact GC)</li>
</ul>
</li>
<li>根据对象的生命周期，使用不同的标记和清理策略</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>开源实践入门</title>
    <url>/2025/02/21/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/17.%E5%BC%80%E6%BA%90%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8/%E5%BC%80%E6%BA%90%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<p>看完感觉跟没看一样，学习笔记就直接把课件CV一份，好歹也是看了</p>
<h1 id="开源软件定义"><a href="#开源软件定义" class="headerlink" title="开源软件定义"></a>开源软件定义</h1><p>非盈利组织 Open Source Initiative(OSI)极力倡导，任何开源软件都必须遵循如下标准</p>
<ul>
<li>可以被免费进行二次分发。</li>
<li>源代码应当公开、可用。</li>
<li>可以与原始软件不同的格式进行修改和分发。</li>
<li>软件本身不应歧视任何个人或团体。</li>
<li>软件本身不应限制其他软件的使用或调用。</li>
</ul>
<p>开源不仅仅意味着源码开放，同时还需要支持衍生物发行、符合传播规范、满足非歧视原则等要求OSI让开源具有了教育和倡导开放式开发流程的优势。(社会价值)<br>开源软件提供了一种与潜在的软件用户和开发人员相互动的宝贵方法。通过一个具有互动参与性的社区大家可以创建新的或改进原有的源代码。(项目价值)</p>
<h1 id="自由软件-开源软件-免费软件"><a href="#自由软件-开源软件-免费软件" class="headerlink" title="自由软件 &amp; 开源软件 &amp; 免费软件"></a>自由软件 &amp; 开源软件 &amp; 免费软件</h1><ul>
<li>所谓“Free Software”中的“free”-词强调的是自由，而不是价格上的免费。</li>
<li>自由软件有比开源软件更严格的概念，因此所有自由软件都是开放源代码的，但不是所有的开源软件都能被称为“自由”。</li>
<li>免费软件就是不要钱的软件，但“不要钱”的定义往往是模糊的:是指人们取得该软件时无需付费，还是说人们在使用的过程中都无需付费，亦或是指该软件的发行者不从中获取利益?实际情况往往是复杂而黑暗的。</li>
</ul>
<h1 id="开源软件的意义"><a href="#开源软件的意义" class="headerlink" title="开源软件的意义"></a>开源软件的意义</h1><p>从软件分发而言</p>
<ul>
<li>任何人可以修改源代码，以满足使用需求</li>
<li>打破专有软件垄断，根据许可证要求再分发</li>
<li>降低软件总拥有成本，促进软件行业快速发展</li>
</ul>
<p>从行为动机而言</p>
<ul>
<li>礼物文化:付出热情、智慧和努力，得到认可</li>
<li>行动中学习，教与学的过程，例如 Code Review</li>
</ul>
<p>从技术发展而言</p>
<ul>
<li>标准化快速落地，打破软件烟囱，技术生态繁荣发展</li>
<li>沟通协作和技术场景复杂，促进代码和架构的模块化</li>
<li>开源引领技术创新，成为新技术的摇篮</li>
</ul>
<p>从组织管理而言</p>
<ul>
<li>打造开放式组织，最大化知识工作者的效益</li>
<li>Private Collective Model，即成员私有投入，产出公开可见</li>
<li>民主与决策，Communityovercode 下的社区治理实践</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>什么是消息队列（Kafka）</title>
    <url>/2025/05/26/articles/%E6%AF%8F%E6%97%A5%E4%B8%80%E7%AF%87/%E4%BB%80%E4%B9%88%E6%98%AF%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%88Kafka%EF%BC%89/</url>
    <content><![CDATA[<h3 id="模拟场景"><a href="#模拟场景" class="headerlink" title="模拟场景"></a>模拟场景</h3><p>假如现在我需要维护两个服务A和B，B服务每秒能处理100个消息，但A服务每秒能发两百个消息</p>
<p>结果我们也能想到，B服务非常容器就爆炸了，聪明的我一定能想到，我在B里面加一个队列来存放A发来的消息，用offset偏移量来记录消息的位置，B服务看能力来处理消息，不断更新offset值</p>
<p>但这又产生了一个新问题，来不及处理的消息放在内存里，如果在服务B里面的消息没有处理完的情况下B服务关机或者重启了，里面的消息就全部丢失了，但聪明的我肯定还会想到，那我们把队列拉出来单独开一个进程不就行了嘛</p>
<p>这就是消息队列的来源，像A服务一样发数据到队列里就是生产者，B服务这样处理数据的就是消费者</p>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><ul>
<li><p><strong>高性能</strong><br>  简单来说就是软件不行加硬件，消费者太慢了就加消费者，生产者慢就加生产者，但这听着感觉还是不对，如果多个生产者和消费者同时争抢同一个消息队列，抢不到就等怎么办</p>
<p>  解决方法：<br>  对消息进行分类，每一类是一个topic，按照topic数量，生产者将消息分发给不同的消息队列里面，一个消费者需要订阅不同的队列来获取消息，但这样还是会出现一个topic里消息还是很多，我们还可以把单个topic拆成多个partition分区，每个消费者负责一个partition分区</p>
</li>
<li><p><strong>高扩展</strong></p>
<p>  随着partition变多，如果partition都在同一台机器上可能会导致单机CPU内存负载过高，影响系统整体效率</p>
<p>  解决方法：<br>  将partition分散部署到多台机器上，每一台机器就是一个broker，我们可以通过增加broker来缓解机器CPU负载过高带来的性能问题</p>
</li>
<li><p><strong>高可用</strong></p>
<p>  如果其中一个broker挂了，那里面所有partition的消息也会跟着消失</p>
<p>  解决方法：<br>  给partition多加几个副本，统称为replicas，将他们分为leader和follower，leader负责应对生产者和消费者的读写请求，follower负责同步leader的消息，将leader和follower分散到不同的broker里，这样就算leader所在的broker挂了也不会影响到follower所在的broker，并且还能重新选举一个leader partition顶上</p>
</li>
<li><p><strong>持久化和过期策略</strong></p>
<p>  假设全部broker都挂了，那所以的partition的消息不都丢失了吗</p>
<p>  解决方法：<br>  所以我们不能光将数据放在内存里，还需要持久化到磁盘上，但问题又来了，磁盘是有限的，一直往里面写数据迟早得炸，所以还需要给数据加上保留策略retention policy，比如磁盘数据超过一定大小或者数据放置超过一定时间就会被清理掉</p>
</li>
<li><p><strong>消费者组consumer group</strong></p>
<p>  按现在的消费方式，每次新增的消费者只能跟着最新的offset接着消费，如何让新增的消费者从指定的offset开始消费呢</p>
<p>  解决方法：<br>  引入消费者组概念，不同消费者组维护自己的消费进度，互不打扰</p>
</li>
<li><p><strong>ZooKeeper</strong></p>
<p>  就目前来看，组件太多了，而且每个组件都有自己的数据和状态，因此需要有一个组件去统一维护这些组件的状态，于是引入了ZooKeeper组件</p>
<p>  ZooKeeper会定期和broker通信，获取整个Kafka集群的状态，以此判断某些broker是不是挂了，某些消费者消费到哪了</p>
</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li>流量削峰填谷</li>
<li>异构同步（不同类型、不同厂商的数据库系统之间进行数据同步）</li>
<li>日志处理与分析</li>
<li>系统监控与报警等</li>
</ul>
]]></content>
      <tags>
        <tag>面试八股文</tag>
      </tags>
  </entry>
  <entry>
    <title>校园闪送项目笔记</title>
    <url>/2025/04/17/articles/Substitute%20driver/%E6%88%91%E6%9D%A5%E5%BC%80%EF%BC%81%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="搭建前端环境"><a href="#搭建前端环境" class="headerlink" title="搭建前端环境"></a>搭建前端环境</h1><h2 id="注册微信开发者账号"><a href="#注册微信开发者账号" class="headerlink" title="注册微信开发者账号"></a>注册微信开发者账号</h2><p>打开微信公总平台，按照流程一步步注册：<code>https://mp.weixin.qq.com/</code></p>
<p>然后去申请开通三个我们项目会用到的接口<br>![[Pasted image 20250417092751.png]]</p>
<p>以及我们需要用到的插件<br>![[Pasted image 20250417093027.png]]<br><a href="https://fuwu.weixin.qq.com/search?tab=3&type=&serviceType=3&page=1&kw=%E8%85%BE%E8%AE%AF%E4%BD%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%9C%B0%E5%9B%BE%E9%80%89%E7%82%B9">https://fuwu.weixin.qq.com/search?tab=3&amp;type=&amp;serviceType=3&amp;page=1&amp;kw=腾讯位置服务地图选点</a><br>fuwu.weixin.qq.com&#x2F;search?tab&#x3D;3&amp;type&#x3D;&amp;serviceType&#x3D;3&amp;page&#x3D;1&amp;kw&#x3D;微信同声传译</p>
<h2 id="安装-node-js-和微信开发者工具"><a href="#安装-node-js-和微信开发者工具" class="headerlink" title="安装 node.js 和微信开发者工具"></a>安装 node.js 和微信开发者工具</h2><p>下载node.js：<code>https://nodejs.org/en/download</code> 版本选择16.20.0<br>![[Pasted image 20250417093149.png]]</p>
<p>微信开发者工具也是点击下载一步步走就行</p>
<ul>
<li>下载两遍，安装两个相同的，方便后期项目两个端口一起调试<br>![[Pasted image 20250417091648.png]]<br>![[Pasted image 20250417091741.png]]</li>
</ul>
<h2 id="在开发者工具中运行前端代码"><a href="#在开发者工具中运行前端代码" class="headerlink" title="在开发者工具中运行前端代码"></a>在开发者工具中运行前端代码</h2><ul>
<li><p>点击左上角项目栏下的导入项目<br>![[Pasted image 20250417093655.png]]</p>
</li>
<li><p>点击上方设置栏中的安全设置，打开里面的服务端口<br>![[Pasted image 20250417093936.png]]</p>
</li>
</ul>
<p>另一个也是一样</p>
<h1 id="搭建后端环境"><a href="#搭建后端环境" class="headerlink" title="搭建后端环境"></a>搭建后端环境</h1><h2 id="安装软件环境"><a href="#安装软件环境" class="headerlink" title="安装软件环境"></a>安装软件环境</h2><h3 id="安装rabbitmq"><a href="#安装rabbitmq" class="headerlink" title="安装rabbitmq"></a>安装rabbitmq</h3><ul>
<li>**第一步 拉取镜像</li>
</ul>
<p>&#96;docker pull rabbitmq:3.9.0-management</p>
<ul>
<li>**第二步 使用容器启动服务</li>
</ul>
<p>&#96;docker run -d –name&#x3D;rabbitmq –restart&#x3D;always -p 5672:5672 -p 15672:15672 rabbitmq:3.9.0-management  </p>
<ul>
<li>**第三步 安装延迟队列插件</li>
</ul>
<p>1、首先下载rabbitmq_delayed_message_exchange-3.9.0.ez文件上传到RabbitMQ所在服务器，下载地址：<a href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a></p>
<p>2、上传下载延迟队列插件到Linux操作系统中，切换到插件所在目录，</p>
<p>执行 <code>docker cp rabbitmq_delayed_message_exchange-3.9.0.ez rabbitmq:/plugins</code> 命令，将刚插件拷贝到容器内plugins目录下</p>
<p>3、执行 <code>docker exec -it rabbitmq /bin/bash</code> 命令进入到容器内部，并 <code>cd plugins</code> 进入plugins目录</p>
<p>执行 <code>ls -l|grep delay</code>  命令查看插件是否copy成功<br>在容器内plugins目录下，执行 <code>rabbitmq-plugins enable rabbitmq_delayed_message_exchange</code>  命令启用插件</p>
<p>4、exit命令退出RabbitMQ容器内部，然后执行 <code>docker restart rabbitmq</code> 命令重启RabbitMQ容器</p>
<ul>
<li>**第四步 远程访问设置凭证<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 进入容器</span><br><span class="line">docker exec -it rabbitmq bash</span><br><span class="line"></span><br><span class="line"># 创建新用户（用户名：admin，密码：Abc123）</span><br><span class="line">rabbitmqctl add_user admin Abc123</span><br><span class="line"></span><br><span class="line"># 赋予管理员权限</span><br><span class="line">rabbitmqctl set_user_tags admin administrator</span><br><span class="line"></span><br><span class="line"># 赋予所有权限（虚拟主机为 /）</span><br><span class="line">rabbitmqctl set_permissions -p / admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h3><ul>
<li>**第一步 拉取镜像</li>
</ul>
<p><code>docker pull redis</code></p>
<ul>
<li>**第二步 创建Redis配置文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">## 创建目录</span><br><span class="line">mkdir -p /home/redis/conf</span><br><span class="line">## 创建文件</span><br><span class="line">touch /home/redis/conf/redis.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>**第三步 创建redis并启动</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name redis \</span><br><span class="line">  -p 6379:6379 \</span><br><span class="line">  --restart unless-stopped \</span><br><span class="line">  -v /home/redis/data:/data \</span><br><span class="line">  -v /home/redis/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">  redis:latest \</span><br><span class="line">  redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>**第四步 进入redis容器</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">### 直接通过Docker Redis 命令进入Redis控制台</span><br><span class="line">docker exec -it redis redis-cli</span><br><span class="line">### 进入 Redis 控制台</span><br><span class="line">redis-cli</span><br><span class="line">### 添加一个变量为 key 为 name , value 为 bella 的内容</span><br><span class="line">&gt; set name bella</span><br><span class="line">### 查看 key 为 name 的 value 值</span><br><span class="line">&gt; get name</span><br></pre></td></tr></table></figure>
<h3 id="安装minio"><a href="#安装minio" class="headerlink" title="安装minio"></a>安装minio</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> docker run \</span><br><span class="line">--name minio_one \</span><br><span class="line">-p 9000:9000  \</span><br><span class="line">-p 9001:9001  \</span><br><span class="line">-d \</span><br><span class="line">-e &quot;MINIO_ROOT_USER=admin&quot; \</span><br><span class="line">-e &quot;MINIO_ROOT_PASSWORD=admin123456&quot; \</span><br><span class="line">-v /root/minio-data:/data \</span><br><span class="line">-v /root/minio-config:/root/.minio \</span><br><span class="line">minio/minio server  /data --console-address &quot;:9001&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>docker run：这是Docker命令行工具用来运行一个新容器的命令。</p>
</li>
<li><p>–name minio_one：这个参数为容器指定了一个名称，这里名称被设置为minio_one。使用名称可以更方便地管理容器。</p>
</li>
<li><p>p 9000:9000：这个参数将容器内的9000端口映射到宿主机的9000端口。MinIO服务默认使用9000端口提供API服务。</p>
</li>
<li><p>-p 9001:9001：这个参数将容器内的9001端口映射到宿主机的9001端口。这是MinIO的控制台（Console）端口，用于访问MinIO的图形用户界面。</p>
</li>
<li><p>-d：这个参数告诉Docker以“detached”模式运行容器，即在后台运行。</p>
</li>
<li><p>-e “MINIO_ROOT_USER&#x3D;admin”：设置环境变量MINIO_ROOT_USER，这是访问MinIO服务的用户名称，这里设置为admin。</p>
</li>
<li><p>-e “MINIO_ROOT_PASSWORD&#x3D;admin123456”：设置环境变量MINIO_ROOT_PASSWORD，这是访问MinIO服务的用户密码，这里设置为admin123456。</p>
</li>
<li><p>-v &#x2F;home&#x2F;data:&#x2F;data：这个参数将宿主机的目录&#x2F;home&#x2F;data:&#x2F;data挂载到容器的&#x2F;data目录。MinIO会将所有数据存储在这个目录。</p>
</li>
<li><p>-v  &#x2F;root&#x2F;config:&#x2F;root&#x2F;.minio：这个参数将宿主机的目录&#x2F;root&#x2F;minio-config挂载到容器的&#x2F;root&#x2F;.minio目录。这个目录用于存储MinIO的配置文件和数据。</p>
</li>
<li><p>minio&#x2F;minio：这是要运行的Docker镜像的名称，这里使用的是官方发布的MinIO镜像。</p>
</li>
<li><p>server &#x2F;data：这是传递给MinIO程序的命令行参数，告诉MinIO以服务器模式运行，并且使用&#x2F;data目录作为其数据存储位置。</p>
</li>
<li><p>–console-address “:9001”：这个参数指定MinIO控制台服务的监听地址和端口。在这个例子中，它设置为监听所有接口上的9001端口。</p>
</li>
</ul>
<p>注意:文件上传时，需要调整-下Linux 服务器的时间与Windows 时间一致!</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">第一步:安装ntp服务</span><br><span class="line">yum -y install ntp</span><br><span class="line">第二步:开启开机启动服务</span><br><span class="line">systemctl enable ntpd</span><br><span class="line">第三步:启动服务</span><br><span class="line">systemctl start ntpd</span><br><span class="line">第四步:更改时区</span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line">第五步:启用ntp同步</span><br><span class="line">timedatectl set-ntp yes</span><br><span class="line">第六步:同步时间</span><br><span class="line">ntpq -p</span><br></pre></td></tr></table></figure>

<p>如果启动不了，那么就重构主义，推了重建</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 强制删除旧容器（保留数据卷）</span><br><span class="line">docker rm -f minio_one</span><br><span class="line"></span><br><span class="line"># 重新运行 MinIO 容器（使用正确的镜像名称 minio/minio）</span><br><span class="line">docker run \</span><br><span class="line">--name minio_one \</span><br><span class="line">-p 9000:9000 \</span><br><span class="line">-p 9001:9001 \</span><br><span class="line">-d \</span><br><span class="line">-e &quot;MINIO_ROOT_USER=admin&quot; \</span><br><span class="line">-e &quot;MINIO_ROOT_PASSWORD=admin123456&quot; \</span><br><span class="line">-v /root/minio-data:/data \</span><br><span class="line">-v /root/minio-config:/root/.minio \</span><br><span class="line">minio/minio server /data --console-address &quot;:9001&quot;</span><br></pre></td></tr></table></figure>

<h3 id="nacos"><a href="#nacos" class="headerlink" title="nacos"></a>nacos</h3><ul>
<li>开启nacos</li>
</ul>
<p><code>bash /root/nacos/bin/startup.sh -m standalone</code></p>
<ul>
<li>关闭nacos</li>
</ul>
<p><code>bash /root/nacos/bin/shutdown.sh</code></p>
<h2 id="导入数据库内容"><a href="#导入数据库内容" class="headerlink" title="导入数据库内容"></a>导入数据库内容</h2><ul>
<li><p>只需要在 DataGrip 连接上服务器或者本地的数据库</p>
</li>
<li><p>然后再把所需要的数据库和表创建好，数据导入进去</p>
</li>
</ul>
<h3 id="逻辑删除"><a href="#逻辑删除" class="headerlink" title="逻辑删除"></a>逻辑删除</h3><ul>
<li><p>物理删除是与之前一样，直接把数据删除，但这样不方便我们恢复数据，所以 mybatis-plus 有一种删除叫逻辑删除</p>
</li>
<li><p>我们可以在数据表加一列属性表示为逻辑删除，值为0表示没有删除，值为1表示删除，方便我们恢复数据</p>
</li>
</ul>
<p>官方文档：<a href="https://baomidou.com/guides/logic-delete/">https://baomidou.com/guides/logic-delete/</a></p>
<p>第一种方法：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">logic-delete-field:</span> <span class="string">isDelete</span> <span class="comment">#默认deleted</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure>

<p>第二种方法：<br>添加@TableLogic注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">。。。</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1删除0正常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableLogic(value = &quot;1&quot;,delval = &quot;0&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer isDelete;</span><br><span class="line">。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加完后再使用mp已经封装好的语句都会加上 <code>where deleted = 0</code></p>
<h3 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h3><ul>
<li><p>实现分页查询前需要配置分页插件</p>
</li>
<li><p>分页插件：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;scan.your.mapper.package&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加分页插件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL)); <span class="comment">// 如果配置多个插件, 切记分页最后添加</span></span><br><span class="line">        <span class="comment">// 如果有多数据源可以不配具体类型, 否则都建议配上具体的 DbType</span></span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="导入配置文件"><a href="#导入配置文件" class="headerlink" title="导入配置文件"></a>导入配置文件</h2><ul>
<li>两种导入模式</li>
</ul>
<p>第一种：像之前一样一条一条创建</p>
<p>第二种：把文件打成压缩包，但是压缩包名称要与组的名字相同（默认是 <code>DEFAULT_GROUP</code>）<br>![[Pasted image 20250418214153.png]]</p>
<h1 id="客户端登录"><a href="#客户端登录" class="headerlink" title="客户端登录"></a>客户端登录</h1><h2 id="微信小程序登录流程"><a href="#微信小程序登录流程" class="headerlink" title="微信小程序登录流程"></a>微信小程序登录流程</h2><ul>
<li>官方文档：<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html</a></li>
</ul>
<p>![[Pasted image 20250419174655.png]]</p>
<h2 id="微信小程序登录接口"><a href="#微信小程序登录接口" class="headerlink" title="微信小程序登录接口"></a>微信小程序登录接口</h2><ul>
<li>这是接下来需要实现的步骤</li>
</ul>
<p>项目工程结构：<br>![[Pasted image 20250419180421.png]]</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul>
<li>**导入微信工具包相关依赖</li>
</ul>
<p>在 service-customer 中引入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.binarywang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>weixin-java-miniapp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>**修改 nacos 配置中心文件</p>
<ul>
<li><p>因为查看官方文档可以看到我们后端请求腾讯接口需要三个值：小程序id、密钥和临时票据code，所以我们需要去 nacos 修改配置文件，把密钥和小程序id先作配置</p>
</li>
<li><p>注意查看项目配置文件 <code>bootstrap.properties</code> 里 nacos 的 IP 与端口是否正确</p>
</li>
</ul>
</li>
<li><p>创建配置类来读取配置文件信息</p>
</li>
</ul>
<p>在 service-customer 创建包config，创建类来读取配置文件中的内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="comment">//从配置文件中读取 wx.miniapp 前缀下的字段</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;wx.miniapp&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxConfigProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建微信工具包对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxConfigOperator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WxConfigProperties wxConfigProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WxMaService <span class="title function_">wxMaService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">WxMaDefaultConfigImpl</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxMaDefaultConfigImpl</span>();</span><br><span class="line">        config.setAppid(wxConfigProperties.getAppId());</span><br><span class="line">        config.setSecret(wxConfigProperties.getSecret());</span><br><span class="line"></span><br><span class="line">        <span class="type">WxMaService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxMaServiceImpl</span>();</span><br><span class="line">        service.setWxMaConfig(config);</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="功能实现-基础功能"><a href="#功能实现-基础功能" class="headerlink" title="功能实现-基础功能"></a>功能实现-基础功能</h3><ul>
<li><p>在 service-customer 的 CustomerInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/customer/info&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerInfoController</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CustomerInfoService customerInfoService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 微信小程序登录接口</span></span><br><span class="line">	<span class="meta">@Operation(summary = &quot;小程序授权登录&quot;)</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;login/&#123;code&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">longin</span><span class="params">(<span class="meta">@PathVariable</span> String code)</span> &#123;</span><br><span class="line">	    <span class="keyword">return</span> Result.ok(customerInfoService.login(code));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service实现接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;CustomerInfoMapper, CustomerInfo&gt; <span class="keyword">implements</span> <span class="title class_">CustomerInfoService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WxMaService wxMaService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerInfoMapper customerInfoMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerLoginLogMapper customerLoginLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//微信小程序登录</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">login</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 获取code值，通过微信工具包对象，获取唯一标识openId</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">WxMaJscode2SessionResult</span> <span class="variable">sessionInfo</span> <span class="operator">=</span> wxMaService.getUserService().getSessionInfo(code);</span><br><span class="line">             openid = sessionInfo.getOpenid();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WxErrorException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用openId查询数据库是否存在</span></span><br><span class="line">        <span class="comment">// 如果openId不存在返回null，如果存在返回记录</span></span><br><span class="line">        LambdaQueryWrapper&lt;CustomerInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>();</span><br><span class="line">        wrapper.eq(CustomerInfo::getWxOpenId, openid);</span><br><span class="line">        <span class="type">CustomerInfo</span> <span class="variable">customerInfo</span> <span class="operator">=</span> customerInfoMapper.selectOne(wrapper);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果不存在，也就是第一次登陆，添加信息到用户表</span></span><br><span class="line">        <span class="keyword">if</span> (customerInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            customerInfo = <span class="keyword">new</span> <span class="title class_">CustomerInfo</span>();</span><br><span class="line">            <span class="comment">//用当前时间戳作为昵称</span></span><br><span class="line">            customerInfo.setNickname(String.valueOf(System.currentTimeMillis()));</span><br><span class="line">            <span class="comment">//设置默认头像</span></span><br><span class="line">            customerInfo.setAvatarUrl(<span class="string">&quot;https://oss.aliyuncs.com/aliyun_id_photo_bucket/default_handsome.jpg&quot;</span>);</span><br><span class="line">            <span class="comment">//把openId存入用户表</span></span><br><span class="line">            customerInfo.setWxOpenId(openid);</span><br><span class="line">            customerInfoMapper.insert(customerInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录登录日志</span></span><br><span class="line">        <span class="type">CustomerLoginLog</span> <span class="variable">loginLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomerLoginLog</span>();</span><br><span class="line">        loginLog.setCustomerId(customerInfo.getId());</span><br><span class="line">        loginLog.setMsg(<span class="string">&quot;小程序登录&quot;</span>);</span><br><span class="line">        customerLoginLogMapper.insert(loginLog);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后返回用户id</span></span><br><span class="line">        <span class="keyword">return</span> customerInfo.getId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="功能实现-远程调用"><a href="#功能实现-远程调用" class="headerlink" title="功能实现-远程调用"></a>功能实现-远程调用</h3><ul>
<li><p>service-customer-client 定义接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;service-customer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CustomerInfoFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/customer/info/login/&#123;code&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">longin</span><span class="params">(<span class="meta">@PathVariable</span> String code)</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 web-customer 进行远程调用<br>controller：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Tag(name = &quot;客户API接口管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/customer&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerService customerInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;小程序授权登录&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/login/&#123;code&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">wxLogin</span><span class="params">(<span class="meta">@PathVariable</span> String code)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(customerInfoService.login(code));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>service：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CustomerService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注入远程调用</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerInfoFeignClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String code)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拿着code进行远程调用，返回用户id</span></span><br><span class="line">        Result&lt;Long&gt; longin = client.longin(code);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果返回失败了。返回错误信息</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">code1</span> <span class="operator">=</span> longin.getCode();</span><br><span class="line">        <span class="keyword">if</span>(code1 != <span class="number">200</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取远程调用的用户id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> longin.getData();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断返回用户id是否为空，为空则返回错误提示</span></span><br><span class="line">        <span class="keyword">if</span>(customerId == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把用户id放到Redis中，设置过期时间</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回token</span></span><br><span class="line">        redisTemplate.opsForValue().set(RedisConstant.USER_LOGIN_KEY_PREFIX+token,</span><br><span class="line">                customerId.toString(),</span><br><span class="line">                RedisConstant.USER_LOGIN_KEY_TIMEOUT,</span><br><span class="line">                TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="功能实现-测试"><a href="#功能实现-测试" class="headerlink" title="功能实现-测试"></a>功能实现-测试</h3><ul>
<li><p>运行乘客端微信小程序（微信开发者工具）</p>
</li>
<li><p>启动后端服务</p>
<ul>
<li><p>启动网关</p>
</li>
<li><p>启动 service-customer 服务</p>
</li>
<li><p>启动 web-customer 服务</p>
</li>
</ul>
</li>
</ul>
<p>把用到的配置文件都检查一遍，重点看看IP地址和开放端口，以及MySQL的远程用户(就是因为这个问题，后面用映射成localhost解决了)</p>
<h2 id="获取客户端登录信息"><a href="#获取客户端登录信息" class="headerlink" title="获取客户端登录信息"></a>获取客户端登录信息</h2><h3 id="service-customer-接口"><a href="#service-customer-接口" class="headerlink" title="service-customer 接口"></a>service-customer 接口</h3><ul>
<li><p>Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取客户端登录信息&quot;)</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/getCustomerLoginInfo/&#123;customerId&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;CustomerLoginVo&gt; <span class="title function_">getCustomerLoginInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long customerId)</span> &#123;</span><br><span class="line">		<span class="type">CustomerLoginVo</span> <span class="variable">customerLoginVo</span> <span class="operator">=</span> customerInfoService.getCustomerInfoService(customerId);</span><br><span class="line">		<span class="keyword">return</span> Result.ok(customerLoginVo);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CustomerLoginVo <span class="title function_">getCustomerInfoService</span><span class="params">(Long customerId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据用户id查询用户信息</span></span><br><span class="line"><span class="comment">//        LambdaQueryWrapper&lt;CustomerInfo&gt; wrapper = new LambdaQueryWrapper();</span></span><br><span class="line"><span class="comment">//        wrapper.eq(CustomerInfo::getId, customerId);</span></span><br><span class="line"><span class="comment">//        CustomerInfo customerInfo = customerInfoMapper.selectOne(wrapper);</span></span><br><span class="line">        <span class="type">CustomerInfo</span> <span class="variable">info</span> <span class="operator">=</span> customerInfoMapper.selectById(customerId);</span><br><span class="line">        <span class="keyword">if</span> (info == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装到customerLoginVo对象</span></span><br><span class="line">        <span class="type">CustomerLoginVo</span> <span class="variable">customerLoginVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomerLoginVo</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// springboot的工具类，可以把第一个对象的属性复制到第二个对象的同名属性中</span></span><br><span class="line">        BeanUtils.copyProperties(info, customerLoginVo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 还有一个属性需要手动拷贝，判断是否存在手机号</span></span><br><span class="line"><span class="comment">        * StringUtils.hasText(info.getPhone())判断字符串是否有值</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        customerLoginVo.setIsBindPhone(StringUtils.hasText(info.getPhone()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回对象</span></span><br><span class="line">        <span class="keyword">return</span> customerLoginVo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="web-customer-接口"><a href="#web-customer-接口" class="headerlink" title="web-customer 接口"></a>web-customer 接口</h3><ul>
<li><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取客户登录信息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getCustomerLoginInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CustomerLoginVo&gt; <span class="title function_">getCustomerLoginInfo</span><span class="params">(<span class="meta">@RequestHeader(value = &quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">CustomerLoginVo</span> <span class="variable">customerLoginVo</span> <span class="operator">=</span> customerInfoService.getCustomerLoginInfo(token);</span><br><span class="line">	<span class="comment">// 返回用户对象</span></span><br><span class="line">	<span class="keyword">return</span> Result.ok(customerLoginVo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<ul>
<li>这里的token要和前面设置的一样</li>
<li>redisTemplate.opsForValue().get() 就是把redis当成一个map容器，通过键值对的方式来存储或查询<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CustomerLoginVo <span class="title function_">getCustomerLoginInfo</span><span class="params">(String token)</span> &#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 从请求头中获取token字符串</span></span><br><span class="line"><span class="comment">	 * 根据token查询redis</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">customerId</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(RedisConstant.USER_LOGIN_KEY_PREFIX+token);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据用户id进行远程调用，获取用户信息</span></span><br><span class="line">	<span class="keyword">if</span>(!StringUtils.hasText(customerId))&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Result&lt;CustomerLoginVo&gt; customerLoginInfo = client.getCustomerLoginInfo(Long.parseLong(customerId));</span><br><span class="line">	<span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> customerLoginInfo.getCode();</span><br><span class="line">	<span class="keyword">if</span>(code != <span class="number">200</span>)&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">CustomerLoginVo</span> <span class="variable">data</span> <span class="operator">=</span> customerLoginInfo.getData();</span><br><span class="line">	<span class="keyword">if</span>(data == <span class="literal">null</span>)&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="登录校验"><a href="#登录校验" class="headerlink" title="登录校验"></a>登录校验</h2><p>这里选用 AOP面向切面加自定义注解完成，有想过用拦截器来做，但是路径太多，懒得配置了（高情商，更希望学习底层知识）</p>
<h3 id="创建自定义注解"><a href="#创建自定义注解" class="headerlink" title="创建自定义注解"></a>创建自定义注解</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> LoginDetection &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建切面类"><a href="#创建切面类" class="headerlink" title="创建切面类"></a>创建切面类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 环绕通知，运行前后都触发</span></span><br><span class="line">    <span class="comment">// 切入点表达式，用来指定那些规则的方法进行增强</span></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.atguigu.daijia.*.controller.*.*(..)) &amp;&amp; @annotation(loginDetection)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">login</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint,</span></span><br><span class="line"><span class="params">                        LoginDetection loginDetection)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取request对象，并且从请求头获取token</span></span><br><span class="line">        <span class="type">RequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">sra</span> <span class="operator">=</span> (ServletRequestAttributes) requestAttributes;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> sra.getRequest().getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断token是否有效，如果为空或过期，返回登录提示</span></span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.hasText(token))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.LOGIN_AUTH);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// token不为空，查询redis、对应用户id，把用户id放到ThreadLocal里面</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">customerId</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(RedisConstant.USER_LOGIN_KEY_PREFIX + token);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(customerId))&#123;</span><br><span class="line">            AuthContextHolder.setUserId(Long.parseLong(customerId));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行目标方法</span></span><br><span class="line">        <span class="keyword">return</span> proceedingJoinPoint.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="把之前的getCustomerLoginInfo用上注解"><a href="#把之前的getCustomerLoginInfo用上注解" class="headerlink" title="把之前的getCustomerLoginInfo用上注解"></a>把之前的getCustomerLoginInfo用上注解</h3><p>在web-customer中的service里 getCustomerLoginInfo 做修改，用上我们刚刚写的注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取客户登录信息&quot;)</span></span><br><span class="line">    <span class="meta">@LoginDetection</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getCustomerLoginInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;CustomerLoginVo&gt; <span class="title function_">getCustomerLoginInfo</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从ThreadLocal获取用户id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用service</span></span><br><span class="line">        <span class="type">CustomerLoginVo</span> <span class="variable">customerLoginVo</span> <span class="operator">=</span> customerInfoService.getCustomerInfo(userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回用户对象</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(customerLoginVo);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CustomerLoginVo <span class="title function_">getCustomerInfo</span><span class="params">(Long customerId)</span> &#123;</span><br><span class="line"></span><br><span class="line">	Result&lt;CustomerLoginVo&gt; customerLoginInfo = client.getCustomerLoginInfo(customerId);</span><br><span class="line">	<span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> customerLoginInfo.getCode();</span><br><span class="line">	<span class="keyword">if</span>(code != <span class="number">200</span>)&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">CustomerLoginVo</span> <span class="variable">data</span> <span class="operator">=</span> customerLoginInfo.getData();</span><br><span class="line">	<span class="keyword">if</span>(data == <span class="literal">null</span>)&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取乘客手机号"><a href="#获取乘客手机号" class="headerlink" title="获取乘客手机号"></a>获取乘客手机号</h2><p>可恶，写完的时候发现个人版的微信开发无法使用这个，白写，最后不做判断直接改成true了</p>
<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;更新客户微信手机号码&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/updateWxPhoneNumber&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateWxPhoneNumber</span><span class="params">(<span class="meta">@RequestBody</span> UpdateWxPhoneForm updateWxPhoneForm)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Result.ok(customerInfoService.updateWxPhoneNumber(updateWxPhoneForm));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新客户微信手机号码</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateWxPhoneNumber</span><span class="params">(UpdateWxPhoneForm updateWxPhoneForm)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据code查询用户信息</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="type">WxMaPhoneNumberInfo</span> <span class="variable">phoneNoInfo</span> <span class="operator">=</span> wxMaService.getUserService().getPhoneNoInfo(updateWxPhoneForm.getCode());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 更新用户信息</span></span><br><span class="line">		<span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> updateWxPhoneForm.getCustomerId();</span><br><span class="line">		<span class="type">CustomerInfo</span> <span class="variable">customerInfo</span> <span class="operator">=</span> customerInfoMapper.selectById(customerId);</span><br><span class="line">		customerInfo.setPhone(phoneNoInfo.getPhoneNumber());</span><br><span class="line">		customerInfoMapper.updateById(customerInfo);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (WxErrorException e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="web-customer"><a href="#web-customer" class="headerlink" title="web-customer"></a>web-customer</h3><ul>
<li>controller<br>企业版<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;更新用户微信手机号&quot;)</span></span><br><span class="line"><span class="meta">@LoginDetection</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/updateWxPhone&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateWxPhone</span><span class="params">(<span class="meta">@RequestBody</span> UpdateWxPhoneForm updateWxPhoneForm)</span> &#123;</span><br><span class="line">	updateWxPhoneForm.setCustomerId(AuthContextHolder.getUserId());</span><br><span class="line">	<span class="keyword">return</span> Result.ok(customerInfoService.updateWxPhoneNumber(updateWxPhoneForm));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>个人版：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;更新用户微信手机号&quot;)</span></span><br><span class="line"><span class="meta">@LoginDetection</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/updateWxPhone&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateWxPhone</span><span class="params">(<span class="meta">@RequestBody</span> UpdateWxPhoneForm updateWxPhoneForm)</span> &#123;</span><br><span class="line">	updateWxPhoneForm.setCustomerId(AuthContextHolder.getUserId());</span><br><span class="line">	<span class="keyword">return</span> Result.ok(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>service<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateWxPhoneNumber</span><span class="params">(UpdateWxPhoneForm updateWxPhoneForm)</span> &#123;</span><br><span class="line">	Result&lt;Boolean&gt; booleanResult = client.updateWxPhoneNumber(updateWxPhoneForm);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="司机端登录"><a href="#司机端登录" class="headerlink" title="司机端登录"></a>司机端登录</h1><h3 id="司机开启接单的条件："><a href="#司机开启接单的条件：" class="headerlink" title="司机开启接单的条件："></a><strong>司机开启接单的条件：</strong></h3><p>1、登录</p>
<p>2、认证通过</p>
<p>3、建立了腾讯云人员库人员</p>
<p>4、当日验证了人脸识别</p>
<h2 id="准备工作与流程"><a href="#准备工作与流程" class="headerlink" title="准备工作与流程"></a>准备工作与流程</h2><ul>
<li>准备共奏</li>
</ul>
<p>因为司机端要完成认证模块，比如身份证，驾驶证之类的，所以我们需要用到腾讯云的对象存储COS<br>还有腾讯云的OCR来识别身份证和驾驶证</p>
<ul>
<li>流程如下<ul>
<li>司机端登录功能</li>
<li>获取用户信息</li>
<li>腾讯云对象存储COS</li>
<li>上传信息接口</li>
<li>腾讯云OCR，识别身份证与驾驶证</li>
<li>人脸识别</li>
</ul>
</li>
</ul>
<ul>
<li><p>修改项目配置文件和Nacos里面配置文件内容</p>
</li>
<li><p>创建类，读取配置文件内容，微信小程序id和秘钥，这个跟客户端的一样，直接复制过来</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;wx.miniapp&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxConfigProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建类，初始化微信工具包相关对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxConfigOperator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WxConfigProperties wxConfigProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WxMaService <span class="title function_">wxMaService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//微信小程序id和秘钥</span></span><br><span class="line">        <span class="type">WxMaDefaultConfigImpl</span> <span class="variable">wxMaConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxMaDefaultConfigImpl</span>();</span><br><span class="line">        wxMaConfig.setAppid(wxConfigProperties.getAppId());</span><br><span class="line">        wxMaConfig.setSecret(wxConfigProperties.getSecret());</span><br><span class="line">        <span class="type">WxMaService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxMaServiceImpl</span>();</span><br><span class="line">        service.setWxMaConfig(wxMaConfig);</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="司机端登录功能"><a href="#司机端登录功能" class="headerlink" title="司机端登录功能"></a>司机端登录功能</h2><p>这个步骤跟之前客户端差不多</p>
<ul>
<li>service：<ul>
<li>就是获取code，然后通过code加密钥和小程序id去获取用户的唯一表示openid</li>
<li>判断这个用户是不是第一次登录</li>
<li>是的话初始化用户</li>
<li>返回id</li>
</ul>
</li>
<li>web-service:<ul>
<li>获取code，调用service</li>
<li>远程调用获取数据</li>
<li>生成token</li>
<li>放入redis</li>
<li>返回token</li>
</ul>
</li>
</ul>
<h3 id="service-drive"><a href="#service-drive" class="headerlink" title="service-drive"></a>service-drive</h3><p>DriverInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Tag(name = &quot;司机API接口管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(value=&quot;/driver/info&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverInfoController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DriverInfoService driverInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;小程序授权登录&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/login/&#123;code&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@PathVariable(&quot;code&quot;)</span> String code)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(driverInfoService.login(code));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DriverInfoServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;DriverInfoMapper, DriverInfo&gt; <span class="keyword">implements</span> <span class="title class_">DriverInfoService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WxMaService wxMaService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DriverInfoMapper driverInfoMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DriverSetMapper driverSetMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DriverAccountMapper driverAccountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DriverLoginLogMapper driverLoginLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 小程序授权登录</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">login</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 通过code+密钥+小程序id获取用户唯一标识openid</span></span><br><span class="line">            <span class="type">WxMaJscode2SessionResult</span> <span class="variable">sessionInfo</span> <span class="operator">=</span> wxMaService.getUserService().getSessionInfo(code);</span><br><span class="line">            <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> sessionInfo.getOpenid();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据openid查询用户信息</span></span><br><span class="line">            LambdaQueryWrapper&lt;DriverInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            wrapper.eq(DriverInfo::getWxOpenId, openid);</span><br><span class="line">            <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> driverInfoMapper.selectOne(wrapper);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(driverInfo == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// 添加司机基本信息</span></span><br><span class="line">                driverInfo = <span class="keyword">new</span> <span class="title class_">DriverInfo</span>();</span><br><span class="line">                driverInfo.setNickname(String.valueOf(System.currentTimeMillis()));</span><br><span class="line">                driverInfo.setAvatarUrl(<span class="string">&quot;https://oss.aliyuncs.com/aliyun_id_photo_bucket/default_handsome.jpg&quot;</span>);</span><br><span class="line">                driverInfo.setWxOpenId(openid);</span><br><span class="line">                driverInfoMapper.insert(driverInfo);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 初始化司机设置</span></span><br><span class="line">                <span class="type">DriverSet</span> <span class="variable">driverSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverSet</span>();</span><br><span class="line">                driverSet.setDriverId(driverInfo.getId());</span><br><span class="line">                driverSet.setOrderDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0</span>));<span class="comment">//0：无限制</span></span><br><span class="line">                driverSet.setAcceptDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(SystemConstant.ACCEPT_DISTANCE));<span class="comment">//默认接单范围：5公里</span></span><br><span class="line">                driverSet.setIsAutoAccept(<span class="number">0</span>);<span class="comment">//0：否 1：是</span></span><br><span class="line">                driverSetMapper.insert(driverSet);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 初始化司机账户信息</span></span><br><span class="line">                <span class="type">DriverAccount</span> <span class="variable">driverAccount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverAccount</span>();</span><br><span class="line">                driverAccount.setDriverId(driverInfo.getId());</span><br><span class="line">                driverAccountMapper.insert(driverAccount);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新登录日志</span></span><br><span class="line">            <span class="type">DriverLoginLog</span> <span class="variable">loginLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverLoginLog</span>();</span><br><span class="line">            loginLog.setDriverId(driverInfo.getId());</span><br><span class="line">            loginLog.setMsg(<span class="string">&quot;小程序登录&quot;</span>);</span><br><span class="line">            driverLoginLogMapper.insert(loginLog);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回用户id</span></span><br><span class="line">            <span class="keyword">return</span> driverInfo.getId();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WxErrorException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="service-drive-client"><a href="#service-drive-client" class="headerlink" title="service-drive-client"></a>service-drive-client</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;service-driver&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DriverInfoFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 小程序授权登录</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/driver/info/login/&#123;code&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@PathVariable(&quot;code&quot;)</span> String code)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="web-drive"><a href="#web-drive" class="headerlink" title="web-drive"></a>web-drive</h3><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Tag(name = &quot;司机API接口管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(value=&quot;/driver&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DriverService driverService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;小程序授权登录&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/login/&#123;code&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@PathVariable(&quot;code&quot;)</span> String code)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(driverService.login(code));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DriverService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DriverInfoFeignClient driverInfoFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 小程序授权登录</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        Result&lt;Long&gt; result = driverInfoFeignClient.login(code);</span><br><span class="line">        <span class="keyword">if</span>(result.getCode() != <span class="number">200</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">data</span> <span class="operator">=</span> result.getData();</span><br><span class="line">        <span class="keyword">if</span>(data == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        redisTemplate.opsForValue().set(RedisConstant.USER_LOGIN_KEY_PREFIX + token,</span><br><span class="line">                data.toString(),</span><br><span class="line">                RedisConstant.USER_LOGIN_KEY_TIMEOUT,</span><br><span class="line">                TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取登录司机信息"><a href="#获取登录司机信息" class="headerlink" title="获取登录司机信息"></a>获取登录司机信息</h2><h3 id="service-driver"><a href="#service-driver" class="headerlink" title="service-driver"></a>service-driver</h3><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取司机登录信息&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getDriverLoginInfo/&#123;driverId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverLoginVo&gt; <span class="title function_">getDriverInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> <span class="type">long</span> driverId)</span> &#123;  </span><br><span class="line">    <span class="type">DriverLoginVo</span> <span class="variable">driverLoginVo</span> <span class="operator">=</span> driverInfoService.getDriverInfo(driverId);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverLoginVo);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取司机登录信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverLoginVo <span class="title function_">getDriverInfo</span><span class="params">(<span class="type">long</span> driverId)</span> &#123;</span><br><span class="line">	<span class="comment">// 通过id查询司机信息</span></span><br><span class="line">	<span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> driverInfoMapper.selectById(driverId);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 赋予到vo对象中</span></span><br><span class="line">	<span class="type">DriverLoginVo</span> <span class="variable">driverLoginVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverLoginVo</span>();</span><br><span class="line">	BeanUtils.copyProperties(driverInfo, driverLoginVo);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查询是否需要建档人脸识别</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">faceModelId</span> <span class="operator">=</span> driverInfo.getFaceModelId();</span><br><span class="line">	<span class="type">boolean</span> <span class="variable">isArchiveFace</span> <span class="operator">=</span> StringUtils.hasText(faceModelId);</span><br><span class="line">	driverLoginVo.setIsArchiveFace(isArchiveFace);</span><br><span class="line">	<span class="keyword">return</span> driverLoginVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> service-driver-client</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;service-driver&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DriverInfoFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 小程序授权登录</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/driver/info/login/&#123;code&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@PathVariable(&quot;code&quot;)</span> String code)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取登录司机信息</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/driver/info/getDriverLoginInfo/&#123;driverId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;DriverLoginVo&gt; <span class="title function_">getDriverInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> <span class="type">long</span> driverId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="web-driver"><a href="#web-driver" class="headerlink" title="web-driver"></a>web-driver</h3><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取登录司机信息&quot;)</span></span><br><span class="line"><span class="meta">@LoginDetection</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getDriverLoginInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverLoginVo&gt; <span class="title function_">getDriverLoginInfo</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Result.ok(driverService.getDriverLoginVo());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverLoginVo <span class="title function_">getDriverLoginVo</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">	Result&lt;DriverLoginVo&gt; driverInfo = driverInfoFeignClient.getDriverInfo(driverId);</span><br><span class="line">	<span class="keyword">return</span> driverInfo.getData();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试一下前面的代码"><a href="#测试一下前面的代码" class="headerlink" title="测试一下前面的代码"></a>测试一下前面的代码</h3><ul>
<li>打开微信开发者工具</li>
<li>改好相关配置文件</li>
<li>nacos</li>
<li>启动后端服务<ul>
<li>网关服务service-gateway</li>
<li>司机端基础服务service-driver</li>
<li>对外访问服务web-driver</li>
</ul>
</li>
</ul>
<p>可恶，在这里前面web-driver里面controller的路径写错了，一直访问不上，还有nacos里面的配置忘记修改成映射后的端口</p>
<h2 id="开通腾讯云对象存储COS"><a href="#开通腾讯云对象存储COS" class="headerlink" title="开通腾讯云对象存储COS"></a>开通腾讯云对象存储COS</h2><h3 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h3><ul>
<li>注册并实名腾讯云</li>
<li>找到对象存储</li>
<li>创建储存桶</li>
<li>创建并保存密钥和id</li>
</ul>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>在 web-driver：</p>
<ul>
<li>获取文件以及存放路径</li>
<li>远程调用实现文件上传</li>
<li>返回 vo 对象</li>
</ul>
<p>在 service-driver：</p>
<ul>
<li>导入依赖</li>
<li>获取上传文件及路径</li>
<li>修改配置文件</li>
<li>基于腾讯云官方文档调用实现上传</li>
<li>返回 vo 对象</li>
</ul>
<p>注意点：因为保密隐私，我们这里的存储桶肯定是私密的，但是我们又要让用户能看到上传后的结果，因此我们需要创建一个临时地址，让客户看到存储内容</p>
<h3 id="web-service"><a href="#web-service" class="headerlink" title="web-service"></a>web-service</h3><ul>
<li><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Tag(name = &quot;上传管理接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;file&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CosService cosService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件上传接口</span></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;上传&quot;)</span></span><br><span class="line">    <span class="meta">@LoginDetection</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;CosUploadVo&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                      <span class="meta">@RequestParam(value = &quot;path&quot;, defaultValue = &quot;auth&quot;)</span> String path)</span> &#123;</span><br><span class="line">        <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> cosService.uploadFile(file, path);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(cosUploadVo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CosServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CosService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CosFeignClient cosFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件上传接口</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CosUploadVo <span class="title function_">uploadFile</span><span class="params">(MultipartFile file, String path)</span> &#123;</span><br><span class="line">        <span class="comment">// 远程调用获取vo</span></span><br><span class="line">        Result&lt;CosUploadVo&gt; result =  cosFeignClient.upload(file, path);</span><br><span class="line">        <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> result.getData();</span><br><span class="line">        <span class="keyword">return</span> cosUploadVo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="service-driver-client"><a href="#service-driver-client" class="headerlink" title="service-driver-client"></a>service-driver-client</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;service-driver&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CosFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 文件上传</span></span><br><span class="line"><span class="comment">    * MediaType 表示上传类型</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/cos/upload&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;CosUploadVo&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                      <span class="meta">@RequestParam(value = &quot;path&quot;)</span> String path)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="service-driver-1"><a href="#service-driver-1" class="headerlink" title="service-driver"></a>service-driver</h3><ul>
<li><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.qcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cos_api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6.227<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件</p>
</li>
<li><p>创建类读取配置文件内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;tencent.cloud&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TencentCloudProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String secretId;</span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line">    <span class="keyword">private</span> String region;</span><br><span class="line">    <span class="keyword">private</span> String bucketPrivate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Tag(name = &quot;腾讯云cos上传接口管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(value=&quot;/cos&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CosController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CosService cosService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;上传&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;CosUploadVo&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                      <span class="meta">@RequestParam(&quot;path&quot;)</span> String path)</span> &#123;</span><br><span class="line">        <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> cosService.upload(file, path);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(cosUploadVo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CosServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CosService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TencentCloudProperties tencentCloudProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件上传</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CosUploadVo <span class="title function_">upload</span><span class="params">(MultipartFile file, String path)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取cos客户端</span></span><br><span class="line">        <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> getCosClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 文件上传</span></span><br><span class="line">        <span class="comment">// 设置文件元数据信息</span></span><br><span class="line">        <span class="type">ObjectMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMetadata</span>();</span><br><span class="line">        metadata.setContentLength(file.getSize());</span><br><span class="line">        metadata.setContentEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        metadata.setContentType(file.getContentType());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 向储存桶保存文件</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileType</span> <span class="operator">=</span> file.getOriginalFilename().substring(file.getOriginalFilename().lastIndexOf(<span class="string">&quot;.&quot;</span>)); <span class="comment">//文件后缀名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uploadPath</span> <span class="operator">=</span> <span class="string">&quot;/driver/&quot;</span> + path + <span class="string">&quot;/&quot;</span> + UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>) + fileType;</span><br><span class="line">        <span class="comment">// 01.jpg</span></span><br><span class="line">        <span class="comment">// /driver/auth/0o98754.jpg</span></span><br><span class="line">        <span class="type">PutObjectRequest</span> <span class="variable">putObjectRequest</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1 bucket名称</span></span><br><span class="line">            <span class="comment">//2</span></span><br><span class="line">            putObjectRequest = <span class="keyword">new</span> <span class="title class_">PutObjectRequest</span>(tencentCloudProperties.getBucketPrivate(),</span><br><span class="line">                    uploadPath,</span><br><span class="line">                    file.getInputStream(),</span><br><span class="line">                    metadata);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        putObjectRequest.setStorageClass(StorageClass.Standard);</span><br><span class="line">        <span class="type">PutObjectResult</span> <span class="variable">putObjectResult</span> <span class="operator">=</span> cosClient.putObject(putObjectRequest); <span class="comment">//上传文件</span></span><br><span class="line">        cosClient.shutdown();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回vo对象</span></span><br><span class="line">        <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CosUploadVo</span>();</span><br><span class="line">        cosUploadVo.setUrl(uploadPath);</span><br><span class="line">        <span class="comment">// 图片临时访问回显url</span></span><br><span class="line">        cosUploadVo.setShowUrl(<span class="built_in">this</span>.getImagerUrl(uploadPath));</span><br><span class="line">        <span class="keyword">return</span> cosUploadVo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>提取CosClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> COSClient <span class="title function_">getCosClient</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// 1 初始化用户身份信息（secretId, secretKey）。</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">secretId</span> <span class="operator">=</span> tencentCloudProperties.getSecretId();</span><br><span class="line">	<span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> tencentCloudProperties.getSecretKey();</span><br><span class="line">	<span class="type">COSCredentials</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicCOSCredentials</span>(secretId, secretKey);</span><br><span class="line">	<span class="comment">// 2 设置 bucket 的地域</span></span><br><span class="line">	<span class="type">Region</span> <span class="variable">region</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Region</span>(tencentCloudProperties.getRegion());</span><br><span class="line">	<span class="type">ClientConfig</span> <span class="variable">clientConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientConfig</span>(region);</span><br><span class="line">	<span class="comment">// 这里建议设置使用 https 协议</span></span><br><span class="line">	clientConfig.setHttpProtocol(HttpProtocol.https);</span><br><span class="line">	<span class="comment">// 3 生成 cos 客户端。</span></span><br><span class="line">	<span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">COSClient</span>(cred, clientConfig);</span><br><span class="line">	<span class="keyword">return</span> cosClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取临时签名url</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getImagerUrl</span><span class="params">(String path)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span>(!StringUtils.hasText(path))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> getCosClient();</span><br><span class="line">	<span class="type">GeneratePresignedUrlRequest</span> <span class="variable">request</span> <span class="operator">=</span></span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">GeneratePresignedUrlRequest</span>(tencentCloudProperties.getBucketPrivate(),</span><br><span class="line">					path,</span><br><span class="line">					HttpMethodName.GET);</span><br><span class="line">	<span class="comment">// 设置临时URL有效期</span></span><br><span class="line">	<span class="type">DateTime</span> <span class="variable">dateTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>().plusMinutes(<span class="number">15</span>);</span><br><span class="line">	request.setExpiration(dateTime.toDate());</span><br><span class="line">	<span class="comment">// 调用方法获取</span></span><br><span class="line">	<span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> cosClient.generatePresignedUrl(request);</span><br><span class="line">	cosClient.shutdown();</span><br><span class="line">	<span class="keyword">return</span> url.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一大段看着很复杂，其实大部分都是腾讯云官方文档里面的内容，我们只需要修改一下参数即可</p>
<h2 id="腾讯云身份证与驾驶证识别接口"><a href="#腾讯云身份证与驾驶证识别接口" class="headerlink" title="腾讯云身份证与驾驶证识别接口"></a>腾讯云身份证与驾驶证识别接口</h2><h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>司机注册成功后，应该需要去实名认证，这里可以用到腾讯云的身份识别和云存储功能，身份证和驾驶证上传的步骤都差不多，这里就写在一起了</p>
<p>那我们现在计划很明确了</p>
<p>web-driver：</p>
<ul>
<li>获取上传文件</li>
<li>远程调用获取认证信息</li>
<li>返回认证信息</li>
</ul>
<p>service-driver：</p>
<ul>
<li>上传认证图片</li>
<li>调用腾讯云相关接口完成认证</li>
<li>返回认证信息</li>
</ul>
<h3 id="service-driver-2"><a href="#service-driver-2" class="headerlink" title="service-driver"></a>service-driver</h3><ul>
<li><p>controller：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Tag(name = &quot;腾讯云识别接口管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(value=&quot;/ocr&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OcrController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OcrService ocrService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;身份证识别&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/idCardOcr&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;IdCardOcrVo&gt; <span class="title function_">idCardOcr</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="type">IdCardOcrVo</span> <span class="variable">idCardOcrVo</span> <span class="operator">=</span> ocrService.idCardOcr(file);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(idCardOcrVo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Operation(summary = &quot;驾驶证识别&quot;)</span>  </span><br><span class="line">	<span class="meta">@PostMapping(&quot;/driverLicenseOcr&quot;)</span>  </span><br><span class="line">	<span class="keyword">public</span> Result&lt;DriverLicenseOcrVo&gt; <span class="title function_">driverLicenseOcr</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file)</span> &#123;  </span><br><span class="line">	    <span class="type">DriverLicenseOcrVo</span> <span class="variable">driverLicenseOcrVo</span> <span class="operator">=</span> ocrService.driverLicenseOcr(file);  </span><br><span class="line">	    <span class="keyword">return</span> Result.ok(driverLicenseOcrVo);  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service：<br>导入依赖：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;com.tencentcloudapi&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;tencentcloud-sdk-java&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;$&#123;tencentcloud.version&#125;&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>看着代码很多，其实全都是从腾讯云官网拉过来修改配置的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OcrServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OcrService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TencentCloudProperties tencentCloudProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CosService cosService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 身份证识别</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IdCardOcrVo <span class="title function_">idCardOcr</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// file转换成base64</span></span><br><span class="line">            <span class="type">byte</span>[] base64 = Base64.encodeBase64(file.getBytes());</span><br><span class="line">            <span class="type">String</span> <span class="variable">fileBase64</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(base64);</span><br><span class="line">            <span class="comment">// 实例化一个认证对象，入参需要传入腾讯云账户 SecretId 和 SecretKey，此处还需注意密钥对的保密</span></span><br><span class="line">            <span class="type">Credential</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credential</span>(tencentCloudProperties.getSecretId(),</span><br><span class="line">                    tencentCloudProperties.getSecretKey());</span><br><span class="line">            <span class="comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">            <span class="type">HttpProfile</span> <span class="variable">httpProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpProfile</span>();</span><br><span class="line">            httpProfile.setEndpoint(<span class="string">&quot;ocr.tencentcloudapi.com&quot;</span>);</span><br><span class="line">            <span class="comment">// 实例化一个client选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">            <span class="type">ClientProfile</span> <span class="variable">clientProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientProfile</span>();</span><br><span class="line">            clientProfile.setHttpProfile(httpProfile);</span><br><span class="line">            <span class="comment">// 实例化要请求产品的client对象,clientProfile是可选的</span></span><br><span class="line">            <span class="type">OcrClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OcrClient</span>(cred,tencentCloudProperties.getRegion(), clientProfile);</span><br><span class="line">            <span class="comment">// 实例化一个请求对象,每个接口都会对应一个request对象</span></span><br><span class="line">            <span class="type">IDCardOCRRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IDCardOCRRequest</span>();</span><br><span class="line">            <span class="comment">//设置文件</span></span><br><span class="line">            req.setImageBase64(fileBase64);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回的resp是一个IDCardOCRResponse的实例，与请求对象对应</span></span><br><span class="line">            <span class="type">IDCardOCRResponse</span> <span class="variable">resp</span> <span class="operator">=</span> client.IDCardOCR(req);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//转换为IdCardOcrVo对象</span></span><br><span class="line">            <span class="type">IdCardOcrVo</span> <span class="variable">idCardOcrVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IdCardOcrVo</span>();</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(resp.getName())) &#123;</span><br><span class="line">                <span class="comment">//身份证正面</span></span><br><span class="line">                idCardOcrVo.setName(resp.getName());</span><br><span class="line">                idCardOcrVo.setGender(<span class="string">&quot;男&quot;</span>.equals(resp.getSex()) ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;2&quot;</span>);</span><br><span class="line">                idCardOcrVo.setBirthday(DateTimeFormat.forPattern(<span class="string">&quot;yyyy/MM/dd&quot;</span>).parseDateTime(resp.getBirth()).toDate());</span><br><span class="line">                idCardOcrVo.setIdcardNo(resp.getIdNum());</span><br><span class="line">                idCardOcrVo.setIdcardAddress(resp.getAddress());</span><br><span class="line"></span><br><span class="line">                <span class="comment">//上传身份证正面图片到腾讯云cos</span></span><br><span class="line">                <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> cosService.upload(file, <span class="string">&quot;idCard&quot;</span>);</span><br><span class="line">                idCardOcrVo.setIdcardFrontUrl(cosUploadVo.getUrl());</span><br><span class="line">                idCardOcrVo.setIdcardFrontShowUrl(cosUploadVo.getShowUrl());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//身份证反面</span></span><br><span class="line">                <span class="comment">//证件有效期：&quot;2010.07.21-2020.07.21&quot;</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">idcardExpireString</span> <span class="operator">=</span> resp.getValidDate().split(<span class="string">&quot;-&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">                idCardOcrVo.setIdcardExpire(DateTimeFormat.forPattern(<span class="string">&quot;yyyy.MM.dd&quot;</span>).parseDateTime(idcardExpireString).toDate());</span><br><span class="line">                <span class="comment">//上传身份证反面图片到腾讯云cos</span></span><br><span class="line">                <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> cosService.upload(file, <span class="string">&quot;idCard&quot;</span>);</span><br><span class="line">                idCardOcrVo.setIdcardBackUrl(cosUploadVo.getUrl());</span><br><span class="line">                idCardOcrVo.setIdcardBackShowUrl(cosUploadVo.getShowUrl());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> idCardOcrVo;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//驾驶证识别  </span></span><br><span class="line">	<span class="meta">@Override</span>  </span><br><span class="line">	<span class="keyword">public</span> DriverLicenseOcrVo <span class="title function_">driverLicenseOcr</span><span class="params">(MultipartFile file)</span> &#123;  </span><br><span class="line">	    <span class="keyword">try</span>&#123;  </span><br><span class="line">	        <span class="comment">//图片转换base64格式字符串  </span></span><br><span class="line">	        <span class="type">byte</span>[] base64 = Base64.encodeBase64(file.getBytes());  </span><br><span class="line">	        <span class="type">String</span> <span class="variable">fileBase64</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(base64);  </span><br><span class="line">	  </span><br><span class="line">	        <span class="comment">// 实例化一个认证对象，入参需要传入腾讯云账户 SecretId 和 SecretKey，此处还需注意密钥对的保密  </span></span><br><span class="line">	        <span class="type">Credential</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credential</span>(tencentCloudProperties.getSecretId(),  </span><br><span class="line">	                tencentCloudProperties.getSecretKey());  </span><br><span class="line">	        <span class="comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过  </span></span><br><span class="line">	        <span class="type">HttpProfile</span> <span class="variable">httpProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpProfile</span>();  </span><br><span class="line">	        httpProfile.setEndpoint(<span class="string">&quot;ocr.tencentcloudapi.com&quot;</span>);  </span><br><span class="line">	        <span class="comment">// 实例化一个client选项，可选的，没有特殊需求可以跳过  </span></span><br><span class="line">	        <span class="type">ClientProfile</span> <span class="variable">clientProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientProfile</span>();  </span><br><span class="line">	        clientProfile.setHttpProfile(httpProfile);  </span><br><span class="line">	        <span class="comment">// 实例化要请求产品的client对象,clientProfile是可选的  </span></span><br><span class="line">	        <span class="type">OcrClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OcrClient</span>(cred, tencentCloudProperties.getRegion(),  </span><br><span class="line">	                clientProfile);  </span><br><span class="line">	        <span class="comment">// 实例化一个请求对象,每个接口都会对应一个request对象  </span></span><br><span class="line">	        <span class="type">DriverLicenseOCRRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverLicenseOCRRequest</span>();  </span><br><span class="line">	        req.setImageBase64(fileBase64);  </span><br><span class="line">	  </span><br><span class="line">	        <span class="comment">// 返回的resp是一个DriverLicenseOCRResponse的实例，与请求对象对应  </span></span><br><span class="line">	        <span class="type">DriverLicenseOCRResponse</span> <span class="variable">resp</span> <span class="operator">=</span> client.DriverLicenseOCR(req);  </span><br><span class="line">	  </span><br><span class="line">	        <span class="comment">//封装到vo对象里面  </span></span><br><span class="line">	        <span class="type">DriverLicenseOcrVo</span> <span class="variable">driverLicenseOcrVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverLicenseOcrVo</span>();  </span><br><span class="line">	        <span class="keyword">if</span> (StringUtils.hasText(resp.getName())) &#123;  </span><br><span class="line">	            <span class="comment">//驾驶证正面  </span></span><br><span class="line">	            <span class="comment">//驾驶证名称要与身份证名称一致  </span></span><br><span class="line">	            driverLicenseOcrVo.setName(resp.getName());  </span><br><span class="line">	            driverLicenseOcrVo.setDriverLicenseClazz(resp.getClass_());  </span><br><span class="line">	            driverLicenseOcrVo.setDriverLicenseNo(resp.getCardCode());  </span><br><span class="line">	            driverLicenseOcrVo.setDriverLicenseIssueDate(DateTimeFormat.forPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>).parseDateTime(resp.getDateOfFirstIssue()).toDate());  </span><br><span class="line">	            driverLicenseOcrVo.setDriverLicenseExpire(DateTimeFormat.forPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>).parseDateTime(resp.getEndDate()).toDate());  </span><br><span class="line">	  </span><br><span class="line">	            <span class="comment">//上传驾驶证反面图片到腾讯云cos  </span></span><br><span class="line">	            <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> cosService.upload(file, <span class="string">&quot;driverLicense&quot;</span>);  </span><br><span class="line">	            driverLicenseOcrVo.setDriverLicenseFrontUrl(cosUploadVo.getUrl());  </span><br><span class="line">	            driverLicenseOcrVo.setDriverLicenseFrontShowUrl(cosUploadVo.getShowUrl());  </span><br><span class="line">	        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">	            <span class="comment">//驾驶证反面  </span></span><br><span class="line">	            <span class="comment">//上传驾驶证反面图片到腾讯云cos  </span></span><br><span class="line">	            <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span>  cosService.upload(file, <span class="string">&quot;driverLicense&quot;</span>);  </span><br><span class="line">	            driverLicenseOcrVo.setDriverLicenseBackUrl(cosUploadVo.getUrl());  </span><br><span class="line">	            driverLicenseOcrVo.setDriverLicenseBackShowUrl(cosUploadVo.getShowUrl());  </span><br><span class="line">	        &#125;  </span><br><span class="line">	  </span><br><span class="line">	        <span class="keyword">return</span> driverLicenseOcrVo;  </span><br><span class="line">	    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">	        e.printStackTrace();  </span><br><span class="line">	        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);  </span><br><span class="line">	    &#125;  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="service-client"><a href="#service-client" class="headerlink" title="service-client"></a>service-client</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;service-driver&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OcrFeignClient</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/ocr/idCardOcr&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span>  </span><br><span class="line">    Result&lt;IdCardOcrVo&gt; <span class="title function_">idCardOcr</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file)</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/ocr/driverLicenseOcr&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span>  </span><br><span class="line">    Result&lt;DriverLicenseOcrVo&gt; <span class="title function_">driverLicenseOcr</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="web-service-1"><a href="#web-service-1" class="headerlink" title="web-service"></a>web-service</h3><ul>
<li><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span>  </span><br><span class="line"><span class="meta">@Tag(name = &quot;腾讯云识别接口管理&quot;)</span>  </span><br><span class="line"><span class="meta">@RestController</span>  </span><br><span class="line"><span class="meta">@RequestMapping(value=&quot;/ocr&quot;)</span>  </span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OcrController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> OcrService ocrService;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Operation(summary = &quot;身份证识别&quot;)</span>  </span><br><span class="line">    <span class="meta">@LoginDetection</span>  </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/idCardOcr&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> Result&lt;IdCardOcrVo&gt; <span class="title function_">uploadDriverLicenseOcr</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span>MultipartFile file)</span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(ocrService.idCardOcr(file));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Operation(summary = &quot;驾驶证识别&quot;)</span>  </span><br><span class="line">    <span class="meta">@LoginDetection</span>  </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/driverLicenseOcr&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> Result&lt;DriverLicenseOcrVo&gt; <span class="title function_">driverLicenseOcr</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span>MultipartFile file)</span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(ocrService.driverLicenseOcr(file));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>serivce</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span>  </span><br><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OcrServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OcrService</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> OcrFeignClient ocrFeignClient;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 身份证  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> IdCardOcrVo <span class="title function_">idCardOcr</span><span class="params">(MultipartFile file)</span> &#123;  </span><br><span class="line">        Result&lt;IdCardOcrVo&gt; ocrVoResult = ocrFeignClient.idCardOcr(file);  </span><br><span class="line">        <span class="keyword">return</span> ocrVoResult.getData();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 驾驶证  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> DriverLicenseOcrVo <span class="title function_">driverLicenseOcr</span><span class="params">(MultipartFile file)</span> &#123;  </span><br><span class="line">        Result&lt;DriverLicenseOcrVo&gt; result = ocrFeignClient.driverLicenseOcr(file);  </span><br><span class="line">        <span class="keyword">return</span> result.getData();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="获取司机认证信息"><a href="#获取司机认证信息" class="headerlink" title="获取司机认证信息"></a>获取司机认证信息</h2><h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p>司机登录后会进入认证界面，判单是否认证，进入认证界面是会显示回显的图片</p>
<p>其实这个很简单，因为腾讯云的那个文字识别会返回参数出来，我们只需要把回显地址返回回去就行</p>
<p>driver-service</p>
<ul>
<li>通过id来传入回显地址</li>
</ul>
<p>driver-web</p>
<ul>
<li>调用该</li>
</ul>
<h3 id="service-driver-3"><a href="#service-driver-3" class="headerlink" title="service-driver"></a>service-driver</h3><ul>
<li><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取司机认证信息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getDriverAuthInfo/&#123;driverId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverAuthInfoVo&gt; <span class="title function_">getDriverAuthInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> &#123;</span><br><span class="line">    <span class="type">DriverAuthInfoVo</span> <span class="variable">driverAuthInfoVo</span> <span class="operator">=</span> driverInfoService.getDriverAuthInfo(driverId);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverAuthInfoVo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">```java</span><br><span class="line"><span class="comment">//获取司机认证信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverAuthInfoVo <span class="title function_">getDriverAuthInfo</span><span class="params">(Long driverId)</span> &#123;</span><br><span class="line">    <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> driverInfoMapper.selectById(driverId);</span><br><span class="line">    <span class="type">DriverAuthInfoVo</span> <span class="variable">driverAuthInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverAuthInfoVo</span>();</span><br><span class="line">    BeanUtils.copyProperties(driverInfo,driverAuthInfoVo);</span><br><span class="line">    driverAuthInfoVo.setIdcardBackShowUrl(cosService.getImageUrl(driverAuthInfoVo.getIdcardBackUrl()));</span><br><span class="line">        driverAuthInfoVo.setIdcardFrontShowUrl(cosService.getImageUrl(driverAuthInfoVo.getIdcardFrontUrl()));</span><br><span class="line"></span><br><span class="line">    driverAuthInfoVo.setIdcardHandShowUrl(cosService.getImageUrl(driverAuthInfoVo.getIdcardHandUrl()));</span><br><span class="line"></span><br><span class="line">    driverAuthInfoVo.setDriverLicenseFrontShowUrl(cosService.getImageUrl(driverAuthInfoVo.getDriverLicenseFrontUrl()));</span><br><span class="line"></span><br><span class="line">    driverAuthInfoVo.setDriverLicenseBackShowUrl(cosService.getImageUrl(driverAuthInfoVo.getDriverLicenseBackUrl()));</span><br><span class="line"></span><br><span class="line">    driverAuthInfoVo.setDriverLicenseHandShowUrl(cosService.getImageUrl(driverAuthInfoVo.getDriverLicenseHandUrl()));</span><br><span class="line">    <span class="keyword">return</span> driverAuthInfoVo;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="service-client-1"><a href="#service-client-1" class="headerlink" title="service-client"></a>service-client</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/driver/info/getDriverAuthInfo/&#123;driverId&#125;&quot;)</span></span><br><span class="line">Result&lt;DriverAuthInfoVo&gt; <span class="title function_">getDriverAuthInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br></pre></td></tr></table></figure>


<h3 id="web-serive"><a href="#web-serive" class="headerlink" title="web-serive"></a>web-serive</h3><ul>
<li><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取司机认证信息&quot;)</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getDriverAuthInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverAuthInfoVo&gt; <span class="title function_">getDriverAuthInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//获取登录用户id，当前是司机id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverService.getDriverAuthInfo(driverId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>serivce</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//司机认证信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverAuthInfoVo <span class="title function_">getDriverAuthInfo</span><span class="params">(Long driverId)</span> &#123;</span><br><span class="line">    Result&lt;DriverAuthInfoVo&gt; authInfoVoResult = driverInfoFeignClient.getDriverAuthInfo(driverId);</span><br><span class="line">    <span class="type">DriverAuthInfoVo</span> <span class="variable">driverAuthInfoVo</span> <span class="operator">=</span> authInfoVoResult.getData();</span><br><span class="line">    <span class="keyword">return</span> driverAuthInfoVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="修改司机认证信息"><a href="#修改司机认证信息" class="headerlink" title="修改司机认证信息"></a>修改司机认证信息</h2><h3 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h3><p>前端点击提交后，后端需要更新客户认证信息<br>​    0:  未认证 【刚注册完为未认证状态】<br>​    1：审核中 【提交了认证信息后变为审核中】<br>​    2：认证通过 【后台审核通过】<br>​   -1：认证未通过【后台审核不通过】</p>
<p>这个和上面差不多，其他就不写了，就写一个service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新司机认证信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateDriverAuthInfo</span><span class="params">(UpdateDriverAuthInfoForm update)</span> &#123;</span><br><span class="line">	<span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> update.getDriverId();</span><br><span class="line">	<span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverInfo</span>();</span><br><span class="line">	driverInfo.setId(driverId);</span><br><span class="line">	BeanUtils.copyProperties(update, driverInfo);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">this</span>.updateById(driverInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="开通人脸识别"><a href="#开通人脸识别" class="headerlink" title="开通人脸识别"></a>开通人脸识别</h2><p>腾讯云文档：<a href="https://cloud.tencent.com/product/facerecognition">人脸识别_人脸搜索_人脸检测_人脸比对-腾讯云</a></p>
<p>1、开通腾讯云人脸识别<br>2、创建人员库</p>
<h3 id="创建司机人脸模型"><a href="#创建司机人脸模型" class="headerlink" title="创建司机人脸模型"></a>创建司机人脸模型</h3><p>创建人脸识别模型之后，腾讯云返回模型id，获取模型id，更新到数据库表，但是因为这是调用腾讯云接口，所以如果之前已经有人拿这张图片创建过则不会创建新的模型id，而是返回之前创建的id</p>
<ul>
<li><p>修改配置文件</p>
</li>
<li><p>修改配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;tencent.cloud&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TencentCloudProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String secretId;</span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line">    <span class="keyword">private</span> String region;</span><br><span class="line">    <span class="keyword">private</span> String bucketPrivate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String persionGroupId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据腾讯云文档来实现代码 <a href="https://console.cloud.tencent.com/api/explorer?Product=iai&Version=2020-03-03&Action=CreatePerson">API Explorer - 云 API - 控制台</a></p>
</li>
</ul>
<h3 id="service-driver-4"><a href="#service-driver-4" class="headerlink" title="service-driver"></a>service-driver</h3><p>后面都是只写重要的代码实现，一般的调用就不写了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建司机人脸模型</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">creatDriverFaceModel</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span> &#123;</span><br><span class="line">	<span class="comment">//根据司机id获取司机信息</span></span><br><span class="line">	<span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span></span><br><span class="line">			driverInfoMapper.selectById(driverFaceModelForm.getDriverId());</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="type">Credential</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credential</span>(tencentCloudProperties.getSecretId(),</span><br><span class="line">				tencentCloudProperties.getSecretKey());</span><br><span class="line">		<span class="comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">		<span class="type">HttpProfile</span> <span class="variable">httpProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpProfile</span>();</span><br><span class="line">		httpProfile.setEndpoint(<span class="string">&quot;iai.tencentcloudapi.com&quot;</span>);</span><br><span class="line">		<span class="comment">// 实例化一个client选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">		<span class="type">ClientProfile</span> <span class="variable">clientProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientProfile</span>();</span><br><span class="line">		clientProfile.setHttpProfile(httpProfile);</span><br><span class="line">		<span class="comment">// 实例化要请求产品的client对象,clientProfile是可选的</span></span><br><span class="line">		<span class="type">IaiClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IaiClient</span>(cred, tencentCloudProperties.getRegion(),</span><br><span class="line">				clientProfile);</span><br><span class="line">		<span class="comment">// 实例化一个请求对象,每个接口都会对应一个request对象</span></span><br><span class="line">		<span class="type">CreatePersonRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreatePersonRequest</span>();</span><br><span class="line">		<span class="comment">//设置相关值</span></span><br><span class="line">		req.setGroupId(tencentCloudProperties.getPersionGroupId());</span><br><span class="line">		<span class="comment">//基本信息</span></span><br><span class="line">		req.setPersonId(String.valueOf(driverInfo.getId()));</span><br><span class="line">		req.setGender(Long.parseLong(driverInfo.getGender()));</span><br><span class="line">		req.setQualityControl(<span class="number">4L</span>);</span><br><span class="line">		req.setUniquePersonControl(<span class="number">4L</span>);</span><br><span class="line">		req.setPersonName(driverInfo.getName());</span><br><span class="line">		req.setImage(driverFaceModelForm.getImageBase64());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 返回的resp是一个CreatePersonResponse的实例，与请求对象对应</span></span><br><span class="line">		<span class="type">CreatePersonResponse</span> <span class="variable">resp</span> <span class="operator">=</span> client.CreatePerson(req);</span><br><span class="line">		<span class="comment">// 输出json格式的字符串回包</span></span><br><span class="line">		System.out.println(AbstractModel.toJsonString(resp));</span><br><span class="line">		<span class="type">String</span> <span class="variable">faceId</span> <span class="operator">=</span> resp.getFaceId();</span><br><span class="line">		<span class="keyword">if</span>(StringUtils.hasText(faceId)) &#123;</span><br><span class="line">			driverInfo.setFaceModelId(faceId);</span><br><span class="line">			driverInfoMapper.updateById(driverInfo);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (TencentCloudSDKException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="预估订单数据"><a href="#预估订单数据" class="headerlink" title="预估订单数据"></a>预估订单数据</h1><h2 id="查找客户端当前订单"><a href="#查找客户端当前订单" class="headerlink" title="查找客户端当前订单"></a>查找客户端当前订单</h2><p>当一个客户发起订单前先要查询是否有发起并且没有完成的订单，如果有订单未完成，则会弹出进行中的订单</p>
<h2 id="预估驾驶路线"><a href="#预估驾驶路线" class="headerlink" title="预估驾驶路线"></a>预估驾驶路线</h2><ul>
<li><p>访问腾讯官网 <a href="https://lbs.qq.com/">https://lbs.qq.com/</a></p>
</li>
<li><p>进行注册，手机号或者微信或者其他方式</p>
</li>
<li><p>使用注册账号进行登录，找到控制台</p>
</li>
<li><p>在应用管理 – 我的应用 ，创建应用</p>
</li>
<li><p>在创建应用中，添加key</p>
</li>
<li><p>修改nacos配置文件</p>
</li>
<li><p>编写接口</p>
</li>
</ul>
<p>下面实现接口，具体内容就是请求腾讯云提供的接口，按照接口传参数，然后返回需要的结果</p>
<p>腾讯官方文档：<a href="https://lbs.qq.com/service/webService/webServiceGuide/route/webServiceRoute">WebService API | 腾讯位置服务</a></p>
<ul>
<li><p>编写配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span>  </span><br><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MapService</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;tencent.map.key&#125;&quot;)</span>  </span><br><span class="line">    <span class="keyword">private</span> String key;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//计算驾驶线路  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> DrivingLineVo <span class="title function_">calculateDrivingLine</span><span class="params">(CalculateDrivingLineForm calculateDrivingLineForm)</span> &#123;  </span><br><span class="line">        <span class="comment">//请求腾讯提供接口，按照接口要求传递相关参数，返回需要结果  </span></span><br><span class="line">        <span class="comment">//使用HttpClient，目前Spring封装调用工具使用RestTemplate  </span></span><br><span class="line">        <span class="comment">//定义调用腾讯地址  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;https://apis.map.qq.com/ws/direction/v1/driving/?from=&#123;from&#125;&amp;to=&#123;to&#125;&amp;key=&#123;key&#125;&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//封装传递参数  </span></span><br><span class="line">        Map&lt;String,String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line">        <span class="comment">//开始位置  </span></span><br><span class="line">        <span class="comment">// 经纬度：比如 北纬40 东京116  </span></span><br><span class="line">        map.put(<span class="string">&quot;from&quot;</span>,calculateDrivingLineForm.getStartPointLatitude()+<span class="string">&quot;,&quot;</span>+calculateDrivingLineForm.getStartPointLongitude());  </span><br><span class="line">        <span class="comment">//结束位置  </span></span><br><span class="line">        map.put(<span class="string">&quot;to&quot;</span>,calculateDrivingLineForm.getEndPointLatitude()+<span class="string">&quot;,&quot;</span>+calculateDrivingLineForm.getEndPointLongitude());  </span><br><span class="line">        <span class="comment">//key  </span></span><br><span class="line">        map.put(<span class="string">&quot;key&quot;</span>,key);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//使用RestTemplate调用 GET        JSONObject result = restTemplate.getForObject(url, JSONObject.class, map);  </span></span><br><span class="line">        <span class="comment">//处理返回结果  </span></span><br><span class="line">        <span class="comment">//判断调用是否成功  </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> Objects.requireNonNull(result).getIntValue(<span class="string">&quot;status&quot;</span>);  </span><br><span class="line">        <span class="keyword">if</span>(status != <span class="number">0</span>) &#123;<span class="comment">//失败  </span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.MAP_FAIL);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//获取返回路线信息  </span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">route</span> <span class="operator">=</span>  </span><br><span class="line">                result.getJSONObject(<span class="string">&quot;result&quot;</span>).getJSONArray(<span class="string">&quot;routes&quot;</span>).getJSONObject(<span class="number">0</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//创建vo对象  </span></span><br><span class="line">        <span class="type">DrivingLineVo</span> <span class="variable">drivingLineVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DrivingLineVo</span>();  </span><br><span class="line">        <span class="comment">//预估时间  </span></span><br><span class="line">        drivingLineVo.setDuration(route.getBigDecimal(<span class="string">&quot;duration&quot;</span>));  </span><br><span class="line">        <span class="comment">//距离  6.583 == 6.58 / 6.59        drivingLineVo.setDistance(route.getBigDecimal(&quot;distance&quot;)  </span></span><br><span class="line">                .divide(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">1000</span>))  </span><br><span class="line">                .setScale(<span class="number">2</span>, RoundingMode.HALF_UP));  </span><br><span class="line">        <span class="comment">//路线  </span></span><br><span class="line">        drivingLineVo.setPolyline(route.getJSONArray(<span class="string">&quot;polyline&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> drivingLineVo;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="预估订单金额"><a href="#预估订单金额" class="headerlink" title="预估订单金额"></a>预估订单金额</h2><h3 id="整合规则引擎Drools"><a href="#整合规则引擎Drools" class="headerlink" title="整合规则引擎Drools"></a>整合规则引擎Drools</h3><ul>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-compiler<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-decisiontables<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-mvel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建Drools配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DroolsConfig</span> &#123;</span><br><span class="line">    <span class="comment">// 制定规则文件的路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RULES_CUSTOMER_RULES_DRL</span> <span class="operator">=</span> <span class="string">&quot;rules/FeeRule.drl&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KieContainer <span class="title function_">kieContainer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">KieServices</span> <span class="variable">kieServices</span> <span class="operator">=</span> KieServices.Factory.get();</span><br><span class="line"></span><br><span class="line">        <span class="type">KieFileSystem</span> <span class="variable">kieFileSystem</span> <span class="operator">=</span> kieServices.newKieFileSystem();</span><br><span class="line">        kieFileSystem.write(ResourceFactory.newClassPathResource(RULES_CUSTOMER_RULES_DRL));</span><br><span class="line">        <span class="type">KieBuilder</span> <span class="variable">kb</span> <span class="operator">=</span> kieServices.newKieBuilder(kieFileSystem);</span><br><span class="line">        kb.buildAll();</span><br><span class="line"></span><br><span class="line">        <span class="type">KieModule</span> <span class="variable">kieModule</span> <span class="operator">=</span> kb.getKieModule();</span><br><span class="line">        <span class="type">KieContainer</span> <span class="variable">kieContainer</span> <span class="operator">=</span> kieServices.newKieContainer(kieModule.getReleaseId());</span><br><span class="line">        <span class="keyword">return</span> kieContainer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建规则文件</p>
</li>
</ul>
<h3 id="封装费用规则接口"><a href="#封装费用规则接口" class="headerlink" title="封装费用规则接口"></a>封装费用规则接口</h3><h4 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h4><ul>
<li><p>两个实体类，输入对象和输出对象</p>
</li>
<li><p>输入对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeeRuleRequest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;代驾里程&quot;)</span><span class="comment">// swagger里面的描述</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal distance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;代驾时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String startTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;等候分钟&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer waitMinute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeeRuleResponse</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;总金额&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalAmount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;里程费&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal distanceFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;等时费用&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal waitFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;远程费&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal longDistanceFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;基础里程（公里）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal baseDistance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;基础里程费（元）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal baseDistanceFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;超出基础里程的里程（公里）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal exceedDistance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;超出基础里程的价格（元/公里）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal exceedDistancePrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;基础等时分钟（分钟）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer baseWaitMinute;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;超出基础等时的分钟（分钟）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer exceedWaitMinute;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;超出基础分钟的价格（元/分钟）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal exceedWaitMinutePrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;基础远途里程（公里）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal baseLongDistance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;超出基础远程里程的里程（公里）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal exceedLongDistance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = &quot;超出基础远程里程的价格（元/公里）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal exceedLongDistancePrice;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="费用规则文件"><a href="#费用规则文件" class="headerlink" title="费用规则文件"></a>费用规则文件</h4><p>1.起步价<br>    00:00:00-06:59:59  19元(含3公里)<br>    07:00:00-23:59:59  19元(含5公里)<br>2.里程费<br>    超出起步里程后开始计算<br>    00:00:00-06:59:59   4元&#x2F;1公里<br>    07:00:00-23:59:59   3元&#x2F;1公里<br>3.等候费<br>    等候10分钟后  1元&#x2F;1分钟<br>4.远途费<br>    订单行程超出12公里后每公里1元<br>5.计算总金额<br>    订单总金额 &#x3D; 基础里程费 + 超出基础里程的费 + 等候费 + 远程费</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//package对应的不一定是真正的目录，可以任意写com.abc，同一个包下的drl文件可以相互访问</span><br><span class="line">package  com.atguigu.daijia</span><br><span class="line"></span><br><span class="line">import com.atguigu.daijia.model.form.rules.FeeRuleRequest;</span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">import java.math.RoundingMode;</span><br><span class="line"></span><br><span class="line">global com.atguigu.daijia.model.vo.rules.FeeRuleResponse feeRuleResponse;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">1.起步价</span><br><span class="line">    00:00:00-06:59:59  19元(含3公里)</span><br><span class="line">    07:00:00-23:59:59  19元(含5公里)</span><br><span class="line">*/</span><br><span class="line">rule &quot;起步价 00:00:00-06:59:59  19元(含3公里)&quot;</span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象</span><br><span class="line">        里面出来的结果只能是ture或者false</span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span><br><span class="line">        $rule:FeeRuleRequest(startTime &gt;= &quot;00:00:00&quot; &amp;&amp; startTime &lt;= &quot;06:59:59&quot;)</span><br><span class="line">    then</span><br><span class="line">        feeRuleResponse.setBaseDistance(new BigDecimal(&quot;3.0&quot;));</span><br><span class="line">        feeRuleResponse.setBaseDistanceFee(new BigDecimal(&quot;19.0&quot;));</span><br><span class="line">        //3公里内里程费为0</span><br><span class="line">        feeRuleResponse.setExceedDistance(new BigDecimal(&quot;0.0&quot;));</span><br><span class="line">        feeRuleResponse.setExceedDistancePrice(new BigDecimal(&quot;4.0&quot;));</span><br><span class="line">        System.out.println(&quot;00:00:00-06:59:59 &quot; + feeRuleResponse.getBaseDistance() + &quot;公里，起步价:&quot; + feeRuleResponse.getBaseDistanceFee() + &quot;元&quot;);</span><br><span class="line">end</span><br><span class="line">rule &quot;起步价 07:00:00-23:59:59  19元(含5公里)&quot;</span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象</span><br><span class="line">        里面出来的结果只能是ture或者false</span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span><br><span class="line">        $rule:FeeRuleRequest(startTime &gt;= &quot;07:00:00&quot; &amp;&amp; startTime &lt;= &quot;23:59:59&quot;)</span><br><span class="line">    then</span><br><span class="line">        feeRuleResponse.setBaseDistance(new BigDecimal(&quot;5.0&quot;));</span><br><span class="line">        feeRuleResponse.setBaseDistanceFee(new BigDecimal(&quot;19.0&quot;));</span><br><span class="line"></span><br><span class="line">        //5公里内里程费为0</span><br><span class="line">        feeRuleResponse.setExceedDistance(new BigDecimal(&quot;0.0&quot;));</span><br><span class="line">        feeRuleResponse.setExceedDistancePrice(new BigDecimal(&quot;3.0&quot;));</span><br><span class="line">        System.out.println(&quot;07:00:00-23:59:59 &quot; + feeRuleResponse.getBaseDistance() + &quot;公里，起步价:&quot; + feeRuleResponse.getBaseDistanceFee() + &quot;元&quot;);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">2.里程费</span><br><span class="line">    超出起步里程后开始计算</span><br><span class="line">    00:00:00-06:59:59   4元/1公里</span><br><span class="line">    07:00:00-23:59:59   3元/1公里</span><br><span class="line">*/</span><br><span class="line">rule &quot;里程费 00:00:00-06:59:59 4元/1公里&quot;</span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象</span><br><span class="line">        里面出来的结果只能是ture或者false</span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span><br><span class="line">        $rule:FeeRuleRequest(startTime &gt;= &quot;00:00:00&quot;</span><br><span class="line">            &amp;&amp; startTime &lt;= &quot;06:59:59&quot;</span><br><span class="line">            &amp;&amp; distance.doubleValue() &gt; 3.0)</span><br><span class="line">    then</span><br><span class="line">        BigDecimal exceedDistance = $rule.getDistance().subtract(new BigDecimal(&quot;3.0&quot;));</span><br><span class="line">        feeRuleResponse.setExceedDistance(exceedDistance);</span><br><span class="line">        feeRuleResponse.setExceedDistancePrice(new BigDecimal(&quot;4.0&quot;));</span><br><span class="line">        System.out.println(&quot;里程费，超出里程:&quot; + feeRuleResponse.getExceedDistance() + &quot;公里，单价：&quot; + feeRuleResponse.getExceedDistancePrice());</span><br><span class="line">end</span><br><span class="line">rule &quot;里程费 07:00:00-23:59:59 3元/1公里&quot;</span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象</span><br><span class="line">        里面出来的结果只能是ture或者false</span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span><br><span class="line">        $rule:FeeRuleRequest(startTime &gt;= &quot;07:00:00&quot;</span><br><span class="line">            &amp;&amp; startTime &lt;= &quot;23:59:59&quot;</span><br><span class="line">            &amp;&amp; distance.doubleValue() &gt; 5.0)</span><br><span class="line">    then</span><br><span class="line">        BigDecimal exceedDistance = $rule.getDistance().subtract(new BigDecimal(&quot;5.0&quot;));</span><br><span class="line">        feeRuleResponse.setExceedDistance(exceedDistance);</span><br><span class="line">        feeRuleResponse.setExceedDistancePrice(new BigDecimal(&quot;3.0&quot;));</span><br><span class="line">        System.out.println(&quot;里程费，超出里程:&quot; + feeRuleResponse.getExceedDistance() + &quot;公里，单价：&quot; + feeRuleResponse.getExceedDistancePrice());</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">3.等候费</span><br><span class="line">    等候10分钟后  1元/1分钟</span><br><span class="line">*/</span><br><span class="line">rule &quot;等候费 等候10分钟后 1元/1分钟&quot;</span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象</span><br><span class="line">        里面出来的结果只能是ture或者false</span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span><br><span class="line">        $rule:FeeRuleRequest(waitMinute &gt; 10)</span><br><span class="line">    then</span><br><span class="line">        Integer exceedWaitMinute = $rule.getWaitMinute() - 10;</span><br><span class="line">        feeRuleResponse.setBaseWaitMinute(10);</span><br><span class="line">        feeRuleResponse.setExceedWaitMinute(exceedWaitMinute);</span><br><span class="line">        feeRuleResponse.setExceedWaitMinutePrice(new BigDecimal(&quot;1.0&quot;));</span><br><span class="line">        System.out.println(&quot;等候费，超出分钟:&quot; + feeRuleResponse.getExceedWaitMinute() + &quot;分钟，单价：&quot; + feeRuleResponse.getExceedWaitMinutePrice());</span><br><span class="line">end</span><br><span class="line">rule &quot;无等候费&quot;</span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象</span><br><span class="line">        里面出来的结果只能是ture或者false</span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span><br><span class="line">        $rule:FeeRuleRequest(waitMinute &lt;= 10)</span><br><span class="line">    then</span><br><span class="line">        feeRuleResponse.setBaseWaitMinute(10);</span><br><span class="line">        feeRuleResponse.setExceedWaitMinute(0);</span><br><span class="line">        feeRuleResponse.setExceedWaitMinutePrice(new BigDecimal(&quot;1.0&quot;));</span><br><span class="line">        System.out.println(&quot;等候费：无&quot;);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">4.远途费</span><br><span class="line">    订单行程超出12公里后每公里1元</span><br><span class="line">*/</span><br><span class="line">rule &quot;远途费 订单行程超出12公里后每公里1元&quot;</span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象</span><br><span class="line">        里面出来的结果只能是ture或者false</span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span><br><span class="line">        $rule:FeeRuleRequest(distance.doubleValue() &gt; 12.0)</span><br><span class="line">    then</span><br><span class="line">        BigDecimal exceedLongDistance = $rule.getDistance().subtract(new BigDecimal(&quot;12.0&quot;));</span><br><span class="line">        feeRuleResponse.setBaseLongDistance(new BigDecimal(&quot;12.0&quot;));</span><br><span class="line">        feeRuleResponse.setExceedLongDistance(exceedLongDistance);</span><br><span class="line">        feeRuleResponse.setExceedLongDistancePrice(new BigDecimal(&quot;1.0&quot;));</span><br><span class="line">        System.out.println(&quot;远途费，超出公里:&quot; + feeRuleResponse.getExceedLongDistance() + &quot;公里，单价：&quot; + feeRuleResponse.getExceedLongDistancePrice());</span><br><span class="line">end</span><br><span class="line">rule &quot;无远途费&quot;</span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象</span><br><span class="line">        里面出来的结果只能是ture或者false</span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span><br><span class="line">        $rule:FeeRuleRequest(distance.doubleValue() &lt;= 12.0)</span><br><span class="line">    then</span><br><span class="line">        feeRuleResponse.setBaseLongDistance(new BigDecimal(&quot;12.0&quot;));</span><br><span class="line">        feeRuleResponse.setExceedLongDistance(new BigDecimal(&quot;0&quot;));</span><br><span class="line">        feeRuleResponse.setExceedLongDistancePrice(new BigDecimal(&quot;0&quot;));</span><br><span class="line">        System.out.println(&quot;远途费：无&quot;);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">5.计算总金额</span><br><span class="line">    订单总金额 = 基础里程费 + 超出基础里程的费 + 等候费 + 远程费</span><br><span class="line">*/</span><br><span class="line">rule &quot;计算总金额&quot;</span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span><br><span class="line">    no-loop true         //防止陷入死循环</span><br><span class="line">    when</span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象</span><br><span class="line">        里面出来的结果只能是ture或者false</span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span><br><span class="line">        $rule:FeeRuleRequest(distance.doubleValue() &gt; 0.0)</span><br><span class="line">    then</span><br><span class="line">        //订单总金额 = 基础里程费 + 超出基础里程的费 + 等候费 + 远程费</span><br><span class="line">        BigDecimal distanceFee = feeRuleResponse.getBaseDistanceFee().add(feeRuleResponse.getExceedDistance().multiply(feeRuleResponse.getExceedDistancePrice()));</span><br><span class="line">        BigDecimal waitFee = new BigDecimal(feeRuleResponse.getExceedWaitMinute()).multiply(feeRuleResponse.getExceedWaitMinutePrice());</span><br><span class="line">        BigDecimal longDistanceFee = feeRuleResponse.getExceedLongDistance().multiply(feeRuleResponse.getExceedLongDistancePrice());</span><br><span class="line">        BigDecimal totalAmount = distanceFee.add(waitFee).add(longDistanceFee);</span><br><span class="line">        feeRuleResponse.setDistanceFee(distanceFee);</span><br><span class="line">        feeRuleResponse.setWaitFee(waitFee);</span><br><span class="line">        feeRuleResponse.setLongDistanceFee(longDistanceFee);</span><br><span class="line">        feeRuleResponse.setTotalAmount(totalAmount);</span><br><span class="line">        System.out.println(&quot;计算总金额:&quot; + feeRuleResponse.getTotalAmount() + &quot;元&quot;);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h4 id="预估订单金额接口"><a href="#预估订单金额接口" class="headerlink" title="预估订单金额接口"></a>预估订单金额接口</h4><ul>
<li><p>FeeRuleController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rules/fee&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeeRuleController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FeeRuleService feeRuleService;</span><br><span class="line">    <span class="meta">@Operation(summary = &quot;计算订单费用&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/calculateOrderFee&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;FeeRuleResponseVo&gt; <span class="title function_">calculateOrderFee</span><span class="params">(<span class="meta">@RequestBody</span> FeeRuleRequestForm calculateOrderFeeForm)</span> &#123;</span><br><span class="line">        <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleService.calculateOrderFee(calculateOrderFeeForm);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(feeRuleResponseVo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>FeeRuleService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeeRuleServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">FeeRuleService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KieContainer kieContainer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算订单费用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FeeRuleResponseVo <span class="title function_">calculateOrderFee</span><span class="params">(FeeRuleRequestForm form)</span> &#123;</span><br><span class="line">        <span class="comment">// 封装输入对象</span></span><br><span class="line">        <span class="type">FeeRuleRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequest</span>();</span><br><span class="line">        request.setDistance(form.getDistance());</span><br><span class="line">        <span class="type">Date</span> <span class="variable">startTime</span> <span class="operator">=</span> form.getStartTime();</span><br><span class="line">        request.setStartTime(<span class="keyword">new</span> <span class="title class_">DateTime</span>(startTime).toString(<span class="string">&quot;HH:mm:ss&quot;</span>));</span><br><span class="line">        request.setWaitMinute(form.getWaitMinute());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Drools执行规则</span></span><br><span class="line">        <span class="type">KieSession</span> <span class="variable">session</span> <span class="operator">=</span> kieContainer.newKieSession();</span><br><span class="line">        <span class="comment">// 封装返回对象</span></span><br><span class="line">        <span class="type">FeeRuleResponseVo</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleResponseVo</span>();</span><br><span class="line">        session.setGlobal(<span class="string">&quot;feeRuleResponse&quot;</span>,response);</span><br><span class="line"></span><br><span class="line">        session.insert(request);</span><br><span class="line">        session.fireAllRules();</span><br><span class="line">        session.dispose();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装数据到输出对象</span></span><br><span class="line">        <span class="type">FeeRuleResponseVo</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleResponseVo</span>();</span><br><span class="line">        BeanUtils.copyProperties(response,vo);</span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="远程调用接口"><a href="#远程调用接口" class="headerlink" title="远程调用接口"></a>远程调用接口</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;service-rules&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FeeRuleFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算订单费用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> calculateOrderFeeForm</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/rules/fee/calculateOrderFee&quot;)</span></span><br><span class="line">    Result&lt;FeeRuleResponseVo&gt; <span class="title function_">calculateOrderFee</span><span class="params">(<span class="meta">@RequestBody</span> FeeRuleRequestForm calculateOrderFeeForm)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="预估订单数据接口"><a href="#预估订单数据接口" class="headerlink" title="预估订单数据接口"></a>预估订单数据接口</h3><ul>
<li><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> OrderService orderService;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Operation(summary = &quot;预估订单数据&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/expectOrder&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;ExpectOrderVo&gt; <span class="title function_">expectOrder</span><span class="params">(<span class="meta">@RequestBody</span> ExpectOrderForm expectOrderForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.expectOrder(expectOrderForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>OrderService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MapFeignClient mapFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FeeRuleFeignClient feeRuleFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 预估订单数据</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExpectOrderVo <span class="title function_">expectOrder</span><span class="params">(ExpectOrderForm expectOrderForm)</span> &#123;</span><br><span class="line">        <span class="comment">//获取驾驶线路</span></span><br><span class="line">        <span class="type">CalculateDrivingLineForm</span> <span class="variable">calculateDrivingLineForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculateDrivingLineForm</span>();</span><br><span class="line">        BeanUtils.copyProperties(expectOrderForm,calculateDrivingLineForm);</span><br><span class="line">        Result&lt;DrivingLineVo&gt; drivingLineVoResult = mapFeignClient.calculateDrivingLine(calculateDrivingLineForm);</span><br><span class="line">        <span class="type">DrivingLineVo</span> <span class="variable">drivingLineVo</span> <span class="operator">=</span> drivingLineVoResult.getData();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取订单费用</span></span><br><span class="line">        <span class="type">FeeRuleRequestForm</span> <span class="variable">calculateOrderFeeForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();</span><br><span class="line">        calculateOrderFeeForm.setDistance(drivingLineVo.getDistance());</span><br><span class="line">        calculateOrderFeeForm.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        calculateOrderFeeForm.setWaitMinute(<span class="number">0</span>);</span><br><span class="line">        Result&lt;FeeRuleResponseVo&gt; feeRuleResponseVoResult = feeRuleFeignClient.calculateOrderFee(calculateOrderFeeForm);</span><br><span class="line">        <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleResponseVoResult.getData();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//封装ExpectOrderVo</span></span><br><span class="line">        <span class="type">ExpectOrderVo</span> <span class="variable">expectOrderVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpectOrderVo</span>();</span><br><span class="line">        expectOrderVo.setDrivingLineVo(drivingLineVo);</span><br><span class="line">        expectOrderVo.setFeeRuleResponseVo(feeRuleResponseVo);</span><br><span class="line">        <span class="keyword">return</span> expectOrderVo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="乘客下单（一）"><a href="#乘客下单（一）" class="headerlink" title="乘客下单（一）"></a>乘客下单（一）</h1><p>点击 <code>呼叫代驾</code> 会生成代驾订单，在 <code>order_info</code> 里添加订单数据</p>
<h2 id="乘客下单接口"><a href="#乘客下单接口" class="headerlink" title="乘客下单接口"></a>乘客下单接口</h2><ul>
<li><p>controller 不写了，就是调用获取数据</p>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;OrderInfoMapper, OrderInfo&gt; <span class="keyword">implements</span> <span class="title class_">OrderInfoService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderInfoMapper orderInfoMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderStatusLogMapper orderStatusLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 乘客下单</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">saveOrderInfo</span><span class="params">(OrderInfoForm orderInfoForm)</span> &#123;</span><br><span class="line">        <span class="comment">// 向order_info表中插入数据</span></span><br><span class="line">        <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">        BeanUtils.copyProperties(orderInfoForm, orderInfo);</span><br><span class="line"></span><br><span class="line">        orderInfo.setOrderNo(UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">        orderInfo.setStatus(OrderStatus.WAITING_ACCEPT.getStatus());</span><br><span class="line"></span><br><span class="line">        orderInfoMapper.insert(orderInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录日志</span></span><br><span class="line">        <span class="built_in">this</span>.log(orderInfo.getId(), orderInfo.getStatus());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> orderInfo.getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(Long orderId, Integer status)</span> &#123;</span><br><span class="line">        <span class="type">OrderStatusLog</span> <span class="variable">orderStatusLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderStatusLog</span>();</span><br><span class="line">        orderStatusLog.setOrderId(orderId);</span><br><span class="line">        orderStatusLog.setOrderStatus(status);</span><br><span class="line">        orderStatusLog.setOperateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        orderStatusLogMapper.insert(orderStatusLog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>远程调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;service-order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderInfoFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存订单信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderInfoForm</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/order/info/saveOrderInfo&quot;)</span></span><br><span class="line">    Result&lt;Long&gt; <span class="title function_">saveOrderInfo</span><span class="params">(<span class="meta">@RequestBody</span> OrderInfoForm orderInfoForm)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>web-service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">submitOrder</span><span class="params">(SubmitOrderForm submitOrderForm)</span> &#123;</span><br><span class="line">	<span class="comment">//1 重新计算驾驶线路</span></span><br><span class="line">	<span class="type">CalculateDrivingLineForm</span> <span class="variable">calculateDrivingLineForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculateDrivingLineForm</span>();</span><br><span class="line">	BeanUtils.copyProperties(submitOrderForm,submitOrderForm);</span><br><span class="line">	Result&lt;DrivingLineVo&gt; drivingLineVoResult = mapFeignClient.calculateDrivingLine(calculateDrivingLineForm);</span><br><span class="line">	<span class="type">DrivingLineVo</span> <span class="variable">drivingLineVo</span> <span class="operator">=</span> drivingLineVoResult.getData();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2 重新订单费用</span></span><br><span class="line">	<span class="type">FeeRuleRequestForm</span> <span class="variable">calculateOrderFeeForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();</span><br><span class="line">	calculateOrderFeeForm.setDistance(drivingLineVo.getDistance());</span><br><span class="line">	calculateOrderFeeForm.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">	calculateOrderFeeForm.setWaitMinute(<span class="number">0</span>);</span><br><span class="line">	Result&lt;FeeRuleResponseVo&gt; feeRuleResponseVoResult = feeRuleFeignClient.calculateOrderFee(calculateOrderFeeForm);</span><br><span class="line">	<span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleResponseVoResult.getData();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//封装数据</span></span><br><span class="line">	<span class="type">OrderInfoForm</span> <span class="variable">orderInfoForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoForm</span>();</span><br><span class="line">	BeanUtils.copyProperties(submitOrderForm,orderInfoForm);</span><br><span class="line">	orderInfoForm.setExpectDistance(drivingLineVo.getDistance());</span><br><span class="line">	orderInfoForm.setExpectAmount(feeRuleResponseVo.getTotalAmount());</span><br><span class="line">	Result&lt;Long&gt; orderInfoResult = orderInfoFeignClient.saveOrderInfo(orderInfoForm);</span><br><span class="line">	<span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> orderInfoResult.getData();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//TODO 查询附近可以接单司机</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> orderId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="查询订单状态"><a href="#查询订单状态" class="headerlink" title="查询订单状态"></a>查询订单状态</h2><h3 id="订单微服务模块接口"><a href="#订单微服务模块接口" class="headerlink" title="订单微服务模块接口"></a>订单微服务模块接口</h3><ul>
<li><p>根据订单id得到订单状态</p>
</li>
<li><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;根据订单id获取订单状态&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderStatus/&#123;orderId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Integer&gt; <span class="title function_">getOrderStatus</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.getOrderStatus(orderId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Integer <span class="title function_">getOrderStatus</span><span class="params">(Long orderId)</span> &#123;  </span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(OrderInfo::getId, orderId);  </span><br><span class="line">    wrapper.select(OrderInfo::getStatus);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(wrapper);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span>(orderInfo == <span class="literal">null</span>)&#123;  </span><br><span class="line">        <span class="keyword">return</span> OrderStatus.NULL_ORDER.getStatus();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> orderInfo.getStatus();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>远程调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取订单状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/getOrderStatus/&#123;orderId&#125;&quot;)</span></span><br><span class="line">Result&lt;Integer&gt; <span class="title function_">getOrderStatus</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="远程调用"><a href="#远程调用" class="headerlink" title="远程调用"></a>远程调用</h3><h4 id="乘客端-web-customer"><a href="#乘客端-web-customer" class="headerlink" title="乘客端 web-customer"></a>乘客端 web-customer</h4><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;查询订单状态&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderStatus/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Integer&gt; <span class="title function_">getOrderStatus</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getOrderStatus(orderId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Integer <span class="title function_">getOrderStatus</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    Result&lt;Integer&gt; integerResult = orderInfoFeignClient.getOrderStatus(orderId);</span><br><span class="line">    <span class="keyword">return</span> integerResult.getData();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="司机端-web-driver"><a href="#司机端-web-driver" class="headerlink" title="司机端 web-driver"></a>司机端 web-driver</h4><p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Tag(name = &quot;订单API接口管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Operation(summary = &quot;查询订单状态&quot;)</span></span><br><span class="line">    <span class="meta">@GuiguLogin</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getOrderStatus/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Integer&gt; <span class="title function_">getOrderStatus</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderService.getOrderStatus(orderId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderInfoFeignClient orderInfoFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getOrderStatus</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> orderInfoFeignClient.getOrderStatus(orderId).getData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="乘客下单（二）"><a href="#乘客下单（二）" class="headerlink" title="乘客下单（二）"></a>乘客下单（二）</h1><h2 id="搜索附件可以下单的司机"><a href="#搜索附件可以下单的司机" class="headerlink" title="搜索附件可以下单的司机"></a>搜索附件可以下单的司机</h2><h3 id="Redis的GEO功能"><a href="#Redis的GEO功能" class="headerlink" title="Redis的GEO功能"></a>Redis的GEO功能</h3><ul>
<li>**GEOADD 添加位置信息</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEOADD zhangsan 116.403963 39.915119 tiananmen 116.417876 39.915411 wangfujing 116.404354 39.904748 qianmen</span><br></pre></td></tr></table></figure>

<ul>
<li>**GEORADIUS 搜索范围以内消息</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEORADIUS zhangsan 116.4000 39.9000 1 km WITHDIST</span><br></pre></td></tr></table></figure>
<h2 id="实时更新司机的位置信息"><a href="#实时更新司机的位置信息" class="headerlink" title="实时更新司机的位置信息"></a>实时更新司机的位置信息</h2><h3 id="封装位置相关接口"><a href="#封装位置相关接口" class="headerlink" title="封装位置相关接口"></a>封装位置相关接口</h3><p>service.service-map</p>
<p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Tag(name = &quot;位置API接口管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/map/location&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocationController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LocationService locationService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//司机开启接单，更新司机位置信息</span></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;开启接单服务：更新司机经纬度位置&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/updateDriverLocation&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateDriverLocation</span><span class="params">(<span class="meta">@RequestBody</span></span></span><br><span class="line"><span class="params">                                                UpdateDriverLocationForm updateDriverLocationForm)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> locationService.updateDriverLocation(updateDriverLocationForm);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//司机关闭接单，删除司机位置信息</span></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;关闭接单服务：删除司机经纬度位置&quot;)</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/removeDriverLocation/&#123;driverId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">removeDriverLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(locationService.removeDriverLocation(driverId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocationServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LocationService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新司机位置信息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">updateDriverLocation</span><span class="params">(UpdateDriverLocationForm updateDriverLocationForm)</span> &#123;</span><br><span class="line">        <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(updateDriverLocationForm.getLongitude().doubleValue(),</span><br><span class="line">                updateDriverLocationForm.getLatitude().doubleValue());</span><br><span class="line">        redisTemplate.opsForGeo().add(RedisConstant.DRIVER_GEO_LOCATION,</span><br><span class="line">                                point,</span><br><span class="line">                                updateDriverLocationForm.getDriverId().toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除司机位置信息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">removeDriverLocation</span><span class="params">(Long driverId)</span> &#123;</span><br><span class="line">        redisTemplate.opsForGeo().remove(RedisConstant.DRIVER_GEO_LOCATION,driverId.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用定义"><a href="#远程调用定义" class="headerlink" title="远程调用定义"></a>远程调用定义</h3><p>service-client.service-map-client</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;service-map&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LocationFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启接单服务：更新司机经纬度位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> updateDriverLocationForm</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/map/location/updateDriverLocation&quot;)</span></span><br><span class="line">    Result&lt;Boolean&gt; <span class="title function_">updateDriverLocation</span><span class="params">(<span class="meta">@RequestBody</span> UpdateDriverLocationForm updateDriverLocationForm)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭接单服务：删除司机经纬度位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/map/location/removeDriverLocation/&#123;driverId&#125;&quot;)</span></span><br><span class="line">    Result&lt;Boolean&gt; <span class="title function_">removeDriverLocation</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="司机web端"><a href="#司机web端" class="headerlink" title="司机web端"></a>司机web端</h3><p>web.web-driver.controller</p>
<p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span>  </span><br><span class="line"><span class="meta">@Tag(name = &quot;位置API接口管理&quot;)</span>  </span><br><span class="line"><span class="meta">@RestController</span>  </span><br><span class="line"><span class="meta">@RequestMapping(value=&quot;/location&quot;)</span>  </span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocationController</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> LocationService locationService;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Operation(summary = &quot;开启接单服务：更新司机经纬度位置&quot;)</span>  </span><br><span class="line">    <span class="meta">@LoginDetection</span>  </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/updateDriverLocation&quot;)</span>  </span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateDriverLocation</span><span class="params">(<span class="meta">@RequestBody</span> UpdateDriverLocationForm updateDriverLocationForm)</span> &#123;  </span><br><span class="line">        <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">        updateDriverLocationForm.setDriverId(driverId);  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(locationService.updateDriverLocation(updateDriverLocationForm));  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocationServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LocationService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LocationFeignClient locationFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新司机消息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">updateDriverLocation</span><span class="params">(UpdateDriverLocationForm updateDriverLocationForm)</span> &#123;</span><br><span class="line">        Result&lt;Boolean&gt; booleanResult = locationFeignClient.updateDriverLocation(updateDriverLocationForm);</span><br><span class="line">        <span class="keyword">return</span> booleanResult.getData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取司机个性化设置信息"><a href="#获取司机个性化设置信息" class="headerlink" title="获取司机个性化设置信息"></a>获取司机个性化设置信息</h2><h3 id="封装查询司机个性化信息接口"><a href="#封装查询司机个性化信息接口" class="headerlink" title="封装查询司机个性化信息接口"></a>封装查询司机个性化信息接口</h3><p>service.service-driver.driver</p>
<p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取司机设置信息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getDriverSet/&#123;driverId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverSet&gt; <span class="title function_">getDriverSet</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Result.ok(driverInfoService.getDriverSet(driverId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverSet <span class="title function_">getDriverSet</span><span class="params">(Long driverId)</span> &#123;</span><br><span class="line">	LambdaQueryWrapper&lt;DriverSet&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">	wrapper.eq(DriverSet::getDriverId, driverId);</span><br><span class="line">	<span class="type">DriverSet</span> <span class="variable">driverSet</span> <span class="operator">=</span> driverSetMapper.selectOne(wrapper);</span><br><span class="line">	<span class="keyword">return</span> driverSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-1"><a href="#远程调用-1" class="headerlink" title="远程调用"></a>远程调用</h3><p>service-client.serivce-driver-client.DriverInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/driver/info/getDriverSet/&#123;driverId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;DriverSet&gt; <span class="title function_">getDriverSet</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="修改司机web端"><a href="#修改司机web端" class="headerlink" title="修改司机web端"></a>修改司机web端</h3><p>web.web-driver.controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocationServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LocationService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LocationFeignClient locationFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DriverInfoFeignClient driverInfoFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新司机消息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">updateDriverLocation</span><span class="params">(UpdateDriverLocationForm updateDriverLocationForm)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> updateDriverLocationForm.getDriverId();</span><br><span class="line">        Result&lt;DriverSet&gt; driverSet = driverInfoFeignClient.getDriverSet(driverId);</span><br><span class="line">        <span class="type">DriverSet</span> <span class="variable">data</span> <span class="operator">=</span> driverSet.getData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(data.getServiceStatus() == <span class="number">1</span>)&#123;</span><br><span class="line">            Result&lt;Boolean&gt; booleanResult = locationFeignClient.updateDriverLocation(updateDriverLocationForm);</span><br><span class="line">            <span class="keyword">return</span> booleanResult.getData();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.NO_START_SERVICE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="搜索附件适合接单的司机"><a href="#搜索附件适合接单的司机" class="headerlink" title="搜索附件适合接单的司机"></a>搜索附件适合接单的司机</h2><h3 id="封装搜索接单司机接口"><a href="#封装搜索接单司机接口" class="headerlink" title="封装搜索接单司机接口"></a>封装搜索接单司机接口</h3><p>service-map.map</p>
<p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;搜索附近满足条件的司机&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/searchNearByDriver&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;NearByDriverVo&gt;&gt; <span class="title function_">searchNearByDriver</span><span class="params">(<span class="meta">@RequestBody</span></span></span><br><span class="line"><span class="params">													   SearchNearByDriverForm searchNearByDriverForm)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Result.ok(locationService.searchNearByDriver(searchNearByDriverForm));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//搜索附近满足条件的司机</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;NearByDriverVo&gt; <span class="title function_">searchNearByDriver</span><span class="params">(SearchNearByDriverForm searchNearByDriverForm)</span> &#123;</span><br><span class="line">    <span class="comment">//搜索经纬度位置5公里以内的司机</span></span><br><span class="line">    <span class="comment">//1 操作redis里面geo</span></span><br><span class="line">    <span class="comment">//创建point，经纬度位置</span></span><br><span class="line">    <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(searchNearByDriverForm.getLongitude().doubleValue(),</span><br><span class="line">            searchNearByDriverForm.getLatitude().doubleValue());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义距离，5公里</span></span><br><span class="line">    <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Distance</span>(SystemConstant.NEARBY_DRIVER_RADIUS,</span><br><span class="line">                           RedisGeoCommands.DistanceUnit.KILOMETERS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建circle对象，point  distance</span></span><br><span class="line">    <span class="type">Circle</span> <span class="variable">circle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Circle</span>(point,distance);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义GEO参数，设置返回结果包含内容</span></span><br><span class="line">    RedisGeoCommands.<span class="type">GeoRadiusCommandArgs</span> <span class="variable">args</span> <span class="operator">=</span></span><br><span class="line">            RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs()</span><br><span class="line">                    .includeDistance()  <span class="comment">//包含距离</span></span><br><span class="line">                    .includeCoordinates() <span class="comment">//包含坐标</span></span><br><span class="line">                    .sortAscending(); <span class="comment">//升序</span></span><br><span class="line"></span><br><span class="line">    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; result =</span><br><span class="line">            redisTemplate.opsForGeo().radius(RedisConstant.DRIVER_GEO_LOCATION, circle, args);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 查询redis最终返回list集合</span></span><br><span class="line">    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; content = result.getContent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3 对查询list集合进行处理</span></span><br><span class="line">    <span class="comment">// 遍历list集合，得到每个司机信息</span></span><br><span class="line">    <span class="comment">// 根据每个司机个性化设置信息判断</span></span><br><span class="line">    List&lt;NearByDriverVo&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(content)) &#123;</span><br><span class="line">        Iterator&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; iterator = content.iterator();</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext()) &#123;</span><br><span class="line">            GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; item = iterator.next();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取司机id</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> Long.parseLong(item.getContent().getName());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//远程调用，根据司机id个性化设置信息</span></span><br><span class="line">            Result&lt;DriverSet&gt; driverSetResult = driverInfoFeignClient.getDriverSet(driverId);</span><br><span class="line">            <span class="type">DriverSet</span> <span class="variable">driverSet</span> <span class="operator">=</span> driverSetResult.getData();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//判断订单里程order_distance</span></span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">orderDistance</span> <span class="operator">=</span> driverSet.getOrderDistance();</span><br><span class="line">            <span class="comment">//orderDistance==0，司机没有限制的</span></span><br><span class="line">            <span class="comment">//如果不等于0 ，比如30，接单30公里代驾订单。</span></span><br><span class="line">            <span class="comment">//接单距离 - 当前单子距离  &lt; 0,不复合条件</span></span><br><span class="line">            <span class="comment">// 30          35</span></span><br><span class="line">            <span class="keyword">if</span>(orderDistance.doubleValue() != <span class="number">0</span></span><br><span class="line">                    &amp;&amp; orderDistance.subtract(searchNearByDriverForm.getMileageDistance()).doubleValue()&lt;<span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//判断接单里程 accept_distance</span></span><br><span class="line">            <span class="comment">//当前接单距离</span></span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">currentDistance</span> <span class="operator">=</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(item.getDistance().getValue()).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line"></span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">acceptDistance</span> <span class="operator">=</span> driverSet.getAcceptDistance();</span><br><span class="line">            <span class="keyword">if</span>(acceptDistance.doubleValue() !=<span class="number">0</span></span><br><span class="line">            &amp;&amp; acceptDistance.subtract(currentDistance).doubleValue()&lt;<span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//封装复合条件数据</span></span><br><span class="line">            <span class="type">NearByDriverVo</span> <span class="variable">nearByDriverVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NearByDriverVo</span>();</span><br><span class="line">            nearByDriverVo.setDriverId(driverId);</span><br><span class="line">            nearByDriverVo.setDistance(currentDistance);</span><br><span class="line">            list.add(nearByDriverVo);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h2><ul>
<li>启动相关服务</li>
</ul>
<p>service-map 和 service-driver</p>
<ul>
<li>使用Swagger进行接口测试</li>
</ul>
<p><a href="http://localhost:8503/doc.html#/home">http://localhost:8503/doc.html#/home</a></p>
<p>第一个接口测试用例及结果<br>![[Pasted image 20250528233022.png]]</p>
<p>发现错误来源于redis，开始排查</p>
<p>排查成功，犯了两个很低级的错误</p>
<ul>
<li>测试错误接口</li>
<li>nacos没有改配置文件，导致redis连接不上</li>
</ul>
<p>再次测试为成功<br>![[Pasted image 20250528233937.png]]</p>
<p>第二个接口测试用例及结果<br>![[Pasted image 20250528234733.png]]</p>
<p>还是失败，挠头了，去看看报错是什么<br>![[Pasted image 20250528235311.png]]</p>
<p>空对象？ok啊，结合自己聪明的大脑以及一点外界帮助，得出原因是因为司机只有一个，但是却有三满足条件司机的数据，程序蒙了，不知道返回哪个</p>
<p>解决方法是：因为是测试嘛，也不用太严谨，自己手动在数据库里面凭空产生点司机出来就行</p>
<p>再次测试，成功<br>![[Pasted image 20250528235542.png]]</p>
<h2 id="集成XXL-JOB"><a href="#集成XXL-JOB" class="headerlink" title="集成XXL-JOB"></a>集成XXL-JOB</h2><p>service.serivce-dispatch模块</p>
<h3 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="执行器配置"><a href="#执行器配置" class="headerlink" title="执行器配置"></a>执行器配置</h3><ul>
<li><p>修改nacos配置文件 <code>service-dispatch-dev.yaml</code></p>
</li>
<li><p>创建XXL-JOB配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">        <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="编写任务job方法测试是否成功"><a href="#编写任务job方法测试是否成功" class="headerlink" title="编写任务job方法测试是否成功"></a>编写任务job方法测试是否成功</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatchJobHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@XxlJob(&quot;firstJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJobHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;xxl-job项目集成测试&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>第一步，启动相关服务</p>
<ul>
<li>调度中心</li>
<li>执行器项目服务</li>
</ul>
<p>第二步，在调度中心创建任务</p>
<p>第三步，启动任务</p>
<p>测试的时候遇到点小问题：</p>
<ul>
<li>先运行调度中心再运行项目</li>
<li>失败要留意xxl的错误日志，哪里有问题就删哪里</li>
</ul>
<h2 id="封装XXL-JOB客户端"><a href="#封装XXL-JOB客户端" class="headerlink" title="封装XXL-JOB客户端"></a>封装XXL-JOB客户端</h2><h3 id="调度中心创建任务方法"><a href="#调度中心创建任务方法" class="headerlink" title="调度中心创建任务方法"></a>调度中心创建任务方法</h3><p>在xxl-job-admin中的controller中创建</p>
<p>JobInfoController把原来的添加删除修改任务替换</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//自定义任务操作的方法</span></span><br><span class="line"><span class="comment">//添加任务</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/addJob&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">addJobInfo</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> xxlJobService.add(jobInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除任务</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/removeJob&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">removeJob</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> xxlJobService.remove(jobInfo.getId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改任务</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/updateJob&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">updateJob</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> xxlJobService.update(jobInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//停止任务</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/stopJob&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">pauseJob</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> xxlJobService.stop(jobInfo.getId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//启动任务</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/startJob&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">startJob</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> xxlJobService.start(jobInfo.getId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加并启动任务</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/addAndStartJob&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">addAndStartJob</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> &#123;</span><br><span class="line">	ReturnT&lt;String&gt; result = xxlJobService.add(jobInfo);</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> result.getContent();</span><br><span class="line">	<span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> Integer.parseInt(content);</span><br><span class="line">	xxlJobService.start(id);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//立即执行一次</span></span><br><span class="line">	JobTriggerPoolHelper.trigger(id, TriggerTypeEnum.MANUAL, -<span class="number">1</span>, <span class="literal">null</span>, jobInfo.getExecutorParam(), <span class="string">&quot;&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="执行器项目配置文件添加任务方法"><a href="#执行器项目配置文件添加任务方法" class="headerlink" title="执行器项目配置文件添加任务方法"></a>执行器项目配置文件添加任务方法</h3><ul>
<li>修改nacos配置文件 <code>service-dispatch-dev.yaml</code></li>
<li>在job.admin下<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">client:</span></span><br><span class="line">  <span class="attr">jobGroupId:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">addUrl:</span> <span class="string">$&#123;xxl.job.admin.addresses&#125;/jobinfo/addJob</span></span><br><span class="line">  <span class="attr">removeUrl:</span> <span class="string">$&#123;xxl.job.admin.addresses&#125;/jobinfo/removeJob</span></span><br><span class="line">  <span class="attr">startJobUrl:</span> <span class="string">$&#123;xxl.job.admin.addresses&#125;/jobinfo/startJob</span></span><br><span class="line">  <span class="attr">stopJobUrl:</span> <span class="string">$&#123;xxl.job.admin.addresses&#125;/jobinfo/stopJob</span></span><br><span class="line">  <span class="attr">addAndStartUrl:</span> <span class="string">$&#123;xxl.job.admin.addresses&#125;/jobinfo/addAndStartJob</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="添加相关配置类service-dispatch"><a href="#添加相关配置类service-dispatch" class="headerlink" title="添加相关配置类service-dispatch"></a>添加相关配置类service-dispatch</h3><ul>
<li>创建配置类，读取配置文件里面的调用的调度中心的操作方法<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;xxl.job.client&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobClientConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer jobGroupId;</span><br><span class="line">    <span class="keyword">private</span> String addUrl;</span><br><span class="line">    <span class="keyword">private</span> String removeUrl;</span><br><span class="line">    <span class="keyword">private</span> String startJobUrl;</span><br><span class="line">    <span class="keyword">private</span> String stopJobUrl;</span><br><span class="line">    <span class="keyword">private</span> String addAndStartUrl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>创建客户端类，编写调用调度中心里面的方法<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.execption.GuiguException;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.result.ResultCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.dispatch.xxl.config.XxlJobClientConfig;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.model.entity.dispatch.XxlJobInfo;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobClientConfig xxlJobClientConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//客户端调用服务端里面的方法</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">addJob</span><span class="params">(String executorHandler, String param, String corn, String desc)</span>&#123;</span><br><span class="line">        <span class="type">XxlJobInfo</span> <span class="variable">xxlJobInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobInfo</span>();</span><br><span class="line">        xxlJobInfo.setJobGroup(xxlJobClientConfig.getJobGroupId());</span><br><span class="line">        xxlJobInfo.setJobDesc(desc);</span><br><span class="line">        xxlJobInfo.setAuthor(<span class="string">&quot;qy&quot;</span>);</span><br><span class="line">        xxlJobInfo.setScheduleType(<span class="string">&quot;CRON&quot;</span>);</span><br><span class="line">        xxlJobInfo.setScheduleConf(corn);</span><br><span class="line">        xxlJobInfo.setGlueType(<span class="string">&quot;BEAN&quot;</span>);</span><br><span class="line">        xxlJobInfo.setExecutorHandler(executorHandler);</span><br><span class="line">        xxlJobInfo.setExecutorParam(param);</span><br><span class="line">        xxlJobInfo.setExecutorRouteStrategy(<span class="string">&quot;FIRST&quot;</span>);</span><br><span class="line">        xxlJobInfo.setExecutorBlockStrategy(<span class="string">&quot;SERIAL_EXECUTION&quot;</span>);</span><br><span class="line">        xxlJobInfo.setMisfireStrategy(<span class="string">&quot;FIRE_ONCE_NOW&quot;</span>);</span><br><span class="line">        xxlJobInfo.setExecutorTimeout(<span class="number">0</span>);</span><br><span class="line">        xxlJobInfo.setExecutorFailRetryCount(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;XxlJobInfo&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(xxlJobInfo, headers);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxlJobClientConfig.getAddUrl();</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response =</span><br><span class="line">                restTemplate.postForEntity(url, request, JSONObject.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody().getIntValue(<span class="string">&quot;code&quot;</span>) == <span class="number">200</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;增加xxl执行任务成功,返回信息:&#123;&#125;&quot;</span>, response.getBody().toJSONString());</span><br><span class="line">            <span class="comment">//content为任务id</span></span><br><span class="line">            <span class="keyword">return</span> response.getBody().getLong(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;调用xxl增加执行任务失败:&#123;&#125;&quot;</span>, response.getBody().toJSONString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">startJob</span><span class="params">(Long jobId)</span> &#123;</span><br><span class="line">        <span class="type">XxlJobInfo</span> <span class="variable">xxlJobInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobInfo</span>();</span><br><span class="line">        xxlJobInfo.setId(jobId.intValue());</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;XxlJobInfo&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(xxlJobInfo, headers);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxlJobClientConfig.getStartJobUrl();</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.postForEntity(url, request, JSONObject.class);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody().getIntValue(<span class="string">&quot;code&quot;</span>) == <span class="number">200</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;启动xxl执行任务成功:&#123;&#125;,返回信息:&#123;&#125;&quot;</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;启动xxl执行任务失败:&#123;&#125;,返回信息:&#123;&#125;&quot;</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">stopJob</span><span class="params">(Long jobId)</span> &#123;</span><br><span class="line">        <span class="type">XxlJobInfo</span> <span class="variable">xxlJobInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobInfo</span>();</span><br><span class="line">        xxlJobInfo.setId(jobId.intValue());</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;XxlJobInfo&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(xxlJobInfo, headers);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxlJobClientConfig.getStopJobUrl();</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.postForEntity(url, request, JSONObject.class);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody().getIntValue(<span class="string">&quot;code&quot;</span>) == <span class="number">200</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;停止xxl执行任务成功:&#123;&#125;,返回信息:&#123;&#125;&quot;</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;停止xxl执行任务失败:&#123;&#125;,返回信息:&#123;&#125;&quot;</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">removeJob</span><span class="params">(Long jobId)</span> &#123;</span><br><span class="line">        <span class="type">XxlJobInfo</span> <span class="variable">xxlJobInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobInfo</span>();</span><br><span class="line">        xxlJobInfo.setId(jobId.intValue());</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;XxlJobInfo&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(xxlJobInfo, headers);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxlJobClientConfig.getRemoveUrl();</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.postForEntity(url, request, JSONObject.class);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody().getIntValue(<span class="string">&quot;code&quot;</span>) == <span class="number">200</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;删除xxl执行任务成功:&#123;&#125;,返回信息:&#123;&#125;&quot;</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;删除xxl执行任务失败:&#123;&#125;,返回信息:&#123;&#125;&quot;</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加并启动任务</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">addAndStart</span><span class="params">(String executorHandler, String param, String corn, String desc)</span> &#123;</span><br><span class="line">        <span class="type">XxlJobInfo</span> <span class="variable">xxlJobInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobInfo</span>();</span><br><span class="line">        xxlJobInfo.setJobGroup(xxlJobClientConfig.getJobGroupId());</span><br><span class="line">        xxlJobInfo.setJobDesc(desc);</span><br><span class="line">        xxlJobInfo.setAuthor(<span class="string">&quot;qy&quot;</span>);</span><br><span class="line">        xxlJobInfo.setScheduleType(<span class="string">&quot;CRON&quot;</span>);</span><br><span class="line">        xxlJobInfo.setScheduleConf(corn);</span><br><span class="line">        xxlJobInfo.setGlueType(<span class="string">&quot;BEAN&quot;</span>);</span><br><span class="line">        xxlJobInfo.setExecutorHandler(executorHandler);</span><br><span class="line">        xxlJobInfo.setExecutorParam(param);</span><br><span class="line">        xxlJobInfo.setExecutorRouteStrategy(<span class="string">&quot;FIRST&quot;</span>);</span><br><span class="line">        xxlJobInfo.setExecutorBlockStrategy(<span class="string">&quot;SERIAL_EXECUTION&quot;</span>);</span><br><span class="line">        xxlJobInfo.setMisfireStrategy(<span class="string">&quot;FIRE_ONCE_NOW&quot;</span>);</span><br><span class="line">        xxlJobInfo.setExecutorTimeout(<span class="number">0</span>);</span><br><span class="line">        xxlJobInfo.setExecutorFailRetryCount(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;XxlJobInfo&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(xxlJobInfo, headers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取调度中心请求路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxlJobClientConfig.getAddAndStartUrl();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//restTemplate</span></span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.postForEntity(url, request, JSONObject.class);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody().getIntValue(<span class="string">&quot;code&quot;</span>) == <span class="number">200</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;增加并开始执行xxl任务成功,返回信息:&#123;&#125;&quot;</span>, response.getBody().toJSONString());</span><br><span class="line">            <span class="comment">//content为任务id</span></span><br><span class="line">            <span class="keyword">return</span> response.getBody().getLong(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;增加并开始执行xxl任务失败:&#123;&#125;&quot;</span>, response.getBody().toJSONString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="启动类配置RestTemplate"><a href="#启动类配置RestTemplate" class="headerlink" title="启动类配置RestTemplate"></a>启动类配置RestTemplate</h3><p>直接把RestTemplate写在启动类里</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span>  </span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>  </span><br><span class="line"><span class="meta">@EnableFeignClients</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceDispatchApplication</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        SpringApplication.run(ServiceDispatchApplication.class, args);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建并启动任务接口"><a href="#创建并启动任务接口" class="headerlink" title="创建并启动任务接口"></a>创建并启动任务接口</h2><p>service-dispatch</p>
<p>controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建并启动任务调度方法</span></span><br><span class="line"><span class="meta">@Operation(summary = &quot;添加并开始新订单任务调度&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/addAndStartTask&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">addAndStartTask</span><span class="params">(<span class="meta">@RequestBody</span> NewOrderTaskVo newOrderTaskVo)</span> &#123;</span><br><span class="line">	<span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> newOrderService.addAndStartTask(newOrderTaskVo);</span><br><span class="line">	<span class="keyword">return</span> Result.ok(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 添加并开始新订单任务调度</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">addAndStartTask</span><span class="params">(NewOrderTaskVo newOrderTaskVo)</span> &#123;</span><br><span class="line">	<span class="comment">// 判断当前订单是否开启任务调度</span></span><br><span class="line">	LambdaQueryWrapper&lt;OrderJob&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">	wrapper.eq(OrderJob::getOrderId, newOrderTaskVo.getOrderId());</span><br><span class="line">	<span class="type">OrderJob</span> <span class="variable">orderJob</span> <span class="operator">=</span> orderJobMapper.selectOne(wrapper);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 没有启动，进行操作</span></span><br><span class="line">	<span class="keyword">if</span>(orderJob == <span class="literal">null</span>)&#123;</span><br><span class="line">		<span class="comment">//创建并启动任务调度</span></span><br><span class="line">		<span class="comment">//String executorHandler 执行任务job方法</span></span><br><span class="line">		<span class="comment">// String param</span></span><br><span class="line">		<span class="comment">// String corn 执行cron表达式</span></span><br><span class="line">		<span class="comment">// String desc 描述信息</span></span><br><span class="line">		<span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> xxlJobClient.addAndStart(<span class="string">&quot;newOrderTaskHandler&quot;</span>,</span><br><span class="line">				<span class="string">&quot;&quot;</span>, <span class="string">&quot;0 0/1 * * * ?&quot;</span>,</span><br><span class="line">				<span class="string">&quot;新创建订单任务调度：&quot;</span> + newOrderTaskVo.getOrderId());</span><br><span class="line"></span><br><span class="line">		orderJob = <span class="keyword">new</span> <span class="title class_">OrderJob</span>();</span><br><span class="line">		orderJob.setOrderId(newOrderTaskVo.getOrderId());</span><br><span class="line">		orderJob.setJobId(id);</span><br><span class="line">		orderJob.setParameter(JSONObject.toJSONString(newOrderTaskVo));</span><br><span class="line"></span><br><span class="line">		orderJobMapper.insert(orderJob);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> orderJob.getJobId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-2"><a href="#远程调用-2" class="headerlink" title="远程调用"></a>远程调用</h3><p>service-client<br>service-dispatch-client</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;service-dispatch&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">NewOrderFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加新订单任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newOrderDispatchVo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/dispatch/newOrder/addAndStartTask&quot;)</span></span><br><span class="line">    Result&lt;Long&gt; <span class="title function_">addAndStartTask</span><span class="params">(<span class="meta">@RequestBody</span> NewOrderTaskVo newOrderDispatchVo)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="开发具体任务job方法"><a href="#开发具体任务job方法" class="headerlink" title="开发具体任务job方法"></a>开发具体任务job方法</h2><p>JobHandler</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobLogMapper xxlJobLogMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NewOrderService newOrderService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@XxlJob(&quot;newOrderTaskHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">newOrderTaskHandler</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//记录任务调度日志</span></span><br><span class="line">        <span class="type">XxlJobLog</span> <span class="variable">xxlJobLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobLog</span>();</span><br><span class="line">        xxlJobLog.setJobId(XxlJobHelper.getJobId());</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行任务：搜索附近代驾司机</span></span><br><span class="line">            newOrderService.executeTask(XxlJobHelper.getJobId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//成功状态</span></span><br><span class="line">            xxlJobLog.setStatus(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//失败状态</span></span><br><span class="line">            xxlJobLog.setStatus(<span class="number">0</span>);</span><br><span class="line">            xxlJobLog.setError(e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">times</span> <span class="operator">=</span> System.currentTimeMillis()- startTime;</span><br><span class="line">            <span class="comment">//TODO 完善long</span></span><br><span class="line">            xxlJobLog.setTimes((<span class="type">int</span>)times);</span><br><span class="line">            xxlJobLogMapper.insert(xxlJobLog);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>远程调用<br>service-driver-client<br>LocationFeignClient<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 搜索附近满足条件的司机</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/map/location/searchNearByDriver&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;NearByDriverVo&gt;&gt; <span class="title function_">searchNearByDriver</span><span class="params">(<span class="meta">@RequestBody</span> SearchNearByDriverForm searchNearByDriverForm)</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>service-dispatch<br>NewOrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> LocationFeignClient locationFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderInfoFeignClient orderInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜索附件司机</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTask</span><span class="params">(<span class="type">long</span> jobId)</span> &#123;</span><br><span class="line">	<span class="comment">// 根据jobid查询当前任务是否已经创建</span></span><br><span class="line">	LambdaQueryWrapper&lt;OrderJob&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">	wrapper.eq(OrderJob::getJobId, jobId);</span><br><span class="line">	<span class="type">OrderJob</span> <span class="variable">orderJob</span> <span class="operator">=</span> orderJobMapper.selectOne(wrapper);</span><br><span class="line">	<span class="keyword">if</span>(orderJob == <span class="literal">null</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 查询订单状态，如果是接单状态，继续执行，否则停止</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">parameter</span> <span class="operator">=</span> orderJob.getParameter();</span><br><span class="line">	<span class="type">NewOrderTaskVo</span> <span class="variable">newOrderTaskVo</span> <span class="operator">=</span> JSONObject.parseObject(parameter, NewOrderTaskVo.class);</span><br><span class="line">	<span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> orderInfoFeignClient.getOrderStatus(newOrderTaskVo.getOrderId()).getData();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(status.intValue() != OrderStatus.WAITING_ACCEPT.getStatus().intValue())&#123;</span><br><span class="line">		xxlJobClient.stopJob(jobId);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 远程调用，查询正在接单的司机集合</span></span><br><span class="line">	<span class="type">SearchNearByDriverForm</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchNearByDriverForm</span>();</span><br><span class="line">	<span class="type">SearchNearByDriverForm</span> <span class="variable">searchNearByDriverForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchNearByDriverForm</span>();</span><br><span class="line">	searchNearByDriverForm.setLongitude(newOrderTaskVo.getStartPointLongitude());</span><br><span class="line">	searchNearByDriverForm.setLatitude(newOrderTaskVo.getStartPointLatitude());</span><br><span class="line">	List&lt;NearByDriverVo&gt; result = locationFeignClient.searchNearByDriver(from).getData();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 遍历满足条件的司机集合，为每个司机创建临时队列，存储新订单信息</span></span><br><span class="line">	result.forEach(driver -&gt; &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">repeatKey</span> <span class="operator">=</span></span><br><span class="line">				RedisConstant.DRIVER_ORDER_REPEAT_LIST+newOrderTaskVo.getOrderId();</span><br><span class="line">		<span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> redisTemplate.opsForSet().isMember(repeatKey, driver.getDriverId());</span><br><span class="line">		<span class="keyword">if</span>(!isMember)&#123;</span><br><span class="line">			<span class="comment">// 把订单信息推送刚给满足条件的司机</span></span><br><span class="line">			redisTemplate.opsForSet().add(parameter, driver.getDriverId());</span><br><span class="line">			<span class="comment">// 设置过期时间15分钟(一分钟等待)</span></span><br><span class="line">			redisTemplate.expire(repeatKey,</span><br><span class="line">					RedisConstant.DRIVER_ORDER_REPEAT_LIST_EXPIRES_TIME,</span><br><span class="line">					TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">			<span class="type">NewOrderDataVo</span> <span class="variable">newOrderDataVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NewOrderDataVo</span>();</span><br><span class="line">			newOrderDataVo.setOrderId(newOrderTaskVo.getOrderId());</span><br><span class="line">			newOrderDataVo.setStartLocation(newOrderTaskVo.getStartLocation());</span><br><span class="line">			newOrderDataVo.setEndLocation(newOrderTaskVo.getEndLocation());</span><br><span class="line">			newOrderDataVo.setExpectAmount(newOrderTaskVo.getExpectAmount());</span><br><span class="line">			newOrderDataVo.setExpectDistance(newOrderTaskVo.getExpectDistance());</span><br><span class="line">			newOrderDataVo.setExpectTime(newOrderTaskVo.getExpectTime());</span><br><span class="line">			newOrderDataVo.setFavourFee(newOrderTaskVo.getFavourFee());</span><br><span class="line">			newOrderDataVo.setDistance(driver.getDistance());</span><br><span class="line">			newOrderDataVo.setCreateTime(newOrderTaskVo.getCreateTime());</span><br><span class="line">			<span class="comment">// 新订单保存司机的临时队列</span></span><br><span class="line">			<span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.DRIVER_ORDER_TEMP_LIST+driver.getDriverId();</span><br><span class="line">			redisTemplate.opsForList().leftPush(key, JSONObject.toJSONString(newOrderDataVo));</span><br><span class="line">			<span class="comment">// 设置过期时间，一分钟</span></span><br><span class="line">			redisTemplate.expire(key, RedisConstant.DRIVER_ORDER_TEMP_LIST_EXPIRES_TIME, TimeUnit.MINUTES);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="乘客下单添加任务调度"><a href="#乘客下单添加任务调度" class="headerlink" title="乘客下单添加任务调度"></a>乘客下单添加任务调度</h2><p>web-customer<br>补充之前OrderServiceImpl里写的查询附近可以接单司机</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> NewOrderFeignClient newOrderFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">submitOrder</span><span class="params">(SubmitOrderForm submitOrderForm)</span> &#123;</span><br><span class="line">	<span class="comment">//1 重新计算驾驶线路</span></span><br><span class="line">	<span class="type">CalculateDrivingLineForm</span> <span class="variable">calculateDrivingLineForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculateDrivingLineForm</span>();</span><br><span class="line">	BeanUtils.copyProperties(submitOrderForm,submitOrderForm);</span><br><span class="line">	Result&lt;DrivingLineVo&gt; drivingLineVoResult = mapFeignClient.calculateDrivingLine(calculateDrivingLineForm);</span><br><span class="line">	<span class="type">DrivingLineVo</span> <span class="variable">drivingLineVo</span> <span class="operator">=</span> drivingLineVoResult.getData();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2 重新订单费用</span></span><br><span class="line">	<span class="type">FeeRuleRequestForm</span> <span class="variable">calculateOrderFeeForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();</span><br><span class="line">	calculateOrderFeeForm.setDistance(drivingLineVo.getDistance());</span><br><span class="line">	calculateOrderFeeForm.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">	calculateOrderFeeForm.setWaitMinute(<span class="number">0</span>);</span><br><span class="line">	Result&lt;FeeRuleResponseVo&gt; feeRuleResponseVoResult = feeRuleFeignClient.calculateOrderFee(calculateOrderFeeForm);</span><br><span class="line">	<span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleResponseVoResult.getData();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//封装数据</span></span><br><span class="line">	<span class="type">OrderInfoForm</span> <span class="variable">orderInfoForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoForm</span>();</span><br><span class="line">	BeanUtils.copyProperties(submitOrderForm,orderInfoForm);</span><br><span class="line">	orderInfoForm.setExpectDistance(drivingLineVo.getDistance());</span><br><span class="line">	orderInfoForm.setExpectAmount(feeRuleResponseVo.getTotalAmount());</span><br><span class="line">	Result&lt;Long&gt; orderInfoResult = orderInfoFeignClient.saveOrderInfo(orderInfoForm);</span><br><span class="line">	<span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> orderInfoResult.getData();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 任务调度：查询附近可以接单司机</span></span><br><span class="line">	<span class="type">NewOrderTaskVo</span> <span class="variable">newOrderTaskVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NewOrderTaskVo</span>();</span><br><span class="line">	newOrderTaskVo.setOrderId(orderId);</span><br><span class="line">	newOrderTaskVo.setStartLocation(orderInfoForm.getStartLocation());</span><br><span class="line">	newOrderTaskVo.setStartPointLongitude(orderInfoForm.getStartPointLongitude());</span><br><span class="line">	newOrderTaskVo.setStartPointLatitude(orderInfoForm.getStartPointLatitude());</span><br><span class="line">	newOrderTaskVo.setEndLocation(orderInfoForm.getEndLocation());</span><br><span class="line">	newOrderTaskVo.setEndPointLongitude(orderInfoForm.getEndPointLongitude());</span><br><span class="line">	newOrderTaskVo.setEndPointLatitude(orderInfoForm.getEndPointLatitude());</span><br><span class="line">	newOrderTaskVo.setExpectAmount(orderInfoForm.getExpectAmount());</span><br><span class="line">	newOrderTaskVo.setExpectDistance(orderInfoForm.getExpectDistance());</span><br><span class="line">	newOrderTaskVo.setExpectTime(drivingLineVo.getDuration());</span><br><span class="line">	newOrderTaskVo.setFavourFee(orderInfoForm.getFavourFee());</span><br><span class="line">	newOrderTaskVo.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">	<span class="type">Long</span> <span class="variable">jobId</span> <span class="operator">=</span> newOrderFeignClient.addAndStartTask(newOrderTaskVo).getData();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> orderId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="司机获取最新订单数据"><a href="#司机获取最新订单数据" class="headerlink" title="司机获取最新订单数据"></a>司机获取最新订单数据</h2><p>service-dispatch</p>
<h3 id="查询最新订单和清空司机队列数据"><a href="#查询最新订单和清空司机队列数据" class="headerlink" title="查询最新订单和清空司机队列数据"></a>查询最新订单和清空司机队列数据</h3><p>NewOrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;查询司机新订单数据&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/findNewOrderQueueData/&#123;driverId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;NewOrderDataVo&gt;&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Result.ok(newOrderService.findNewOrderQueueData(driverId));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = &quot;清空新订单队列数据&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/clearNewOrderQueueData/&#123;driverId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">clearNewOrderQueueData</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Result.ok(newOrderService.clearNewOrderQueueData(driverId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NewOrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//获取最新订单</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;NewOrderDataVo&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">(Long driverId)</span> &#123;</span><br><span class="line">    List&lt;NewOrderDataVo&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.DRIVER_ORDER_TEMP_LIST + driverId;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> redisTemplate.opsForList().size(key);</span><br><span class="line">    <span class="keyword">if</span>(size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> (String)redisTemplate.opsForList().leftPop(key);</span><br><span class="line">            <span class="type">NewOrderDataVo</span> <span class="variable">newOrderDataVo</span> <span class="operator">=</span> JSONObject.parseObject(content,NewOrderDataVo.class);</span><br><span class="line">            list.add(newOrderDataVo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//清空队列数据</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">clearNewOrderQueueData</span><span class="params">(Long driverId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.DRIVER_ORDER_TEMP_LIST + driverId;</span><br><span class="line">    redisTemplate.delete(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-3"><a href="#远程调用-3" class="headerlink" title="远程调用"></a>远程调用</h3><p>service-dispatch</p>
<p>NewOrderFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 查询司机新订单数据</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/dispatch/newOrder/findNewOrderQueueData/&#123;driverId&#125;&quot;)</span></span><br><span class="line">Result&lt;List&lt;NewOrderDataVo&gt;&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空新订单队列数据</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/dispatch/newOrder/clearNewOrderQueueData/&#123;driverId&#125;&quot;)</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">clearNewOrderQueueData</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="司机web端调用"><a href="#司机web端调用" class="headerlink" title="司机web端调用"></a>司机web端调用</h3><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;查询司机新订单数据&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/findNewOrderQueueData&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;NewOrderDataVo&gt;&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.findNewOrderQueueData(driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> NewOrderFeignClient newOrderFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> List&lt;NewOrderDataVo&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">(Long driverId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> newOrderFeignClient.findNewOrderQueueData(driverId).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="司机接单"><a href="#司机接单" class="headerlink" title="司机接单"></a>司机接单</h1><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul>
<li>乘客下单后，新订单信息已经放在司机临时队列，然后可以开始接单了</li>
</ul>
<p>首先，司机登录、认证（身份证、驾驶证、创建人脸模型）<br>第二，司机每天接单前都需要人脸识别<br>第三，司机开始接单，更新接单状态<br>第四，司机接单后，删除司机之前存储在redis里面的位置信息<br>第五，司机接单后，清空临时队列新订单信息</p>
<h2 id="查找司机端当前订单"><a href="#查找司机端当前订单" class="headerlink" title="查找司机端当前订单"></a>查找司机端当前订单</h2><p>设定是接单去需要验证司机是否有未完成的订单，暂时不管</p>
<ul>
<li>后续完成，暂时跳过</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;查找司机端当前订单&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/searchDriverCurrentOrder&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchDriverCurrentOrder</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">CurrentOrderInfoVo</span> <span class="variable">currentOrderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentOrderInfoVo</span>();  </span><br><span class="line">    <span class="comment">// TODO 后续完善  </span></span><br><span class="line">    currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">false</span>);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(currentOrderInfoVo);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="判断司机在当日是否人脸识别"><a href="#判断司机在当日是否人脸识别" class="headerlink" title="判断司机在当日是否人脸识别"></a>判断司机在当日是否人脸识别</h2><h3 id="service-driver-5"><a href="#service-driver-5" class="headerlink" title="service-driver"></a>service-driver</h3><p>DriverInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;判断司机当日是否进行过人脸识别&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/isFaceRecognition/&#123;driverId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">isFaceRecognition</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverInfoService.isFaceRecognition(driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 判断司机当日是否进行过人脸识别  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">isFaceRecognition</span><span class="params">(Long driverId)</span> &#123;  </span><br><span class="line">    <span class="comment">//根据司机id + 当日日期进行查询  </span></span><br><span class="line">    LambdaQueryWrapper&lt;DriverFaceRecognition&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(DriverFaceRecognition::getDriverId,driverId);  </span><br><span class="line">    <span class="comment">// 年-月-日 格式  </span></span><br><span class="line">    wrapper.eq(DriverFaceRecognition::getFaceDate,<span class="keyword">new</span> <span class="title class_">DateTime</span>().toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>));  </span><br><span class="line">    <span class="comment">//调用mapper方法  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> driverFaceRecognitionMapper.selectCount(wrapper);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> count != <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>远程调用</p>
<p>DriverInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 判断司机当日是否进行过人脸识别  </span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/driver/info/isFaceRecognition/&#123;driverId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">isFaceRecognition</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br></pre></td></tr></table></figure>


<h3 id="web端调用"><a href="#web端调用" class="headerlink" title="web端调用"></a>web端调用</h3><p>DriverController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;判断司机当日是否进行过人脸识别&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/isFaceRecognition&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">isFaceRecognition</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverService.isFaceRecognition(driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 判断司机当日是否进行过人脸识别  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">isFaceRecognition</span><span class="params">(Long driverId)</span> &#123;  </span><br><span class="line">    Result&lt;Boolean&gt; faceRecognition = driverInfoFeignClient.isFaceRecognition(driverId);  </span><br><span class="line">    <span class="keyword">return</span> faceRecognition.getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="人脸识别接口"><a href="#人脸识别接口" class="headerlink" title="人脸识别接口"></a>人脸识别接口</h2><ul>
<li><p>进行人脸识别，基于腾讯云实现</p>
</li>
<li><p>之前创建人脸识别模型，基于之前创建人脸模型完成当前识别功能</p>
</li>
<li><p>找到腾讯云文档1：照片比对<br><a href="https://console.cloud.tencent.com/api/explorer?Product=iai&Version=2020-03-03&Action=VerifyFace">https://console.cloud.tencent.com/api/explorer?Product=iai&amp;Version=2020-03-03&amp;Action=VerifyFace</a></p>
</li>
<li><p>找到腾讯云文档2：人脸静态活体检测<br><a href="https://console.cloud.tencent.com/api/explorer?Product=iai&Version=2020-03-03&Action=DetectLiveFace">https://console.cloud.tencent.com/api/explorer?Product=iai&amp;Version=2020-03-03&amp;Action=DetectLiveFace</a></p>
</li>
</ul>
<h3 id="service-driver-6"><a href="#service-driver-6" class="headerlink" title="service-driver"></a>service-driver</h3><p>DriverInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;验证司机人脸&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/verifyDriverFace&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">verifyDriverFace</span><span class="params">(<span class="meta">@RequestBody</span> DriverFaceModelForm driverFaceModelForm)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverInfoService.verifyDriverFace(driverFaceModelForm));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 验证司机人脸  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">verifyDriverFace</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span> &#123;  </span><br><span class="line">    <span class="comment">// 照片比对  </span></span><br><span class="line">    <span class="keyword">try</span>&#123;  </span><br><span class="line">        <span class="comment">// 实例化一个认证对象，入参需要传入腾讯云账户 SecretId 和 SecretKey，此处还需注意密钥对的保密  </span></span><br><span class="line">        <span class="comment">// 代码泄露可能会导致 SecretId 和 SecretKey 泄露，并威胁账号下所有资源的安全性  </span></span><br><span class="line">        <span class="comment">// 以下代码示例仅供参考，建议采用更安全的方式来使用密钥  </span></span><br><span class="line">        <span class="comment">// 请参见：https://cloud.tencent.com/document/product/1278/85305  </span></span><br><span class="line">        <span class="comment">// 密钥可前往官网控制台 https://console.cloud.tencent.com/cam/capi 进行获取  </span></span><br><span class="line">        <span class="type">Credential</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credential</span>(tencentCloudProperties.getSecretId(),  </span><br><span class="line">                tencentCloudProperties.getSecretKey());  </span><br><span class="line">        <span class="comment">// 使用临时密钥示例  </span></span><br><span class="line">        <span class="comment">// Credential cred = new Credential(&quot;SecretId&quot;, &quot;SecretKey&quot;, &quot;Token&quot;);  </span></span><br><span class="line">        <span class="comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过  </span></span><br><span class="line">        <span class="type">HttpProfile</span> <span class="variable">httpProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpProfile</span>();  </span><br><span class="line">        httpProfile.setEndpoint(<span class="string">&quot;iai.tencentcloudapi.com&quot;</span>);  </span><br><span class="line">        <span class="comment">// 实例化一个client选项，可选的，没有特殊需求可以跳过  </span></span><br><span class="line">        <span class="type">ClientProfile</span> <span class="variable">clientProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientProfile</span>();  </span><br><span class="line">        clientProfile.setHttpProfile(httpProfile);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 实例化要请求产品的client对象,clientProfile是可选的  </span></span><br><span class="line">        <span class="type">IaiClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IaiClient</span>(cred,  </span><br><span class="line">                tencentCloudProperties.getRegion(), clientProfile);  </span><br><span class="line">        <span class="comment">// 实例化一个请求对象,每个接口都会对应一个request对象  </span></span><br><span class="line">        <span class="type">VerifyFaceRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VerifyFaceRequest</span>();  </span><br><span class="line">        <span class="comment">// 设置相关参数  </span></span><br><span class="line">        req.setImage(driverFaceModelForm.getImageBase64());  </span><br><span class="line">        req.setPersonId(String.valueOf(driverFaceModelForm.getDriverId()));  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 返回的resp是一个VerifyFaceResponse的实例，与请求对象对应  </span></span><br><span class="line">        <span class="type">VerifyFaceResponse</span> <span class="variable">resp</span> <span class="operator">=</span> client.VerifyFace(req);  </span><br><span class="line">        <span class="comment">// 输出json格式的字符串回包  </span></span><br><span class="line">        System.out.println(AbstractModel.toJsonString(resp));  </span><br><span class="line">        <span class="keyword">if</span>(resp.getIsMatch())&#123;  </span><br><span class="line">            <span class="comment">// 静态活体检测  </span></span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> <span class="built_in">this</span>.detectLiveFace(driverFaceModelForm.getImageBase64());  </span><br><span class="line">            <span class="keyword">if</span>(isSuccess)&#123;  </span><br><span class="line">                <span class="comment">// 都没问题，添加塑胶到认证表中  </span></span><br><span class="line">                <span class="type">DriverFaceRecognition</span> <span class="variable">driverFaceRecognition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverFaceRecognition</span>();  </span><br><span class="line">                driverFaceRecognition.setDriverId(driverFaceModelForm.getDriverId());  </span><br><span class="line">                driverFaceRecognition.setFaceDate(<span class="keyword">new</span> <span class="title class_">Date</span>());  </span><br><span class="line">                driverFaceRecognitionMapper.insert(driverFaceRecognition);  </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (TencentCloudSDKException e) &#123;  </span><br><span class="line">        System.out.println(e.toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//人脸静态活体检测  </span></span><br><span class="line"><span class="keyword">private</span> Boolean <span class="title function_">detectLiveFace</span><span class="params">(String imageBase64)</span> &#123;  </span><br><span class="line">    <span class="keyword">try</span>&#123;  </span><br><span class="line">        <span class="comment">// 实例化一个认证对象，入参需要传入腾讯云账户 SecretId 和 SecretKey，此处还需注意密钥对的保密  </span></span><br><span class="line">        <span class="comment">// 代码泄露可能会导致 SecretId 和 SecretKey 泄露，并威胁账号下所有资源的安全性。以下代码示例仅供参考，建议采用更安全的方式来使用密钥，请参见：https://cloud.tencent.com/document/product/1278/85305  </span></span><br><span class="line">        <span class="comment">// 密钥可前往官网控制台 https://console.cloud.tencent.com/cam/capi 进行获取  </span></span><br><span class="line">        <span class="type">Credential</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credential</span>(tencentCloudProperties.getSecretId(),  </span><br><span class="line">                tencentCloudProperties.getSecretKey());  </span><br><span class="line">        <span class="comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过  </span></span><br><span class="line">        <span class="type">HttpProfile</span> <span class="variable">httpProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpProfile</span>();  </span><br><span class="line">        httpProfile.setEndpoint(<span class="string">&quot;iai.tencentcloudapi.com&quot;</span>);  </span><br><span class="line">        <span class="comment">// 实例化一个client选项，可选的，没有特殊需求可以跳过  </span></span><br><span class="line">        <span class="type">ClientProfile</span> <span class="variable">clientProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientProfile</span>();  </span><br><span class="line">        clientProfile.setHttpProfile(httpProfile);  </span><br><span class="line">        <span class="comment">// 实例化要请求产品的client对象,clientProfile是可选的  </span></span><br><span class="line">        <span class="type">IaiClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IaiClient</span>(cred, tencentCloudProperties.getRegion(),  </span><br><span class="line">                clientProfile);  </span><br><span class="line">        <span class="comment">// 实例化一个请求对象,每个接口都会对应一个request对象  </span></span><br><span class="line">        <span class="type">DetectLiveFaceRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DetectLiveFaceRequest</span>();  </span><br><span class="line">        req.setImage(imageBase64);  </span><br><span class="line">        <span class="comment">// 返回的resp是一个DetectLiveFaceResponse的实例，与请求对象对应  </span></span><br><span class="line">        <span class="type">DetectLiveFaceResponse</span> <span class="variable">resp</span> <span class="operator">=</span> client.DetectLiveFace(req);  </span><br><span class="line">        <span class="comment">// 输出json格式的字符串回包  </span></span><br><span class="line">        System.out.println(DetectLiveFaceResponse.toJsonString(resp));  </span><br><span class="line">        <span class="keyword">if</span>(resp.getIsLiveness()) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (TencentCloudSDKException e) &#123;  </span><br><span class="line">        System.out.println(e.toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-service-driver-client"><a href="#远程调用-service-driver-client" class="headerlink" title="远程调用 service-driver-client"></a>远程调用 service-driver-client</h3><p>DriverInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 验证司机人脸  </span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/driver/info/verifyDriverFace&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">verifyDriverFace</span><span class="params">(<span class="meta">@RequestBody</span> DriverFaceModelForm driverFaceModelForm)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="web-driver-1"><a href="#web-driver-1" class="headerlink" title="web-driver"></a>web-driver</h3><p>DriverController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;验证司机人脸&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/verifyDriverFace&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">verifyDriverFace</span><span class="params">(<span class="meta">@RequestBody</span> DriverFaceModelForm driverFaceModelForm)</span> &#123;  </span><br><span class="line">    driverFaceModelForm.setDriverId(AuthContextHolder.getUserId());  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverService.verifyDriverFace(driverFaceModelForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 验证司机人脸  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">verifyDriverFace</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span> &#123;  </span><br><span class="line">    Result&lt;Boolean&gt; booleanResult = driverInfoFeignClient.verifyDriverFace(driverFaceModelForm);  </span><br><span class="line">    <span class="keyword">return</span> booleanResult.getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="更新司机接单状态"><a href="#更新司机接单状态" class="headerlink" title="更新司机接单状态"></a>更新司机接单状态</h2><p>DriverInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;更新接单状态&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/updateServiceStatus/&#123;driverId&#125;/&#123;status&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateServiceStatus</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId, <span class="meta">@PathVariable</span> Integer status)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverInfoService.updateServiceStatus(driverId, status));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateServiceStatus</span><span class="params">(Long driverId, Integer status)</span> &#123;  </span><br><span class="line">    LambdaQueryWrapper&lt;DriverSet&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(DriverSet::getDriverId,driverId);  </span><br><span class="line">    <span class="type">DriverSet</span> <span class="variable">driverSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverSet</span>();  </span><br><span class="line">    driverSet.setServiceStatus(status);  </span><br><span class="line">    driverSetMapper.update(driverSet,wrapper);  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>远程调用DriverInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新接单状态  </span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/driver/info/updateServiceStatus/&#123;driverId&#125;/&#123;status&#125;&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateServiceStatus</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId, <span class="meta">@PathVariable(&quot;status&quot;)</span> Integer status)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="开启接单服务web接口"><a href="#开启接单服务web接口" class="headerlink" title="开启接单服务web接口"></a>开启接单服务web接口</h2><p>在web-driver中进行编写</p>
<p>司机开启接单后，上传位置信息到redis的GEO，才能被任务调度搜索到司机信息，开始抢单</p>
<h3 id="DriverController"><a href="#DriverController" class="headerlink" title="DriverController"></a>DriverController</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;开始接单服务&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/startService&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">startService</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverService.startService(driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DriverServiceImpl"><a href="#DriverServiceImpl" class="headerlink" title="DriverServiceImpl"></a>DriverServiceImpl</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> LocationFeignClient locationFeignClient;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> NewOrderFeignClient newOrderFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始接单服务  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">startService</span><span class="params">(Long driverId)</span> &#123;  </span><br><span class="line">    <span class="comment">//1 判断完成认证  </span></span><br><span class="line">    <span class="type">DriverLoginVo</span> <span class="variable">driverLoginVo</span> <span class="operator">=</span> driverInfoFeignClient.getDriverLoginInfo(driverId).getData();  </span><br><span class="line">    <span class="keyword">if</span>(driverLoginVo.getAuthStatus()!=<span class="number">2</span>) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.AUTH_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//2 判断当日是否人脸识别  </span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isFace</span> <span class="operator">=</span> driverInfoFeignClient.isFaceRecognition(driverId).getData();  </span><br><span class="line">    <span class="keyword">if</span>(!isFace) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.FACE_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//3 更新订单状态 1 开始接单  </span></span><br><span class="line">    driverInfoFeignClient.updateServiceStatus(driverId,<span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//4 删除redis司机位置信息  </span></span><br><span class="line">    locationFeignClient.removeDriverLocation(driverId);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//5 清空司机临时队列数据  </span></span><br><span class="line">    newOrderFeignClient.clearNewOrderQueueData(driverId);  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="停止接单服务web接口"><a href="#停止接单服务web接口" class="headerlink" title="停止接单服务web接口"></a>停止接单服务web接口</h2><p>DriverController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;停止接单服务&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/stopService&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">stopService</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverService.stopService(driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DriverServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//停止接单服务  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">stopService</span><span class="params">(Long driverId)</span> &#123;  </span><br><span class="line">    <span class="comment">//更新司机的接单状态 0   </span></span><br><span class="line">    driverInfoFeignClient.updateServiceStatus(driverId,<span class="number">0</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//删除司机位置信息  </span></span><br><span class="line">    locationFeignClient.removeDriverLocation(driverId);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//清空司机临时队列  </span></span><br><span class="line">    newOrderFeignClient.clearNewOrderQueueData(driverId);  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="司机抢单"><a href="#司机抢单" class="headerlink" title="司机抢单"></a>司机抢单</h1><h2 id="抢单接口"><a href="#抢单接口" class="headerlink" title="抢单接口"></a>抢单接口</h2><h3 id="微服务抢单接口"><a href="#微服务抢单接口" class="headerlink" title="微服务抢单接口"></a>微服务抢单接口</h3><p>service-order模块内</p>
<p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机抢单&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/robNewOrder/&#123;driverId&#125;/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">robNewOrder</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId, <span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.robNewOrder(driverId, orderId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>在OrderInfoServiceImpl之前保存订单 方法修改</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">//乘客下单  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">saveOrderInfo</span><span class="params">(OrderInfoForm orderInfoForm)</span> &#123;  </span><br><span class="line">    <span class="comment">//order_info添加订单数据  </span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();  </span><br><span class="line">    BeanUtils.copyProperties(orderInfoForm,orderInfo);  </span><br><span class="line">    <span class="comment">//订单号  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">orderNo</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>);  </span><br><span class="line">    orderInfo.setOrderNo(orderNo);  </span><br><span class="line">    <span class="comment">//订单状态  </span></span><br><span class="line">    orderInfo.setStatus(OrderStatus.WAITING_ACCEPT.getStatus());  </span><br><span class="line">    orderInfoMapper.insert(orderInfo);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//记录日志  </span></span><br><span class="line">    <span class="built_in">this</span>.log(orderInfo.getId(),orderInfo.getStatus());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//向redis添加标识  </span></span><br><span class="line">    <span class="comment">//接单标识，标识不存在了说明不在等待接单状态了  </span></span><br><span class="line">    redisTemplate.opsForValue().set(RedisConstant.ORDER_ACCEPT_MARK,  </span><br><span class="line">            <span class="string">&quot;0&quot;</span>, RedisConstant.ORDER_ACCEPT_MARK_EXPIRES_TIME, TimeUnit.MINUTES);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> orderInfo.getId();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OrderInfoServiceImpl新增司机抢单方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//司机抢单  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">robNewOrder</span><span class="params">(Long driverId, Long orderId)</span> &#123;  </span><br><span class="line">    <span class="comment">//判断订单是否存在，通过Redis，减少数据库压力  </span></span><br><span class="line">    <span class="keyword">if</span>(!redisTemplate.hasKey(RedisConstant.ORDER_ACCEPT_MARK)) &#123;  </span><br><span class="line">        <span class="comment">//抢单失败  </span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//司机抢单  </span></span><br><span class="line">    <span class="comment">//修改order_info表订单状态值2：已经接单 + 司机id + 司机接单时间  </span></span><br><span class="line">    <span class="comment">//修改条件：根据订单id  </span></span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(OrderInfo::getId,orderId);  </span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(wrapper);  </span><br><span class="line">    <span class="comment">//设置  </span></span><br><span class="line">    orderInfo.setStatus(OrderStatus.ACCEPTED.getStatus());  </span><br><span class="line">    orderInfo.setStatus(OrderStatus.ACCEPTED.getStatus());  </span><br><span class="line">    orderInfo.setDriverId(driverId);  </span><br><span class="line">    orderInfo.setAcceptTime(<span class="keyword">new</span> <span class="title class_">Date</span>());  </span><br><span class="line">    <span class="comment">//调用方法修改  </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> orderInfoMapper.updateById(orderInfo);  </span><br><span class="line">    <span class="keyword">if</span>(rows != <span class="number">1</span>) &#123;  </span><br><span class="line">        <span class="comment">//抢单失败  </span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//删除抢单标识  </span></span><br><span class="line">    redisTemplate.delete(RedisConstant.ORDER_ACCEPT_MARK);  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>远程调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 司机抢单  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/robNewOrder/&#123;driverId&#125;/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">robNewOrder</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId, <span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="司机web端接口"><a href="#司机web端接口" class="headerlink" title="司机web端接口"></a>司机web端接口</h3><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机抢单&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/robNewOrder/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">robNewOrder</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.robNewOrder(driverId, orderId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 司机抢单  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">robNewOrder</span><span class="params">(Long driverId, Long orderId)</span> &#123;  </span><br><span class="line">    Result&lt;Boolean&gt; booleanResult = orderInfoFeignClient.robNewOrder(driverId, orderId);  </span><br><span class="line">    <span class="keyword">return</span> booleanResult.getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加Redisson分布式锁到司机抢单"><a href="#添加Redisson分布式锁到司机抢单" class="headerlink" title="添加Redisson分布式锁到司机抢单"></a>添加Redisson分布式锁到司机抢单</h3><p>在service里service-order中OrderInfoServiceImpl添加分布式锁</p>
<p>修改之前写的robNewOrder</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">//司机抢单  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">robNewOrder</span><span class="params">(Long driverId, Long orderId)</span> &#123;  </span><br><span class="line">    <span class="comment">//判断订单是否存在，通过Redis，减少数据库压力  </span></span><br><span class="line">    <span class="keyword">if</span>(!redisTemplate.hasKey(RedisConstant.ORDER_ACCEPT_MARK)) &#123;  </span><br><span class="line">        <span class="comment">//抢单失败  </span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//创建锁  </span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(RedisConstant.ROB_NEW_ORDER_LOCK + orderId);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="comment">//获取锁  </span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> lock.tryLock(RedisConstant.ROB_NEW_ORDER_LOCK_WAIT_TIME,  </span><br><span class="line">                RedisConstant.ROB_NEW_ORDER_LOCK_LEASE_TIME,   </span><br><span class="line">                TimeUnit.SECONDS);  </span><br><span class="line">        <span class="keyword">if</span>(flag) &#123;  </span><br><span class="line">            <span class="keyword">if</span>(!redisTemplate.hasKey(RedisConstant.ORDER_ACCEPT_MARK)) &#123;  </span><br><span class="line">                <span class="comment">//抢单失败  </span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">//司机抢单  </span></span><br><span class="line">            <span class="comment">//修改order_info表订单状态值2：已经接单 + 司机id + 司机接单时间  </span></span><br><span class="line">            <span class="comment">//修改条件：根据订单id  </span></span><br><span class="line">            LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">            wrapper.eq(OrderInfo::getId,orderId);  </span><br><span class="line">            <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(wrapper);  </span><br><span class="line">            <span class="comment">//设置  </span></span><br><span class="line">            orderInfo.setStatus(OrderStatus.ACCEPTED.getStatus());  </span><br><span class="line">            orderInfo.setDriverId(driverId);  </span><br><span class="line">            orderInfo.setAcceptTime(<span class="keyword">new</span> <span class="title class_">Date</span>());  </span><br><span class="line">            <span class="comment">//调用方法修改  </span></span><br><span class="line">            <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> orderInfoMapper.updateById(orderInfo);  </span><br><span class="line">            <span class="keyword">if</span>(rows != <span class="number">1</span>) &#123;  </span><br><span class="line">                <span class="comment">//抢单失败  </span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//删除抢单标识  </span></span><br><span class="line">            redisTemplate.delete(RedisConstant.ORDER_ACCEPT_MARK);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        <span class="comment">//抢单失败  </span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);  </span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;  </span><br><span class="line">        <span class="comment">//释放  </span></span><br><span class="line">        <span class="keyword">if</span>(lock.isLocked()) &#123;  </span><br><span class="line">            lock.unlock();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="订单执行（一）"><a href="#订单执行（一）" class="headerlink" title="订单执行（一）"></a>订单执行（一）</h1><h2 id="加载当前订单"><a href="#加载当前订单" class="headerlink" title="加载当前订单"></a>加载当前订单</h2><h3 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h3><ul>
<li>无论是司机端，还是乘客端，遇到页面切换，重新登录小程序等，只要回到首页面，查看当前是否有正在执行的订单，如果有跳转到当前订单的执行页面</li>
</ul>
<h3 id="乘客端查找当前订单"><a href="#乘客端查找当前订单" class="headerlink" title="乘客端查找当前订单"></a>乘客端查找当前订单</h3><h4 id="订单微服务接口"><a href="#订单微服务接口" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h4><ul>
<li>OrderInfoController<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;乘客端查找当前订单&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/searchCustomerCurrentOrder/&#123;customerId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchCustomerCurrentOrder</span><span class="params">(<span class="meta">@PathVariable</span> Long customerId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.searchCustomerCurrentOrder(customerId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>OrderInfoServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">//乘客端查找当前订单  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> CurrentOrderInfoVo <span class="title function_">searchCustomerCurrentOrder</span><span class="params">(Long customerId)</span> &#123;  </span><br><span class="line">    <span class="comment">//封装条件  </span></span><br><span class="line">    <span class="comment">//乘客id  </span></span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(OrderInfo::getCustomerId,customerId);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//各种状态  </span></span><br><span class="line">    Integer[] statusArray = &#123;  </span><br><span class="line">            OrderStatus.ACCEPTED.getStatus(),  </span><br><span class="line">            OrderStatus.DRIVER_ARRIVED.getStatus(),  </span><br><span class="line">            OrderStatus.UPDATE_CART_INFO.getStatus(),  </span><br><span class="line">            OrderStatus.START_SERVICE.getStatus(),  </span><br><span class="line">            OrderStatus.END_SERVICE.getStatus(),  </span><br><span class="line">            OrderStatus.UNPAID.getStatus()  </span><br><span class="line">    &#125;;  </span><br><span class="line">    wrapper.in(OrderInfo::getStatus,statusArray);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//获取最新一条记录  </span></span><br><span class="line">    wrapper.orderByDesc(OrderInfo::getId);  </span><br><span class="line">    wrapper.last(<span class="string">&quot; limit 1&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//调用方法  </span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(wrapper);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//封装到CurrentOrderInfoVo  </span></span><br><span class="line">    <span class="type">CurrentOrderInfoVo</span> <span class="variable">currentOrderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentOrderInfoVo</span>();  </span><br><span class="line">    <span class="keyword">if</span>(orderInfo != <span class="literal">null</span>) &#123;  </span><br><span class="line">        currentOrderInfoVo.setOrderId(orderInfo.getId());  </span><br><span class="line">        currentOrderInfoVo.setStatus(orderInfo.getStatus());  </span><br><span class="line">        currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">true</span>);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">false</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> currentOrderInfoVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="远程调用-4"><a href="#远程调用-4" class="headerlink" title="远程调用"></a>远程调用</h4><p>serivce-order-client<br>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 乘客端查找当前订单  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/searchCustomerCurrentOrder/&#123;customerId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchCustomerCurrentOrder</span><span class="params">(<span class="meta">@PathVariable(&quot;customerId&quot;)</span> Long customerId)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="乘客web端接口"><a href="#乘客web端接口" class="headerlink" title="乘客web端接口"></a>乘客web端接口</h4><p>web-customer<br>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;乘客端查找当前订单&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/searchCustomerCurrentOrder&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchCustomerCurrentOrder</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.searchCustomerCurrentOrder(customerId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 乘客端查找当前订单  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> CurrentOrderInfoVo <span class="title function_">searchCustomerCurrentOrder</span><span class="params">(Long customerId)</span> &#123;  </span><br><span class="line">    Result&lt;CurrentOrderInfoVo&gt; currentOrderInfoVoResult = orderInfoFeignClient.searchCustomerCurrentOrder(customerId);  </span><br><span class="line">    <span class="keyword">return</span> currentOrderInfoVoResult.getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="司机端查找当前订单"><a href="#司机端查找当前订单" class="headerlink" title="司机端查找当前订单"></a>司机端查找当前订单</h3><h4 id="订单微服务接口-1"><a href="#订单微服务接口-1" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h4><p>service-order<br>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机端查找当前订单&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/searchDriverCurrentOrder/&#123;driverId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchDriverCurrentOrder</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.searchDriverCurrentOrder(driverId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 司机端查找当前订单</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CurrentOrderInfoVo <span class="title function_">searchDriverCurrentOrder</span><span class="params">(Long driverId)</span> &#123;</span><br><span class="line">	<span class="comment">//封装条件</span></span><br><span class="line">	LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">	wrapper.eq(OrderInfo::getDriverId,driverId);</span><br><span class="line">	Integer[] statusArray = &#123;</span><br><span class="line">			OrderStatus.ACCEPTED.getStatus(),</span><br><span class="line">			OrderStatus.DRIVER_ARRIVED.getStatus(),</span><br><span class="line">			OrderStatus.UPDATE_CART_INFO.getStatus(),</span><br><span class="line">			OrderStatus.START_SERVICE.getStatus(),</span><br><span class="line">			OrderStatus.END_SERVICE.getStatus()</span><br><span class="line">	&#125;;</span><br><span class="line">	wrapper.in(OrderInfo::getStatus,statusArray);</span><br><span class="line">	wrapper.orderByDesc(OrderInfo::getId);</span><br><span class="line">	wrapper.last(<span class="string">&quot; limit 1&quot;</span>);</span><br><span class="line">	<span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(wrapper);</span><br><span class="line">	<span class="comment">//封装到vo</span></span><br><span class="line">	<span class="type">CurrentOrderInfoVo</span> <span class="variable">currentOrderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentOrderInfoVo</span>();</span><br><span class="line">	<span class="keyword">if</span>(<span class="literal">null</span> != orderInfo) &#123;</span><br><span class="line">		currentOrderInfoVo.setStatus(orderInfo.getStatus());</span><br><span class="line">		currentOrderInfoVo.setOrderId(orderInfo.getId());</span><br><span class="line">		currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">true</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> currentOrderInfoVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="远程调用-5"><a href="#远程调用-5" class="headerlink" title="远程调用"></a>远程调用</h4><p>service-order-client<br>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 司机端查找当前订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/searchDriverCurrentOrder/&#123;driverId&#125;&quot;)</span></span><br><span class="line">Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchDriverCurrentOrder</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="司机端web接口"><a href="#司机端web接口" class="headerlink" title="司机端web接口"></a>司机端web接口</h4><p>web-driver<br>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机端查找当前订单&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/searchDriverCurrentOrder&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchDriverCurrentOrder</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.searchDriverCurrentOrder(driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 司机端查找当前订单  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> CurrentOrderInfoVo <span class="title function_">searchDriverCurrentOrder</span><span class="params">(Long driverId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.searchDriverCurrentOrder(driverId).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取订单信息"><a href="#获取订单信息" class="headerlink" title="获取订单信息"></a>获取订单信息</h3><h4 id="订单微服务接口-2"><a href="#订单微服务接口-2" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h4><p>service-order<br>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;根据订单id获取订单信息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderInfo/&#123;orderId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderInfo&gt; <span class="title function_">getOrderInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.getById(orderId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="远程调用-6"><a href="#远程调用-6" class="headerlink" title="远程调用"></a>远程调用</h4><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取订单信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/getOrderInfo/&#123;orderId&#125;&quot;)</span></span><br><span class="line">Result&lt;OrderInfo&gt; <span class="title function_">getOrderInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="乘客端web接口"><a href="#乘客端web接口" class="headerlink" title="乘客端web接口"></a>乘客端web接口</h4><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取订单信息&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderInfo/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderInfoVo&gt; <span class="title function_">getOrderInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getOrderInfo(orderId, customerId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取订单信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">getOrderInfo</span><span class="params">(Long orderId, Long customerId)</span> &#123;  </span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();  </span><br><span class="line">    <span class="comment">//判断  </span></span><br><span class="line">    <span class="keyword">if</span>(orderInfo.getCustomerId() != customerId) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderInfoVo</span> <span class="variable">orderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoVo</span>();  </span><br><span class="line">    orderInfoVo.setOrderId(orderId);  </span><br><span class="line">    BeanUtils.copyProperties(orderInfo,orderInfoVo);  </span><br><span class="line">    <span class="keyword">return</span> orderInfoVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="司机端web接口-1"><a href="#司机端web接口-1" class="headerlink" title="司机端web接口"></a>司机端web接口</h4><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取订单账单详细信息&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderInfo/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderInfoVo&gt; <span class="title function_">getOrderInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getOrderInfo(orderId, driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">getOrderInfo</span><span class="params">(Long orderId, Long driverId)</span> &#123;</span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();</span><br><span class="line">    <span class="keyword">if</span>(orderInfo.getDriverId() != driverId) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">OrderInfoVo</span> <span class="variable">orderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoVo</span>();</span><br><span class="line">    orderInfoVo.setOrderId(orderId);</span><br><span class="line">    BeanUtils.copyProperties(orderInfo,orderInfoVo);</span><br><span class="line">    <span class="keyword">return</span> orderInfoVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="司乘同显"><a href="#司乘同显" class="headerlink" title="司乘同显"></a>司乘同显</h2><h3 id="司机端同显"><a href="#司机端同显" class="headerlink" title="司机端同显"></a>司机端同显</h3><ul>
<li>司机所在地址就是司乘同显开始位置，订单地址就是司乘同显的终点</li>
<li>计算司机司乘同显最佳路线</li>
</ul>
<h4 id="司机端web"><a href="#司机端web" class="headerlink" title="司机端web"></a>司机端web</h4><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;计算最佳驾驶线路&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/calculateDrivingLine&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;DrivingLineVo&gt; <span class="title function_">calculateDrivingLine</span><span class="params">(<span class="meta">@RequestBody</span> CalculateDrivingLineForm calculateDrivingLineForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.calculateDrivingLine(calculateDrivingLineForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> MapFeignClient mapFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算最佳驾驶线路  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> DrivingLineVo <span class="title function_">calculateDrivingLine</span><span class="params">(CalculateDrivingLineForm calculateDrivingLineForm)</span> &#123;  </span><br><span class="line">    Result&lt;DrivingLineVo&gt; drivingLineVoResult = mapFeignClient.calculateDrivingLine(calculateDrivingLineForm);  </span><br><span class="line">    <span class="keyword">return</span> drivingLineVoResult.getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="更新位置到redis"><a href="#更新位置到redis" class="headerlink" title="更新位置到redis"></a>更新位置到redis</h3><ul>
<li>实时更新司机位置到redis</li>
</ul>
<h4 id="地图微服务接口service-map"><a href="#地图微服务接口service-map" class="headerlink" title="地图微服务接口service-map"></a>地图微服务接口service-map</h4><p>LocationController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机赶往代驾起始点：更新订单地址到缓存&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/updateOrderLocationToCache&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateOrderLocationToCache</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderLocationForm updateOrderLocationForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.updateOrderLocationToCache(updateOrderLocationForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 司机赶往代驾起始点：更新订单地址到缓存  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateOrderLocationToCache</span><span class="params">(UpdateOrderLocationForm updateOrderLocationForm)</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderLocationVo</span> <span class="variable">orderLocationVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderLocationVo</span>();  </span><br><span class="line">    orderLocationVo.setLongitude(updateOrderLocationForm.getLongitude());  </span><br><span class="line">    orderLocationVo.setLatitude(updateOrderLocationForm.getLatitude());  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.UPDATE_ORDER_LOCATION + updateOrderLocationForm.getOrderId();  </span><br><span class="line">    redisTemplate.opsForValue().set(key, orderLocationVo);  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="远程调用service-map-client"><a href="#远程调用service-map-client" class="headerlink" title="远程调用service-map-client"></a>远程调用service-map-client</h4><p>LocationFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 司机赶往代驾起始点：更新订单地址到缓存  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> updateOrderLocationForm  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/map/location/updateOrderLocationToCache&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateOrderLocationToCache</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderLocationForm updateOrderLocationForm)</span>;</span><br></pre></td></tr></table></figure>


<h4 id="司机web端-1"><a href="#司机web端-1" class="headerlink" title="司机web端"></a>司机web端</h4><p>LocationController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机赶往代驾起始点：更新订单位置到Redis缓存&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/updateOrderLocationToCache&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateOrderLocationToCache</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderLocationForm updateOrderLocationForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.updateOrderLocationToCache(updateOrderLocationForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 司机赶往代驾起始点：更新订单位置到Redis缓存  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateOrderLocationToCache</span><span class="params">(UpdateOrderLocationForm updateOrderLocationForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> locationFeignClient.updateOrderLocationToCache(updateOrderLocationForm).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取司机基本信息"><a href="#获取司机基本信息" class="headerlink" title="获取司机基本信息"></a>获取司机基本信息</h3><ul>
<li>乘客端进入司乘同显界面可以看到司机的基本信息.</li>
</ul>
<h4 id="司机微服务接口service-driver"><a href="#司机微服务接口service-driver" class="headerlink" title="司机微服务接口service-driver"></a>司机微服务接口service-driver</h4><p>DriverInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取司机基本信息&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getDriverInfo/&#123;driverId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverInfoVo&gt; <span class="title function_">getDriverInfoOrder</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverInfoService.getDriverInfoOrder(driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//获取司机基本信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> DriverInfoVo <span class="title function_">getDriverInfoOrder</span><span class="params">(Long driverId)</span> &#123;  </span><br><span class="line">    <span class="comment">//司机id获取基本信息  </span></span><br><span class="line">    <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> driverInfoMapper.selectById(driverId);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//封装DriverInfoVo  </span></span><br><span class="line">    <span class="type">DriverInfoVo</span> <span class="variable">driverInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverInfoVo</span>();  </span><br><span class="line">    BeanUtils.copyProperties(driverInfo,driverInfoVo);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//计算驾龄  </span></span><br><span class="line">    <span class="comment">//获取当前年  </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">currentYear</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>().getYear();  </span><br><span class="line">    <span class="comment">//获取驾驶证初次领证日期  </span></span><br><span class="line">    <span class="comment">//driver_license_issue_date  </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">firstYear</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(driverInfo.getDriverLicenseIssueDate()).getYear();  </span><br><span class="line">    <span class="type">int</span> <span class="variable">driverLicenseAge</span> <span class="operator">=</span> currentYear - firstYear;  </span><br><span class="line">    driverInfoVo.setDriverLicenseAge(driverLicenseAge);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> driverInfoVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="远程调用-7"><a href="#远程调用-7" class="headerlink" title="远程调用"></a>远程调用</h4><p>DriverInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取司机基本信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/driver/info/getDriverInfo/&#123;driverId&#125;&quot;)</span></span><br><span class="line">Result&lt;DriverInfoVo&gt; <span class="title function_">getDriverInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="乘客端web接口-1"><a href="#乘客端web接口-1" class="headerlink" title="乘客端web接口"></a>乘客端web接口</h4><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;根据订单id获取司机基本信息&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getDriverInfo/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverInfoVo&gt; <span class="title function_">getDriverInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getDriverInfo(orderId, customerId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 根据订单id获取司机基本信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> DriverInfoVo <span class="title function_">getDriverInfo</span><span class="params">(Long orderId, Long customerId)</span> &#123;  </span><br><span class="line">    <span class="comment">//根据订单id获取订单信息  </span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();  </span><br><span class="line">    <span class="keyword">if</span>(orderInfo.getCustomerId() != customerId) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> driverInfoFeignClient.getDriverInfo(orderInfo.getDriverId()).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="乘客端获取司机经纬度位置"><a href="#乘客端获取司机经纬度位置" class="headerlink" title="乘客端获取司机经纬度位置"></a>乘客端获取司机经纬度位置</h3><ul>
<li>乘客查看司机位置</li>
</ul>
<h4 id="地图微服务接口service-map-1"><a href="#地图微服务接口service-map-1" class="headerlink" title="地图微服务接口service-map"></a>地图微服务接口service-map</h4><p>LocationController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机赶往代驾起始点：获取订单经纬度位置&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getCacheOrderLocation/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderLocationVo&gt; <span class="title function_">getCacheOrderLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123; </span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.getCacheOrderLocation(orderId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 司机赶往代驾起始点：获取订单经纬度位置  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> OrderLocationVo <span class="title function_">getCacheOrderLocation</span><span class="params">(Long orderId)</span> &#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.UPDATE_ORDER_LOCATION + orderId;  </span><br><span class="line">    <span class="type">OrderLocationVo</span> <span class="variable">orderLocationVo</span> <span class="operator">=</span> (OrderLocationVo)redisTemplate.opsForValue().get(key);  </span><br><span class="line">    <span class="keyword">return</span> orderLocationVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="远程调用-8"><a href="#远程调用-8" class="headerlink" title="远程调用"></a>远程调用</h4><p>LocationFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 司机赶往代驾起始点：获取订单经纬度位置  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/map/location/getCacheOrderLocation/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;OrderLocationVo&gt; <span class="title function_">getCacheOrderLocation</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="乘客端web接口-2"><a href="#乘客端web接口-2" class="headerlink" title="乘客端web接口"></a>乘客端web接口</h4><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机赶往代驾起始点：获取订单经纬度位置&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getCacheOrderLocation/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderLocationVo&gt; <span class="title function_">getCacheOrderLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getCacheOrderLocation(orderId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 司机赶往代驾起始点：获取订单经纬度位置  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> OrderLocationVo <span class="title function_">getCacheOrderLocation</span><span class="params">(Long orderId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> locationFeignClient.getCacheOrderLocation(orderId).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="乘客端同显"><a href="#乘客端同显" class="headerlink" title="乘客端同显"></a>乘客端同显</h3><h4 id="乘客端web接口-3"><a href="#乘客端web接口-3" class="headerlink" title="乘客端web接口"></a>乘客端web接口</h4><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;计算最佳驾驶线路&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/calculateDrivingLine&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;DrivingLineVo&gt; <span class="title function_">calculateDrivingLine</span><span class="params">(<span class="meta">@RequestBody</span> CalculateDrivingLineForm calculateDrivingLineForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.calculateDrivingLine(calculateDrivingLineForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 计算最佳驾驶线路  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> DrivingLineVo <span class="title function_">calculateDrivingLine</span><span class="params">(CalculateDrivingLineForm calculateDrivingLineForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> mapFeignClient.calculateDrivingLine(calculateDrivingLineForm).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="司机到达起始点"><a href="#司机到达起始点" class="headerlink" title="司机到达起始点"></a>司机到达起始点</h2><ul>
<li>司机到达起始点后更新订单数据</li>
<li>更新订单状态：司机已到达</li>
<li>更新订单到达时间</li>
</ul>
<h3 id="订单微服务接口service-order"><a href="#订单微服务接口service-order" class="headerlink" title="订单微服务接口service-order"></a>订单微服务接口service-order</h3><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机到达起始点&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/driverArriveStartLocation/&#123;orderId&#125;/&#123;driverId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">driverArriveStartLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId, <span class="meta">@PathVariable</span> Long driverId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.driverArriveStartLocation(orderId, driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//司机到达起始点  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">driverArriveStartLocation</span><span class="params">(Long orderId, Long driverId)</span> &#123;  </span><br><span class="line">    <span class="comment">// 更新订单状态和到达时间，条件：orderId + driverId  </span></span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(OrderInfo::getId,orderId);  </span><br><span class="line">    wrapper.eq(OrderInfo::getDriverId,driverId);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();  </span><br><span class="line">    orderInfo.setStatus(OrderStatus.DRIVER_ARRIVED.getStatus());  </span><br><span class="line">    orderInfo.setArriveTime(<span class="keyword">new</span> <span class="title class_">Date</span>());  </span><br><span class="line">  </span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> orderInfoMapper.update(orderInfo, wrapper);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span>(rows == <span class="number">1</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用service-order-client"><a href="#远程调用service-order-client" class="headerlink" title="远程调用service-order-client"></a>远程调用service-order-client</h3><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 司机到达起始点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/driverArriveStartLocation/&#123;orderId&#125;/&#123;driverId&#125;&quot;)</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">driverArriveStartLocation</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId, <span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="司机web调用"><a href="#司机web调用" class="headerlink" title="司机web调用"></a>司机web调用</h3><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机到达代驾起始地点&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/driverArriveStartLocation/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">driverArriveStartLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.driverArriveStartLocation(orderId, driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 司机到达代驾起始地点  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">driverArriveStartLocation</span><span class="params">(Long orderId, Long driverId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.driverArriveStartLocation(orderId, driverId).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="司机更新代驾车辆信息"><a href="#司机更新代驾车辆信息" class="headerlink" title="司机更新代驾车辆信息"></a>司机更新代驾车辆信息</h2><h3 id="订单微服务接口service-order-1"><a href="#订单微服务接口service-order-1" class="headerlink" title="订单微服务接口service-order"></a>订单微服务接口service-order</h3><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;更新代驾车辆信息&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/updateOrderCart&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateOrderCart</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderCartForm updateOrderCartForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.updateOrderCart(updateOrderCartForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新代驾车辆信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateOrderCart</span><span class="params">(UpdateOrderCartForm updateOrderCartForm)</span> &#123;  </span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(OrderInfo::getId,updateOrderCartForm.getOrderId());  </span><br><span class="line">    wrapper.eq(OrderInfo::getDriverId,updateOrderCartForm.getDriverId());  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();  </span><br><span class="line">    BeanUtils.copyProperties(updateOrderCartForm,orderInfo);  </span><br><span class="line">    orderInfo.setStatus(OrderStatus.UPDATE_CART_INFO.getStatus());  </span><br><span class="line">  </span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> orderInfoMapper.update(orderInfo, wrapper);  </span><br><span class="line">    <span class="keyword">if</span>(rows == <span class="number">1</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-9"><a href="#远程调用-9" class="headerlink" title="远程调用"></a>远程调用</h3><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 更新代驾车辆信息  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> updateOrderCartForm  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/order/info//updateOrderCart&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateOrderCart</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderCartForm updateOrderCartForm)</span>;</span><br></pre></td></tr></table></figure>


<h3 id="司机web端接口-1"><a href="#司机web端接口-1" class="headerlink" title="司机web端接口"></a>司机web端接口</h3><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;更新代驾车辆信息&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/updateOrderCart&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateOrderCart</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderCartForm updateOrderCartForm)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    updateOrderCartForm.setDriverId(driverId);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.updateOrderCart(updateOrderCartForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新代驾车辆信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateOrderCart</span><span class="params">(UpdateOrderCartForm updateOrderCartForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.updateOrderCart(updateOrderCartForm).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><ul>
<li><p>启动项目：</p>
<ul>
<li>XxlJobAdminApplication</li>
<li>ServerGatewayApplication :8600&#x2F;</li>
<li>ServiceCustomerApplication :8501&#x2F;</li>
<li>ServiceDispatchApplication :8509&#x2F;</li>
<li>ServiceDriverApplication :8502&#x2F;</li>
<li>ServiceMapApplication :8503&#x2F;</li>
<li>ServiceOrderApplication:8505&#x2F;</li>
<li>ServiceRulesApplication :8504&#x2F;</li>
<li>WebCustomerApplication :8601&#x2F;</li>
<li>WebDriverApplication :8602&#x2F;</li>
</ul>
</li>
<li><p>清除之前的数据</p>
</li>
<li><p>启动微信开发者工具</p>
</li>
</ul>
<p>修改前面的代码web-driver</p>
<p>FileController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> CosService cosService;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//文件上传接口  </span></span><br><span class="line"><span class="meta">@Operation(summary = &quot;上传&quot;)</span>  </span><br><span class="line"><span class="comment">//@LoginDetection  </span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file,  </span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam(name = &quot;path&quot;,defaultValue = &quot;auth&quot;)</span> String path)</span> &#123;  </span><br><span class="line">    <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> cosService.uploadFile(file,path);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">showUrl</span> <span class="operator">=</span> cosUploadVo.getShowUrl();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(showUrl);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="订单执行（二）"><a href="#订单执行（二）" class="headerlink" title="订单执行（二）"></a>订单执行（二）</h1><h2 id="开始服务"><a href="#开始服务" class="headerlink" title="开始服务"></a>开始服务</h2><ul>
<li>更新订单状态</li>
</ul>
<h3 id="订单微服务接口-3"><a href="#订单微服务接口-3" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h3><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;开始服务&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/startDrive&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">startDriver</span><span class="params">(<span class="meta">@RequestBody</span> StartDriveForm startDriveForm)</span> &#123;  </span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> orderInfoService.startDriver(startDriveForm);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(flag);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//开始代驾服务  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">startDriver</span><span class="params">(StartDriveForm startDriveForm)</span> &#123;  </span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(OrderInfo::getId,startDriveForm.getOrderId());  </span><br><span class="line">    wrapper.eq(OrderInfo::getDriverId,startDriveForm.getDriverId());  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();  </span><br><span class="line">    orderInfo.setStatus(OrderStatus.START_SERVICE.getStatus());  </span><br><span class="line">    orderInfo.setStartServiceTime(<span class="keyword">new</span> <span class="title class_">Date</span>());  </span><br><span class="line">  </span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> orderInfoMapper.update(orderInfo, wrapper);  </span><br><span class="line">    <span class="keyword">if</span>(rows == <span class="number">1</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="远程调用-10"><a href="#远程调用-10" class="headerlink" title="远程调用"></a>远程调用</h3><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 开始代驾服务  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startDriveForm  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/order/info/startDrive&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">startDrive</span><span class="params">(<span class="meta">@RequestBody</span> StartDriveForm startDriveForm)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="司机web端调用-1"><a href="#司机web端调用-1" class="headerlink" title="司机web端调用"></a>司机web端调用</h3><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;开始代驾服务&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/startDrive&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">startDrive</span><span class="params">(<span class="meta">@RequestBody</span> StartDriveForm startDriveForm)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    startDriveForm.setDriverId(driverId);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.startDrive(startDriveForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 开始代驾服务  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">startDrive</span><span class="params">(StartDriveForm startDriveForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.startDrive(startDriveForm).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="批量保存订单位置信息"><a href="#批量保存订单位置信息" class="headerlink" title="批量保存订单位置信息"></a>批量保存订单位置信息</h2><ul>
<li>开始服务后，司机端会实时收集司机位置</li>
<li>定时批量上传位置到后台服务保存到MongoDB</li>
</ul>
<h3 id="地图微服务接口"><a href="#地图微服务接口" class="headerlink" title="地图微服务接口"></a>地图微服务接口</h3><p>LocationController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;批量保存代驾服务订单位置&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/saveOrderServiceLocation&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">saveOrderServiceLocation</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.saveOrderServiceLocation(orderLocationServiceFormList));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderServiceLocationRepository</span> <span class="keyword">extends</span> <span class="title class_">MongoRepository</span>&lt;OrderServiceLocation, String&gt; &#123;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--mongodb--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> OrderServiceLocationRepository orderServiceLocationRepository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">saveOrderServiceLocation</span><span class="params">(List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span> &#123;  </span><br><span class="line">    List&lt;OrderServiceLocation&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();  </span><br><span class="line">    <span class="comment">// 遍历，变成OrderServiceLocation  </span></span><br><span class="line">    orderLocationServiceFormList.forEach(orderServiceLocationForm-&gt;&#123;  </span><br><span class="line">        <span class="comment">//orderServiceLocationForm -- OrderServiceLocation  </span></span><br><span class="line">        <span class="type">OrderServiceLocation</span> <span class="variable">orderServiceLocation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderServiceLocation</span>();  </span><br><span class="line">        BeanUtils.copyProperties(orderServiceLocationForm,orderServiceLocation);  </span><br><span class="line">        orderServiceLocation.setId(ObjectId.get().toString());  </span><br><span class="line">        orderServiceLocation.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());  </span><br><span class="line">  </span><br><span class="line">        list.add(orderServiceLocation);  </span><br><span class="line">    &#125;);  </span><br><span class="line">    <span class="comment">//批量添加到MongoDB  </span></span><br><span class="line">    orderServiceLocationRepository.saveAll(list);  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="远程调用-11"><a href="#远程调用-11" class="headerlink" title="远程调用"></a>远程调用</h3><p>LocationFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 开始代驾服务：保存代驾服务订单位置  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderLocationServiceFormList  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/map/location/saveOrderServiceLocation&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">saveOrderServiceLocation</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="司机web端调用-2"><a href="#司机web端调用-2" class="headerlink" title="司机web端调用"></a>司机web端调用</h3><p>LocationController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;开始代驾服务：保存代驾服务订单位置&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/saveOrderServiceLocation&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">saveOrderServiceLocation</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.saveOrderServiceLocation(orderLocationServiceFormList));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 始代驾服务：保存代驾服务订单位置  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">saveOrderServiceLocation</span><span class="params">(List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> locationFeignClient.saveOrderServiceLocation(orderLocationServiceFormList).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="获取订单最后一个位置"><a href="#获取订单最后一个位置" class="headerlink" title="获取订单最后一个位置"></a>获取订单最后一个位置</h2><ul>
<li>司机开始服务后，乘客端获取司机的最新动向</li>
</ul>
<h3 id="地图微服务接口-1"><a href="#地图微服务接口-1" class="headerlink" title="地图微服务接口"></a>地图微服务接口</h3><p>LocationController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;代驾服务：获取订单服务最后一个位置信息&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderServiceLastLocation/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderServiceLastLocationVo&gt; <span class="title function_">getOrderServiceLastLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.getOrderServiceLastLocation(orderId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代驾服务：获取订单服务最后一个位置信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> OrderServiceLastLocationVo <span class="title function_">getOrderServiceLastLocation</span><span class="params">(Long orderId)</span> &#123;  </span><br><span class="line">    <span class="comment">//查询MongoDB,查询条件 ：orderId  </span></span><br><span class="line">    <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>();  </span><br><span class="line">    query.addCriteria(Criteria.where(<span class="string">&quot;orderId&quot;</span>).is(orderId));  </span><br><span class="line">    <span class="comment">//根据创建时间降序排列  </span></span><br><span class="line">    query.with(Sort.by(Sort.Order.desc(<span class="string">&quot;createTime&quot;</span>)));  </span><br><span class="line">    <span class="comment">//只取一条数据  </span></span><br><span class="line">    query.limit(<span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderServiceLocation</span> <span class="variable">orderServiceLocation</span> <span class="operator">=</span>  </span><br><span class="line">            mongoTemplate.findOne(query, OrderServiceLocation.class);  </span><br><span class="line">    <span class="type">OrderServiceLastLocationVo</span> <span class="variable">orderServiceLastLocationVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderServiceLastLocationVo</span>();  </span><br><span class="line">    BeanUtils.copyProperties(orderServiceLocation,orderServiceLastLocationVo);  </span><br><span class="line">    <span class="keyword">return</span> orderServiceLastLocationVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-12"><a href="#远程调用-12" class="headerlink" title="远程调用"></a>远程调用</h3><p>LocationFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 代驾服务：获取订单服务最后一个位置信息  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/map/location/getOrderServiceLastLocation/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;OrderServiceLastLocationVo&gt; <span class="title function_">getOrderServiceLastLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="乘客web端调用"><a href="#乘客web端调用" class="headerlink" title="乘客web端调用"></a>乘客web端调用</h3><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;代驾服务：获取订单服务最后一个位置信息&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderServiceLastLocation/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderServiceLastLocationVo&gt; <span class="title function_">getOrderServiceLastLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getOrderServiceLastLocation(orderId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 代驾服务：获取订单服务最后一个位置信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> OrderServiceLastLocationVo <span class="title function_">getOrderServiceLastLocation</span><span class="params">(Long orderId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> locationFeignClient.getOrderServiceLastLocation(orderId).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Minio上传接口"><a href="#Minio上传接口" class="headerlink" title="Minio上传接口"></a>Minio上传接口</h2><ul>
<li>司机服务过程中，司机端小程序实时采集录音，把录音和对话文本上传到后台服务，把完整监控保存到Minio</li>
</ul>
<h3 id="Minio安装"><a href="#Minio安装" class="headerlink" title="Minio安装"></a>Minio安装</h3><p><strong>使用docker安装</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// 创建数据存储目录</span><br><span class="line">mkdir -p ~/minio/data</span><br><span class="line"></span><br><span class="line">// 创建minio</span><br><span class="line">docker run \</span><br><span class="line">   -p 9000:9000 \</span><br><span class="line">   -p 9090:9090 \</span><br><span class="line">   --name minio \</span><br><span class="line">   -v ~/minio/data:/data \</span><br><span class="line">   -e &quot;MINIO_ROOT_USER=admin&quot; \</span><br><span class="line">   -e &quot;MINIO_ROOT_PASSWORD=admin123456&quot; \</span><br><span class="line">   -d \</span><br><span class="line">   quay.io/minio/minio server /data --console-address &quot;:9090&quot;</span><br></pre></td></tr></table></figure>

<p><strong>2 安装到windows里面</strong></p>
<ul>
<li><p>找到minio安装文件，放到没有中文没有空格目录</p>
</li>
<li><p>创建空文件夹，作为数据存储目录</p>
</li>
<li><p>在windows使用命令启动Minio服务</p>
</li>
</ul>
<p>– minio.exe server D:\Desktop\hhsqdmz\sort\minio\data</p>
<h3 id="Minio启动"><a href="#Minio启动" class="headerlink" title="Minio启动"></a>Minio启动</h3><ul>
<li><p>访问Minio控制台：ip:9000</p>
</li>
<li><p>默认控制台用户名和密码都是：minioadmin</p>
</li>
<li><p>在minio控制台里创建buckets</p>
</li>
<li><p>创建buckets后<strong>记得把Access Policy设为public</strong></p>
</li>
</ul>
<h3 id="司机端web接口-2"><a href="#司机端web接口-2" class="headerlink" title="司机端web接口"></a>司机端web接口</h3><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改配置文件common-account.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">minio:</span></span><br><span class="line">  <span class="attr">endpointUrl:</span> <span class="string">http://localhost:9000</span></span><br><span class="line">  <span class="attr">accessKey:</span> <span class="string">minioadmin</span></span><br><span class="line">  <span class="attr">secreKey:</span> <span class="string">minioadmin</span></span><br><span class="line">  <span class="attr">bucketName:</span> <span class="string">daijia</span></span><br></pre></td></tr></table></figure>

<p>创建配置类，读取minio的值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix=&quot;minio&quot;)</span> <span class="comment">//读取节点  </span></span><br><span class="line"><span class="meta">@Data</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioProperties</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String endpointUrl;  </span><br><span class="line">    <span class="keyword">private</span> String accessKey;  </span><br><span class="line">    <span class="keyword">private</span> String secreKey;  </span><br><span class="line">    <span class="keyword">private</span> String bucketName;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FileController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> FileService fileService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = &quot;上传&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file)</span> &#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> fileService.upload(file);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(url);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> MinioProperties minioProperties;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 上传  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(MultipartFile file)</span> &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="comment">// 创建一个Minio的客户端对象  </span></span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span> MinioClient.builder()  </span><br><span class="line">                .endpoint(minioProperties.getEndpointUrl())  </span><br><span class="line">                .credentials(minioProperties.getAccessKey(), minioProperties.getSecreKey())  </span><br><span class="line">                .build();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 判断桶是否存在  </span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span> minioClient.bucketExists(BucketExistsArgs.builder().bucket(minioProperties.getBucketName()).build());  </span><br><span class="line">        <span class="keyword">if</span> (!found) &#123;       <span class="comment">// 如果不存在，那么此时就创建一个新的桶  </span></span><br><span class="line">            minioClient.makeBucket(MakeBucketArgs.builder().bucket(minioProperties.getBucketName()).build());  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  <span class="comment">// 如果存在打印信息  </span></span><br><span class="line">            System.out.println(<span class="string">&quot;Bucket &#x27;daijia&#x27; already exists.&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 设置存储对象名称  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">extFileName</span> <span class="operator">=</span> file.getOriginalFilename().substring(file.getOriginalFilename().lastIndexOf(<span class="string">&quot;.&quot;</span>));  </span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyyMMdd&quot;</span>)  </span><br><span class="line">                .format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot;/&quot;</span> + UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span> , <span class="string">&quot;&quot;</span>) + <span class="string">&quot;.&quot;</span> + extFileName;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">PutObjectArgs</span> <span class="variable">putObjectArgs</span> <span class="operator">=</span> PutObjectArgs.builder()  </span><br><span class="line">                .bucket(minioProperties.getBucketName())  </span><br><span class="line">                .stream(file.getInputStream(), file.getSize(), -<span class="number">1</span>)  </span><br><span class="line">                .object(fileName)  </span><br><span class="line">                .build();  </span><br><span class="line">        minioClient.putObject(putObjectArgs) ;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> minioProperties.getEndpointUrl() + <span class="string">&quot;/&quot;</span> + minioProperties.getBucketName() + <span class="string">&quot;/&quot;</span> + fileName ;  </span><br><span class="line">  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="保存订单监控记录数据"><a href="#保存订单监控记录数据" class="headerlink" title="保存订单监控记录数据"></a>保存订单监控记录数据</h2><ul>
<li>订单执行过程中，记录对话信息</li>
<li>在前端小程序，同声传译，把录音转换文本，保存文本内存</li>
</ul>
<h3 id="订单微服务接口-4"><a href="#订单微服务接口-4" class="headerlink" title="订单微服务接口."></a>订单微服务接口.</h3><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加MongoRepository</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderMonitorRecordRepository</span> <span class="keyword">extends</span> <span class="title class_">MongoRepository</span>&lt;OrderMonitorRecord, String&gt; &#123;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OrderMonitorController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> OrderMonitorService orderMonitorService;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Operation(summary = &quot;保存订单监控记录数据&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/saveOrderMonitorRecord&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">saveMonitorRecord</span><span class="params">(<span class="meta">@RequestBody</span> OrderMonitorRecord orderMonitorRecord)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderMonitorService.saveOrderMonitorRecord(orderMonitorRecord));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> OrderMonitorRecordRepository orderMonitorRecordRepository;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 保存订单监控记录数据  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">saveOrderMonitorRecord</span><span class="params">(OrderMonitorRecord orderMonitorRecord)</span> &#123;  </span><br><span class="line">    orderMonitorRecordRepository.save(orderMonitorRecord);  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-13"><a href="#远程调用-13" class="headerlink" title="远程调用"></a>远程调用</h3><p>OrderMonitorFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 保存订单监控记录数据  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderMonitorRecord  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/order/monitor/saveOrderMonitorRecord&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">saveMonitorRecord</span><span class="params">(<span class="meta">@RequestBody</span> OrderMonitorRecord orderMonitorRecord)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="司机端web调用"><a href="#司机端web调用" class="headerlink" title="司机端web调用"></a>司机端web调用</h3><p>MonitorController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> MonitorService monitorService;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Operation(summary = &quot;上传录音&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,  </span></span><br><span class="line"><span class="params">                              OrderMonitorForm orderMonitorForm)</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(monitorService.upload(file, orderMonitorForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> FileService fileService;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> OrderMonitorFeignClient orderMonitorFeignClient;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 上传录音  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">upload</span><span class="params">(MultipartFile file, OrderMonitorForm orderMonitorForm)</span> &#123;  </span><br><span class="line">    <span class="comment">//上传文件  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> fileService.upload(file);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderMonitorRecord</span> <span class="variable">orderMonitorRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMonitorRecord</span>();  </span><br><span class="line">    orderMonitorRecord.setOrderId(orderMonitorForm.getOrderId());  </span><br><span class="line">    orderMonitorRecord.setFileUrl(url);  </span><br><span class="line">    orderMonitorRecord.setContent(orderMonitorForm.getContent());  </span><br><span class="line">    orderMonitorFeignClient.saveMonitorRecord(orderMonitorRecord);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="订单监控审核"><a href="#订单监控审核" class="headerlink" title="订单监控审核"></a>订单监控审核</h2><p>使用腾讯云数据万象实现自动审核</p>
<ul>
<li>官方网址：<a href="https://cloud.tencent.com/product/ci">https://cloud.tencent.com/product/ci</a></li>
</ul>
<h3 id="腾讯云COS图片审核"><a href="#腾讯云COS图片审核" class="headerlink" title="腾讯云COS图片审核"></a>腾讯云COS图片审核</h3><h4 id="封装图片审核方法"><a href="#封装图片审核方法" class="headerlink" title="封装图片审核方法"></a>封装图片审核方法</h4><p>在service-driver的CiService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Boolean <span class="title function_">imageAuditing</span><span class="params">(String path)</span>;</span><br></pre></td></tr></table></figure>

<p>CiServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CiServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CiService</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> TencentCloudProperties tencentCloudProperties;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//图片审核  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">imageAuditing</span><span class="params">(String path)</span> &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//1.创建任务请求对象  </span></span><br><span class="line">        <span class="type">ImageAuditingRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImageAuditingRequest</span>();  </span><br><span class="line">        <span class="comment">//2.添加请求参数 参数详情请见 API 接口文档  </span></span><br><span class="line">        <span class="comment">//2.1设置请求 bucket        request.setBucketName(tencentCloudProperties.getBucketPrivate());  </span></span><br><span class="line">        <span class="comment">//2.2设置审核策略 不传则为默认策略（预设）  </span></span><br><span class="line">        <span class="comment">//request.setBizType(&quot;&quot;);  </span></span><br><span class="line">        <span class="comment">//2.3设置 bucket 中的图片位置  </span></span><br><span class="line">        request.setObjectKey(path);  </span><br><span class="line">        <span class="comment">//3.调用接口,获取任务响应对象  </span></span><br><span class="line">        <span class="type">COSClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="built_in">this</span>.getCosClient();  </span><br><span class="line">        <span class="type">ImageAuditingResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.imageAuditing(request);  </span><br><span class="line">        client.shutdown();  </span><br><span class="line">        <span class="comment">//用于返回该审核场景的审核结果，返回值：0：正常。1：确认为当前场景的违规内容。2：疑似为当前场景的违规内容。  </span></span><br><span class="line">        <span class="keyword">if</span> (!response.getPornInfo().getHitFlag().equals(<span class="string">&quot;0&quot;</span>)  </span><br><span class="line">                || !response.getAdsInfo().getHitFlag().equals(<span class="string">&quot;0&quot;</span>)  </span><br><span class="line">                || !response.getTerroristInfo().getHitFlag().equals(<span class="string">&quot;0&quot;</span>)  </span><br><span class="line">                || !response.getPoliticsInfo().getHitFlag().equals(<span class="string">&quot;0&quot;</span>)  </span><br><span class="line">        ) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> COSClient <span class="title function_">getCosClient</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">secretId</span> <span class="operator">=</span> tencentCloudProperties.getSecretId();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> tencentCloudProperties.getSecretKey();  </span><br><span class="line">        <span class="type">COSCredentials</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicCOSCredentials</span>(secretId, secretKey);  </span><br><span class="line">        <span class="comment">// 2 设置 bucket 的地域, COS 地域  </span></span><br><span class="line">        <span class="type">Region</span> <span class="variable">region</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Region</span>(tencentCloudProperties.getRegion());  </span><br><span class="line">        <span class="type">ClientConfig</span> <span class="variable">clientConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientConfig</span>(region);  </span><br><span class="line">        <span class="comment">// 这里建议设置使用 https 协议  </span></span><br><span class="line">        clientConfig.setHttpProtocol(HttpProtocol.https);  </span><br><span class="line">        <span class="comment">// 3 生成 cos 客户端。  </span></span><br><span class="line">        <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">COSClient</span>(cred, clientConfig);  </span><br><span class="line">        <span class="keyword">return</span> cosClient;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="腾讯云COS图片添加审核"><a href="#腾讯云COS图片添加审核" class="headerlink" title="腾讯云COS图片添加审核"></a>腾讯云COS图片添加审核</h4><p>CosServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> CiService ciService;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> CosUploadVo <span class="title function_">upload</span><span class="params">(MultipartFile file, String path)</span> &#123;  </span><br><span class="line">    <span class="comment">//获取cosClient对象  </span></span><br><span class="line">    <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="built_in">this</span>.getCosClient();  </span><br><span class="line">    <span class="comment">//文件上传  </span></span><br><span class="line">    <span class="comment">//元数据信息  </span></span><br><span class="line">    <span class="type">ObjectMetadata</span> <span class="variable">meta</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMetadata</span>();  </span><br><span class="line">    meta.setContentLength(file.getSize());  </span><br><span class="line">    meta.setContentEncoding(<span class="string">&quot;UTF-8&quot;</span>);  </span><br><span class="line">    meta.setContentType(file.getContentType());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//向存储桶中保存文件  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileType</span> <span class="operator">=</span> file.getOriginalFilename().substring(file.getOriginalFilename().lastIndexOf(<span class="string">&quot;.&quot;</span>)); <span class="comment">//文件后缀名  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uploadPath</span> <span class="operator">=</span> <span class="string">&quot;/driver/&quot;</span> + path + <span class="string">&quot;/&quot;</span> + UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>) + fileType;  </span><br><span class="line">    <span class="comment">// 01.jpg  </span></span><br><span class="line">    <span class="comment">// /driver/auth/0o98754.jpg    PutObjectRequest putObjectRequest = null;  </span></span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="comment">//1 bucket名称  </span></span><br><span class="line">        <span class="comment">//2  </span></span><br><span class="line">        putObjectRequest = <span class="keyword">new</span> <span class="title class_">PutObjectRequest</span>(tencentCloudProperties.getBucketPrivate(),  </span><br><span class="line">                uploadPath,  </span><br><span class="line">                file.getInputStream(),  </span><br><span class="line">                meta);  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">    &#125;  </span><br><span class="line">    putObjectRequest.setStorageClass(StorageClass.Standard);  </span><br><span class="line">    <span class="type">PutObjectResult</span> <span class="variable">putObjectResult</span> <span class="operator">=</span> cosClient.putObject(putObjectRequest); <span class="comment">//上传文件  </span></span><br><span class="line">    cosClient.shutdown();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 图片审核  </span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">imageAuditing</span> <span class="operator">=</span> ciService.imageAuditing(uploadPath);  </span><br><span class="line">    <span class="keyword">if</span>(!imageAuditing)&#123;  </span><br><span class="line">        cosClient.deleteObject(tencentCloudProperties.getBucketPrivate(), uploadPath);  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.IMAGE_AUDITION_FAIL);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//返回vo对象  </span></span><br><span class="line">    <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CosUploadVo</span>();  </span><br><span class="line">    cosUploadVo.setUrl(uploadPath);  </span><br><span class="line">    <span class="comment">//图片临时访问url，回显使用  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">imageUrl</span> <span class="operator">=</span> <span class="built_in">this</span>.getImageUrl(uploadPath);  </span><br><span class="line">    cosUploadVo.setShowUrl(imageUrl);  </span><br><span class="line">    <span class="keyword">return</span> cosUploadVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="封装文本审核接口"><a href="#封装文本审核接口" class="headerlink" title="封装文本审核接口"></a>封装文本审核接口</h3><h4 id="司机微服务接口"><a href="#司机微服务接口" class="headerlink" title="司机微服务接口"></a>司机微服务接口</h4><p>CiController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> CiService ciService;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Operation(summary = &quot;文本审核&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/textAuditing&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;TextAuditingVo&gt; <span class="title function_">textAuditing</span><span class="params">(<span class="meta">@RequestBody</span> String content)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(ciService.textAuditing(content));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 文本审核  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> TextAuditingVo <span class="title function_">textAuditing</span><span class="params">(String content)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.hasText(content)) &#123;  </span><br><span class="line">        <span class="type">TextAuditingVo</span> <span class="variable">textAuditingVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextAuditingVo</span>();  </span><br><span class="line">        textAuditingVo.setResult(<span class="string">&quot;0&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> textAuditingVo;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="built_in">this</span>.getCosClient();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//1.创建任务请求对象  </span></span><br><span class="line">    <span class="type">TextAuditingRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextAuditingRequest</span>();  </span><br><span class="line">    <span class="comment">//2.添加请求参数 参数详情请见 API 接口文档  </span></span><br><span class="line">    request.setBucketName(tencentCloudProperties.getBucketPrivate());  </span><br><span class="line">    <span class="comment">//2.1.1设置请求内容,文本内容的Base64编码  </span></span><br><span class="line">    <span class="type">byte</span>[] encoder = org.apache.commons.codec.binary.Base64.encodeBase64(content.getBytes());  </span><br><span class="line">    <span class="type">String</span> <span class="variable">contentBase64</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encoder);  </span><br><span class="line">    request.getInput().setContent(contentBase64);  </span><br><span class="line">    request.getConf().setDetectType(<span class="string">&quot;all&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//3.调用接口,获取任务响应对象  </span></span><br><span class="line">    <span class="type">TextAuditingResponse</span> <span class="variable">response</span> <span class="operator">=</span> cosClient.createAuditingTextJobs(request);  </span><br><span class="line">    <span class="type">AuditingJobsDetail</span> <span class="variable">detail</span> <span class="operator">=</span> response.getJobsDetail();  </span><br><span class="line">    <span class="type">TextAuditingVo</span> <span class="variable">textAuditingVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextAuditingVo</span>();  </span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;Success&quot;</span>.equals(detail.getState())) &#123;  </span><br><span class="line">        <span class="comment">//检测结果: 0（审核正常），1 （判定为违规敏感文件），2（疑似敏感，建议人工复核）。  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> detail.getResult();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//违规关键词  </span></span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">keywords</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();  </span><br><span class="line">        List&lt;SectionInfo&gt; sectionInfoList = detail.getSectionList();  </span><br><span class="line">        <span class="keyword">for</span> (SectionInfo info : sectionInfoList) &#123;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">String</span> <span class="variable">pornInfoKeyword</span> <span class="operator">=</span> info.getPornInfo().getKeywords();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">illegalInfoKeyword</span> <span class="operator">=</span> info.getIllegalInfo().getKeywords();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">abuseInfoKeyword</span> <span class="operator">=</span> info.getAbuseInfo().getKeywords();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (pornInfoKeyword.length() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                keywords.append(pornInfoKeyword).append(<span class="string">&quot;,&quot;</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">if</span> (illegalInfoKeyword.length() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                keywords.append(illegalInfoKeyword).append(<span class="string">&quot;,&quot;</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">if</span> (abuseInfoKeyword.length() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                keywords.append(abuseInfoKeyword).append(<span class="string">&quot;,&quot;</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        textAuditingVo.setResult(result);  </span><br><span class="line">        textAuditingVo.setKeywords(keywords.toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> textAuditingVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="远程调用-14"><a href="#远程调用-14" class="headerlink" title="远程调用"></a>远程调用</h4><p>CiFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 文本审核  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> content  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/ci/textAuditing&quot;)</span>  </span><br><span class="line">Result&lt;TextAuditingVo&gt; <span class="title function_">textAuditing</span><span class="params">(<span class="meta">@RequestBody</span> String content)</span>;</span><br></pre></td></tr></table></figure>


<h3 id="订单监控接口完善"><a href="#订单监控接口完善" class="headerlink" title="订单监控接口完善"></a>订单监控接口完善</h3><p>修改web-driver的MonitorServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> FileService fileService;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> OrderMonitorFeignClient orderMonitorFeignClient;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> CiFeignClient ciFeignClient;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 上传录音  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">upload</span><span class="params">(MultipartFile file, OrderMonitorForm orderMonitorForm)</span> &#123;  </span><br><span class="line">    <span class="comment">//上传文件  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> fileService.upload(file);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderMonitorRecord</span> <span class="variable">orderMonitorRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMonitorRecord</span>();  </span><br><span class="line">    orderMonitorRecord.setOrderId(orderMonitorForm.getOrderId());  </span><br><span class="line">    orderMonitorRecord.setFileUrl(url);  </span><br><span class="line">    orderMonitorRecord.setContent(orderMonitorForm.getContent());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 文本审核  </span></span><br><span class="line">    <span class="type">TextAuditingVo</span> <span class="variable">textAuditingVo</span> <span class="operator">=</span> ciFeignClient.textAuditing(orderMonitorForm.getContent()).getData();  </span><br><span class="line">    orderMonitorRecord.setResult(textAuditingVo.getResult());  </span><br><span class="line">    orderMonitorRecord.setKeywords(textAuditingVo.getKeywords());  </span><br><span class="line">  </span><br><span class="line">    orderMonitorFeignClient.saveMonitorRecord(orderMonitorRecord);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="订单执行（三）"><a href="#订单执行（三）" class="headerlink" title="订单执行（三）"></a>订单执行（三）</h1><h2 id="计算订单实际里程"><a href="#计算订单实际里程" class="headerlink" title="计算订单实际里程"></a>计算订单实际里程</h2><ul>
<li>在MongoDB保存订单过程中司机位置信息，把MongoDB存储司机位置信息获取出来，以时间排序，连接每个点，成为实际距离</li>
</ul>
<h3 id="准备计算距离工具类"><a href="#准备计算距离工具类" class="headerlink" title="准备计算距离工具类"></a>准备计算距离工具类</h3><p>common-util中的LocationUtil</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span> <span class="title function_">getDistance</span><span class="params">(<span class="type">double</span> lat1, <span class="type">double</span> lng1, <span class="type">double</span> lat2,  </span></span><br><span class="line"><span class="params">                                 <span class="type">double</span> lng2)</span> &#123;  </span><br><span class="line">    <span class="type">double</span> <span class="variable">radLat1</span> <span class="operator">=</span> rad(lat1);  </span><br><span class="line">    <span class="type">double</span> <span class="variable">radLat2</span> <span class="operator">=</span> rad(lat2);  </span><br><span class="line">    <span class="type">double</span> <span class="variable">a</span> <span class="operator">=</span> radLat1 - radLat2;  </span><br><span class="line">    <span class="type">double</span> <span class="variable">b</span> <span class="operator">=</span> rad(lng1) - rad(lng2);  </span><br><span class="line">    <span class="type">double</span> <span class="variable">s</span> <span class="operator">=</span> <span class="number">2</span> * Math.asin(Math.sqrt(Math.pow(Math.sin(a / <span class="number">2</span>), <span class="number">2</span>)  </span><br><span class="line">            + Math.cos(radLat1) * Math.cos(radLat2)  </span><br><span class="line">            * Math.pow(Math.sin(b / <span class="number">2</span>), <span class="number">2</span>)));  </span><br><span class="line">    s = s * EARTH_RADIUS;  </span><br><span class="line">    s = Math.round(s * <span class="number">10000d</span>) / <span class="number">10000d</span>;  </span><br><span class="line">    s = s * <span class="number">1000</span>;  </span><br><span class="line">    <span class="keyword">return</span> s;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="地图微服务接口-2"><a href="#地图微服务接口-2" class="headerlink" title="地图微服务接口"></a>地图微服务接口</h3><p>LocationController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;代驾服务：计算订单实际里程&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/calculateOrderRealDistance/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;BigDecimal&gt; <span class="title function_">calculateOrderRealDistance</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.calculateOrderRealDistance(orderId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 代驾服务：计算订单实际里程  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> BigDecimal <span class="title function_">calculateOrderRealDistance</span><span class="params">(Long orderId)</span> &#123;  </span><br><span class="line">    <span class="comment">// 根据订单id获取位置信息，按照创建时间排序  </span></span><br><span class="line">    List&lt;OrderServiceLocation&gt; list =  </span><br><span class="line">            orderServiceLocationRepository.findByOrderIdOrderByCreateTimeAsc(orderId);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 第一步查询返回订单位置信息list集合  </span></span><br><span class="line">    <span class="comment">// 把list集合遍历，得到每个位置信息，计算两个位置距离，把计算所有距离相加操作  </span></span><br><span class="line">    <span class="type">double</span> <span class="variable">realDistance</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(list)) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>,size = list.size()-<span class="number">1</span>; i &lt; size; i++) &#123;  </span><br><span class="line">            <span class="type">OrderServiceLocation</span> <span class="variable">location1</span> <span class="operator">=</span> list.get(i);  </span><br><span class="line">            <span class="type">OrderServiceLocation</span> <span class="variable">location2</span> <span class="operator">=</span> list.get(i + <span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//计算位置距离  </span></span><br><span class="line">            <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> LocationUtil.getDistance(location1.getLatitude().doubleValue(),  </span><br><span class="line">                    location1.getLongitude().doubleValue(),  </span><br><span class="line">                    location2.getLatitude().doubleValue(),  </span><br><span class="line">                    location2.getLongitude().doubleValue());  </span><br><span class="line">  </span><br><span class="line">            realDistance += distance;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(realDistance);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-15"><a href="#远程调用-15" class="headerlink" title="远程调用"></a>远程调用</h3><p>LocationFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 代驾服务：计算订单实际里程</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/map/location/calculateOrderRealDistance/&#123;orderId&#125;&quot;)</span></span><br><span class="line">Result&lt;BigDecimal&gt; <span class="title function_">calculateOrderRealDistance</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span>;</span><br></pre></td></tr></table></figure>


<h2 id="计算系统奖励"><a href="#计算系统奖励" class="headerlink" title="计算系统奖励"></a>计算系统奖励</h2><h3 id="创建规则文件"><a href="#创建规则文件" class="headerlink" title="创建规则文件"></a>创建规则文件</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//package对应的不一定是真正的目录，可以任意写com.abc，同一个包下的drl文件可以相互访问  </span></span><br><span class="line"><span class="keyword">package</span>  com.atguigu.daijia  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.model.form.rules.RewardRuleRequest;  </span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;  </span><br><span class="line"><span class="keyword">import</span> java.math.RoundingMode;  </span><br><span class="line">  </span><br><span class="line">global com.atguigu.daijia.model.vo.rules.RewardRuleResponse rewardRuleResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">系统奖励  </span></span><br><span class="line"><span class="comment">    00:00:00-06:59:59  完成5单后 奖励5元  </span></span><br><span class="line"><span class="comment">    07:00:00-23:59:59  完成10单后 奖励2元  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line">rule <span class="string">&quot;00:00:00-06:59:59  完成5单后 每单奖励5元&quot;</span>  </span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行  </span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环  </span></span><br><span class="line">    when  </span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象  </span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false  </span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span>  </span><br><span class="line">        $rule:RewardRuleRequest(startTime &gt;= <span class="string">&quot;00:00:00&quot;</span> &amp;&amp; startTime &lt;= <span class="string">&quot;06:59:59&quot;</span> &amp;&amp; orderNum &gt; <span class="number">5</span>)  </span><br><span class="line">    then  </span><br><span class="line">        rewardRuleResponse.setRewardAmount(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;5.0&quot;</span>));  </span><br><span class="line">        System.out.println(<span class="string">&quot;00:00:00-06:59:59 奖励：&quot;</span> + rewardRuleResponse.getRewardAmount() + <span class="string">&quot;元&quot;</span>);  </span><br><span class="line">end  </span><br><span class="line">rule <span class="string">&quot;07:00:00-23:59:59  完成10单后 每单奖励2元&quot;</span>  </span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行  </span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环  </span></span><br><span class="line">    when  </span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象  </span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false  </span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span>  </span><br><span class="line">        $rule:RewardRuleRequest(startTime &gt;= <span class="string">&quot;07:00:00&quot;</span> &amp;&amp; startTime &lt;= <span class="string">&quot;23:59:59&quot;</span> &amp;&amp; orderNum &gt; <span class="number">10</span>)  </span><br><span class="line">    then  </span><br><span class="line">        rewardRuleResponse.setRewardAmount(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;2.0&quot;</span>));  </span><br><span class="line">        System.out.println(<span class="string">&quot;00:00:00-06:59:59 奖励：&quot;</span> + rewardRuleResponse.getRewardAmount() + <span class="string">&quot;元&quot;</span>);  </span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h3 id="添加规则引擎工具类"><a href="#添加规则引擎工具类" class="headerlink" title="添加规则引擎工具类"></a>添加规则引擎工具类</h3><p>在service-rules中utils包下创建</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DroolsHelper</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RULES_CUSTOMER_RULES_DRL</span> <span class="operator">=</span> <span class="string">&quot;rules/FeeRule.drl&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> KieSession <span class="title function_">loadForRule</span><span class="params">(String drlStr)</span> &#123;  </span><br><span class="line">        <span class="type">KieServices</span> <span class="variable">kieServices</span> <span class="operator">=</span> KieServices.Factory.get();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">KieFileSystem</span> <span class="variable">kieFileSystem</span> <span class="operator">=</span> kieServices.newKieFileSystem();  </span><br><span class="line">        kieFileSystem.write(  </span><br><span class="line">                ResourceFactory.newClassPathResource(drlStr));  </span><br><span class="line">  </span><br><span class="line">        <span class="type">KieBuilder</span> <span class="variable">kb</span> <span class="operator">=</span> kieServices.newKieBuilder(kieFileSystem);  </span><br><span class="line">        kb.buildAll();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">KieModule</span> <span class="variable">kieModule</span> <span class="operator">=</span> kb.getKieModule();  </span><br><span class="line">        <span class="type">KieContainer</span> <span class="variable">kieContainer</span> <span class="operator">=</span> kieServices.newKieContainer(kieModule.getReleaseId());  </span><br><span class="line">        <span class="keyword">return</span> kieContainer.newKieSession();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="规则微服务接口"><a href="#规则微服务接口" class="headerlink" title="规则微服务接口"></a>规则微服务接口</h3><p>RewardRuleController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> RewardRuleService rewardRuleService;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Operation(summary = &quot;计算订单奖励费用&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/calculateOrderRewardFee&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;RewardRuleResponseVo&gt;  </span><br><span class="line"><span class="title function_">calculateOrderRewardFee</span><span class="params">(<span class="meta">@RequestBody</span> RewardRuleRequestForm rewardRuleRequestForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(rewardRuleService.calculateOrderRewardFee(rewardRuleRequestForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 计算订单奖励费用  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> RewardRuleResponseVo <span class="title function_">calculateOrderRewardFee</span><span class="params">(RewardRuleRequestForm rewardRuleRequestForm)</span> &#123;  </span><br><span class="line">    <span class="comment">//封装传入参数对象  </span></span><br><span class="line">    <span class="type">RewardRuleRequest</span> <span class="variable">rewardRuleRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleRequest</span>();  </span><br><span class="line">    rewardRuleRequest.setOrderNum(rewardRuleRequestForm.getOrderNum());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//创建规则引擎对象  </span></span><br><span class="line">    <span class="type">KieSession</span> <span class="variable">kieSession</span> <span class="operator">=</span> DroolsHelper.loadForRule(RULES_CUSTOMER_RULES_DRL);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//封装返回对象  </span></span><br><span class="line">    <span class="type">RewardRuleResponse</span> <span class="variable">rewardRuleResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleResponse</span>();  </span><br><span class="line">    kieSession.setGlobal(<span class="string">&quot;rewardRuleResponse&quot;</span>,rewardRuleResponse);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//设置对象，触发规则  </span></span><br><span class="line">    kieSession.insert(rewardRuleRequest);  </span><br><span class="line">    kieSession.fireAllRules();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//终止会话  </span></span><br><span class="line">    kieSession.dispose();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//封装RewardRuleResponseVo  </span></span><br><span class="line">    <span class="type">RewardRuleResponseVo</span> <span class="variable">rewardRuleResponseVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleResponseVo</span>();  </span><br><span class="line">    rewardRuleResponseVo.setRewardAmount(rewardRuleResponse.getRewardAmount());  </span><br><span class="line">    <span class="keyword">return</span> rewardRuleResponseVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-16"><a href="#远程调用-16" class="headerlink" title="远程调用"></a>远程调用</h3><p>RewardRuleFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算订单奖励费用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rewardRuleRequestForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/rules/reward/calculateOrderRewardFee&quot;)</span></span><br><span class="line">Result&lt;RewardRuleResponseVo&gt; <span class="title function_">calculateOrderRewardFee</span><span class="params">(<span class="meta">@RequestBody</span> RewardRuleRequestForm rewardRuleRequestForm)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="根据时间段获取订单数量"><a href="#根据时间段获取订单数量" class="headerlink" title="根据时间段获取订单数量"></a>根据时间段获取订单数量</h2><h3 id="订单微服务接口-5"><a href="#订单微服务接口-5" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h3><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;根据时间段获取订单数&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderNumByTime/&#123;startTime&#125;/&#123;endTime&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">getOrderNumByTime</span><span class="params">(<span class="meta">@PathVariable</span> String startTime, <span class="meta">@PathVariable</span> String endTime)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.getOrderNumByTime(startTime, endTime));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 根据时间段获取订单数  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">getOrderNumByTime</span><span class="params">(String startTime, String endTime)</span> &#123;  </span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.ge(OrderInfo::getStartServiceTime,startTime);  </span><br><span class="line">    wrapper.lt(OrderInfo::getStartServiceTime,endTime);  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> orderInfoMapper.selectCount(wrapper);  </span><br><span class="line">    <span class="keyword">return</span> count;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-17"><a href="#远程调用-17" class="headerlink" title="远程调用"></a>远程调用</h3><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> *  根据时间段获取订单数  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startTime  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endTime  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/getOrderNumByTime/&#123;startTime&#125;/&#123;endTime&#125;&quot;)</span>  </span><br><span class="line">Result&lt;Long&gt; <span class="title function_">getOrderNumByTime</span><span class="params">(<span class="meta">@PathVariable(&quot;startTime&quot;)</span> String startTime, <span class="meta">@PathVariable(&quot;endTime&quot;)</span> String endTime)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="计算分账信息"><a href="#计算分账信息" class="headerlink" title="计算分账信息"></a>计算分账信息</h2><h3 id="创建规则文件-1"><a href="#创建规则文件-1" class="headerlink" title="创建规则文件"></a>创建规则文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//package对应的不一定是真正的目录，可以任意写com.abc，同一个包下的drl文件可以相互访问  </span><br><span class="line">package  com.atguigu.daijia  </span><br><span class="line">  </span><br><span class="line">import com.atguigu.daijia.model.form.rules.ProfitsharingRuleRequest;  </span><br><span class="line">import java.math.BigDecimal;  </span><br><span class="line">import java.math.RoundingMode;  </span><br><span class="line">  </span><br><span class="line">global com.atguigu.daijia.model.vo.rules.ProfitsharingRuleResponse profitsharingRuleResponse;  </span><br><span class="line">//支付微信平台费率：0.6%  </span><br><span class="line">//global BigDecimal paymentRate = new BigDecimal(0.006);  </span><br><span class="line">/**  </span><br><span class="line">支付微信平台费用  </span><br><span class="line">    平台费率：0.6%  </span><br><span class="line">*/  </span><br><span class="line">rule &quot;支付微信平台费用 平台费率：0.6%&quot;  </span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行  </span><br><span class="line">    no-loop true         //防止陷入死循环  </span><br><span class="line">    when  </span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象  </span><br><span class="line">        里面出来的结果只能是ture或者false  </span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/  </span><br><span class="line">        $rule:ProfitsharingRuleRequest()  </span><br><span class="line">    then  </span><br><span class="line">        profitsharingRuleResponse.setOrderAmount($rule.getOrderAmount());  </span><br><span class="line">        profitsharingRuleResponse.setPaymentRate(new BigDecimal(&quot;0.006&quot;));  </span><br><span class="line">        BigDecimal paymentFee = profitsharingRuleResponse.getOrderAmount().multiply(profitsharingRuleResponse.getPaymentRate()).setScale(2, RoundingMode.HALF_UP);  </span><br><span class="line">        profitsharingRuleResponse.setPaymentFee(paymentFee);  </span><br><span class="line">        System.out.println(&quot;支付微信平台费用：&quot; + profitsharingRuleResponse.getPaymentFee() + &quot;元&quot;);  </span><br><span class="line">end  </span><br><span class="line">  </span><br><span class="line">/**  </span><br><span class="line">订单金额小于等于100  </span><br><span class="line">    当天完成订单小于等于10单 平台抽成 20%  </span><br><span class="line">    当天完成订单大于10单 平台抽成 18%  </span><br><span class="line">*/  </span><br><span class="line">rule &quot;订单金额小于等于100 当天完成订单小于等于10单&quot;  </span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行  </span><br><span class="line">    no-loop true         //防止陷入死循环  </span><br><span class="line">    when  </span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象  </span><br><span class="line">        里面出来的结果只能是ture或者false  </span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/  </span><br><span class="line">        $rule:ProfitsharingRuleRequest(orderAmount.doubleValue() &lt;= 100.0 &amp;&amp; orderNum &lt;= 10)  </span><br><span class="line">    then  </span><br><span class="line">        BigDecimal totalAmount = profitsharingRuleResponse.getOrderAmount().subtract(profitsharingRuleResponse.getPaymentFee());  </span><br><span class="line">        BigDecimal platformIncome = totalAmount.multiply(new BigDecimal(&quot;0.2&quot;)).setScale(2, RoundingMode.HALF_UP);  </span><br><span class="line">        BigDecimal driverTotalIncome = totalAmount.subtract(platformIncome);  </span><br><span class="line">        //代驾司机个税，税率：10%  </span><br><span class="line">        BigDecimal driverTaxFee = driverTotalIncome.multiply(new BigDecimal(&quot;0.1&quot;)).setScale(2, RoundingMode.HALF_UP);  </span><br><span class="line">        BigDecimal driverIncome = driverTotalIncome.subtract(driverTaxFee);  </span><br><span class="line">        profitsharingRuleResponse.setPlatformIncome(platformIncome);  </span><br><span class="line">        profitsharingRuleResponse.setDriverIncome(driverIncome);  </span><br><span class="line">        profitsharingRuleResponse.setDriverTaxRate(new BigDecimal(&quot;0.1&quot;));  </span><br><span class="line">        profitsharingRuleResponse.setDriverTaxFee(driverTaxFee);  </span><br><span class="line">        System.out.println(&quot;平台分账收入：&quot; + platformIncome + &quot;元&quot; + &quot;，司机分账收入：&quot; + driverIncome + &quot;元&quot; + &quot;，司机个税：&quot; + driverTaxFee + &quot;元&quot;);  </span><br><span class="line">end  </span><br><span class="line">rule &quot;订单金额小于等于100 天完成订单大于10单&quot;  </span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行  </span><br><span class="line">    no-loop true         //防止陷入死循环  </span><br><span class="line">    when  </span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象  </span><br><span class="line">        里面出来的结果只能是ture或者false  </span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/  </span><br><span class="line">        $rule:ProfitsharingRuleRequest(orderAmount.doubleValue() &lt;= 100.0 &amp;&amp; orderNum &gt; 10)  </span><br><span class="line">    then  </span><br><span class="line">        BigDecimal totalAmount = profitsharingRuleResponse.getOrderAmount().subtract(profitsharingRuleResponse.getPaymentFee());  </span><br><span class="line">        BigDecimal platformIncome = totalAmount.multiply(new BigDecimal(&quot;0.18&quot;)).setScale(2, RoundingMode.HALF_UP);  </span><br><span class="line">        BigDecimal driverTotalIncome = totalAmount.subtract(platformIncome);  </span><br><span class="line">        //代驾司机个税，税率：10%  </span><br><span class="line">        BigDecimal driverTaxFee = driverTotalIncome.multiply(new BigDecimal(&quot;0.1&quot;)).setScale(2, RoundingMode.HALF_UP);  </span><br><span class="line">        BigDecimal driverIncome = driverTotalIncome.subtract(driverTaxFee);  </span><br><span class="line">        profitsharingRuleResponse.setPlatformIncome(platformIncome);  </span><br><span class="line">        profitsharingRuleResponse.setDriverIncome(driverIncome);  </span><br><span class="line">        profitsharingRuleResponse.setDriverTaxRate(new BigDecimal(&quot;0.1&quot;));  </span><br><span class="line">        profitsharingRuleResponse.setDriverTaxFee(driverTaxFee);  </span><br><span class="line">        System.out.println(&quot;平台分账收入：&quot; + platformIncome + &quot;元&quot; + &quot;，司机分账收入：&quot; + driverIncome + &quot;元&quot; + &quot;，司机个税：&quot; + driverTaxFee + &quot;元&quot;);  </span><br><span class="line">end  </span><br><span class="line">  </span><br><span class="line">/**  </span><br><span class="line">订单金额大于100  </span><br><span class="line">    当天完成订单小于等于10单 平台抽成 18%  </span><br><span class="line">    当天完成订单大于10单 平台抽成 16%  </span><br><span class="line">*/  </span><br><span class="line">rule &quot;订单金额大于100 当天完成订单小于等于10单&quot;  </span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行  </span><br><span class="line">    no-loop true         //防止陷入死循环  </span><br><span class="line">    when  </span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象  </span><br><span class="line">        里面出来的结果只能是ture或者false  </span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/  </span><br><span class="line">        $rule:ProfitsharingRuleRequest(orderAmount.doubleValue() &gt; 100.0 &amp;&amp; orderNum &lt;= 10)  </span><br><span class="line">    then  </span><br><span class="line">        BigDecimal totalAmount = profitsharingRuleResponse.getOrderAmount().subtract(profitsharingRuleResponse.getPaymentFee());  </span><br><span class="line">        BigDecimal platformIncome = totalAmount.multiply(new BigDecimal(&quot;0.18&quot;)).setScale(2, RoundingMode.HALF_UP);  </span><br><span class="line">        BigDecimal driverTotalIncome = totalAmount.subtract(platformIncome);  </span><br><span class="line">        //代驾司机个税，税率：10%  </span><br><span class="line">        BigDecimal driverTaxFee = driverTotalIncome.multiply(new BigDecimal(&quot;0.1&quot;)).setScale(2, RoundingMode.HALF_UP);  </span><br><span class="line">        BigDecimal driverIncome = driverTotalIncome.subtract(driverTaxFee);  </span><br><span class="line">        profitsharingRuleResponse.setPlatformIncome(platformIncome);  </span><br><span class="line">        profitsharingRuleResponse.setDriverIncome(driverIncome);  </span><br><span class="line">        profitsharingRuleResponse.setDriverTaxRate(new BigDecimal(&quot;0.1&quot;));  </span><br><span class="line">        profitsharingRuleResponse.setDriverTaxFee(driverTaxFee);  </span><br><span class="line">        System.out.println(&quot;平台分账收入：&quot; + platformIncome + &quot;元&quot; + &quot;，司机分账收入：&quot; + driverIncome + &quot;元&quot; + &quot;，司机个税：&quot; + driverTaxFee + &quot;元&quot;);  </span><br><span class="line">end  </span><br><span class="line">rule &quot;订单金额大于100 天完成订单大于10单&quot;  </span><br><span class="line">    salience 10          //指定优先级，数值越大优先级越高，不指定的情况下由上到下执行  </span><br><span class="line">    no-loop true         //防止陷入死循环  </span><br><span class="line">    when  </span><br><span class="line">        /*规则条件，到工作内存中查找FeeRuleRequest对象  </span><br><span class="line">        里面出来的结果只能是ture或者false  </span><br><span class="line">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/  </span><br><span class="line">        $rule:ProfitsharingRuleRequest(orderAmount.doubleValue() &gt; 100.0 &amp;&amp; orderNum &gt; 10)  </span><br><span class="line">    then  </span><br><span class="line">        BigDecimal totalAmount = profitsharingRuleResponse.getOrderAmount().subtract(profitsharingRuleResponse.getPaymentFee());  </span><br><span class="line">        BigDecimal platformIncome = totalAmount.multiply(new BigDecimal(&quot;0.18&quot;)).setScale(2, RoundingMode.HALF_UP);  </span><br><span class="line">        BigDecimal driverTotalIncome = totalAmount.subtract(platformIncome);  </span><br><span class="line">        //代驾司机个税，税率：10%  </span><br><span class="line">        BigDecimal driverTaxFee = driverTotalIncome.multiply(new BigDecimal(&quot;0.1&quot;)).setScale(2, RoundingMode.HALF_UP);  </span><br><span class="line">        BigDecimal driverIncome = driverTotalIncome.subtract(driverTaxFee);  </span><br><span class="line">        profitsharingRuleResponse.setPlatformIncome(platformIncome);  </span><br><span class="line">        profitsharingRuleResponse.setDriverIncome(driverIncome);  </span><br><span class="line">        profitsharingRuleResponse.setDriverTaxRate(new BigDecimal(&quot;0.1&quot;));  </span><br><span class="line">        profitsharingRuleResponse.setDriverTaxFee(driverTaxFee);  </span><br><span class="line">        System.out.println(&quot;平台分账收入：&quot; + platformIncome + &quot;元&quot; + &quot;，司机分账收入：&quot; + driverIncome + &quot;元&quot; + &quot;，司机个税：&quot; + driverTaxFee + &quot;元&quot;);  </span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h3 id="规则微服务接口-1"><a href="#规则微服务接口-1" class="headerlink" title="规则微服务接口"></a>规则微服务接口</h3><p>ProfitsharingRuleController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> ProfitsharingRuleService profitsharingRuleService;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Operation(summary = &quot;计算系统分账费用&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/calculateOrderProfitsharingFee&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;ProfitsharingRuleResponseVo&gt; <span class="title function_">calculateOrderProfitsharingFee</span><span class="params">(<span class="meta">@RequestBody</span> ProfitsharingRuleRequestForm profitsharingRuleRequestForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(profitsharingRuleService.calculateOrderProfitsharingFee(profitsharingRuleRequestForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> ProfitsharingRuleMapper rewardRuleMapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RULES_CUSTOMER_RULES_DRL</span> <span class="operator">=</span> <span class="string">&quot;rules/ProfitsharingRule.drl&quot;</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> ProfitsharingRuleResponseVo <span class="title function_">calculateOrderProfitsharingFee</span><span class="params">(ProfitsharingRuleRequestForm profitsharingRuleRequestForm)</span> &#123;  </span><br><span class="line">    <span class="comment">//传入参数对象封装  </span></span><br><span class="line">    <span class="type">ProfitsharingRuleRequest</span> <span class="variable">profitsharingRuleRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleRequest</span>();  </span><br><span class="line">    profitsharingRuleRequest.setOrderAmount(profitsharingRuleRequestForm.getOrderAmount());  </span><br><span class="line">    profitsharingRuleRequest.setOrderNum(profitsharingRuleRequestForm.getOrderNum());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//创建kieSession  </span></span><br><span class="line">    <span class="type">KieSession</span> <span class="variable">kieSession</span> <span class="operator">=</span> DroolsHelper.loadForRule(RULES_CUSTOMER_RULES_DRL);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//封装返回对象  </span></span><br><span class="line">    <span class="type">ProfitsharingRuleResponse</span> <span class="variable">profitsharingRuleResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleResponse</span>();  </span><br><span class="line">    kieSession.setGlobal(<span class="string">&quot;profitsharingRuleResponse&quot;</span>,profitsharingRuleResponse);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//触发规则，返回vo对象  </span></span><br><span class="line">    kieSession.insert(profitsharingRuleRequest);  </span><br><span class="line">    kieSession.fireAllRules();  </span><br><span class="line">    kieSession.dispose();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">ProfitsharingRuleResponseVo</span> <span class="variable">profitsharingRuleResponseVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleResponseVo</span>();  </span><br><span class="line">    BeanUtils.copyProperties(profitsharingRuleResponse,profitsharingRuleResponseVo);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> profitsharingRuleResponseVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-18"><a href="#远程调用-18" class="headerlink" title="远程调用"></a>远程调用</h3><p>ProfitsharingRuleFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 计算订单分账数据  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> profitsharingRuleRequestForm  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/rules/profitsharing/calculateOrderProfitsharingFee&quot;)</span>  </span><br><span class="line">Result&lt;ProfitsharingRuleResponseVo&gt; <span class="title function_">calculateOrderProfitsharingFee</span><span class="params">(<span class="meta">@RequestBody</span> ProfitsharingRuleRequestForm profitsharingRuleRequestForm)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="结束服务更新订单"><a href="#结束服务更新订单" class="headerlink" title="结束服务更新订单"></a>结束服务更新订单</h2><ul>
<li>更新订单数据：订单状态、订单实际距离、订单实际金额等</li>
<li>添加实际账单信息</li>
<li>添加分账信息</li>
</ul>
<h3 id="订单微服务接口-6"><a href="#订单微服务接口-6" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h3><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;结束代驾服务更新订单账单&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/endDrive&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">endDrive</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderBillForm updateOrderBillForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.endDrive(updateOrderBillForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> OrderBillMapper orderBillMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> OrderProfitsharingMapper orderProfitsharingMapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结束代驾服务更新订单账单  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">endDrive</span><span class="params">(UpdateOrderBillForm updateOrderBillForm)</span> &#123;  </span><br><span class="line">    <span class="comment">// 更新订单信息  </span></span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(OrderInfo::getId,updateOrderBillForm.getOrderId());  </span><br><span class="line">    wrapper.eq(OrderInfo::getDriverId,updateOrderBillForm.getDriverId());  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();  </span><br><span class="line">    orderInfo.setStatus(OrderStatus.END_SERVICE.getStatus());  </span><br><span class="line">    orderInfo.setRealAmount(updateOrderBillForm.getTotalAmount());  </span><br><span class="line">    orderInfo.setFavourFee(updateOrderBillForm.getFavourFee());  </span><br><span class="line">    orderInfo.setRealDistance(updateOrderBillForm.getRealDistance());  </span><br><span class="line">    orderInfo.setEndServiceTime(<span class="keyword">new</span> <span class="title class_">Date</span>());  </span><br><span class="line">  </span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> orderInfoMapper.update(orderInfo, wrapper);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span>(rows == <span class="number">1</span>) &#123;  </span><br><span class="line">        <span class="comment">//添加账单数据  </span></span><br><span class="line">        <span class="type">OrderBill</span> <span class="variable">orderBill</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderBill</span>();  </span><br><span class="line">        BeanUtils.copyProperties(updateOrderBillForm,orderBill);  </span><br><span class="line">        orderBill.setOrderId(updateOrderBillForm.getOrderId());  </span><br><span class="line">        orderBill.setPayAmount(updateOrderBillForm.getTotalAmount());  </span><br><span class="line">        orderBillMapper.insert(orderBill);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//添加分账信息  </span></span><br><span class="line">        <span class="type">OrderProfitsharing</span> <span class="variable">orderProfitsharing</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderProfitsharing</span>();  </span><br><span class="line">        BeanUtils.copyProperties(updateOrderBillForm, orderProfitsharing);  </span><br><span class="line">        orderProfitsharing.setOrderId(updateOrderBillForm.getOrderId());  </span><br><span class="line">        orderProfitsharing.setRuleId(updateOrderBillForm.getProfitsharingRuleId());  </span><br><span class="line">        orderProfitsharing.setStatus(<span class="number">1</span>);  </span><br><span class="line">        orderProfitsharingMapper.insert(orderProfitsharing);  </span><br><span class="line">  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程调用-19"><a href="#远程调用-19" class="headerlink" title="远程调用"></a>远程调用</h3><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 结束代驾服务更新订单账单  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> updateOrderBillForm  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/order/info/endDrive&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">endDrive</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderBillForm updateOrderBillForm)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="结束服务"><a href="#结束服务" class="headerlink" title="结束服务"></a>结束服务</h2><p>web-driver中的OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;结束代驾服务更新订单账单&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/endDrive&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">endDrive</span><span class="params">(<span class="meta">@RequestBody</span> OrderFeeForm orderFeeForm)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    orderFeeForm.setDriverId(driverId);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.endDrive(orderFeeForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> LocationFeignClient locationFeignClient;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> FeeRuleFeignClient feeRuleFeignClient;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> RewardRuleFeignClient rewardRuleFeignClient;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> ProfitsharingRuleFeignClient profitsharingRuleFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结束代驾服务更新订单账单  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">endDrive</span><span class="params">(OrderFeeForm orderFeeForm)</span> &#123;  </span><br><span class="line">    <span class="comment">// 根据orderId获取订单信息，判断当前订单是否司机接单  </span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderFeeForm.getOrderId()).getData();  </span><br><span class="line">    <span class="keyword">if</span>(orderInfo.getDriverId() != orderFeeForm.getDriverId()) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 计算订单实际里程  </span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">realDistance</span> <span class="operator">=</span>  </span><br><span class="line">            locationFeignClient.calculateOrderRealDistance(orderFeeForm.getOrderId()).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 计算代驾实际费用  </span></span><br><span class="line">    <span class="comment">//封装FeeRuleRequestForm  </span></span><br><span class="line">    <span class="type">FeeRuleRequestForm</span> <span class="variable">feeRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();  </span><br><span class="line">    feeRuleRequestForm.setDistance(realDistance);  </span><br><span class="line">    feeRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//计算司机到达代驾开始位置时间  </span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">waitMinute</span> <span class="operator">=</span>  </span><br><span class="line">            Math.abs((<span class="type">int</span>)((orderInfo.getStartServiceTime().getTime()-orderInfo.getArriveTime().getTime())/(<span class="number">1000</span> * <span class="number">60</span>)));  </span><br><span class="line">    feeRuleRequestForm.setWaitMinute(waitMinute);  </span><br><span class="line">    <span class="comment">//远程调用 代驾费用  </span></span><br><span class="line">    <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleFeignClient.calculateOrderFee(feeRuleRequestForm).getData();  </span><br><span class="line">    <span class="comment">//实际费用 = 代驾费用 + 其他费用（停车费）  </span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span>  </span><br><span class="line">            feeRuleResponseVo.getTotalAmount().add(orderFeeForm.getTollFee())  </span><br><span class="line">                    .add(orderFeeForm.getParkingFee())  </span><br><span class="line">                    .add(orderFeeForm.getOtherFee())  </span><br><span class="line">                    .add(orderInfo.getFavourFee());  </span><br><span class="line">    feeRuleResponseVo.setTotalAmount(totalAmount);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 计算系统奖励  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>) + <span class="string">&quot; 00:00:00&quot;</span>;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">endTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>) + <span class="string">&quot; 24:00:00&quot;</span>;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderNum</span> <span class="operator">=</span> orderInfoFeignClient.getOrderNumByTime(startTime, endTime).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">RewardRuleRequestForm</span> <span class="variable">rewardRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleRequestForm</span>();  </span><br><span class="line">    rewardRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());  </span><br><span class="line">    rewardRuleRequestForm.setOrderNum(orderNum);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">RewardRuleResponseVo</span> <span class="variable">rewardRuleResponseVo</span> <span class="operator">=</span> rewardRuleFeignClient.calculateOrderRewardFee(rewardRuleRequestForm).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 计算分账信息  </span></span><br><span class="line">    <span class="type">ProfitsharingRuleRequestForm</span> <span class="variable">profitsharingRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleRequestForm</span>();  </span><br><span class="line">    profitsharingRuleRequestForm.setOrderAmount(feeRuleResponseVo.getTotalAmount());  </span><br><span class="line">    profitsharingRuleRequestForm.setOrderNum(orderNum);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">ProfitsharingRuleResponseVo</span> <span class="variable">profitsharingRuleResponseVo</span> <span class="operator">=</span> profitsharingRuleFeignClient.calculateOrderProfitsharingFee(profitsharingRuleRequestForm).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 封装实体类，结束代驾更新订单，添加账单和分账信息  </span></span><br><span class="line">    <span class="type">UpdateOrderBillForm</span> <span class="variable">updateOrderBillForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateOrderBillForm</span>();  </span><br><span class="line">    updateOrderBillForm.setOrderId(orderFeeForm.getOrderId());  </span><br><span class="line">    updateOrderBillForm.setDriverId(orderFeeForm.getDriverId());  </span><br><span class="line">    <span class="comment">//路桥费、停车费、其他费用  </span></span><br><span class="line">    updateOrderBillForm.setTollFee(orderFeeForm.getTollFee());  </span><br><span class="line">    updateOrderBillForm.setParkingFee(orderFeeForm.getParkingFee());  </span><br><span class="line">    updateOrderBillForm.setOtherFee(orderFeeForm.getOtherFee());  </span><br><span class="line">    <span class="comment">//乘客好处费  </span></span><br><span class="line">    updateOrderBillForm.setFavourFee(orderInfo.getFavourFee());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//实际里程  </span></span><br><span class="line">    updateOrderBillForm.setRealDistance(realDistance);  </span><br><span class="line">    <span class="comment">//订单奖励信息  </span></span><br><span class="line">    BeanUtils.copyProperties(rewardRuleResponseVo, updateOrderBillForm);  </span><br><span class="line">    <span class="comment">//代驾费用信息  </span></span><br><span class="line">    BeanUtils.copyProperties(feeRuleResponseVo, updateOrderBillForm);  </span><br><span class="line">    <span class="comment">//分账相关信息  </span></span><br><span class="line">    BeanUtils.copyProperties(profitsharingRuleResponseVo, updateOrderBillForm);  </span><br><span class="line">    updateOrderBillForm.setProfitsharingRuleId(profitsharingRuleResponseVo.getProfitsharingRuleId());  </span><br><span class="line">    orderInfoFeignClient.endDrive(updateOrderBillForm);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加位置限定"><a href="#添加位置限定" class="headerlink" title="添加位置限定"></a>添加位置限定</h2><p>修改之前web-driver中OrderServiceImpl编写的方法，在开始订单做判断</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//司机到达代驾起始地点  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">driverArriveStartLocation</span><span class="params">(Long orderId, Long driverId)</span> &#123;  </span><br><span class="line">    <span class="comment">//判断  </span></span><br><span class="line">    <span class="comment">// orderInfo有代驾开始位置  </span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//司机当前位置  </span></span><br><span class="line">    <span class="type">OrderLocationVo</span> <span class="variable">orderLocationVo</span> <span class="operator">=</span> locationFeignClient.getCacheOrderLocation(orderId).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//司机当前位置 和 代驾开始位置距离  </span></span><br><span class="line">    <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> LocationUtil.getDistance(orderInfo.getStartPointLatitude().doubleValue(),  </span><br><span class="line">            orderInfo.getStartPointLongitude().doubleValue(),  </span><br><span class="line">            orderLocationVo.getLatitude().doubleValue(),  </span><br><span class="line">            orderLocationVo.getLongitude().doubleValue());  </span><br><span class="line">    <span class="keyword">if</span>(distance &gt; SystemConstant.DRIVER_START_LOCATION_DISTION) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DRIVER_START_LOCATION_DISTION_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.driverArriveStartLocation(orderId,driverId).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结束订单也是一样</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 结束代驾服务更新订单账单  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">endDrive</span><span class="params">(OrderFeeForm orderFeeForm)</span> &#123;  </span><br><span class="line">    <span class="comment">// 根据orderId获取订单信息，判断当前订单是否司机接单  </span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderFeeForm.getOrderId()).getData();  </span><br><span class="line">    <span class="keyword">if</span>(orderInfo.getDriverId() != orderFeeForm.getDriverId()) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 判断距离  </span></span><br><span class="line">    <span class="type">OrderServiceLastLocationVo</span> <span class="variable">orderServiceLastLocationVo</span> <span class="operator">=</span> locationFeignClient.getOrderServiceLastLocation(orderFeeForm.getOrderId()).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//司机当前位置 距离 结束代驾位置  </span></span><br><span class="line">    <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> LocationUtil.getDistance(orderInfo.getEndPointLatitude().doubleValue(),  </span><br><span class="line">            orderInfo.getEndPointLongitude().doubleValue(),  </span><br><span class="line">            orderServiceLastLocationVo.getLatitude().doubleValue(),  </span><br><span class="line">            orderServiceLastLocationVo.getLongitude().doubleValue());  </span><br><span class="line">    <span class="keyword">if</span>(distance &gt; SystemConstant.DRIVER_END_LOCATION_DISTION) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DRIVER_END_LOCATION_DISTION_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 计算订单实际里程  </span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">realDistance</span> <span class="operator">=</span>  </span><br><span class="line">            locationFeignClient.calculateOrderRealDistance(orderFeeForm.getOrderId()).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 计算代驾实际费用  </span></span><br><span class="line">    <span class="comment">//封装FeeRuleRequestForm  </span></span><br><span class="line">    <span class="type">FeeRuleRequestForm</span> <span class="variable">feeRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();  </span><br><span class="line">    feeRuleRequestForm.setDistance(realDistance);  </span><br><span class="line">    feeRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//计算司机到达代驾开始位置时间  </span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">waitMinute</span> <span class="operator">=</span>  </span><br><span class="line">            Math.abs((<span class="type">int</span>)((orderInfo.getStartServiceTime().getTime()-orderInfo.getArriveTime().getTime())/(<span class="number">1000</span> * <span class="number">60</span>)));  </span><br><span class="line">    feeRuleRequestForm.setWaitMinute(waitMinute);  </span><br><span class="line">    <span class="comment">//远程调用 代驾费用  </span></span><br><span class="line">    <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleFeignClient.calculateOrderFee(feeRuleRequestForm).getData();  </span><br><span class="line">    <span class="comment">//实际费用 = 代驾费用 + 其他费用（停车费）  </span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span>  </span><br><span class="line">            feeRuleResponseVo.getTotalAmount().add(orderFeeForm.getTollFee())  </span><br><span class="line">                    .add(orderFeeForm.getParkingFee())  </span><br><span class="line">                    .add(orderFeeForm.getOtherFee())  </span><br><span class="line">                    .add(orderInfo.getFavourFee());  </span><br><span class="line">    feeRuleResponseVo.setTotalAmount(totalAmount);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 计算系统奖励  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>) + <span class="string">&quot; 00:00:00&quot;</span>;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">endTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>) + <span class="string">&quot; 24:00:00&quot;</span>;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderNum</span> <span class="operator">=</span> orderInfoFeignClient.getOrderNumByTime(startTime, endTime).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">RewardRuleRequestForm</span> <span class="variable">rewardRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleRequestForm</span>();  </span><br><span class="line">    rewardRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());  </span><br><span class="line">    rewardRuleRequestForm.setOrderNum(orderNum);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">RewardRuleResponseVo</span> <span class="variable">rewardRuleResponseVo</span> <span class="operator">=</span> rewardRuleFeignClient.calculateOrderRewardFee(rewardRuleRequestForm).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 计算分账信息  </span></span><br><span class="line">    <span class="type">ProfitsharingRuleRequestForm</span> <span class="variable">profitsharingRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleRequestForm</span>();  </span><br><span class="line">    profitsharingRuleRequestForm.setOrderAmount(feeRuleResponseVo.getTotalAmount());  </span><br><span class="line">    profitsharingRuleRequestForm.setOrderNum(orderNum);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">ProfitsharingRuleResponseVo</span> <span class="variable">profitsharingRuleResponseVo</span> <span class="operator">=</span> profitsharingRuleFeignClient.calculateOrderProfitsharingFee(profitsharingRuleRequestForm).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 封装实体类，结束代驾更新订单，添加账单和分账信息  </span></span><br><span class="line">    <span class="type">UpdateOrderBillForm</span> <span class="variable">updateOrderBillForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateOrderBillForm</span>();  </span><br><span class="line">    updateOrderBillForm.setOrderId(orderFeeForm.getOrderId());  </span><br><span class="line">    updateOrderBillForm.setDriverId(orderFeeForm.getDriverId());  </span><br><span class="line">    <span class="comment">//路桥费、停车费、其他费用  </span></span><br><span class="line">    updateOrderBillForm.setTollFee(orderFeeForm.getTollFee());  </span><br><span class="line">    updateOrderBillForm.setParkingFee(orderFeeForm.getParkingFee());  </span><br><span class="line">    updateOrderBillForm.setOtherFee(orderFeeForm.getOtherFee());  </span><br><span class="line">    <span class="comment">//乘客好处费  </span></span><br><span class="line">    updateOrderBillForm.setFavourFee(orderInfo.getFavourFee());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//实际里程  </span></span><br><span class="line">    updateOrderBillForm.setRealDistance(realDistance);  </span><br><span class="line">    <span class="comment">//订单奖励信息  </span></span><br><span class="line">    BeanUtils.copyProperties(rewardRuleResponseVo, updateOrderBillForm);  </span><br><span class="line">    <span class="comment">//代驾费用信息  </span></span><br><span class="line">    BeanUtils.copyProperties(feeRuleResponseVo, updateOrderBillForm);  </span><br><span class="line">    <span class="comment">//分账相关信息  </span></span><br><span class="line">    BeanUtils.copyProperties(profitsharingRuleResponseVo, updateOrderBillForm);  </span><br><span class="line">    updateOrderBillForm.setProfitsharingRuleId(profitsharingRuleResponseVo.getProfitsharingRuleId());  </span><br><span class="line">    orderInfoFeignClient.endDrive(updateOrderBillForm);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="我的订单和异步编排"><a href="#我的订单和异步编排" class="headerlink" title="我的订单和异步编排"></a>我的订单和异步编排</h1><h2 id="我的订单"><a href="#我的订单" class="headerlink" title="我的订单"></a>我的订单</h2><ul>
<li>乘客端或司机端，都有我的订单，都可以查看用户所有的订单</li>
</ul>
<h3 id="乘客端我的订单"><a href="#乘客端我的订单" class="headerlink" title="乘客端我的订单"></a>乘客端我的订单</h3><h4 id="订单微服务接口-7"><a href="#订单微服务接口-7" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h4><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取乘客订单分页列表&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/findCustomerOrderPage/&#123;customerId&#125;/&#123;page&#125;/&#123;limit&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&gt; <span class="title function_">findCustomerOrderPage</span><span class="params">(<span class="meta">@PathVariable</span> Long customerId,  </span></span><br><span class="line"><span class="params">                                            <span class="meta">@PathVariable</span> Long page,  </span></span><br><span class="line"><span class="params">                                            <span class="meta">@PathVariable</span> Long limit)</span> &#123;  </span><br><span class="line">    <span class="comment">//创建page对象  </span></span><br><span class="line">    Page&lt;OrderInfo&gt; pageParam = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page,limit);  </span><br><span class="line">    <span class="comment">//调用service方法实现分页条件查询  </span></span><br><span class="line">    <span class="type">PageVo</span> <span class="variable">pageVo</span> <span class="operator">=</span> orderInfoService.findCustomerOrderPage(pageParam,customerId);  </span><br><span class="line">    pageVo.setPage(page);  </span><br><span class="line">    pageVo.setLimit(limit);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(pageVo);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//获取乘客订单分页列表  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> PageVo <span class="title function_">findCustomerOrderPage</span><span class="params">(Page&lt;OrderInfo&gt; pageParam, Long customerId)</span> &#123;  </span><br><span class="line">    IPage&lt;OrderListVo&gt; pageInfo =  orderInfoMapper.selectCustomerOrderPage(pageParam,customerId);  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageVo</span>&lt;&gt;(pageInfo.getRecords(),pageInfo.getPages(),pageInfo.getTotal());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="远程调用-20"><a href="#远程调用-20" class="headerlink" title="远程调用"></a>远程调用</h4><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 获取乘客订单分页列表  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> limit  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/findCustomerOrderPage/&#123;customerId&#125;/&#123;page&#125;/&#123;limit&#125;&quot;)</span>  </span><br><span class="line">Result&lt;PageVo&gt; <span class="title function_">findCustomerOrderPage</span><span class="params">(<span class="meta">@PathVariable(&quot;customerId&quot;)</span> Long customerId,  </span></span><br><span class="line"><span class="params">                                     <span class="meta">@PathVariable(&quot;page&quot;)</span> Long page,  </span></span><br><span class="line"><span class="params">                                     <span class="meta">@PathVariable(&quot;limit&quot;)</span> Long limit)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="乘客web端调用-1"><a href="#乘客web端调用-1" class="headerlink" title="乘客web端调用"></a>乘客web端调用</h4><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取乘客订单分页列表&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;findCustomerOrderPage/&#123;page&#125;/&#123;limit&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&gt; <span class="title function_">findCustomerOrderPage</span><span class="params">(  </span></span><br><span class="line"><span class="params">        <span class="meta">@Parameter(name = &quot;page&quot;, description = &quot;当前页码&quot;, required = true)</span>  </span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable</span> Long page,  </span></span><br><span class="line"><span class="params">  </span></span><br><span class="line"><span class="params">        <span class="meta">@Parameter(name = &quot;limit&quot;, description = &quot;每页记录数&quot;, required = true)</span>  </span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable</span> Long limit)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="type">PageVo</span> <span class="variable">pageVo</span> <span class="operator">=</span> orderService.findCustomerOrderPage(customerId, page, limit);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(pageVo);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取乘客订单分页列表  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> PageVo <span class="title function_">findCustomerOrderPage</span><span class="params">(Long customerId, Long page, Long limit)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.findCustomerOrderPage(customerId,page,limit).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--查询乘客订单分页--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectCustomerOrderPage&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.atguigu.daijia.model.vo.order.OrderListVo&quot;</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">        info.id,</span><br><span class="line">        info.order_no,</span><br><span class="line">        info.start_location,</span><br><span class="line">        info.end_location,</span><br><span class="line"></span><br><span class="line">        if(info.status <span class="symbol">&amp;lt;</span> 7, info.expect_amount, bill.pay_amount) as amount,</span><br><span class="line"></span><br><span class="line">        info.status,</span><br><span class="line">        info.create_time</span><br><span class="line">    from order_info info left join order_bill bill on info.id = bill.order_id</span><br><span class="line">    where info.customer_id = #&#123;customerId&#125;</span><br><span class="line">      and info.is_deleted =0</span><br><span class="line">    order by info.create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="司机端我的订单"><a href="#司机端我的订单" class="headerlink" title="司机端我的订单"></a>司机端我的订单</h3><h4 id="订单微服务接口-8"><a href="#订单微服务接口-8" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h4><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取司机订单分页列表&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/findDriverOrderPage/&#123;driverId&#125;/&#123;page&#125;/&#123;limit&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&gt; <span class="title function_">findDriverOrderPage</span><span class="params">(  </span></span><br><span class="line"><span class="params">        <span class="meta">@Parameter(name = &quot;driverId&quot;, description = &quot;司机id&quot;, required = true)</span>  </span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable</span> Long driverId,  </span></span><br><span class="line"><span class="params">        <span class="meta">@Parameter(name = &quot;page&quot;, description = &quot;当前页码&quot;, required = true)</span>  </span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable</span> Long page,  </span></span><br><span class="line"><span class="params">        <span class="meta">@Parameter(name = &quot;limit&quot;, description = &quot;每页记录数&quot;, required = true)</span>  </span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable</span> Long limit)</span> &#123;  </span><br><span class="line">    Page&lt;OrderInfo&gt; pageParam = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page, limit);  </span><br><span class="line">    <span class="type">PageVo</span> <span class="variable">pageVo</span> <span class="operator">=</span> orderInfoService.findDriverOrderPage(pageParam, driverId);  </span><br><span class="line">    pageVo.setPage(page);  </span><br><span class="line">    pageVo.setLimit(limit);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(pageVo);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取司机订单分页列表  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> PageVo <span class="title function_">findDriverOrderPage</span><span class="params">(Page&lt;OrderInfo&gt; pageParam, Long driverId)</span> &#123;  </span><br><span class="line">    IPage&lt;OrderListVo&gt; pageInfo =  orderInfoMapper.selectDriverOrderPage(pageParam,driverId);  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageVo</span>&lt;&gt;(pageInfo.getRecords(),pageInfo.getPages(),pageInfo.getTotal());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectDriverOrderPage&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.atguigu.daijia.model.vo.order.OrderListVo&quot;</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">        info.id,</span><br><span class="line">        info.order_no,</span><br><span class="line">        info.start_location,</span><br><span class="line">        info.end_location,</span><br><span class="line">        real_amount as pay_amount,</span><br><span class="line">        if(info.status <span class="symbol">&amp;lt;</span> 7, info.expect_amount, info.real_amount) as amount,</span><br><span class="line"></span><br><span class="line">        info.status,</span><br><span class="line">        info.create_time</span><br><span class="line">    from order_info info</span><br><span class="line">    where info.driver_id = #&#123;driverId&#125;</span><br><span class="line">    and info.is_deleted =0</span><br><span class="line">    order by info.create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="远程调用-21"><a href="#远程调用-21" class="headerlink" title="远程调用"></a>远程调用</h4><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 获取司机订单分页列表  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> limit  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/findDriverOrderPage/&#123;driverId&#125;/&#123;page&#125;/&#123;limit&#125;&quot;)</span>  </span><br><span class="line">Result&lt;PageVo&gt; <span class="title function_">findDriverOrderPage</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId,  </span></span><br><span class="line"><span class="params">                                   <span class="meta">@PathVariable(&quot;page&quot;)</span> Long page,  </span></span><br><span class="line"><span class="params">                                   <span class="meta">@PathVariable(&quot;limit&quot;)</span> Long limit)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="司机端web接口-3"><a href="#司机端web接口-3" class="headerlink" title="司机端web接口"></a>司机端web接口</h4><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取司机订单分页列表&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;findDriverOrderPage/&#123;page&#125;/&#123;limit&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&gt; <span class="title function_">findDriverOrderPage</span><span class="params">(  </span></span><br><span class="line"><span class="params">        <span class="meta">@Parameter(name = &quot;page&quot;, description = &quot;当前页码&quot;, required = true)</span>  </span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable</span> Long page,  </span></span><br><span class="line"><span class="params">        <span class="meta">@Parameter(name = &quot;limit&quot;, description = &quot;每页记录数&quot;, required = true)</span>  </span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable</span> Long limit)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="type">PageVo</span> <span class="variable">pageVo</span> <span class="operator">=</span> orderService.findDriverOrderPage(driverId, page, limit);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(pageVo);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取司机订单分页列表  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> PageVo <span class="title function_">findDriverOrderPage</span><span class="params">(Long driverId, Long page, Long limit)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.findDriverOrderPage(driverId,page,limit).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="异步编排"><a href="#异步编排" class="headerlink" title="异步编排"></a>异步编排</h2><ul>
<li>问题：司机结束订单后会有大量的远程调用，如果按照流程来会浪费大量时间</li>
<li>解决：使用多线程方式来完成这些操作</li>
</ul>
<h3 id="创建自定义线程池"><a href="#创建自定义线程池" class="headerlink" title="创建自定义线程池"></a>创建自定义线程池</h3><p>在config包下创建类ThreadPoolConfig</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolConfig</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">threadPoolExecutor</span><span class="params">()</span> &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//动态获取服务器核数  </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">processors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();  </span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(  </span><br><span class="line">                processors+<span class="number">1</span>, <span class="comment">// 核心线程个数 io:2n ,cpu: n+1  n:内核数据  </span></span><br><span class="line">                processors+<span class="number">1</span>,  </span><br><span class="line">                <span class="number">0</span>,  </span><br><span class="line">                TimeUnit.SECONDS,  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">3</span>),  </span><br><span class="line">                Executors.defaultThreadFactory(),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy()  </span><br><span class="line">        );  </span><br><span class="line">        <span class="keyword">return</span> threadPoolExecutor;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改web-driver之前的代码"><a href="#修改web-driver之前的代码" class="headerlink" title="修改web-driver之前的代码"></a>修改web-driver之前的代码</h3><p>修改前面driver-web里OrderServiceImpl的endDrive方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//使用多线程CompletableFuture实现  </span></span><br><span class="line"><span class="meta">@SneakyThrows</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">endDrive</span><span class="params">(OrderFeeForm orderFeeForm)</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//1 根据orderId获取订单信息，判断当前订单是否司机接单  </span></span><br><span class="line">    CompletableFuture&lt;OrderInfo&gt; orderInfoCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;  </span><br><span class="line">        <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderFeeForm.getOrderId()).getData();  </span><br><span class="line">        <span class="keyword">if</span> (orderInfo.getDriverId() != orderFeeForm.getDriverId()) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> orderInfo;  </span><br><span class="line">    &#125;);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//防止刷单  </span></span><br><span class="line">    CompletableFuture&lt;OrderServiceLastLocationVo&gt; orderServiceLastLocationVoCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;  </span><br><span class="line">        <span class="type">OrderServiceLastLocationVo</span> <span class="variable">orderServiceLastLocationVo</span> <span class="operator">=</span> locationFeignClient.getOrderServiceLastLocation(orderFeeForm.getOrderId()).getData();  </span><br><span class="line">        <span class="keyword">return</span> orderServiceLastLocationVo;  </span><br><span class="line">    &#125;);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//上面两个合并  </span></span><br><span class="line">    CompletableFuture.allOf(orderInfoCompletableFuture,  </span><br><span class="line">            orderServiceLastLocationVoCompletableFuture).join();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//获取两个线程执行结果  </span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoCompletableFuture.get();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderServiceLastLocationVo</span> <span class="variable">orderServiceLastLocationVo</span> <span class="operator">=</span> orderServiceLastLocationVoCompletableFuture.get();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//司机当前位置 距离 结束代驾位置  </span></span><br><span class="line">    <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> LocationUtil.getDistance(orderInfo.getEndPointLatitude().doubleValue(),  </span><br><span class="line">            orderInfo.getEndPointLongitude().doubleValue(),  </span><br><span class="line">            orderServiceLastLocationVo.getLatitude().doubleValue(),  </span><br><span class="line">            orderServiceLastLocationVo.getLongitude().doubleValue());  </span><br><span class="line">    <span class="keyword">if</span>(distance &gt; SystemConstant.DRIVER_END_LOCATION_DISTION) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DRIVER_END_LOCATION_DISTION_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//2 计算订单实际里程  </span></span><br><span class="line">    CompletableFuture&lt;BigDecimal&gt; realDistanceCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;  </span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">realDistance</span> <span class="operator">=</span>  </span><br><span class="line">                locationFeignClient.calculateOrderRealDistance(orderFeeForm.getOrderId()).getData();  </span><br><span class="line">        <span class="keyword">return</span> realDistance;  </span><br><span class="line">    &#125;);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//3 计算代驾实际费用  </span></span><br><span class="line">    CompletableFuture&lt;FeeRuleResponseVo&gt; feeRuleResponseVoCompletableFuture =  </span><br><span class="line">            realDistanceCompletableFuture.thenApplyAsync((realDistance) -&gt; &#123;  </span><br><span class="line">                <span class="comment">//远程调用，计算代驾费用  </span></span><br><span class="line">                <span class="comment">//封装FeeRuleRequestForm  </span></span><br><span class="line">                <span class="type">FeeRuleRequestForm</span> <span class="variable">feeRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();  </span><br><span class="line">                feeRuleRequestForm.setDistance(realDistance);  </span><br><span class="line">                feeRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">//计算司机到达代驾开始位置时间  </span></span><br><span class="line">                <span class="comment">//orderInfo.getArriveTime() - orderInfo.getAcceptTime()  </span></span><br><span class="line">                <span class="comment">// 分钟 = 毫秒 / 1000 * 60                Integer waitMinute =  </span></span><br><span class="line">                        Math.abs((<span class="type">int</span>) ((orderInfo.getArriveTime().getTime() - orderInfo.getAcceptTime().getTime()) / (<span class="number">1000</span> * <span class="number">60</span>)));  </span><br><span class="line">                feeRuleRequestForm.setWaitMinute(waitMinute);  </span><br><span class="line">                <span class="comment">//远程调用 代驾费用  </span></span><br><span class="line">                <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleFeignClient.calculateOrderFee(feeRuleRequestForm).getData();  </span><br><span class="line">                <span class="comment">//实际费用 = 代驾费用 + 其他费用（停车费）  </span></span><br><span class="line">                <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span>  </span><br><span class="line">                        feeRuleResponseVo.getTotalAmount().add(orderFeeForm.getTollFee())  </span><br><span class="line">                                .add(orderFeeForm.getParkingFee())  </span><br><span class="line">                                .add(orderFeeForm.getOtherFee())  </span><br><span class="line">                                .add(orderInfo.getFavourFee());  </span><br><span class="line">                feeRuleResponseVo.setTotalAmount(totalAmount);  </span><br><span class="line">                <span class="keyword">return</span> feeRuleResponseVo;  </span><br><span class="line">            &#125;);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//4 计算系统奖励  </span></span><br><span class="line">    CompletableFuture&lt;Long&gt; orderNumCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>) + <span class="string">&quot; 00:00:00&quot;</span>;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">endTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">&quot;yyyy-MM-dd&quot;</span>) + <span class="string">&quot; 24:00:00&quot;</span>;  </span><br><span class="line">        <span class="type">Long</span> <span class="variable">orderNum</span> <span class="operator">=</span> orderInfoFeignClient.getOrderNumByTime(startTime, endTime).getData();  </span><br><span class="line">        <span class="keyword">return</span> orderNum;  </span><br><span class="line">    &#125;);  </span><br><span class="line">  </span><br><span class="line">    CompletableFuture&lt;RewardRuleResponseVo&gt; rewardRuleResponseVoCompletableFuture =  </span><br><span class="line">            orderNumCompletableFuture.thenApplyAsync((orderNum) -&gt; &#123;  </span><br><span class="line">                <span class="comment">//4.2.封装参数  </span></span><br><span class="line">                <span class="type">RewardRuleRequestForm</span> <span class="variable">rewardRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleRequestForm</span>();  </span><br><span class="line">                rewardRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());  </span><br><span class="line">                rewardRuleRequestForm.setOrderNum(orderNum);  </span><br><span class="line">                <span class="type">RewardRuleResponseVo</span> <span class="variable">rewardRuleResponseVo</span> <span class="operator">=</span> rewardRuleFeignClient.calculateOrderRewardFee(rewardRuleRequestForm).getData();  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">return</span> rewardRuleResponseVo;  </span><br><span class="line">            &#125;);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//5 计算分账信息  </span></span><br><span class="line">    CompletableFuture&lt;ProfitsharingRuleResponseVo&gt; profitsharingRuleResponseVoCompletableFuture = feeRuleResponseVoCompletableFuture.thenCombineAsync(orderNumCompletableFuture,  </span><br><span class="line">            (feeRuleResponseVo, orderNum) -&gt; &#123;  </span><br><span class="line">                <span class="type">ProfitsharingRuleRequestForm</span> <span class="variable">profitsharingRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleRequestForm</span>();  </span><br><span class="line">                profitsharingRuleRequestForm.setOrderAmount(feeRuleResponseVo.getTotalAmount());  </span><br><span class="line">                profitsharingRuleRequestForm.setOrderNum(orderNum);  </span><br><span class="line">  </span><br><span class="line">                <span class="type">ProfitsharingRuleResponseVo</span> <span class="variable">profitsharingRuleResponseVo</span> <span class="operator">=</span> profitsharingRuleFeignClient.calculateOrderProfitsharingFee(profitsharingRuleRequestForm).getData();  </span><br><span class="line">                <span class="keyword">return</span> profitsharingRuleResponseVo;  </span><br><span class="line">            &#125;);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//合并  </span></span><br><span class="line">    CompletableFuture.allOf(  </span><br><span class="line">            orderInfoCompletableFuture,  </span><br><span class="line">            realDistanceCompletableFuture,  </span><br><span class="line">            feeRuleResponseVoCompletableFuture,  </span><br><span class="line">            orderNumCompletableFuture,  </span><br><span class="line">            rewardRuleResponseVoCompletableFuture,  </span><br><span class="line">            profitsharingRuleResponseVoCompletableFuture  </span><br><span class="line">    ).join();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//获取执行结果  </span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">realDistance</span> <span class="operator">=</span> realDistanceCompletableFuture.get();  </span><br><span class="line">    <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleResponseVoCompletableFuture.get();  </span><br><span class="line">    <span class="type">RewardRuleResponseVo</span> <span class="variable">rewardRuleResponseVo</span> <span class="operator">=</span> rewardRuleResponseVoCompletableFuture.get();  </span><br><span class="line">    <span class="type">ProfitsharingRuleResponseVo</span> <span class="variable">profitsharingRuleResponseVo</span> <span class="operator">=</span> profitsharingRuleResponseVoCompletableFuture.get();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//6 封装实体类，结束代驾更新订单，添加账单和分账信息  </span></span><br><span class="line">    <span class="type">UpdateOrderBillForm</span> <span class="variable">updateOrderBillForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateOrderBillForm</span>();  </span><br><span class="line">    updateOrderBillForm.setOrderId(orderFeeForm.getOrderId());  </span><br><span class="line">    updateOrderBillForm.setDriverId(orderFeeForm.getDriverId());  </span><br><span class="line">    <span class="comment">//路桥费、停车费、其他费用  </span></span><br><span class="line">    updateOrderBillForm.setTollFee(orderFeeForm.getTollFee());  </span><br><span class="line">    updateOrderBillForm.setParkingFee(orderFeeForm.getParkingFee());  </span><br><span class="line">    updateOrderBillForm.setOtherFee(orderFeeForm.getOtherFee());  </span><br><span class="line">    <span class="comment">//乘客好处费  </span></span><br><span class="line">    updateOrderBillForm.setFavourFee(orderInfo.getFavourFee());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//实际里程  </span></span><br><span class="line">    updateOrderBillForm.setRealDistance(realDistance);  </span><br><span class="line">    <span class="comment">//订单奖励信息  </span></span><br><span class="line">    BeanUtils.copyProperties(rewardRuleResponseVo, updateOrderBillForm);  </span><br><span class="line">    <span class="comment">//代驾费用信息  </span></span><br><span class="line">    BeanUtils.copyProperties(feeRuleResponseVo, updateOrderBillForm);  </span><br><span class="line">    <span class="comment">//分账相关信息  </span></span><br><span class="line">    BeanUtils.copyProperties(profitsharingRuleResponseVo, updateOrderBillForm);  </span><br><span class="line">    updateOrderBillForm.setProfitsharingRuleId(profitsharingRuleResponseVo.getProfitsharingRuleId());  </span><br><span class="line">    orderInfoFeignClient.endDrive(updateOrderBillForm);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="订单支付"><a href="#订单支付" class="headerlink" title="订单支付"></a>订单支付</h1><h2 id="账单信息"><a href="#账单信息" class="headerlink" title="账单信息"></a>账单信息</h2><ul>
<li>司机结束代价后，生成账单（包含账单信息和分账信息）</li>
</ul>
<h3 id="获取账单信息"><a href="#获取账单信息" class="headerlink" title="获取账单信息"></a>获取账单信息</h3><h4 id="订单微服务接口-9"><a href="#订单微服务接口-9" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h4><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;根据订单id获取实际账单信息&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderBillInfo/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderBillVo&gt; <span class="title function_">getOrderBillInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.getOrderBillInfo(orderId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 根据订单id获取实际账单信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> OrderBillVo <span class="title function_">getOrderBillInfo</span><span class="params">(Long orderId)</span> &#123;  </span><br><span class="line">    LambdaQueryWrapper&lt;OrderBill&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(OrderBill::getOrderId,orderId);  </span><br><span class="line">    <span class="type">OrderBill</span> <span class="variable">orderBill</span> <span class="operator">=</span> orderBillMapper.selectOne(wrapper);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderBillVo</span> <span class="variable">orderBillVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderBillVo</span>();  </span><br><span class="line">    BeanUtils.copyProperties(orderBill,orderBillVo);  </span><br><span class="line">    <span class="keyword">return</span> orderBillVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="远程调用-22"><a href="#远程调用-22" class="headerlink" title="远程调用"></a>远程调用</h4><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 根据订单id获取实际账单信息  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/getOrderBillInfo/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;OrderBillVo&gt; <span class="title function_">getOrderBillInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="获取分账信息"><a href="#获取分账信息" class="headerlink" title="获取分账信息"></a>获取分账信息</h3><h4 id="订单微服务接口-10"><a href="#订单微服务接口-10" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h4><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;根据订单id获取实际分账信息&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderProfitsharing/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderProfitsharingVo&gt; <span class="title function_">getOrderProfitsharing</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.getOrderProfitsharing(orderId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 根据订单id获取实际分账信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> OrderProfitsharingVo <span class="title function_">getOrderProfitsharing</span><span class="params">(Long orderId)</span> &#123;  </span><br><span class="line">    LambdaQueryWrapper&lt;OrderProfitsharing&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(OrderProfitsharing::getOrderId,orderId);  </span><br><span class="line">    <span class="type">OrderProfitsharing</span> <span class="variable">orderProfitsharing</span> <span class="operator">=</span> orderProfitsharingMapper.selectOne(wrapper);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderProfitsharingVo</span> <span class="variable">orderProfitsharingVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderProfitsharingVo</span>();  </span><br><span class="line">    BeanUtils.copyProperties(orderProfitsharing,orderProfitsharingVo);  </span><br><span class="line">    <span class="keyword">return</span> orderProfitsharingVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="远程调用-23"><a href="#远程调用-23" class="headerlink" title="远程调用"></a>远程调用</h4><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取实际分账信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/getOrderProfitsharing/&#123;orderId&#125;&quot;)</span></span><br><span class="line">Result&lt;OrderProfitsharingVo&gt; <span class="title function_">getOrderProfitsharing</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="司机端获取账单信息"><a href="#司机端获取账单信息" class="headerlink" title="司机端获取账单信息"></a>司机端获取账单信息</h3><p>方法之前有，只需要改service<br>OrderController&#96;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取订单账单详细信息&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderInfo/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderInfoVo&gt; <span class="title function_">getOrderInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getOrderInfo(orderId, driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取订单账单详细信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">getOrderInfo</span><span class="params">(Long orderId, Long driverId)</span> &#123;  </span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();  </span><br><span class="line">    <span class="keyword">if</span>(orderInfo.getDriverId() != driverId) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//获取账单和分账数据，封装到vo里面  </span></span><br><span class="line">    <span class="type">OrderBillVo</span> <span class="variable">orderBillVo</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="type">OrderProfitsharingVo</span> <span class="variable">orderProfitsharingVo</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="comment">//判断  </span></span><br><span class="line">    <span class="keyword">if</span>(orderInfo.getStatus() &gt;= OrderStatus.END_SERVICE.getStatus()) &#123;  </span><br><span class="line">        <span class="comment">//账单信息  </span></span><br><span class="line">        orderBillVo = orderInfoFeignClient.getOrderBillInfo(orderId).getData();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//分账信息  </span></span><br><span class="line">        orderProfitsharingVo = orderInfoFeignClient.getOrderProfitsharing(orderId).getData();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderInfoVo</span> <span class="variable">orderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoVo</span>();  </span><br><span class="line">    orderInfoVo.setOrderId(orderId);  </span><br><span class="line">    BeanUtils.copyProperties(orderInfo,orderInfoVo);  </span><br><span class="line">    orderInfoVo.setOrderBillVo(orderBillVo);  </span><br><span class="line">    orderInfoVo.setOrderProfitsharingVo(orderProfitsharingVo);  </span><br><span class="line">    <span class="keyword">return</span> orderInfoVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="司机发送账单"><a href="#司机发送账单" class="headerlink" title="司机发送账单"></a>司机发送账单</h3><h4 id="订单微服务接口-11"><a href="#订单微服务接口-11" class="headerlink" title="订单微服务接口"></a>订单微服务接口</h4><p>OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;发送账单信息&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/sendOrderBillInfo/&#123;orderId&#125;/&#123;driverId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">sendOrderBillInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId, <span class="meta">@PathVariable</span> Long driverId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.sendOrderBillInfo(orderId, driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 发送账单信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">sendOrderBillInfo</span><span class="params">(Long orderId, Long driverId)</span> &#123;  </span><br><span class="line">    <span class="comment">//更新订单信息  </span></span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    queryWrapper.eq(OrderInfo::getId, orderId);  </span><br><span class="line">    queryWrapper.eq(OrderInfo::getDriverId, driverId);  </span><br><span class="line">    <span class="comment">//更新字段  </span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">updateOrderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();  </span><br><span class="line">    updateOrderInfo.setStatus(OrderStatus.UNPAID.getStatus());  </span><br><span class="line">    <span class="comment">//只能更新自己的订单  </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> orderInfoMapper.update(updateOrderInfo, queryWrapper);  </span><br><span class="line">    <span class="keyword">if</span>(row == <span class="number">1</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="远程调用-24"><a href="#远程调用-24" class="headerlink" title="远程调用"></a>远程调用</h4><p>OrderInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 司机发送账单信息  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/sendOrderBillInfo/&#123;orderId&#125;/&#123;driverId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">sendOrderBillInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId, <span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="司机web端调用-3"><a href="#司机web端调用-3" class="headerlink" title="司机web端调用"></a>司机web端调用</h4><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;司机发送账单信息&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/sendOrderBillInfo/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">sendOrderBillInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.sendOrderBillInfo(orderId, driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 司机发送账单信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">sendOrderBillInfo</span><span class="params">(Long orderId, Long driverId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.sendOrderBillInfo(orderId, driverId).getData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="乘客获取账单"><a href="#乘客获取账单" class="headerlink" title="乘客获取账单"></a>乘客获取账单</h3><p>也是修改之前写过的代码，只需要修改service<br>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取订单信息&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderInfo/&#123;orderId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderInfoVo&gt; <span class="title function_">getOrderInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getOrderInfo(orderId, customerId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取订单信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">getOrderInfo</span><span class="params">(Long orderId, Long customerId)</span> &#123;  </span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();  </span><br><span class="line">    <span class="comment">//判断  </span></span><br><span class="line">    <span class="keyword">if</span>(orderInfo.getCustomerId() != customerId) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//获取司机信息  </span></span><br><span class="line">    <span class="type">DriverInfoVo</span> <span class="variable">driverInfoVo</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> orderInfo.getDriverId();  </span><br><span class="line">    <span class="keyword">if</span>(driverId != <span class="literal">null</span>) &#123;  </span><br><span class="line">        driverInfoVo = driverInfoFeignClient.getDriverInfo(driverId).getData();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//获取账单信息  </span></span><br><span class="line">    <span class="type">OrderBillVo</span> <span class="variable">orderBillVo</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="keyword">if</span>(orderInfo.getStatus() &gt;= OrderStatus.UNPAID.getStatus()) &#123;  </span><br><span class="line">        orderBillVo = orderInfoFeignClient.getOrderBillInfo(orderId).getData();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">OrderInfoVo</span> <span class="variable">orderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoVo</span>();  </span><br><span class="line">    orderInfoVo.setOrderId(orderId);  </span><br><span class="line">    BeanUtils.copyProperties(orderInfo,orderInfoVo);  </span><br><span class="line">    orderInfoVo.setOrderBillVo(orderBillVo);  </span><br><span class="line">    orderInfoVo.setDriverInfoVo(driverInfoVo);  </span><br><span class="line">    <span class="keyword">return</span> orderInfoVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="微信支付"><a href="#微信支付" class="headerlink" title="微信支付"></a>微信支付</h2><h3 id="准备接口"><a href="#准备接口" class="headerlink" title="准备接口"></a>准备接口</h3><h4 id="获取乘客openid"><a href="#获取乘客openid" class="headerlink" title="获取乘客openid"></a>获取乘客openid</h4><p>service-customer中的CustomerInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取客户OpenId&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getCustomerOpenId/&#123;customerId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">getCustomerOpenId</span><span class="params">(<span class="meta">@PathVariable</span> Long customerId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(customerInfoService.getCustomerOpenId(customerId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取客户OpenId  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getCustomerOpenId</span><span class="params">(Long customerId)</span> &#123;  </span><br><span class="line">    LambdaQueryWrapper&lt;CustomerInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();  </span><br><span class="line">    wrapper.eq(CustomerInfo::getId,customerId);  </span><br><span class="line">    <span class="type">CustomerInfo</span> <span class="variable">customerInfo</span> <span class="operator">=</span> customerInfoMapper.selectOne(wrapper);  </span><br><span class="line">    <span class="keyword">return</span> customerInfo.getWxOpenId();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>远程调用</p>
<p>CustomerInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 获取客户OpenId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/customer/info/getCustomerOpenId/&#123;customerId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;String&gt; <span class="title function_">getCustomerOpenId</span><span class="params">(<span class="meta">@PathVariable(&quot;customerId&quot;)</span> Long customerId)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="获取司机openid"><a href="#获取司机openid" class="headerlink" title="获取司机openid"></a>获取司机openid</h4><p>service-driver中DriverInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取司机OpenId&quot;)</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/getDriverOpenId/&#123;driverId&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">getDriverOpenId</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverInfoService.getDriverOpenId(driverId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>serivce</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取司机OpenId  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDriverOpenId</span><span class="params">(Long driverId)</span> &#123;  </span><br><span class="line">    <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;DriverInfo&gt;().eq(DriverInfo::getId, driverId).select(DriverInfo::getWxOpenId));  </span><br><span class="line">    <span class="keyword">return</span> driverInfo.getWxOpenId();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>远程调用</p>
<p>DriverInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 获取司机OpenId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/driver/info/getDriverOpenId/&#123;driverId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;String&gt; <span class="title function_">getDriverOpenId</span><span class="params">(<span class="meta">@PathVariable(&quot;driverId&quot;)</span> Long driverId)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="获取支付信息"><a href="#获取支付信息" class="headerlink" title="获取支付信息"></a>获取支付信息</h4><p>service-order中OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;获取订单支付信息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOrderPayVo/&#123;orderNo&#125;/&#123;customerId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderPayVo&gt; <span class="title function_">getOrderPayVo</span><span class="params">(<span class="meta">@PathVariable</span> String orderNo, <span class="meta">@PathVariable</span> Long customerId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.getOrderPayVo(orderNo, customerId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取订单支付信息  </span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> OrderPayVo <span class="title function_">getOrderPayVo</span><span class="params">(String orderNo, Long customerId)</span> &#123;  </span><br><span class="line">    <span class="type">OrderPayVo</span> <span class="variable">orderPayVo</span> <span class="operator">=</span> orderInfoMapper.selectOrderPayVo(orderNo,customerId);  </span><br><span class="line">    <span class="keyword">if</span>(orderPayVo != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> orderPayVo.getStartLocation() + <span class="string">&quot; 到 &quot;</span>+orderPayVo.getEndLocation();  </span><br><span class="line">        orderPayVo.setContent(content);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> orderPayVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>远程调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 获取订单支付信息  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderNo  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/order/info/getOrderPayVo/&#123;orderNo&#125;/&#123;customerId&#125;&quot;)</span>  </span><br><span class="line">Result&lt;OrderPayVo&gt; <span class="title function_">getOrderPayVo</span><span class="params">(<span class="meta">@PathVariable(&quot;orderNo&quot;)</span> String orderNo, <span class="meta">@PathVariable(&quot;customerId&quot;)</span> Long customerId)</span>;</span><br></pre></td></tr></table></figure>


<h3 id="微信支付接口"><a href="#微信支付接口" class="headerlink" title="微信支付接口"></a>微信支付接口</h3><p>在service-payment下</p>
<ul>
<li><p>导入依赖</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;com.github.wechatpay-apiv3&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;wechatpay-java&lt;/artifactId&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix=&quot;wx.v3pay&quot;)</span> <span class="comment">//读取节点  </span></span><br><span class="line"><span class="meta">@Data</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxPayV3Properties</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String appid;  </span><br><span class="line">    <span class="comment">/** 商户号 */</span>  </span><br><span class="line">    <span class="keyword">public</span> String merchantId;  </span><br><span class="line">    <span class="comment">/** 商户API私钥路径 */</span>  </span><br><span class="line">    <span class="keyword">public</span> String privateKeyPath;  </span><br><span class="line">    <span class="comment">/** 商户证书序列号 */</span>  </span><br><span class="line">    <span class="keyword">public</span> String merchantSerialNumber;  </span><br><span class="line">    <span class="comment">/** 商户APIV3密钥 */</span>  </span><br><span class="line">    <span class="keyword">public</span> String apiV3key;  </span><br><span class="line">    <span class="comment">/** 回调地址 */</span>  </span><br><span class="line">    <span class="keyword">private</span> String notifyUrl;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> RSAAutoCertificateConfig <span class="title function_">getConfig</span><span class="params">()</span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RSAAutoCertificateConfig</span>.Builder()  </span><br><span class="line">                .merchantId(<span class="built_in">this</span>.getMerchantId())  </span><br><span class="line">                .privateKeyFromPath(<span class="built_in">this</span>.getPrivateKeyPath())  </span><br><span class="line">                .merchantSerialNumber(<span class="built_in">this</span>.getMerchantSerialNumber())  </span><br><span class="line">                .apiV3Key(<span class="built_in">this</span>.getApiV3key())  </span><br><span class="line">                .build();  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>WxPayController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> WxPayService wxPayService;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Operation(summary = &quot;创建微信支付&quot;)</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/createJsapi&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;WxPrepayVo&gt; <span class="title function_">createWxPayment</span><span class="params">(<span class="meta">@RequestBody</span> PaymentInfoForm paymentInfoForm)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(wxPayService.createWxPayment(paymentInfoForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>远程调用</li>
</ul>
<p>WxPayFeignClient</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 创建微信支付  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> paymentInfoForm  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/payment/wxPay/createWxPayment&quot;)</span>  </span><br><span class="line">Result&lt;WxPrepayVo&gt; <span class="title function_">createWxPayment</span><span class="params">(<span class="meta">@RequestBody</span> PaymentInfoForm paymentInfoForm)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>乘客web端调用</li>
</ul>
<p>OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;创建微信支付&quot;)</span>  </span><br><span class="line"><span class="meta">@LoginDetection</span>  </span><br><span class="line"><span class="meta">@PostMapping(&quot;/createWxPayment&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result&lt;WxPrepayVo&gt; <span class="title function_">createWxPayment</span><span class="params">(<span class="meta">@RequestBody</span> CreateWxPaymentForm createWxPaymentForm)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();  </span><br><span class="line">    createWxPaymentForm.setCustomerId(customerId);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.createWxPayment(createWxPaymentForm));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> WxPrepayVo <span class="title function_">createWxPayment</span><span class="params">(CreateWxPaymentForm createWxPaymentForm)</span> &#123;  </span><br><span class="line">    <span class="comment">//获取订单支付信息  </span></span><br><span class="line">    <span class="type">OrderPayVo</span> <span class="variable">orderPayVo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderPayVo(createWxPaymentForm.getOrderNo(),  </span><br><span class="line">            createWxPaymentForm.getCustomerId()).getData();  </span><br><span class="line">    <span class="comment">//判断  </span></span><br><span class="line">    <span class="keyword">if</span>(orderPayVo.getStatus() != OrderStatus.UNPAID.getStatus()) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//获取乘客和司机openid  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">customerOpenId</span> <span class="operator">=</span> customerInfoFeignClient.getCustomerOpenId(orderPayVo.getCustomerId()).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">driverOpenId</span> <span class="operator">=</span> driverInfoFeignClient.getDriverOpenId(orderPayVo.getDriverId()).getData();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//封装需要数据到实体类，远程调用发起微信支付  </span></span><br><span class="line">    <span class="type">PaymentInfoForm</span> <span class="variable">paymentInfoForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaymentInfoForm</span>();  </span><br><span class="line">    paymentInfoForm.setCustomerOpenId(customerOpenId);  </span><br><span class="line">    paymentInfoForm.setDriverOpenId(driverOpenId);  </span><br><span class="line">    paymentInfoForm.setOrderNo(orderPayVo.getOrderNo());  </span><br><span class="line">    paymentInfoForm.setAmount(orderPayVo.getPayAmount());  </span><br><span class="line">    paymentInfoForm.setContent(orderPayVo.getContent());  </span><br><span class="line">    paymentInfoForm.setPayWay(<span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">WxPrepayVo</span> <span class="variable">wxPrepayVo</span> <span class="operator">=</span> wxPayFeignClient.createWxPayment(paymentInfoForm).getData();  </span><br><span class="line">    <span class="keyword">return</span> wxPrepayVo;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="支付结果查询"><a href="#支付结果查询" class="headerlink" title="支付结果查询"></a>支付结果查询</h3>]]></content>
      <tags>
        <tag>project</tag>
      </tags>
  </entry>
  <entry>
    <title>定时计划</title>
    <url>/2025/02/17/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/14.%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/%E5%AE%9A%E6%97%B6%E8%AE%A1%E5%88%92/</url>
    <content><![CDATA[<h1 id="基本的定时任务"><a href="#基本的定时任务" class="headerlink" title="基本的定时任务"></a>基本的定时任务</h1><ul>
<li><p><code>Windows</code>运行批处理文件</p>
</li>
<li><p><code>Windows</code>任务计划程序（右键<code>我的电脑</code>）</p>
</li>
<li><p><code>Linux</code>命令—<code>CronJob</code></p>
</li>
<li><p>应用程序编码层—单机定时任务（<code>Timer—Java</code>、<code>Ticker—Go</code>、<code>ScheduledExecutorService</code>—线程池技术）</p>
</li>
<li><p>任务调度—<code>Quartz</code>（单任务极致控制、没有负载均衡机制）</p>
</li>
<li><p>分布式定时任务（平台化管理、分布式部署、支持海量数据）</p>
</li>
</ul>
<h1 id="分布式定时任务"><a href="#分布式定时任务" class="headerlink" title="分布式定时任务"></a>分布式定时任务</h1><ul>
<li><p>定时任务是指系统为了自动完成特定任务，<strong>实时、延时、周期性</strong>完成任务调度的过程。</p>
</li>
<li><p>分布式定时任务是把分散的、可靠性差的定时任务纳入统一的平台，并实现集群管理调度和分布式部署的一种定时任务的管理方式。</p>
</li>
</ul>
<p>按触发时机分类:</p>
<ul>
<li>定时任务：特定时间触发，比如今天15:06执行</li>
<li>延时任务：延时触发，比如10s后执行</li>
<li>周期任务：固定周期时间，或固定频率周期调度触发，比如每天12点或者每隔5s执行</li>
</ul>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul>
<li>自动化：全自动完成定时任务的认度和执行</li>
<li>平台化：基于平台化的思维管控系列的分布式定时任务</li>
<li>分布式：在分布式系统环境下运行任务调度，突破单机定时任务的性能瓶颈</li>
<li>伸缩性：采用集群方式部署，可随时按需扩缩容</li>
<li>高可用：单点故障不影响最终任结果，可以做到故障转移</li>
</ul>
<h3 id="执行方式"><a href="#执行方式" class="headerlink" title="执行方式"></a>执行方式</h3><ul>
<li><p>单机任务：随机触发一台机器执行任务，适用于计算量小、并发度低的任务</p>
</li>
<li><p>广播任务：广播到所有机器上执行同一个任务，比如所有机器一起清理日志</p>
</li>
<li><p>Map任务：一个任务可以分出多个子任务，每个子任务负责一部分的计算。适用于计算量单机无法满足要求的任务</p>
</li>
<li><p>MapReduce任务：在Map任务的基础上，还可以对所有子任务的结果做汇总计算，适用于计算量大，并且需要对子任务结果做汇总的任务</p>
</li>
</ul>
<h3 id="业内定时任务框架"><a href="#业内定时任务框架" class="headerlink" title="业内定时任务框架"></a>业内定时任务框架</h3><p><img src="/p1.png" class="lazyload" data-srcset="/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h3 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h3><p>分布式定时任务VS单机定时任务</p>
<ul>
<li>关系:<ul>
<li>都可以实现自动化的定时、延时、周期任务调度</li>
</ul>
</li>
<li>差异:<ul>
<li>分布式定时任务可支撑更大的业务体量</li>
<li>分布式定时任务的性能、伸缩性、稳定性更高</li>
</ul>
</li>
</ul>
<p>分布式定时任务VS大数据处理引擎</p>
<ul>
<li>关系:<ul>
<li>都可以对海量数据做处理</li>
<li>性能、伸缩性、稳定性都很高</li>
</ul>
</li>
<li>差异:<ul>
<li>定时并不是大数据处理引擎要解决的核心问题</li>
<li>大数据处理引擎往往致力于将源数据处理成结果数据，分布式定时任务除了能做这个之外，还可以调用HTTP和RPC服务</li>
</ul>
</li>
</ul>
<h1 id="核心架构"><a href="#核心架构" class="headerlink" title="核心架构"></a>核心架构</h1><p>分布式定时任务核心要解决<strong>触发、调度、执行</strong>三个关键问题</p>
<ul>
<li><p>触发器：Trigger，解析任务，生成触发事件</p>
<ul>
<li>这个定时任务在什么时间点被准时准点的触发</li>
</ul>
</li>
<li><p>调度器：Scheduler，分配任务，管理任务生命周期</p>
<ul>
<li>这个任务触发了怎么去协调机器来进行任务的调度</li>
</ul>
</li>
<li><p>执行器：Executor，获取执行任务单元，执行任务逻辑</p>
<ul>
<li>单台机器怎么去把分配的任务执行好，遇到故障的回复等等</li>
</ul>
</li>
</ul>
<p>除此之外，还需要提供一个控制台(Admin)，:提供任务管理和干预的功能。</p>
<p><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="控制台"><a href="#控制台" class="headerlink" title="控制台"></a>控制台</h2><p><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<ul>
<li><p>任务:Job，任务元数据</p>
<ul>
<li>任务元数据(Job)是用户对任务属性定义（who），包括任务类型调度时机（when）、执行行为（what）、执行方式（how）等</li>
</ul>
</li>
<li><p>任务实例:Joblnstance,任务运行的实例</p>
<ul>
<li>任务实例(Joblnstance)是一个确定的 Job 的一次运行实例（Job_id、触发时间、状态&amp;结果、过程消息）</li>
</ul>
</li>
<li><p>任务结果:JobResult，任务实例运行的结果</p>
</li>
<li><p>任务历史:JobHistory，用户可以修改任务信息，任务实例对应的任务元数据可以不同，因而使用任务历史存储</p>
</li>
</ul>
<h2 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h2><p><strong>核心职责</strong></p>
<ul>
<li>给定一系列任务，解析它们的触发规则，在规定的时间点触发任务的调度</li>
</ul>
<p><strong>设计约束</strong></p>
<ul>
<li>需支持大量任务</li>
<li>需支持秒级的调度</li>
<li>周期任务需要多次执行</li>
<li>需保证秒级扫描的高性能，并避免资源浪费</li>
</ul>
<h3 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h3><p>时间轮 ( Quartz 所用方案)时间轮是一种高效利用线程资源进行批量化调度的一种调度模型。时间轮是一个存储环形队列，底层采用数组实现，数组中的每个元素可以存放一个定时任务列表。</p>
<p><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>不同业务之间，任务的调度相互影响怎么办？负责扫描和触发的机器挂了怎么办？</p>
<ul>
<li>存储上：不同国别、业务做资源隔离</li>
<li>运行上：不同国别、业务分开执行</li>
<li>部署时：采用多机房集群化部署，避免单点故障，通过数据库锁或分布式锁保证任务只被触发一次</li>
</ul>
<h2 id="调度器"><a href="#调度器" class="headerlink" title="调度器"></a>调度器</h2><h3 id="资源来源"><a href="#资源来源" class="headerlink" title="资源来源"></a>资源来源</h3><ul>
<li><p>业务系统提供资源（阿里、美团、字节）</p>
<ul>
<li>优点：任务执行逻辑与业务系统共用一份资源，利用率高</li>
<li>缺点：更容易发生定时任务脚本影响在线业务的事故；不能由定时任务平台控制扩缩容</li>
</ul>
</li>
<li><p>定时任务平台提供机器资源（字节）</p>
<ul>
<li>优点：任务执行逻辑与业务系统提供的在线服务隔离，避免相互影响，可以优化扩缩容</li>
<li>缺点：消耗更多机器资源；需要额外为定时任务平台申请接口调用权限，而不能直接继承业务系统的权限</li>
</ul>
</li>
</ul>
<h3 id="节点选择"><a href="#节点选择" class="headerlink" title="节点选择"></a>节点选择</h3><ul>
<li><strong>随机节点执行</strong>：选择集群中一个可用的执行节点执行调度任务。适用场景：定时对账，</li>
<li><strong>广播执行</strong>：在集群中所有的执行节点分发调度任务并执行。适用场景：批量运维。</li>
<li><strong>分片执行</strong>：按照用户自定义分片逻辑进行拆分，分发到集群中不同节点并行执行，提升资源利用效率。适用场景：海量日志统计。</li>
</ul>
<p><strong>任务分片</strong>：<br><img src="/p5.png" class="lazyload" data-srcset="/p5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h3 id="高级特性"><a href="#高级特性" class="headerlink" title="高级特性"></a>高级特性</h3><ul>
<li><p><strong>任务编排</strong>：使用有向无环图 DAG(Directed Acyclic Graph)进行可视化任务编排</p>
<ul>
<li>N个执行器Executor，M个业务数据区段，最好M&gt;&#x3D;N，且M是N的整数倍</li>
</ul>
</li>
<li><p><strong>故障转移</strong>：分片任务基于一致性Hash策略分发任务，当某个执行器异常时，调度器会将任务分发到其他执行器。</p>
<ul>
<li>分片任务基于一致性hash策略分发任务，当某Executor异常时，调度器会将任务分发到其他Executor</li>
</ul>
</li>
<li><p><strong>高可用</strong>：调度器可以集群部署，做到完全无状态，靠消息队列的重试机制保障任务一定会被调度。</p>
</li>
</ul>
<p>上半图为故障转移的分发任务，下半图为高可用的消息队列重试机制<br><img src="/p6.png" class="lazyload" data-srcset="/p6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="执行器"><a href="#执行器" class="headerlink" title="执行器"></a>执行器</h2><p><img src="/p7.png" class="lazyload" data-srcset="/p7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br>基于注册中心，可以做到执行器的弹性扩缩容</p>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>Git</title>
    <url>/2025/01/15/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1.Git/Git/</url>
    <content><![CDATA[<h2 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h2><p>在study文件下创建一个git，名字叫blog</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir study</span><br><span class="line">cd study</span><br><span class="line">git init blog</span><br></pre></td></tr></table></figure>

<p>其他参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--initial-branch  初始化的分支</span><br><span class="line">--bare  创建一个裸仓库(纯 Git 目录，没有工作目录)</span><br><span class="line">--template  可以通过模板来创建预先构建好的自定义 git 目录</span><br></pre></td></tr></table></figure>

<h2 id="Git-Config"><a href="#Git-Config" class="headerlink" title="Git Config"></a>Git Config</h2><p>不同级别的 Git 配置</p>
<ul>
<li>**–global   </li>
<li>**–system</li>
<li>**–local</li>
</ul>
<p>每个级别的配置可能会重复，但是低级别的配置会覆盖高级别的配置</p>
<p>system &gt; global &gt; local</p>
<h2 id="常见-Git-配置"><a href="#常见-Git-配置" class="headerlink" title="常见 Git 配置"></a>常见 Git 配置</h2><h3 id="用户名配置"><a href="#用户名配置" class="headerlink" title="用户名配置"></a>用户名配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config --global user.name &quot;用户名&quot;</span><br><span class="line">git config --global user.email &quot;用户邮箱地址&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Instead-of-配置"><a href="#Instead-of-配置" class="headerlink" title="Instead of 配置"></a>Instead of 配置</h3><p>配置命令可以用于将 Git 命令中的 URL 映射到另一个 URL<br>比如下面把 <code>git@github.com</code> 映射成 <code>https://github.com/</code> ：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config --global url.git@github.com:.insteadOf https://github.com/</span><br></pre></td></tr></table></figure>

<h3 id="Git-命令别名配置"><a href="#Git-命令别名配置" class="headerlink" title="Git 命令别名配置"></a>Git 命令别名配置</h3><p>可以用来简化命令<br>比如下面把 <code>commit --amend --no-edit</code> 改成 <code>cin</code> ：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config --global alias.cin &quot;commit --amend --no-edit&quot;</span><br></pre></td></tr></table></figure>

<h2 id="Git-Remote"><a href="#Git-Remote" class="headerlink" title="Git Remote"></a>Git Remote</h2><p>列出当前仓库中已配置的远程仓库，并显示它们的 URL</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git remote -v</span><br></pre></td></tr></table></figure>

<p>添加一个新的远程仓库。指定一个远程仓库的名称和 URL，将其添加到当前仓库中<br><code>git remote add &lt;remote_name&gt; &lt;remote_url&gt;</code><br>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git remote add origin_ssh git@github.com:git/git.git</span><br><span class="line">git remote add origin_http https://github.com/git/git.git</span><br></pre></td></tr></table></figure>

<p>其他关于 Remote 命令可以通过 <code>git remote -h</code> 来查看</p>
<h2 id="Git-Add"><a href="#Git-Add" class="headerlink" title="Git Add"></a>Git Add</h2><p>目执行 <code>git status</code> 查看 git 状态，可以看到一个新的管理的项目目前没有任何提交，然后我们在这个目录下创建一个 &#x3D;&#x3D;readme.md&#x3D;&#x3D; 文件，使用 <code>touch readme.md</code> ，然后再通过 <code>git status</code> 查看状态</p>
<p>在git中，文件的状态只有三种(已修改、已暂存、已提交)</p>
<ul>
<li><strong>已修改</strong><ul>
<li>在工作目录修改Git文件</li>
</ul>
</li>
<li><strong>已暂存</strong><ul>
<li>对已修改的文件执行Git暂存操作(git add)，将文件存入暂存区</li>
</ul>
</li>
<li><strong>已提交</strong><ul>
<li>将已暂存的文件执行Git提交操作(git commit)，将文件存入版本库</li>
</ul>
</li>
</ul>
<p>我们对文件的各种操作新建、编辑(写代码)都是在<code>工作区</code>完成的，但是工作区的文件还是不被Git所管理的，Git会告诉你 read.me 是未被追踪的文件，需要执行<code>git add 文件名</code>把 readme.md 提交到<code>暂存区</code>以便纳入到Git版本管理中来</p>
<p>我们来执行git add 操作，然后再查看状态,可以看到index.php已经被暂存，如果我们想把现在的暂存撤销，可以使用<code>git rm --cached readme.md</code> 命令来撤销，如果想提交到版本库，就再执行git commit操作就可以了</p>
<p>在暂存区的文件使用<code>git commit readme.md -m&quot;备注&quot;</code>提交到版本库中</p>
<p>如果修改了文件并且上传，想要返回上次上次的快照，可以通过查看git status可以看到文件状态被改变了。可以把工作区修改的文件git add提交到暂存区，也可以使用 <code>git checkout —- readme.md</code> 把工作区的修改撤销，这样，文件就会回退到上一次提交时的状态。</p>
<h3 id="Objects-对象"><a href="#Objects-对象" class="headerlink" title="Objects 对象"></a>Objects 对象</h3><p>Git对象一共有三种：数据对象、树对象以及提交对象，这些对象都被保存在了.git&#x2F;objects目录下</p>
<ul>
<li><strong>Blob</strong><ul>
<li>存储文件的内容</li>
</ul>
</li>
<li><strong>Tree</strong><ul>
<li>存储文件的目录信息</li>
</ul>
</li>
<li><strong>Commit</strong><ul>
<li>存储提交信息，一个 Commit 可以对应唯一的版本的代码</li>
</ul>
</li>
</ul>
<p>通过 Commit 寻找到 Tree 信息，每个 Commit 都会存储对应的 Tree ID<br>使用 <code>tree .git</code> 查看 objects 中的所有信息，找到ID，然后使用 <code>git cat-file -p CommitID</code>，就能看到Tree ID 和 作者</p>
<p>通过 Tree 存储信息可以获取到对应的目录树信息，也是用 <code>git cat-file -p TreeID</code></p>
<p>从 Tree 中获取 Blob 的 ID， <code>git cat-file -p BlobID</code> 获取到对应的文件内容<br><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1.Git/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1.Git/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="Refs分支"><a href="#Refs分支" class="headerlink" title="Refs分支"></a>Refs分支</h2><h3 id="新建、切换分支"><a href="#新建、切换分支" class="headerlink" title="新建、切换分支"></a>新建、切换分支</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">切换分支：git checkout 分支名 </span><br><span class="line">新建分支：git checkout -b 分支名</span><br></pre></td></tr></table></figure>

<h3 id="Tag"><a href="#Tag" class="headerlink" title="Tag"></a>Tag</h3><p>标签一般表示一个稳定的版本，指向一个 Commit 一般不会变更</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git tag -a 版本号 -m &quot;备注&quot;</span><br></pre></td></tr></table></figure>


<h3 id="修改历史版本"><a href="#修改历史版本" class="headerlink" title="修改历史版本"></a>修改历史版本</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git commit --amend</span><br></pre></td></tr></table></figure>

<h2 id="Git-Clone-Pull-Fetch"><a href="#Git-Clone-Pull-Fetch" class="headerlink" title="Git Clone &amp; Pull &amp; Fetch"></a>Git Clone &amp; Pull &amp; Fetch</h2><ul>
<li><strong>Clone</strong><ul>
<li>拉取完整的仓库到本地目录，可以指定分支，深度</li>
</ul>
</li>
<li><strong>Fetch</strong><ul>
<li>将远端某些分支最新代码拉取到本地，不会执行 merger 操作，会修改 refs&#x2F;remote 内的分支信息，如果需要和本地代码合并需要手动操作</li>
</ul>
</li>
<li><strong>Pull</strong><ul>
<li>拉取远端某些分支，并和本地代码进行合并，操作等同于 git fetch + git merger，也可以通过 git pull –rebase 完成 git fetch + git rebase 操作，<strong>可能存在冲突，需要手动解决冲突</strong></li>
</ul>
</li>
</ul>
<p><strong>关于 Fetch ，Fetch 会把代码拉取到本地的远端分支，但是并不会合并到当前分支，所以当前分支历史没有变化</strong></p>
<h2 id="Git-Push"><a href="#Git-Push" class="headerlink" title="Git Push"></a>Git Push</h2><p>将本地代码同步到远端的方式</p>
<p>一般使用 <code>git push origin 分支名</code></p>
<p><strong>冲突问题</strong></p>
<ul>
<li>如果本地的 commit 记录和远端的 commit 历史不一致，则会发生冲突，比如 git commit –amend or git rebase 都有可能导致这个问题</li>
<li>如果该分支就自己一个人使用，或者团队内确认可以修改历史则可以通过 <code>git push origin 分支名 -f</code> 来完成强制推送，一般不建议主干分支进行该操作，正常都应该解决冲突后再进行推送</li>
</ul>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>后端框架的剖析</title>
    <url>/2025/02/14/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/13.%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6%E5%89%96%E6%9E%90/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6%E7%9A%84%E5%89%96%E6%9E%90/</url>
    <content><![CDATA[<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p>架构，又称软件架构</p>
<ul>
<li>是有关软件整体结构与组件的抽象描述</li>
<li>用于指导软件系统各个方面的设计</li>
</ul>
<h1 id="单机架构"><a href="#单机架构" class="headerlink" title="单机架构"></a>单机架构</h1><p>软件系统需要具备对外提供服务，单机，就是把所有功能都实现在一个进程里，并部署在一台机器上</p>
<p>优点:</p>
<ul>
<li>简单</li>
</ul>
<p>问题</p>
<ul>
<li><ul>
<li>C10K问题（Concurrent 10,000 Connection）：服务器如何支持10K个并发连接，进行高性能网络编程。解决方式：采用IO复用模型epoll方法，在调用返回时，只给应用提供发生了状态变化的文件句柄，不需要轮询fd（文件描述符）</li>
</ul>
</li>
<li>运维需要停服</li>
</ul>
<h2 id="单体、垂直应用-垂直切分"><a href="#单体、垂直应用-垂直切分" class="headerlink" title="单体、垂直应用|垂直切分"></a>单体、垂直应用|垂直切分</h2><p><strong>单体架构</strong>：分布式部署<br><strong>垂直应用架构</strong>：按应用垂直切分的单体<br>优点：</p>
<ul>
<li>水平扩容</li>
<li>运维不需要停服<br>问题：</li>
<li>职责太多，开发效率不高</li>
<li>爆炸半径大</li>
</ul>
<p><img src="/p1.png" class="lazyload" data-srcset="/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="SOA、微服务-水平切分"><a href="#SOA、微服务-水平切分" class="headerlink" title="SOA、微服务|水平切分"></a>SOA、微服务|水平切分</h2><p>S0A(Service-0riented Architecture)</p>
<ol>
<li>将应用的不同功能单元抽象为服务</li>
<li>定义服务之间的通信标准</li>
</ol>
<p><strong>微服务架构</strong>： S0A 的去中心化演进方向</p>
<h1 id="云计算"><a href="#云计算" class="headerlink" title="云计算"></a>云计算</h1><p><strong>云计算</strong>：是指通过软件自动化管理，提供计算资源的服务网络，是现代互联网大规模熟悉分析和存储的基石。</p>
<p>基础：</p>
<ul>
<li>虚拟化技术 <ul>
<li>整租 vs 合租（“整租”可以对应“独占虚拟机”，“合租”可以对应“共享虚拟机”）</li>
</ul>
</li>
<li>编排方案 <ul>
<li>业主 vs 租赁平台（“业主”可以类比为“私有云或本地数据中心”，“租赁平台”可以类比为“公有云服务提供商”）</li>
</ul>
</li>
</ul>
<p>架构：</p>
<ul>
<li>laaS（Infrastructure as a Service）<strong>（基础设施即服务）</strong><ul>
<li><strong>定义</strong>：基础设施即服务是一种云计算服务模型，它提供虚拟化的计算资源。用户可以通过Internet租用这些资源，如服务器、存储和网络硬件。</li>
<li><strong>控制程度</strong>：IaaS提供了最高的控制程度，用户可以完全控制操作系统安装、应用程序部署和网络配置。</li>
</ul>
</li>
<li>PaaS（Platform as a Service）<strong>（平台即服务）</strong><ul>
<li><strong>定义</strong>：平台即服务是一种云计算服务模型，它提供了一个平台，允许用户开发、运行和管理应用程序，而无需构建和维护底层硬件和软件基础设施。</li>
<li><strong>控制程度</strong>：PaaS提供了一个中间层的控制，用户可以控制应用程序和某些应用程序托管功能，但对底层基础设施的控制有限。</li>
</ul>
</li>
<li>SaaS（Software as a Service）<strong>（软件即服务）</strong><ul>
<li><strong>定义</strong>：软件即服务是一种云计算服务模型，它通过Internet提供应用程序，用户通常通过订阅模式访问这些应用程序。</li>
<li><strong>控制程度</strong>：SaaS提供了最低的控制程度，用户只能使用应用程序的功能，而不能控制应用程序或其运行环境。</li>
</ul>
</li>
<li>FaaS（Function as a Service）<strong>（方法即服务）</strong><ul>
<li><strong>定义</strong>：函数即服务，也称为无服务器计算，是一种云计算服务模型，它允许用户运行代码而无需管理底层的运行环境或基础设施。</li>
<li><strong>控制程度</strong>：FaaS提供了一种事件驱动的计算模型，用户只需上传代码，服务提供商会处理其余的工作，包括自动扩展、负载均衡和状态管理。</li>
</ul>
</li>
</ul>
<h1 id="云原生"><a href="#云原生" class="headerlink" title="云原生"></a>云原生</h1><p>云原生技术为组织(公司)在公有云、自由云、混合云等新型的动态环境中，构建和运行可弹性拓展的应用提供了可能。</p>
<p><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="弹性计算资源类型"><a href="#弹性计算资源类型" class="headerlink" title="弹性计算资源类型"></a>弹性计算资源类型</h2><ul>
<li><strong>服务资源调度</strong><ul>
<li><strong>微服务</strong>：微服务架构将复杂的应用程序拆分为一组小型、独立的服务，每个服务专注于完成一个特定的业务功能。它们通常具有快速开发、部署和扩展的能力</li>
<li><strong>大服务</strong>：大服务通常指那些功能复杂、使用量高且对性能要求较高的服务。它们可能需要长期运行并处理大量数据。</li>
</ul>
</li>
<li><strong>计算资源调度</strong><ul>
<li><strong>在线</strong><ul>
<li><ul>
<li><strong>特点</strong>：在线计算通常需要实时或近实时响应用户请求，对性能和延迟要求较高。</li>
</ul>
</li>
<li><strong>应用场景</strong>：例如，电商网站的热销榜单展示。这类应用需要快速响应用户的查询请求，实时更新数据，并根据流量动态调整资源。</li>
</ul>
</li>
<li><strong>离线</strong><ul>
<li><strong>特点</strong>：离线计算通常用于处理非实时的数据分析或批处理任务，对延迟要求不高，但对数据处理的完整性和准确性要求较高。</li>
<li><strong>应用场景</strong>：例如，热销榜单的更新。这类任务可以在后台运行，定期处理大量数据，生成分析结果，然后更新到在线系统中。</li>
</ul>
</li>
</ul>
</li>
<li><strong>消息队列</strong><ul>
<li><strong>在线消息队列</strong>：<ul>
<li><strong>特点</strong>：在线消息队列主要用于实时或近实时的消息传递，能够实现系统的解耦和削峰填谷。</li>
<li><strong>应用场景</strong>：<ul>
<li><strong>削峰</strong>：在高并发场景下，消息队列可以缓冲用户请求，避免系统过载。</li>
<li><strong>解耦</strong>：将不同的系统或服务通过消息队列连接，降低系统间的耦合度，提高系统的可扩展性和可靠性。</li>
</ul>
</li>
</ul>
</li>
<li><strong>离线消息队列</strong>：<br>  - <strong>特点</strong>：离线消息队列主要用于处理非实时的数据处理任务，通常用于大数据分析、日志处理等场景。<br>  - <strong>应用场景</strong>：例如，收集用户行为日志并进行离线分析，生成用户画像或推荐系统数据。这类任务可以在后台运行，不依赖实时响应。</li>
</ul>
</li>
</ul>
<h2 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h2><p>Dev0ps 是云原生时代软件交付的利器贯穿整个软件开发周期，是一种将软件开发（Development）和 IT 运维（Operations）相结合的文化、理念和实践方法。它旨在打破开发和运维之间的传统壁垒，通过自动化、协作和沟通，实现软件的快速交付和高质量。DevOps 强调团队赋能、跨团队沟通和协作，以及技术自动化。</p>
<p>结合自动化流程，提高软件开发、交付效率</p>
<p>软件大概的生命周期如下：</p>
<p><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h1 id="离在线资源并池"><a href="#离在线资源并池" class="headerlink" title="离在线资源并池"></a>离在线资源并池</h1><ul>
<li><p><strong>核心收益</strong>：</p>
<ul>
<li><p><strong>降低物理资源成本</strong>：通过资源复用，减少闲置资源，提高整体资源利用率。</p>
</li>
<li><p><strong>提供更多的弹性资源，增加收入</strong>：在离线业务的低峰期释放资源给在线业务使用，反之亦然，从而实现资源的灵活调配。</p>
</li>
</ul>
</li>
<li><p><strong>在线业务的特点</strong>：</p>
<ul>
<li><p><strong>IO密集型为主</strong>：在线业务通常对延迟敏感，需要快速响应用户请求。</p>
</li>
<li><p><strong>潮汐性、实时性</strong>：在线业务通常呈现明显的潮汐效应，例如白天流量高，夜间流量低。</p>
</li>
</ul>
</li>
<li><p><strong>离线业务的特点</strong>：</p>
<ul>
<li><p><strong>计算密集型占多数</strong>：离线业务通常需要大量的计算资源，例如数据分析、模型训练等。</p>
</li>
<li><p><strong>非实时性</strong>：离线业务对实时性要求较低，可以在资源允许的情况下排队执行。</p>
</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>后端开发与迭代</title>
    <url>/2025/02/13/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/12.%E5%90%8E%E7%AB%AF%E7%9A%84%E5%BC%80%E5%8F%91%E4%BA%8E%E8%BF%AD%E4%BB%A3/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E4%B8%8E%E8%BF%AD%E4%BB%A3/</url>
    <content><![CDATA[<h1 id="了解开发流程"><a href="#了解开发流程" class="headerlink" title="了解开发流程"></a>了解开发流程</h1><p><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>复杂项目没有流程会有什么问题</p>
<ul>
<li>需求阶段:每个人都有自己的想法，团队决策需要有一个过程</li>
<li>开发阶段:多人&#x2F;多端协作开发，每个人有自己的安排，相互配合需要有一个流程</li>
<li>测试阶段:产物怎样交付，测试如何开展，BUG怎么修都需要流程</li>
<li>发布阶段:怎样确保发布过程平稳丝滑，版本和流量如何控制，需要有规范</li>
<li>运维阶段:线上问题如何应急响应，处理用户反馈和线上问题需要有流程</li>
</ul>
<h2 id="瀑布模型"><a href="#瀑布模型" class="headerlink" title="瀑布模型"></a>瀑布模型</h2><p>需求、开发、测试、发布、运维，一个阶段完全好了，再到下一个</p>
<ul>
<li>传统的线性开发模型，按顺序依次进行需求分析、系统设计、编码、测试和部署。</li>
<li>每个阶段的结果作为下一个阶段的输入。</li>
<li>瀑布模型的突出缺点是不适宜用户需求的变化</li>
<li>需求一旦确认，较难进行修改。</li>
<li>适用于需求较为稳定、项目较小的情况。</li>
</ul>
<h2 id="敏捷开发"><a href="#敏捷开发" class="headerlink" title="敏捷开发"></a>敏捷开发</h2><p>更注重的是个体的互动、工作的软件、客户合作、响应变化</p>
<ul>
<li>以小团队快速迭代</li>
<li>团队成员之间的合作更加紧密</li>
<li>以人为本，和用户沟通</li>
</ul>
<p>更现代的流程模型</p>
<ul>
<li>迭代、增量的开发方法，强调快速响应需求变化和持续交付价值。</li>
<li>开发过程中注重协作、沟通和自组织团队。</li>
<li>将开发任务分解为小块，每个迭代周期内交付可用的功能。</li>
<li>适用于需求不确定、变化频繁的项目。</li>
</ul>
<h2 id="字节团队的开发流程"><a href="#字节团队的开发流程" class="headerlink" title="字节团队的开发流程"></a>字节团队的开发流程</h2><p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/12.%E5%90%8E%E7%AB%AF%E7%9A%84%E5%BC%80%E5%8F%91%E4%BA%8E%E8%BF%AD%E4%BB%A3/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/12.%E5%90%8E%E7%AB%AF%E7%9A%84%E5%BC%80%E5%8F%91%E4%BA%8E%E8%BF%AD%E4%BB%A3/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h1 id="开发流程详解"><a href="#开发流程详解" class="headerlink" title="开发流程详解"></a>开发流程详解</h1><h2 id="需求阶段"><a href="#需求阶段" class="headerlink" title="需求阶段"></a>需求阶段</h2><p>MVP (minimum viable product，最小化可行产品)思想</p>
<p><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>站在用户的角度思考<br>收集用户反馈，快速迭代</p>
<p><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br>把重要和紧急的事情先做，重要放在前面，紧急放在重要后面。</p>
<h2 id="开发阶段"><a href="#开发阶段" class="headerlink" title="开发阶段"></a>开发阶段</h2><h3 id="云原生下的开发"><a href="#云原生下的开发" class="headerlink" title="云原生下的开发"></a>云原生下的开发</h3><p><strong>传统虚拟机</strong></p>
<ul>
<li>在物理主机中虚拟出多个虚拟机，每个虚拟机拥有自己的操作系统</li>
<li>运维人员负责维护和交付虚拟机</li>
<li>每个虚拟机中都要安装相应的依赖环境</li>
</ul>
<p><strong>容器化</strong></p>
<ul>
<li>容器是在操作系统中虚拟出来的</li>
<li>通过cgroup，namespace和Union Mount等技术实现了容器之间的相互隔离，同时容器只有很低的开销</li>
<li>应用和其依赖作为一个整体，打包成镜像交付</li>
</ul>
<p><strong>单体结构</strong></p>
<ul>
<li>多个模块共同组成一个服务，服务体量较大</li>
<li>模块之间直接调用，不需要RPC通信</li>
<li>服务整体扩缩容量</li>
<li>多人开发一个代码仓库，需要充分集成测试</li>
</ul>
<p><strong>微服务架构</strong></p>
<ul>
<li>各个功能在不同的服务中</li>
<li>不同模块需要进行RPC通信</li>
<li>不同模块可以独立扩缩容</li>
<li>每个服务的代码仓库仅由少部分人维护</li>
</ul>
<h3 id="代码规范、自测和文档"><a href="#代码规范、自测和文档" class="headerlink" title="代码规范、自测和文档"></a>代码规范、自测和文档</h3><p><strong>代码规范</strong></p>
<ul>
<li>养成良好的注释习惯，超过三个月的代码，自己都会忘了当时在想什么</li>
<li>不要有魔法数字，魔法字符串</li>
<li>重复的逻辑抽象成公共的方法，不要copy代码</li>
<li>正确使用IDE的重构功能，防止修改错误</li>
</ul>
<p><strong>自测</strong></p>
<ul>
<li>单元测试</li>
<li>功能环境测试测试</li>
<li>数据构造</li>
</ul>
<p><strong>文档</strong></p>
<ul>
<li>大型改造需要有技术设计文档，方案评审</li>
<li>好的接口文档能更方便的和前端进行沟通</li>
</ul>
<h2 id="测试阶段"><a href="#测试阶段" class="headerlink" title="测试阶段"></a>测试阶段</h2><p><img src="/p5.png" class="lazyload" data-srcset="/p5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p><strong>功能环境</strong></p>
<ul>
<li>需要一个能模拟线上的环境进行开发和测试</li>
<li>环境和环境之间能够隔离，不影响其他功能的开发和测试</li>
</ul>
<p><strong>集成环境</strong></p>
<ul>
<li>不同人开发的功能合并在一起测试，相互之间的影响可能产生缺陷</li>
<li>迭代发布的所有功能合并在一起测试，确保发布的所有功能之间的影响不产生缺陷</li>
</ul>
<p><strong>回归环境</strong></p>
<ul>
<li>确保新的功能不对老的功能产生影响</li>
<li>回归测试一般会借助自动化测试脚本</li>
</ul>
<h2 id="发布阶段"><a href="#发布阶段" class="headerlink" title="发布阶段"></a>发布阶段</h2><p>发布之前要查询检查一遍，观察每个服务的发布状态，及时处理异常</p>
<p>发布过程中监视和告警需要特别关注，如果有异常立刻判断是否由变更引起，如果是变引起或用户反馈，及时终止发布。</p>
<p><strong>发布负责人</strong></p>
<ul>
<li>负责按照计划执行发布</li>
<li>需要通知各个相关人员发布进展</li>
<li>观察各个服务的发布状态，及时处理异常</li>
</ul>
<p><strong>变更服务的相关 RD</strong></p>
<ul>
<li>按照上线checklist检查服务的日志，监控，响应上线过程中的告警</li>
<li>对于自己负责的改动，在小流量或者是预览环境进行功能验证</li>
<li>执行发布计划中的其他操作(如线上配置，数据处理等)</li>
</ul>
<p><strong>值班同学</strong></p>
<ul>
<li>发布过程中的监控和告警需要特别关注，如果有异常需要立刻判断是否由变更引起</li>
<li>如果有变更引起的告警或者用户反馈，需要及时中止发布</li>
</ul>
<h3 id="简单发布"><a href="#简单发布" class="headerlink" title="简单发布"></a>简单发布</h3><p>直接用新版本覆盖老版本</p>
<ul>
<li><p>优点：简单、成本低</p>
</li>
<li><p>缺点：发布过程中服务会中断，出了问题会影响全部用户</p>
</li>
</ul>
<p>适用：</p>
<ul>
<li>测试环境部署</li>
<li>小公司或非核心业务</li>
</ul>
<h3 id="金丝雀发布"><a href="#金丝雀发布" class="headerlink" title="金丝雀发布"></a>金丝雀发布</h3><p>由于金丝雀对瓦斯非常铭感，因此以前开矿下矿洞，先放一只金丝雀进去探是否有毒气体，看到金丝雀能否活下来，金丝雀发布由此得名。先发一台服务看看是否有问题</p>
<ul>
<li><p>优点：相对简单，能用少量用户验证新版本功能</p>
</li>
<li><p>缺点：发布过程中服务也会中断，发现不了随用户增大才会暴露的问题</p>
</li>
</ul>
<p>适用：</p>
<ul>
<li>测试环境部小公司或非核心业务</li>
</ul>
<h3 id="滚动发布（推荐）"><a href="#滚动发布（推荐）" class="headerlink" title="滚动发布（推荐）"></a>滚动发布（推荐）</h3><p>每个实例都通过金丝雀的方式逐步放大流量，对用户影响小，体验平滑</p>
<ul>
<li><p>优点：发布过程中用户不会中断，可以充分验证服务功能</p>
</li>
<li><p>缺点：流程复杂，对发布系统比较高的要求，发布速度慢，新老版本不兼容的情况不能用</p>
</li>
</ul>
<p>适用：</p>
<ul>
<li>发布系统能力较强，可以平滑切换流量</li>
<li>发布自动化程度高，可以自动滚动</li>
</ul>
<h3 id="蓝绿发布（推荐）"><a href="#蓝绿发布（推荐）" class="headerlink" title="蓝绿发布（推荐）"></a>蓝绿发布（推荐）</h3><p>把服务分为蓝绿两组，先把蓝组流量摘除然后升级，只用绿组提供服务，之后切换全部流量，只用蓝组提供服务，然后升级绿组服务，最终全部升级</p>
<ul>
<li><p>优点：发布速度快，流程相对简单</p>
</li>
<li><p>缺点：需要对一般机器承担所有流量的能力，出问题影响全部用户</p>
</li>
</ul>
<p>适用：</p>
<ul>
<li>服务器资源丰富</li>
<li>新老版本不能兼容的情况，需要一次性升级到新版</li>
</ul>
<p>半夜流量一般比较低，适合做发布，所有这就是大部分后端开发都工作时间比较晚的原因</p>
<h3 id="红黑发布"><a href="#红黑发布" class="headerlink" title="红黑发布"></a>红黑发布</h3><p>和蓝绿发布类似，但是发布时会动态扩容出一组新的服务，而不需要常备两组服务</p>
<ul>
<li><p>优点：发布速度快流程相对简单</p>
</li>
<li><p>缺点：需要能扩容一倍对机器数量仍然有要求，出问题会影响全部用户</p>
</li>
</ul>
<p>适用：</p>
<ul>
<li>服务器资源丰富</li>
<li>新老版本不能兼容的情况，需要一次性升级到新版</li>
</ul>
<h2 id="运维阶段（了解就行）"><a href="#运维阶段（了解就行）" class="headerlink" title="运维阶段（了解就行）"></a>运维阶段（了解就行）</h2><p>公司在发展过程中，逐渐形成了十分复杂的超大规模微服务体系。为了实现对这些复杂微服务的监控，我们往往会在微服务中添加埋点采<br>集 Metrics、Logging、分布式 Trace 等多种数据。</p>
<h1 id="优化流程"><a href="#优化流程" class="headerlink" title="优化流程"></a>优化流程</h1><ul>
<li><p>技术的发展会带来质量和效率的同时提高</p>
</li>
<li><p>将质量保障融入到流程，将流程自动化</p>
</li>
<li><p>从需求到上线全流程自动化，同时提高质量和效率</p>
</li>
<li><p>DevOps：将开发和运维无缝集成的方法论，通过自动化和协作提高软件开发和运维效率和质量。</p>
</li>
<li><p>全流程自动化：通过自动化工具和流程实现代码构建、测试、部署和监控等环节的自动化。</p>
</li>
<li><p>目标是提高团队效率、减少手动操作和人为错误，实现快速交付和持续集成。</p>
</li>
</ul>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库</title>
    <url>/2025/01/17/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/3.DataBase/%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    <content><![CDATA[<h1 id="ARID磁盘阵列"><a href="#ARID磁盘阵列" class="headerlink" title="ARID磁盘阵列"></a>ARID磁盘阵列</h1><p>Q : 单机存储系统怎么做到高性能&#x2F;高性价比&#x2F;高可靠性</p>
<p>A : <font color=red>R</font>(edundant) <font color=red>A</font>(array) <font color=red>I</font>(nexpensive) <font color=red>D</font>(isks)</p>
<h2 id="ARID的使用背景"><a href="#ARID的使用背景" class="headerlink" title="ARID的使用背景"></a>ARID的使用背景</h2><ul>
<li>单块大容量磁盘的<strong>价格</strong> &gt; 多块小容量磁盘</li>
<li>单块磁盘的写入<strong>性能</strong> &lt; 多块磁盘的并发写入功能</li>
<li>单块磁盘的<strong>容错能力</strong>有限，不够安全</li>
</ul>
<h2 id="常见ARID方案"><a href="#常见ARID方案" class="headerlink" title="常见ARID方案"></a>常见ARID方案</h2><ul>
<li>RAID 0<ul>
<li>多块磁盘简单组合</li>
<li>数据条带化存储，提高磁盘带宽</li>
<li>没有额外的容错设计<br>  例如一条1G的数据1被拆成两条512M数据，分别写道磁盘1和磁盘2上，然后磁盘1和磁盘2的第一个512M共同组成数据1</li>
</ul>
</li>
<li>RAID 1<ul>
<li>一块磁盘对应着一块额外的磁盘</li>
<li>真实空间利用率仅50%</li>
<li>容错能力强<br>  RAID 1和RAID 0是两个极端，把一条数据copy一份放在两个磁盘上</li>
</ul>
</li>
<li>RAID 0 + 1<ul>
<li>结合了 RAID 0 和 RAID 1</li>
<li>真实空间利用率只有50%</li>
<li>容错能力强，写入宽带好<br>  例如说，现在有四块磁盘，可以把它两两组成一个 RAID 0，然后再把组成的单元用 RAID 1 组成起来或者组成 RAID 1，然后再用 RAID 0 组成起来，虽然空间利用率还是只有50%，但是还用上了 RAID 1 的条带化写入，并发存储，写入带宽能翻几倍。</li>
</ul>
</li>
</ul>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><p>关系 &#x3D; 集合 &#x3D; 任意元素组成的若干有序偶对反应了事物间的关系</p>
<p>关系代数 &#x3D; 对关系作运算的抽象查询语言(交、并、笛卡尔积……)</p>
<p>SQL &#x3D; 一种DSL(领域特定语言)</p>
<h2 id="单机数据库"><a href="#单机数据库" class="headerlink" title="单机数据库"></a>单机数据库</h2><p>单机数据库 &#x3D; 单个计算机节点上的数据库系统</p>
<p>事物在单机内执行，也可能通过网络交互实现分布式事物</p>
<p><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p><img src="/p5.png" class="lazyload" data-srcset="/p5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h2><p><font color=red>关系型数据库是存储系统</font>，但是在存储之外，有发展出其他功能</p>
<ul>
<li>结构化数据友好</li>
<li>支持事务(ACID(原子性，一致性、隔离性，持久性))</li>
<li>支持复杂查询语言</li>
</ul>
<p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/3.DataBase/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/3.DataBase/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="非关系型数据库"><a href="#非关系型数据库" class="headerlink" title="非关系型数据库"></a>非关系型数据库</h2><p>非关系型数据库也是存储系统，但是<font color=red>一般不要求严格的结构化</font></p>
<p>关系型数据库一般直接使用 SQL 交互，而非关系型数据库交互方式各不相同</p>
<p>非关系型数据库的数据结构千奇吧百怪，没有关系约束后，schema相对灵活</p>
<h1 id="单机存储系统"><a href="#单机存储系统" class="headerlink" title="单机存储系统"></a>单机存储系统</h1><p>单机存储系统 &#x3D; 单个计算机节点上的存储软件系统，一般不涉及网络交互</p>
<h2 id="本地文件系统"><a href="#本地文件系统" class="headerlink" title="本地文件系统"></a>本地文件系统</h2><p>Linux经典哲学：一切皆文件</p>
<ul>
<li>文件系统管理单元：文件</li>
<li>文件系统接口：如Ext2&#x2F;3&#x2F;4，sysfs，rootfs等，但都遵循VFS的统一抽象接口</li>
<li>Liunx文件系统的两大数据结构：Index Node &amp; Directory Entry</li>
</ul>
<p><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="Key-value存储"><a href="#Key-value存储" class="headerlink" title="Key-value存储"></a>Key-value存储</h2><ul>
<li>常见使用方式：put(k, v) &amp; get(k)</li>
<li>常见数据结构：LSM-Tree，某种程度上牺牲读性能，追求写性能</li>
</ul>
<h2 id="分布式存储系统"><a href="#分布式存储系统" class="headerlink" title="分布式存储系统"></a>分布式存储系统</h2><p>分布式存储系统 &#x3D; 在单机存储基础上实现了分布式协议，涉及大量网络交互</p>
<p>可以解决容量、弹性、性价比问题：</p>
<p>单机数据库通过本地文件系统提供的文件接口，在底层的存储介质读&#x2F;写文件，这有个很明显的问题，就是存储是有限的，所以我们现在普遍使用的是池化的技术，把存储能力做成了一个存储池，存储池由物理或者虚拟机组成，存储池与数据库是用网络进行交互，这样，数据库就不需要看本身的存储能力够不够，只要存储池在达到预值后自动添加存储节点，把数据的写入分配到新加入的存储节点即可</p>
<h3 id="解决弹性问题"><a href="#解决弹性问题" class="headerlink" title="解决弹性问题"></a>解决弹性问题</h3><h3 id="HDFS"><a href="#HDFS" class="headerlink" title="HDFS"></a>HDFS</h3><p>堪称大数据时代的基石</p>
<p>核心特点：</p>
<ul>
<li>支持海量数据存储</li>
<li>高容错性</li>
<li>弱POSIX语义</li>
<li>使用普通x86服务器，性价比高<br><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></li>
</ul>
<h3 id="Ceph"><a href="#Ceph" class="headerlink" title="Ceph"></a>Ceph</h3><p>开源分布式存储系统里的&#x3D;&#x3D;万金油</p>
<p>核心特点：</p>
<ul>
<li>一套系统支持对象接口、块接口、文件接口，但是<font color=red>一切皆对象</font></li>
<li>数据写入采用<font color=red>主备复制模型</font></li>
<li>数据分布模型采用CURSH算法</li>
</ul>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>RDBMS</title>
    <url>/2025/01/20/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/4.RDBMS/RDBMS/</url>
    <content><![CDATA[<h1 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h1><p><strong>ACID</strong>：</p>
<ul>
<li>原子性( tomicity):事务是一个不可再分割的工作单元,事务中的操作要么都发生，要么都不发生。</li>
<li>一致性( onsistency):数据库事务不能破坏关系数据的完整性以及业务逻辑上的一致性，每个操作都必须是合法的。</li>
<li>隔离性( solation):多个事务并发访问时,事务之间是隔离的,一个事务不应该影响其它事务运行效果，类似于串行操作。</li>
<li>持久性(Curability):在事务完成以后，该事务所对数据库所作的更改便持久的保存在数据库之中，并不会被回滚。</li>
</ul>
<h1 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h1><p>1960s，传统的文件系统已经不能满足人们的需要，数据库管理系统(DBMS)应运而生DBMS:按照某种数据模型来组织、存储和管理数据的仓库。所以通常按照数据模型的特点将传统数据库系统分成网状数据库、层次数据库和关系数据库三类。</p>
<h2 id="网状模型"><a href="#网状模型" class="headerlink" title="网状模型"></a>网状模型</h2><p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/4.RDBMS/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/4.RDBMS/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>把每个数据作为一个节点，构成一个网状的结构，每个父节点可以有多个子节点，一个子节点也可以有多个父节点，多对多</p>
<h2 id="层次模型"><a href="#层次模型" class="headerlink" title="层次模型"></a>层次模型</h2><p><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>层次模型是一个树形模型，层次模型和网状模型特别相像，最大的不同是每个父节点可以有多个子节点，但每个子节点只能有一个父节点，一对多</p>
<h2 id="关系模型"><a href="#关系模型" class="headerlink" title="关系模型"></a>关系模型</h2><p><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>把所有的关系都存放在一个或多个二维表里，就是我们现在所使用的数据库模型</p>
<h2 id="优势与劣势"><a href="#优势与劣势" class="headerlink" title="优势与劣势"></a>优势与劣势</h2><table>
<thead>
<tr>
<th>模型类型</th>
<th>优势</th>
<th>劣势</th>
</tr>
</thead>
<tbody><tr>
<td>网状模型</td>
<td>- 能直接描述现实世界<br>- 存取效率较高</td>
<td>- 结构复杂<br>- 用户不易使用<br>- 访问程序设计复杂</td>
</tr>
<tr>
<td>层次模型</td>
<td>- 结构简单<br>- 查询效率高<br>- 可以提供较好的完整性支持</td>
<td>- 无法表示M:N的关系<br>- 插入、删除限制多<br>- 遍历子节点必须经过父节点<br>- 访问程序设计复杂</td>
</tr>
<tr>
<td>关系模型</td>
<td>- 实体及实体间的联系都通过二维表结构表示<br>- 可以方便的表示M:N关系<br>- 数据访问路径对用户透明</td>
<td>- 关联查询效率不够高<br>- 关系必须规范化</td>
</tr>
</tbody></table>
<h1 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h1><ul>
<li>语法风格接近自然语言;</li>
<li>高度非过程化;</li>
<li>面向集合的操作方式;</li>
<li>语言简洁，易学易用。</li>
</ul>
<p>一条SQL语句的执行：<br><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<ul>
<li>Parser：语法解析器</li>
<li>AST：语法树</li>
<li>Optimizer：优化器</li>
<li>Plan：生成一个树状结构PlanTree</li>
<li>Executor：执行器<br>&#x3D;&#x3D;其中Parsser、Optimizer、Executor都是SQL引擎，DataFile、LogFile都是存储引擎，事物引擎没有显示的表现在图上&#x3D;&#x3D;</li>
</ul>
<h2 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a>Parser</h2><p>解析器(Parser)一般分为词法分析(Lexical analysis)、语法分析(Syntax analysis)、语义分析(Semantic analyzer)等步骤。</p>
<p><img src="/p5.png" class="lazyload" data-srcset="/p5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="Optimizer"><a href="#Optimizer" class="headerlink" title="Optimizer"></a>Optimizer</h2><p>作用是在多种可能中选取最优的那种</p>
<h3 id="基于规则的优化（RBO-Rule-Base-Optimizer）"><a href="#基于规则的优化（RBO-Rule-Base-Optimizer）" class="headerlink" title="基于规则的优化（RBO  Rule  Base Optimizer）"></a>基于规则的优化（<strong>RBO</strong>  Rule  Base Optimizer）</h3><ul>
<li><p>条件优化</p>
<ul>
<li>a &gt; b &amp; a &gt; 5  –&gt;  a &gt; 5 &amp; b &gt; 5</li>
<li>a &gt; 5 &amp; a &lt; b &amp; b &#x3D; 1 –&gt;  false</li>
</ul>
</li>
<li><p>表连接优化</p>
<ul>
<li>总是小表先进行连接</li>
</ul>
</li>
<li><p>Scan优化</p>
<ul>
<li>唯一索引</li>
<li>普通索引</li>
<li>全表扫描</li>
</ul>
</li>
</ul>
<h3 id="基于代价的优化（CBO-Cost-Base-Optimizer）"><a href="#基于代价的优化（CBO-Cost-Base-Optimizer）" class="headerlink" title="基于代价的优化（CBO  Cost Base Optimizer）"></a>基于代价的优化（<strong>CBO</strong>  Cost Base Optimizer）</h3><p>一个查询有多种执行方案，CBO会选择其中代价最低的方案去真正的执行</p>
<p>例如：时间，IO，CPU，NET，内存</p>
<h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><h3 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h3><ul>
<li>支持行锁，采用MVCC来支持高并发，有可能死锁</li>
<li>支持事务</li>
<li>支持外键</li>
<li>支持崩溃后的安全恢复</li>
<li>不支持全文索引</li>
</ul>
<h3 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B+Tree"></a>B+Tree</h3><p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/4.RDBMS/p6.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/4.RDBMS/p6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br>页面内页目录中使用二分法快速定位到对应的槽，然后再遍历该槽对应分组中的记录即可快速找到指定的记录。<br>从根到叶，中间节点存储</p>
<h2 id="事物日志"><a href="#事物日志" class="headerlink" title="事物日志"></a>事物日志</h2><ul>
<li><p><strong>Atomicity &amp; Undo log</strong></p>
<ul>
<li>Undo Log是<strong>逻辑日志</strong>，记录的是数据的增量变化。利用Undo Log可以进行事务回滚，从而保证事务的原子性。同时也实现了多版本并发控制(MVCC)解决读写冲突和一致性读的问题</li>
</ul>
</li>
<li><p><strong>Isolation &amp; MVCC</strong></p>
<ul>
<li>MVCC的意义:<ul>
<li>读写互不阻塞;</li>
<li>降低死锁概率;</li>
<li>实现一致性读。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Durability &amp; Redo Log</strong></p>
<ul>
<li>redo log是<strong>物理日志</strong>，记录的是页面的变化，它的作用是保证事务持久化。如果数据写入磁盘前发生故障，重启MySQL后会根据redo loq重做。</li>
</ul>
</li>
</ul>
<h1 id="大流量"><a href="#大流量" class="headerlink" title="大流量"></a>大流量</h1><p>以下为缩写，有需要对照去查资料</p>
<h2 id="Sharding"><a href="#Sharding" class="headerlink" title="Sharding"></a>Sharding</h2><p>问题背景</p>
<ul>
<li>单节点写容易成为瓶颈单机数据容量上限</li>
</ul>
<p>解决方案</p>
<ul>
<li>业务数据进行水平拆分代理层进行分片路由</li>
</ul>
<p>实施效果</p>
<ul>
<li>数据库写入性能线性扩展数据库容量线性扩展</li>
</ul>
<h2 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h2><p>问题背景</p>
<ul>
<li>活动流量上涨集群性能不满足要求</li>
</ul>
<p>解决方案</p>
<ul>
<li>扩容DB物理节点数量利用影子表进行压测</li>
</ul>
<p>实施效果</p>
<ul>
<li>数据库集群提供更高的吞吐保证集群可以承担预期流量</li>
</ul>
<h2 id="代理连接池"><a href="#代理连接池" class="headerlink" title="代理连接池"></a>代理连接池</h2><p>问题背景</p>
<ul>
<li>突增流量导致大量建联大量建联导致负载变大，延时上升</li>
</ul>
<p>解决方案</p>
<ul>
<li>业务侧预热连接池</li>
<li>代理侧预热连接池</li>
<li>代理侧支持连接队列</li>
</ul>
<p>实施效果</p>
<ul>
<li>避免 DB 被突增流量打死避免代理和 DB 被大量建联打死</li>
</ul>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>Go语言</title>
    <url>/2025/01/21/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/5.Go/Go%E8%AF%AD%E8%A8%80/</url>
    <content><![CDATA[<h1 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h1><ul>
<li>变量<ul>
<li>var 变量名 &#x3D; 值</li>
<li>int（数据类型） 变量名 &#x3D; 值</li>
<li>变量名 :&#x3D; 值</li>
</ul>
</li>
<li>常量<ul>
<li>const 变量名 &#x3D; 值</li>
<li>const 变量名 数据类型 &#x3D; 值</li>
</ul>
</li>
</ul>
<h2 id="判断-IF"><a href="#判断-IF" class="headerlink" title="判断 IF"></a>判断 IF</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> <span class="number">7</span>%<span class="number">2</span> == <span class="number">0</span> &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;7 is even&quot;</span>)  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;7 is odd&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="number">8</span>%<span class="number">4</span> == <span class="number">0</span> &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;8 is divisible by 4&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> num := <span class="number">9</span>; num &lt; <span class="number">0</span> &#123;  </span><br><span class="line">       fmt.Println(num, <span class="string">&quot;is negative&quot;</span>)  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> num &lt; <span class="number">10</span> &#123;  </span><br><span class="line">       fmt.Println(num, <span class="string">&quot;has l digit&quot;</span>)  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       fmt.Println(num, <span class="string">&quot;has multiple digits&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="循环-For"><a href="#循环-For" class="headerlink" title="循环 For"></a>循环 For</h2><p>在 Go 中没有 while 和 do while，只有 for 循环</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    i := <span class="number">1</span>  </span><br><span class="line">    <span class="keyword">for</span> &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;loop&quot;</span>)  </span><br><span class="line">       <span class="keyword">break</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> j := <span class="number">7</span>; j &lt; <span class="number">9</span>; j++ &#123;  </span><br><span class="line">       fmt.Println(j)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> n := <span class="number">0</span>; n &lt; <span class="number">5</span>; n++ &#123;  </span><br><span class="line">       <span class="keyword">if</span> n%<span class="number">2</span> == <span class="number">0</span> &#123;  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">       fmt.Println(n)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> i &lt;= <span class="number">3</span> &#123;  </span><br><span class="line">       fmt.Println(i)  </span><br><span class="line">       i++  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="选择-Switch"><a href="#选择-Switch" class="headerlink" title="选择 Switch"></a>选择 Switch</h2><p>相较于C++、Java，Go中的 switch 不需要在每个 case 后都加 break</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">    <span class="string">&quot;time&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    a := <span class="number">2</span>  </span><br><span class="line">    <span class="keyword">switch</span> a &#123;  </span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:  </span><br><span class="line">       fmt.Println(<span class="string">&quot;one&quot;</span>)  </span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:  </span><br><span class="line">       &#123;  </span><br><span class="line">          fmt.Println(<span class="string">&quot;two&quot;</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:  </span><br><span class="line">       fmt.Println(<span class="string">&quot;three&quot;</span>)  </span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>, <span class="number">5</span>:  </span><br><span class="line">       fmt.Println(<span class="string">&quot;four or five&quot;</span>)  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       fmt.Println(<span class="string">&quot;other&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    t := time.Now()  </span><br><span class="line">    <span class="keyword">switch</span> &#123;  </span><br><span class="line">    <span class="keyword">case</span> t.Hour() &lt; <span class="number">12</span>:  </span><br><span class="line">       fmt.Println(<span class="string">&quot;It&#x27;s before noon&quot;</span>)  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       fmt.Println(<span class="string">&quot;It&#x27;s after noon&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上 a &#x3D; 2，进入 switch 后 进入 case 2，跑完 case 2 的事件后就到 t :&#x3D; time.Now() </p>
<p>而且，Go 的 switch 可以用任意的变量类型，比如字符串，结构体等</p>
<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p>一样，数组长度是固定的</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    <span class="keyword">var</span> a [<span class="number">5</span>]<span class="type">int</span>  </span><br><span class="line">    a[<span class="number">4</span>] = <span class="number">100</span>  </span><br><span class="line">    fmt.Println(a[<span class="number">4</span>], <span class="built_in">len</span>(a))  </span><br><span class="line">  </span><br><span class="line">    b := [<span class="number">5</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;  </span><br><span class="line">    fmt.Println(b)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> twoD [<span class="number">2</span>][<span class="number">3</span>]<span class="type">int</span>  </span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;  </span><br><span class="line">       <span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">3</span>; j++ &#123;  </span><br><span class="line">          twoD[i][j] = i + j  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Println(twoD)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h2><p>个人感觉就是链表</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    s := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">3</span>)  </span><br><span class="line">    s[<span class="number">0</span>] = <span class="string">&quot;a&quot;</span>  </span><br><span class="line">    s[<span class="number">1</span>] = <span class="string">&quot;b&quot;</span>  </span><br><span class="line">    s[<span class="number">2</span>] = <span class="string">&quot;c&quot;</span>  </span><br><span class="line">    fmt.Println(s[<span class="number">2</span>])  </span><br><span class="line">    fmt.Println(<span class="built_in">len</span>(s))  </span><br><span class="line">  </span><br><span class="line">    s = <span class="built_in">append</span>(s, <span class="string">&quot;d&quot;</span>)  </span><br><span class="line">    s = <span class="built_in">append</span>(s, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;f&quot;</span>)  </span><br><span class="line">    fmt.Println(s)  </span><br><span class="line">  </span><br><span class="line">    c := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="built_in">len</span>(s))  </span><br><span class="line">    <span class="built_in">copy</span>(c, s)  </span><br><span class="line">    fmt.Println(c)  </span><br><span class="line">  </span><br><span class="line">    fmt.Println(s[<span class="number">2</span>:<span class="number">5</span>]) <span class="comment">// [c d e]  </span></span><br><span class="line">    fmt.Println(s[:<span class="number">5</span>])  <span class="comment">// [a b c d e]  </span></span><br><span class="line">    fmt.Println(s[<span class="number">2</span>:])  <span class="comment">// [c d e f]  </span></span><br><span class="line">  </span><br><span class="line">    good := []<span class="type">string</span>&#123;<span class="string">&quot;g&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;d&quot;</span>&#125;  </span><br><span class="line">    fmt.Println(good)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="map"><a href="#map" class="headerlink" title="map"></a>map</h2><p><code>变量名 := make(map[键]值)</code></p>
<p><code>接收值1, 接收值2 := map变量名[&quot;键&quot;]</code>  第二个接收值可以查看map中是否有这个键，有返回true，反之false</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>)  </span><br><span class="line">    m[<span class="string">&quot;one&quot;</span>] = <span class="number">1</span>  </span><br><span class="line">    m[<span class="string">&quot;two&quot;</span>] = <span class="number">2</span>  </span><br><span class="line">    fmt.Println(m)            <span class="comment">// Output: map[one:1 two:2]  </span></span><br><span class="line">    fmt.Println(<span class="built_in">len</span>(m))       <span class="comment">// Output: 2  </span></span><br><span class="line">    fmt.Println(m[<span class="string">&quot;one&quot;</span>])     <span class="comment">// Output: 1  </span></span><br><span class="line">    fmt.Println(m[<span class="string">&quot;unknown&quot;</span>]) <span class="comment">// Output: 0  </span></span><br><span class="line">  </span><br><span class="line">    r, ok := m[<span class="string">&quot;unknown&quot;</span>]  </span><br><span class="line">    fmt.Println(r, ok) <span class="comment">// Output: 0 false  </span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">delete</span>(m, <span class="string">&quot;one&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    m2 := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;<span class="string">&quot;three&quot;</span>: <span class="number">3</span>, <span class="string">&quot;four&quot;</span>: <span class="number">4</span>&#125;  </span><br><span class="line">    <span class="keyword">var</span> m3 = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;<span class="string">&quot;three&quot;</span>: <span class="number">3</span>, <span class="string">&quot;four&quot;</span>: <span class="number">4</span>&#125;  </span><br><span class="line">    fmt.Println(m2, m3) <span class="comment">// Output: map[three:3 four:4] map[three:3 four:4]  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="range"><a href="#range" class="headerlink" title="range"></a>range</h2><p><code>for 变量1, 变量2 := range 数组（容器） &#123;&#125;</code>  变量1是索引 index， 变量2是索引对照的值val</p>
<p>如果不需要索引就用下划线 <code>_</code> 代替</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    nums := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;  </span><br><span class="line">    sum := <span class="number">0</span>  </span><br><span class="line">    <span class="keyword">for</span> i, num := <span class="keyword">range</span> nums &#123;  </span><br><span class="line">       sum += num  </span><br><span class="line">       <span class="keyword">if</span> num == <span class="number">2</span> &#123;  </span><br><span class="line">          fmt.Println(<span class="string">&quot;index: &quot;</span>, i, <span class="string">&quot;nums: &quot;</span>, num)  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Println(<span class="string">&quot;sum: &quot;</span>, sum)  </span><br><span class="line">  </span><br><span class="line">    m := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;a&quot;</span>: <span class="string">&quot;A&quot;</span>, <span class="string">&quot;b&quot;</span>: <span class="string">&quot;B&quot;</span>, <span class="string">&quot;c&quot;</span>: <span class="string">&quot;C&quot;</span>&#125;  </span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;  </span><br><span class="line">       fmt.Println(k, v) <span class="comment">// prints &quot;a A&quot;, &quot;b B&quot;, &quot;c C&quot;  </span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">for</span> k := <span class="keyword">range</span> m &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;key &quot;</span>, k) <span class="comment">// prints &quot;a&quot;, &quot;b&quot;, &quot;c&quot;  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(a <span class="type">int</span>, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> a + b  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add2</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> a + b  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">exists</span><span class="params">(m <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, key <span class="type">string</span>)</span></span> (v <span class="type">string</span>, ok <span class="type">bool</span>) &#123;  </span><br><span class="line">    v, ok = m[key]  </span><br><span class="line">    <span class="keyword">return</span> v, ok  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    res := add(<span class="number">1</span>, <span class="number">2</span>)  </span><br><span class="line">    fmt.Println(res)  </span><br><span class="line">  </span><br><span class="line">    v, ok := exists(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;a&quot;</span>: <span class="string">&quot;A&quot;</span>&#125;, <span class="string">&quot;a&quot;</span>)  </span><br><span class="line">    fmt.Println(v, ok)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h2><p>相较于 C&#x2F;C++，这里的指针操作有限，主要用途是对传入的参数进行修改</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add2</span><span class="params">(n <span class="type">int</span>)</span></span> &#123;  </span><br><span class="line">    n += <span class="number">2</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add2ptr</span><span class="params">(n *<span class="type">int</span>)</span></span> &#123;  </span><br><span class="line">    *n += <span class="number">2</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    n := <span class="number">5</span>  </span><br><span class="line">    add2(n)  </span><br><span class="line">    fmt.Println(n) <span class="comment">// Output: 5  </span></span><br><span class="line">    add2ptr(&amp;n)  </span><br><span class="line">    fmt.Println(n) <span class="comment">// Output: 7  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;  </span><br><span class="line">    name     <span class="type">string</span>  </span><br><span class="line">    password <span class="type">string</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    a := user&#123;name: <span class="string">&quot;John&quot;</span>, password: <span class="string">&quot;12345&quot;</span>&#125;  </span><br><span class="line">    b := user&#123;<span class="string">&quot;Mary&quot;</span>, <span class="string">&quot;67890&quot;</span>&#125;  </span><br><span class="line">    c := user&#123;name: <span class="string">&quot;Mike&quot;</span>&#125;  </span><br><span class="line">    c.password = <span class="string">&quot;98765&quot;</span>  </span><br><span class="line">    <span class="keyword">var</span> d user  </span><br><span class="line">    d.name = <span class="string">&quot;Peter&quot;</span>  </span><br><span class="line">    d.password = <span class="string">&quot;4321&quot;</span>  </span><br><span class="line">  </span><br><span class="line">    fmt.Println(a, b, c, d) <span class="comment">// Output: &#123;John 12345&#125; &#123;Mary 67890&#125; &#123;Mike 98765&#125; &#123;Peter 4321&#125;  </span></span><br><span class="line">    fmt.Println(checkPassword(a, <span class="string">&quot;1234&quot;</span>)) <span class="comment">// Output: false  </span></span><br><span class="line">    fmt.Println(checkPassword2(&amp;a, <span class="string">&quot;12345&quot;</span>)) <span class="comment">// Output: true  </span></span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkPassword</span><span class="params">(u user, password <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> u.password == password  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkPassword2</span><span class="params">(u *user, password <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> u.password == password  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结构体方法"><a href="#结构体方法" class="headerlink" title="结构体方法"></a>结构体方法</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;  </span><br><span class="line">    name     <span class="type">string</span>  </span><br><span class="line">    password <span class="type">string</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u user)</span></span> checkPassword(password <span class="type">string</span>) <span class="type">bool</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> u.password == password  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *user)</span></span> resetPassword(password <span class="type">string</span>) &#123;  </span><br><span class="line">    u.password = password  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    a := user&#123;name: <span class="string">&quot;John&quot;</span>, password: <span class="string">&quot;12345&quot;</span>&#125;  </span><br><span class="line">    b := user&#123;<span class="string">&quot;Mary&quot;</span>, <span class="string">&quot;67890&quot;</span>&#125;  </span><br><span class="line">    c := user&#123;name: <span class="string">&quot;Mike&quot;</span>&#125;  </span><br><span class="line">    c.password = <span class="string">&quot;98765&quot;</span>  </span><br><span class="line">    <span class="keyword">var</span> d user  </span><br><span class="line">    d.name = <span class="string">&quot;Peter&quot;</span>  </span><br><span class="line">    d.password = <span class="string">&quot;4321&quot;</span>  </span><br><span class="line"></span><br><span class="line">    fmt.Println(a.checkPassword(<span class="string">&quot;12345&quot;</span>))  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>一般在做错误处理时需返回 error，如果有错误就返回 <code>errors.New(&quot;错误介绍&quot;)</code>，否则返回 <code>nil</code></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>  </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;  </span><br><span class="line">    name     <span class="type">string</span>  </span><br><span class="line">    password <span class="type">string</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">findUser</span><span class="params">(users []user, name <span class="type">string</span>)</span></span> (v *user, err <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">for</span> _, u := <span class="keyword">range</span> users &#123;  </span><br><span class="line">       <span class="keyword">if</span> u.name == name &#123;  </span><br><span class="line">          <span class="keyword">return</span> &amp;u, <span class="literal">nil</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;not found&quot;</span>)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    u, err := findUser([]user&#123;&#123;<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;123456&quot;</span>&#125;&#125;, <span class="string">&quot;Alice&quot;</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Println(err)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Println(u.name)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> u, err = findUser([]user&#123;&#123;<span class="string">&quot;wang&quot;</span>, <span class="string">&quot;123&quot;</span>&#125;&#125;, <span class="string">&quot;li&quot;</span>); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Println(err)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       fmt.Println(u.name)  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h2><p>HasPrefix函数用于判断第二个参数代表的字符串&#x2F;字节切片是不是第一个参数的前缀<br>HasSuffix函数则用于判断第二个参数是不是第一个参数的后缀</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">    <span class="string">&quot;strings&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    a := <span class="string">&quot;hello&quot;</span>  </span><br><span class="line">    fmt.Println(strings.Contains(a, <span class="string">&quot;ll&quot;</span>))                <span class="comment">// true  </span></span><br><span class="line">    fmt.Println(strings.Count(a, <span class="string">&quot;l&quot;</span>))                    <span class="comment">// 2  </span></span><br><span class="line">    fmt.Println(strings.HasPrefix(a, <span class="string">&quot;he&quot;</span>))               <span class="comment">// true  </span></span><br><span class="line">    fmt.Println(strings.HasSuffix(a, <span class="string">&quot;llo&quot;</span>))              <span class="comment">// true  </span></span><br><span class="line">    fmt.Println(strings.Index(a, <span class="string">&quot;ll&quot;</span>))                   <span class="comment">// 2  </span></span><br><span class="line">    fmt.Println(strings.Join([]<span class="type">string</span>&#123;<span class="string">&quot;he&quot;</span>, <span class="string">&quot;llo&quot;</span>&#125;, <span class="string">&quot;-&quot;</span>)) <span class="comment">// &quot;he-llo&quot;  </span></span><br><span class="line">    fmt.Println(strings.Repeat(a, <span class="number">2</span>))                     <span class="comment">// &quot;hellohello&quot;  </span></span><br><span class="line">    fmt.Println(strings.Replace(a, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="number">-1</span>))         <span class="comment">// &quot;hEllo&quot;  </span></span><br><span class="line">    fmt.Println(strings.Split(<span class="string">&quot;a-b-c&quot;</span>, <span class="string">&quot;-&quot;</span>))              <span class="comment">// [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]  </span></span><br><span class="line">    fmt.Println(strings.ToLower(a))                       <span class="comment">// &quot;hello&quot;  </span></span><br><span class="line">    fmt.Println(strings.ToUpper(a))                       <span class="comment">// &quot;HELLO&quot;  </span></span><br><span class="line">    fmt.Println(<span class="built_in">len</span>(a))                                   <span class="comment">// 5  </span></span><br><span class="line">  </span><br><span class="line">    b := <span class="string">&quot;你好&quot;</span>  </span><br><span class="line">    fmt.Println(<span class="built_in">len</span>(b)) <span class="comment">//6  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="字符串格式化"><a href="#字符串格式化" class="headerlink" title="字符串格式化"></a>字符串格式化</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> point <span class="keyword">struct</span> &#123;  </span><br><span class="line">    x, y <span class="type">int</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    s := <span class="string">&quot;hello&quot;</span>  </span><br><span class="line">    n := <span class="number">123</span>  </span><br><span class="line">    p := point&#123;<span class="number">1</span>, <span class="number">2</span>&#125;  </span><br><span class="line">    fmt.Println(s, n, p) <span class="comment">// Output: hello 123 &#123;1 2&#125;  </span></span><br><span class="line">  </span><br><span class="line">    fmt.Printf(<span class="string">&quot;s=%v\n&quot;</span>, s) <span class="comment">// Output: s=hello  </span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;n=%v\n&quot;</span>, n) <span class="comment">// Output: n=123  </span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;p=%v\n&quot;</span>, p) <span class="comment">// Output: p=&#123;1 2&#125;  </span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;p=%+v\n&quot;</span>, p) <span class="comment">// Output: p=point&#123;x:1, y:2&#125;  </span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;p=%#v\n&quot;</span>, p) <span class="comment">// Output: p=main.point&#123;x:1, y:2&#125;  </span></span><br><span class="line">  </span><br><span class="line">    f := <span class="number">3.1415926</span>  </span><br><span class="line">    fmt.Println(f) <span class="comment">// Output: 3.1415926  </span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%.2f\n&quot;</span>, f) <span class="comment">// Output: 3.14  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JSON处理"><a href="#JSON处理" class="headerlink" title="JSON处理"></a>JSON处理</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span>  </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> userInfo <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Name  <span class="type">string</span>  </span><br><span class="line">    Age   <span class="type">int</span> <span class="string">`json:&quot;age&quot;`</span>  </span><br><span class="line">    Hobby []<span class="type">string</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    a := userInfo&#123;Name: <span class="string">&quot;John&quot;</span>, Age: <span class="number">25</span>, Hobby: []<span class="type">string</span>&#123;<span class="string">&quot;Golang&quot;</span>, <span class="string">&quot;typeScript&quot;</span>&#125;&#125;  </span><br><span class="line">    buf, err := json.Marshal(a) <span class="comment">// 序列化  </span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="built_in">panic</span>(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Println(buf) <span class="comment">// 输出序列化后的json字符串 [123 34 78 97 109...]    fmt.Println(string(buf)) // 输出序列化后的json字符串 &#123;&quot;Name&quot;:&quot;John&quot;,&quot;age&quot;:25,&quot;Hobby&quot;:[&quot;Golang&quot;,&quot;typeScript&quot;]&#125;  </span></span><br><span class="line">    buf, err = json.MarshalIndent(a, <span class="string">&quot;&quot;</span>, <span class="string">&quot;\t&quot;</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="built_in">panic</span>(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Println(<span class="type">string</span>(buf))  </span><br><span class="line">    <span class="comment">/*  </span></span><br><span class="line"><span class="comment">    &#123;       &quot;Name&quot;: &quot;John&quot;,       &quot;age&quot;: 25,       &quot;Hobby&quot;: [          &quot;Golang&quot;,          &quot;typeScript&quot;       ]    &#125;    */</span>  </span><br><span class="line">    <span class="keyword">var</span> b userInfo  </span><br><span class="line">    err = json.Unmarshal(buf, &amp;b)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="built_in">panic</span>(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Println(b) <span class="comment">// 输出反序列化后的结构体 &#123;John 25 [Golang typeScript]&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="时间处理"><a href="#时间处理" class="headerlink" title="时间处理"></a>时间处理</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">    <span class="string">&quot;time&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    now := time.Now()  </span><br><span class="line">    fmt.Println(now) <span class="comment">// 2025-01-23 15:36:01.0802031 +0800 CST m=+0.000000001  </span></span><br><span class="line">    t := time.Date(<span class="number">2021</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">0</span>, time.UTC)  </span><br><span class="line">    t2 := time.Date(<span class="number">2021</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">0</span>, time.UTC)  </span><br><span class="line">    fmt.Println(t)                                                              <span class="comment">// 2021-10-01 12:30:00 +0000 UTC  </span></span><br><span class="line">    fmt.Println(t.Year(), t.Month(), t.Day(), t.Hour(), t.Minute(), t.Second()) <span class="comment">// 2021 10 1 12 30 0  </span></span><br><span class="line">    fmt.Println(t.Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>))                                <span class="comment">// 2021-10-01 12:30:00  </span></span><br><span class="line">  </span><br><span class="line">    diff := t2.Sub(t)  </span><br><span class="line">    fmt.Println(diff)                           <span class="comment">// -720h0m0s  </span></span><br><span class="line">    fmt.Println(diff.Minutes(), diff.Seconds()) <span class="comment">// -43200 -2.592e+06  </span></span><br><span class="line">    t3, err := time.Parse(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>, <span class="string">&quot;2021-10-01 12:30:00&quot;</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Println(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Println(t3 == t)   <span class="comment">// true  </span></span><br><span class="line">    fmt.Println(t3.Unix()) <span class="comment">// 1633091400  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数字解析"><a href="#数字解析" class="headerlink" title="数字解析"></a>数字解析</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">    <span class="string">&quot;strconv&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    f, _ := strconv.ParseFloat(<span class="string">&quot;3.14&quot;</span>, <span class="number">64</span>)  </span><br><span class="line">    fmt.Println(f) <span class="comment">// Output: 3.14  </span></span><br><span class="line">  </span><br><span class="line">    n, _ := strconv.ParseInt(<span class="string">&quot;111&quot;</span>, <span class="number">10</span>, <span class="number">64</span>)  <span class="comment">// 10是指十进制，传0的表示自动识别，64表示精度为64</span></span><br><span class="line">    fmt.Println(n) <span class="comment">// Output: 111  </span></span><br><span class="line">  </span><br><span class="line">    n, _ = strconv.ParseInt(<span class="string">&quot;0x1234&quot;</span>, <span class="number">0</span>, <span class="number">64</span>)  </span><br><span class="line">    fmt.Println(n) <span class="comment">// Output: 4660  </span></span><br><span class="line">  </span><br><span class="line">    n2, _ := strconv.Atoi(<span class="string">&quot;123&quot;</span>)  </span><br><span class="line">    fmt.Println(n2) <span class="comment">// Output: 123  </span></span><br><span class="line">  </span><br><span class="line">    n2, err := strconv.Atoi(<span class="string">&quot;abc&quot;</span>)  </span><br><span class="line">    fmt.Println(n2, err) <span class="comment">// Output: 0 strconv.ParseInt: parsing &quot;abc&quot;: invalid syntax  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="进程信息"><a href="#进程信息" class="headerlink" title="进程信息"></a>进程信息</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">    <span class="string">&quot;os&quot;</span>    <span class="string">&quot;os/exec&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    fmt.Println(os.Args)  </span><br><span class="line">  </span><br><span class="line">    fmt.Println(os.Getenv(<span class="string">&quot;PATH&quot;</span>))  </span><br><span class="line">    fmt.Println(os.Setenv(<span class="string">&quot;AA&quot;</span>, <span class="string">&quot;BB&quot;</span>))  </span><br><span class="line">  </span><br><span class="line">    buf, err := exec.Command(<span class="string">&quot;grep&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;/etc/hosts&quot;</span>).CombinedOutput()  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Println(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Println(<span class="type">string</span>(buf))  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="综合练习"><a href="#综合练习" class="headerlink" title="综合练习"></a>综合练习</h1><h2 id="猜数字"><a href="#猜数字" class="headerlink" title="猜数字"></a>猜数字</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;bufio&quot;</span>  </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>    <span class="string">&quot;math/rand&quot;</span>    <span class="string">&quot;os&quot;</span>    <span class="string">&quot;strconv&quot;</span>    <span class="string">&quot;strings&quot;</span>    <span class="string">&quot;time&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    maxNum := <span class="number">100</span>  </span><br><span class="line">    rand.Seed(time.Now().UnixNano())  </span><br><span class="line">    secretNumber := rand.Intn(maxNum)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;Please input your guess&quot;</span>)  </span><br><span class="line">       reader := bufio.NewReader(os.Stdin)  </span><br><span class="line">       input, err := reader.ReadString(<span class="string">&#x27;\n&#x27;</span>)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          fmt.Println(<span class="string">&quot;An error occurred while reading input, please try again&quot;</span>, err)  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">       input = strings.TrimSuffix(input, <span class="string">&quot;\n&quot;</span>)  </span><br><span class="line">       guess, err := strconv.Atoi(input)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          fmt.Println(<span class="string">&quot;Invalid input, please try again&quot;</span>, err)  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="keyword">if</span> guess &gt; secretNumber &#123;  </span><br><span class="line">          fmt.Println(<span class="string">&quot;Too high, try again&quot;</span>)  </span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> guess &lt; secretNumber &#123;  </span><br><span class="line">          fmt.Println(<span class="string">&quot;Too low, try again&quot;</span>)  </span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">          fmt.Println(<span class="string">&quot;Congratulations, you guessed the number&quot;</span>, secretNumber)  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在线词典"><a href="#在线词典" class="headerlink" title="在线词典"></a>在线词典</h2><p><strong>第一步</strong><br>首先打开<a href="https://fanyi.caiyunapp.com/">彩云小译官网 - 高效准确的翻译工具 | 文字翻译 | 文档翻译 | 网页翻译 | 浏览器插件 | 双语对照 | 术语库</a></p>
<p>按键盘上的 F12 或者右键页面打开检查，随后点击网络</p>
<p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/5.Go/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/5.Go/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>从下往上找第一个dict，右键复制–&gt;复制cURL(bash)</p>
<p>然后打开<a href="https://curlconverter.com/go/">curl to Go</a>，把复制的代码放在里面，生成 Go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">    <span class="string">&quot;io&quot;</span>    <span class="string">&quot;log&quot;</span>    <span class="string">&quot;net/http&quot;</span>    <span class="string">&quot;strings&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    client := &amp;http.Client&#123;&#125;  </span><br><span class="line">    <span class="keyword">var</span> data = strings.NewReader(<span class="string">`&#123;&quot;trans_type&quot;:&quot;zh2en&quot;,&quot;source&quot;:&quot;帅&quot;&#125;`</span>)  </span><br><span class="line">    req, err := http.NewRequest(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;https://api.interpreter.caiyunai.com/v1/dict&quot;</span>, data)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatal(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;accept&quot;</span>, <span class="string">&quot;application/json, text/plain, */*&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;accept-language&quot;</span>, <span class="string">&quot;zh&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;app-name&quot;</span>, <span class="string">&quot;xiaoyi&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;authorization&quot;</span>, <span class="string">&quot;Bearer&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;content-type&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;device-id&quot;</span>, <span class="string">&quot;&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;origin&quot;</span>, <span class="string">&quot;https://fanyi.caiyunapp.com&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;os-type&quot;</span>, <span class="string">&quot;web&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;os-version&quot;</span>, <span class="string">&quot;&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;priority&quot;</span>, <span class="string">&quot;u=1, i&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;referer&quot;</span>, <span class="string">&quot;https://fanyi.caiyunapp.com/&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;sec-ch-ua&quot;</span>, <span class="string">`&quot;Not A(Brand&quot;;v=&quot;8&quot;, &quot;Chromium&quot;;v=&quot;132&quot;, &quot;Microsoft Edge&quot;;v=&quot;132&quot;`</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;sec-ch-ua-mobile&quot;</span>, <span class="string">&quot;?0&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;sec-ch-ua-platform&quot;</span>, <span class="string">`&quot;Windows&quot;`</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;sec-fetch-dest&quot;</span>, <span class="string">&quot;empty&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;sec-fetch-mode&quot;</span>, <span class="string">&quot;cors&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;sec-fetch-site&quot;</span>, <span class="string">&quot;cross-site&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;user-agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36 Edg/132.0.0.0&quot;</span>)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;x-authorization&quot;</span>, <span class="string">&quot;token:qgemv4jr1y38jyq6vhvi&quot;</span>)  </span><br><span class="line">    resp, err := client.Do(req)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatal(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">defer</span> resp.Body.Close()  </span><br><span class="line">    bodyText, err := io.ReadAll(resp.Body)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatal(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, bodyText)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第二步</strong></p>
<p>我们需要把所需的文本转成 json</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;bytes&quot;</span>  </span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span>    <span class="string">&quot;log&quot;</span>    <span class="string">&quot;net/http&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> DictRequest <span class="keyword">struct</span> &#123;  </span><br><span class="line">    TranType <span class="type">string</span> <span class="string">`json:&quot;tran_type&quot;`</span>  </span><br><span class="line">    Source   <span class="type">string</span> <span class="string">`json:&quot;source&quot;`</span>  </span><br><span class="line">    UserID   <span class="type">string</span> <span class="string">`json:&quot;user_id&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    client := &amp;http.Client&#123;&#125;  </span><br><span class="line">    request := DictRequest&#123;TranType: <span class="string">&quot;EN-ZH&quot;</span>, Source: <span class="string">&quot;good&quot;</span>&#125;  </span><br><span class="line">    buf, err := json.Marshal(request)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatal(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">var</span> data = bytes.NewReader(buf)  </span><br><span class="line">    req, err := http.NewRequest(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;https://api.interpreter.caiyunai.com/v1/dict&quot;</span>, data)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatal(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后因工具因素暂未完成（工具网址暂停运用了），大概工作是对照所需要的 json 来生成 struct，最后全部拼接到一起</p>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>代码优化</title>
    <url>/2025/01/23/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/6.%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81/%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<h1 id="高质量编程"><a href="#高质量编程" class="headerlink" title="高质量编程"></a>高质量编程</h1><p>编写的代码能够达到正确可靠、简洁清晰的目标可称为高质量代码</p>
<ul>
<li>各种边界条件是否考虑完备</li>
<li>异常情况处理，稳定性保证</li>
<li>易读易维护</li>
</ul>
<h2 id="编程原则"><a href="#编程原则" class="headerlink" title="编程原则"></a>编程原则</h2><p>简单性</p>
<ul>
<li>消除“多余的复杂性”，以简单清晰的逻辑编写代码 </li>
<li>不理解的代码无法修复改进<br>可读性</li>
<li>代码是写给人看的，而不是机器</li>
<li>编写可维护代码的第一步是确保代码可读<br>生产力</li>
<li>团队整体工作效率非常重要</li>
</ul>
<h2 id="编写规范"><a href="#编写规范" class="headerlink" title="编写规范"></a>编写规范</h2><h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>公共符号始终要注释</p>
<ul>
<li>包中声明的每个公共的符号：变量、常量、函数以及结构都需要添加注释</li>
<li>任何既不明显也不简短的公共功能必须予以注释</li>
<li>无论长度或复杂程度如何对库中的任何函数都必须进行注释</li>
</ul>
<p>注释应该做的：</p>
<ul>
<li>注释应该解释代码作用</li>
<li>注释应该解释代码如何做的</li>
<li>注释应该解释代码实现的原因</li>
<li>注释应该解释代码什么情况会出错</li>
</ul>
<h3 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h3><h4 id="变量名"><a href="#变量名" class="headerlink" title="变量名"></a>变量名</h4><ul>
<li>简洁胜于冗长</li>
<li>缩略词全大写，但当其位于变量开头且不需要导出时，使用全小写<ul>
<li>例如使用 ServeHTTP 而不是 ServeHttp</li>
<li>使用 XMLHTTPRequest 或者 xmlHTTPRequest</li>
</ul>
</li>
<li>变量距离其被使用的地方越远，则需要携带越多的上下文信息<ul>
<li>全局变量在其名字中需要更多的上下文信息，使得在不同地方可以轻易辨认出其含义</li>
</ul>
</li>
</ul>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Bad</span></span><br><span class="line"><span class="keyword">for</span> index := <span class="number">0</span>; index &lt; <span class="built_in">len</span>(s); index++&#123;</span><br><span class="line">	<span class="comment">//do something...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Good</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++&#123;</span><br><span class="line">	<span class="comment">//do something...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>i 和 index 的作用域范围仅限于 for 循环内部时，index 的额外冗长几乎没有增加对程序的理解</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Good</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span></span> send(req *Request, deadline time.Time)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bad</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span></span> send(req *Request, t time.Time)</span><br></pre></td></tr></table></figure>
<p>将 deadline 替换成t 降低了变量名的信息量，t 常代指任意时间<br>deadline 指截止时间，有特定的含义</p>
<h4 id="函数名"><a href="#函数名" class="headerlink" title="函数名"></a>函数名</h4><ul>
<li>函数名不携带包名的上下文信息，因为包名和函数名总是成对出现的</li>
<li>函数名尽量简短</li>
<li>当名为 foo 的包某个函数返回类型 Foo 时，可以省略类型信息而不导致歧义</li>
<li>当名为 foo 的包某个函数返回类型 T时(T 并不是 Foo)，可以在函数名中加入类型信息</li>
</ul>
<p>例如：<br>在 http 包中创建服务器的函数</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Good</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Server</span><span class="params">(I net.Listener, handler Handler)</span></span> <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Bad</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ServerHTTP</span><span class="params">(I net.Listener, handler Handler)</span></span> <span class="type">error</span></span><br></pre></td></tr></table></figure>
<p>因为我们是在 http 包下创建的函数，如果其他包中调用这个函数那么是 http.函数名，http就没必要出现在函数名中了</p>
<h4 id="package"><a href="#package" class="headerlink" title="package"></a>package</h4><ul>
<li>只由小写字母组成。不包含大写字母和下划线等字符</li>
<li>简短并包含一定的上下文信息。例如 schema、task 等</li>
<li>不要与标准库同名。例如不要使用 sync 或者 strings</li>
</ul>
<p>以下规则尽量满足，以标准库包名为例</p>
<ul>
<li>不使用常用变量名作为包名。例如使用 bufio 而不是 buf</li>
<li>使用单数而不是复数。例如使用 encoding 而不是 encodings</li>
<li>谨慎地使用缩写。例如使用 fmt 在不破坏上下文的情况下比 format 更加简短</li>
</ul>
<h3 id="控制流程"><a href="#控制流程" class="headerlink" title="控制流程"></a>控制流程</h3><p>避免嵌套，保持正常流程清晰</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Bad</span></span><br><span class="line"><span class="keyword">if</span> foo &#123;</span><br><span class="line">	<span class="keyword">return</span> x</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Good</span></span><br><span class="line"><span class="keyword">if</span> foo &#123;</span><br><span class="line">	<span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br></pre></td></tr></table></figure>
<p>如果两个分支中都包含return语句，则可以去除冗余的else</p>
<p>尽量保持正常代码路径为最小缩进</p>
<ul>
<li>优先处理错误情况&#x2F;特殊情况，尽早返回或继续循环来减少嵌套</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Bad</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OneFunc</span><span class="params">()</span></span> err &#123;</span><br><span class="line">	err := doSomething()</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		err := doSomething()</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">// normal case</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Good</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OneFunc</span><span class="params">()</span></span> err &#123;</span><br><span class="line">	<span class="keyword">if</span> err := doSomething(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := doSomething(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">// normal case</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>最常见的正常流程的路径被嵌套在两个 if 条件内</li>
<li>成功的退出条件是 return nil，必须仔细匹配大括号来发现函数最后一行返回一个错误，需要追溯到匹配的左括号，才能了解何时会触发错误</li>
<li>如果后续正常流程需要增加一步操作，调用新的函数，则又会增加一层嵌套</li>
</ul>
<h3 id="错误和异常处理"><a href="#错误和异常处理" class="headerlink" title="错误和异常处理"></a>错误和异常处理</h3><h4 id="简单错误"><a href="#简单错误" class="headerlink" title="简单错误"></a>简单错误</h4><ul>
<li>简单的错误指的是仅出现一次的错误，且在其他地方不需要捕获该错误</li>
<li>优先使用 errors.New 来创建匿名变量来直接表示简单错误</li>
<li>如果有格式化的需求，使用 fmt.Errorf</li>
</ul>
<h4 id="错误的-Wrap-和-Unwrap"><a href="#错误的-Wrap-和-Unwrap" class="headerlink" title="错误的 Wrap 和 Unwrap"></a>错误的 Wrap 和 Unwrap</h4><p>错误的 Wrap 实际上是提供了一个 error 嵌套另一个error 的能力，从而生成一个 error 的跟踪链<br>在 fmt.Errorf 中使用: %w 关键字来将一个错误关联至错误链中</p>
<h4 id="判断错误"><a href="#判断错误" class="headerlink" title="判断错误"></a>判断错误</h4><p>判定一个错误是否为特定错误，使用 errors.ls</p>
<ul>
<li>不同于使用 <code>==</code>，使用该方法可以判定错误链上的所有错误是否含有特定的错误</li>
</ul>
<p>在错误链上获取特定种类的错误，使用errors.As</p>
<h4 id="panic"><a href="#panic" class="headerlink" title="panic"></a>panic</h4><p>注意在Go语言中，recover只在defer调用的函数中有效，并且defer要在panic之前先注册，否则不能捕获异常<br>panic相当于直接 throw 一个异常来终止程序运行，<strong>当panic被捕获到后，被注册的函数将获得程序控制权</strong></p>
<ul>
<li>不建议在业务代码中使用 panic</li>
<li>调用函数不包含 recover 会造成程序崩溃</li>
<li>若问题可以被屏蔽或解决，建议使用error 代替 panic</li>
<li>当程序启动阶段发生不可逆转的错误时可以在 init 或 main 函数中使用 panic</li>
</ul>
<h4 id="recover"><a href="#recover" class="headerlink" title="recover"></a>recover</h4><ul>
<li>recover 只能在被 defer 的函数中使用</li>
<li>嵌套无法生效</li>
<li>只在当前 goroutine 生效</li>
<li>defer 的语句是后进先出</li>
</ul>
<p>如果需要更多的上下文信息，可以recover 后在 log 中记录当前的调用栈</p>
<h2 id="优化性能"><a href="#优化性能" class="headerlink" title="优化性能"></a>优化性能</h2><ul>
<li>性能优化的前提是满足正确可靠、简洁清晰等质量因素</li>
<li>性能优化是综合评估，有时候时间效率和空间效率可能对立</li>
<li>针对 Go 语言特性，介绍 Go 相关的性能优化建议</li>
</ul>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><p>Go 语言提供了支持基准性能测试的 benchmark 工具</p>
<p><code>go test -bench=. -benchmem</code></p>
<p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/6.%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/6.%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h3 id="Slice-预分配内存"><a href="#Slice-预分配内存" class="headerlink" title="Slice 预分配内存"></a>Slice 预分配内存</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Bad</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NoPreAlloc</span><span class="params">(size <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	data := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> k := <span class="number">0</span>; k &lt; size; k++ &#123;</span><br><span class="line">		data = <span class="built_in">append</span>(data, k)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Good</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NoPreAlloc</span><span class="params">(size <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	data := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, size)</span><br><span class="line">	<span class="keyword">for</span> k := <span class="number">0</span>; k &lt; size; k++ &#123;</span><br><span class="line">		data = <span class="built_in">append</span>(data, k)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>切片本质是一个数组片段的描述<ul>
<li>包括数组指针</li>
<li>片段的长度</li>
<li>片段的容量(不改变内存分配情况下的最大长度)</li>
</ul>
</li>
<li>切片操作并不复制切片指向的元素</li>
<li>创建一个新的切片会复用原来切片的底层数组</li>
</ul>
<p><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<ul>
<li>在已有切片基础上创建切片，不会创建新的底层数组场景<ul>
<li>原切片较大，代码在原切片基础上新建小切片</li>
<li>原底层数组在内存中有引用，得不到释放</li>
</ul>
</li>
<li>可使用 copy 替代 re-slice</li>
<li>map 也是一样，不断向 map 中添加元素的操作会触发 map 的扩容，提前分配好空间可以减少内存拷贝和 Rehash 的消耗</li>
</ul>
<h3 id="字符串处理"><a href="#字符串处理" class="headerlink" title="字符串处理"></a>字符串处理</h3><p>常见的字符串拼接方法：strings.Builder</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Bad</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Plus</span><span class="params">(n <span class="type">int</span>, str <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	s := <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">		s += str</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Good</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Plus</span><span class="params">(n <span class="type">int</span>, str <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> builder strings.Builder</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">		builder.WriteString(str)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> builder.String()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 strings.Builder</p>
<ul>
<li>使用+拼接性能最差，strings.Builder，bytes.Buffer 相近，strings.Buffer 更快</li>
</ul>
<p>分析</p>
<ul>
<li>字符串在 Go 语言中是不可变类型，占用内存大小是固定的</li>
<li>使用 +每次都会重新分配内存</li>
<li>strings.Builder，bytes.Buffer 底层都是 []byte 数组</li>
<li>内存扩容策略,不需要每次拼接重新分配内存</li>
</ul>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>网络接入</title>
    <url>/2025/02/12/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/11.%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%85%A5/%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%85%A5/</url>
    <content><![CDATA[<h1 id="域名系统"><a href="#域名系统" class="headerlink" title="域名系统"></a>域名系统</h1><p>使用域名系统来代替 hosts 文件</p>
<p>关于域名空间:<br>    - 域名空间被组织成树形结构<br>    - 域名空间通过划分zone的方式进行分层授权管理<br>    - 全球公共域名空间仅对应一棵树<br>    - 根域名服务器:查询起点<br>    - 域名组成格式:[a-zA-Z0-9-]，以点划分label</p>
<p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/11.%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%85%A5/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/11.%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%85%A5/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>顶级域gTLD（general Top-level Domains）：gov政府.edu教育.com商业.mil军事.org非盈利组织</p>
<h1 id="DNS服务器"><a href="#DNS服务器" class="headerlink" title="DNS服务器"></a>DNS服务器</h1><h3 id="DNS查询过程"><a href="#DNS查询过程" class="headerlink" title="DNS查询过程"></a>DNS查询过程</h3><p><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>比如这里的网络客户端想要访问163.com域名，首先会访问本地的DNS服务器，看看有没有163.com域名的解析记录，第一次访问都不会有解析记录的，如果没有解析记录会依次向根、顶级域进行解析以及保存在本地，以便于下次查询</p>
<h3 id="DNS记录类型"><a href="#DNS记录类型" class="headerlink" title="DNS记录类型"></a>DNS记录类型</h3><ul>
<li>A&#x2F;AAAA:IP指向记录，用于指向IP，前为IPv4记录，后者为IPv6记录</li>
<li>CNAME:别名记录，配置值为别名或主名，客户端根据别名继续解析以提取IP地址</li>
<li>TXT:文本记录，购买证书时需要</li>
<li>MX:邮件交换记录，用于指向邮件交换服务器</li>
<li>NS:解析服务器记录，用于指定哪台服务器对于该域名解析</li>
<li>SOA 记录:起始授权机构记录，每个zon要权威服务器的记录,有且仅有唯一的一条SOA记录，SOA是描述zone属性以及主</li>
</ul>
<h1 id="接入HTTPS协议"><a href="#接入HTTPS协议" class="headerlink" title="接入HTTPS协议"></a>接入HTTPS协议</h1><p>由于HTTP是明文传输，很容易被截取，因此有了HTTPS</p>
<h3 id="对称加密和非对称加密"><a href="#对称加密和非对称加密" class="headerlink" title="对称加密和非对称加密"></a>对称加密和非对称加密</h3><p>加密是在传输过程中为无规则乱码，即使被第三方获取，在没有密钥的情况下也无法进行解密数据，从而保证了数据的安全性<br>    - 对称加密由于双方密码一致，在发送时需要把密码发送给对方，这样在传输的过程中就有可能被截获<br>    - 非对称加密加密和解密使用两种不同的密钥，公钥和私钥，如果使用公钥加密就需要用私钥解密，反之一致</p>
<p><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h3 id="证书链"><a href="#证书链" class="headerlink" title="证书链"></a>证书链</h3><ul>
<li><p>Server 端发送是带签名的证书链</p>
</li>
<li><p>Client 收到会仍然需要验证</p>
<ul>
<li>是否是可信机构颁布</li>
<li>域名是否与实际访问一致</li>
<li>检查数字签名是否一致</li>
<li>检查证书的有效期</li>
<li>检查证书的撤回状态</li>
</ul>
</li>
</ul>
<h1 id="接入全站加速"><a href="#接入全站加速" class="headerlink" title="接入全站加速"></a>接入全站加速</h1><p>源站容量问题：增加后机器扩容;静态内容，使用静态加速缓存<br>网络传输问题：动态加速DCDN<br>全站加速 &#x3D; 静态加逗+动态加速</p>
<p>一般网址常见的问题有许多，例如：</p>
<ul>
<li>源站容量低，可承载的并发请求数低，容易被打垮</li>
<li>丢包、劫持、mtu问题报文经过的网络设备越多，出问题的概率越大，自主选路网络链路长，时延高</li>
<li>卡顿响应慢</li>
<li>极大的流失了大部分的用户群体</li>
<li>NPS 留存率数据不乐观。</li>
</ul>
<h3 id="静态加速"><a href="#静态加速" class="headerlink" title="静态加速"></a>静态加速</h3><p>CDN（Content Delivery Network）内容分发网络，将网站内容发布到最接近用户的边缘节点，使网民可就近取得所需内容，有效解决互联网网络拥塞状况，提高网民访问的响应速度和成功率。静态CDN服务以图片、页面、js、css、大文件安装包等静态文件加速为主。主要原理是通过在现有的Internet中增加一层新的网络架构，将网站的内容发布到最接近用户的cache服务器内，通过DNS负载均衡的技术，判断用户来源就近访问cache服务器取得所需的内容，解决Internet网络拥塞状况，提高用户访问网站的响应速度，如同提供了多个分布在各地的加速器，以达到快速、可冗余的为多个网站加速的目的。</p>
<ul>
<li>解决由于地域、带宽、运营商接入等问题带来的跨网访问问题</li>
<li>结合DNS调度系统，将用户的请求分配至最适合他的节点，提升用户的访问速度</li>
<li>中心节点收敛回源，降低回源且提升命中率，减轻源站压力</li>
<li>隐藏源站，提供大带宽接入，降低源站被攻击的风险</li>
<li>提供存储方案，解决业务线文件存放问题</li>
</ul>
<h1 id="四层负载均衡"><a href="#四层负载均衡" class="headerlink" title="四层负载均衡"></a>四层负载均衡</h1><p>基于IP+端口，利用某种算法将报文转发给某个后端服务器，实现负载均衡地落到后端服务器上。</p>
<p>三个主要功能:</p>
<ol>
<li>解耦 vip 和 rs</li>
<li>NAT</li>
<li>防攻击:syn proxy</li>
</ol>
<p><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="常见的算法"><a href="#常见的算法" class="headerlink" title="常见的算法"></a>常见的算法</h2><ul>
<li>RR轮询:Round Robin，将所有的请求平均分配给每个真实服务器RS</li>
<li>加权RR轮询:给每个后端服务器一个权值比例，将请求按照比例分配</li>
<li>最小连接:把新的连接请求分配到当前连接数最小的服务器</li>
<li>五元组hash:根据sip、sport、proto、dip、dport对静态分配的服务器做散列取模<br>  缺点:当后端某个服务器故障后，所有连接都重新计算，影响整个 hash 环</li>
<li>一致性hash:只影响故障服务器上的连接session，其余服务器上的连接不受影响</li>
</ul>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>数据结构与算法</title>
    <url>/2025/01/24/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/7.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/</url>
    <content><![CDATA[<h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><h2 id="Insertion-Sort-插入排序"><a href="#Insertion-Sort-插入排序" class="headerlink" title="Insertion Sort 插入排序"></a>Insertion Sort 插入排序</h2><p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/7.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/7.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>将元素不断插入已经排序好的 array 中</p>
<ul>
<li>起始只有一个元素5，其本身是一个有序序列</li>
<li>后续元素插入有序序列中，即不断交换，直到找到第一个比其小的元素</li>
</ul>
<table>
<thead>
<tr>
<th>Best</th>
<th>Avg</th>
<th>Worst</th>
</tr>
</thead>
<tbody><tr>
<td>O(n)</td>
<td>O(n^2)</td>
<td>O(n^2)</td>
</tr>
</tbody></table>
<p>缺点</p>
<ul>
<li>平均和最坏情况的时间复杂度高达 O(n^2)</li>
</ul>
<p>优点</p>
<ul>
<li>最好情况时间复杂度为O(n)</li>
</ul>
<p>总结：插入排序平均和最坏情况时间复杂度都是 O(n^2)</p>
<h2 id="Quick-Sort-快速排序"><a href="#Quick-Sort-快速排序" class="headerlink" title="Quick Sort 快速排序"></a>Quick Sort 快速排序</h2><p><img src="/p2.gif" class="lazyload" data-srcset="/p2.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>分治思想，不断分割序列直到序列整体有序</p>
<ul>
<li>选定一个 pivot (轴点)</li>
<li>使用 pivot 分割序列，分成元素比 pivot 大 和元素比 pivot 小两个序列</li>
</ul>
<table>
<thead>
<tr>
<th>Best</th>
<th>Avg</th>
<th>Worst</th>
</tr>
</thead>
<tbody><tr>
<td>O(n * logn)</td>
<td>O(n * logn)</td>
<td>O(n^2)</td>
</tr>
</tbody></table>
<p>缺点</p>
<ul>
<li>平均和最坏情况的时间复杂度高达 O(n * logn)</li>
</ul>
<p>优点</p>
<ul>
<li>最好情况时间复杂度为O(n^2)</li>
</ul>
<p>总结：快速排序整体性能处于中间层次</p>
<h2 id="Heap-Sort-堆排序"><a href="#Heap-Sort-堆排序" class="headerlink" title="Heap Sort 堆排序"></a>Heap Sort 堆排序</h2><p><img src="/p3.gif" class="lazyload" data-srcset="/p3.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>大顶堆和小顶堆</p>
<ul>
<li>小顶堆是根节点比子节点小</li>
<li>大顶堆是根节点比子节点大</li>
</ul>
<table>
<thead>
<tr>
<th>Best</th>
<th>Avg</th>
<th>Worst</th>
</tr>
</thead>
<tbody><tr>
<td>O(n * logn)</td>
<td>O(n * logn)</td>
<td>O(n * logn)</td>
</tr>
<tr>
<td>总结：众生平等堆排序性能稳定</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="实际场景-benchmark"><a href="#实际场景-benchmark" class="headerlink" title="实际场景 benchmark"></a>实际场景 benchmark</h2><p>根据序列元素排列情况划分</p>
<ul>
<li>完全随机的情况(random)</li>
<li>有序&#x2F;逆序的情况 (sorted&#x2F;reverse)</li>
<li>元素重复度较高的情况(mod8)<br>在此基础上，还需要根据序列长度的划分(16&#x2F;128&#x2F;1024)</li>
</ul>
<h3 id="random"><a href="#random" class="headerlink" title="random"></a>random</h3><p><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<ul>
<li>插入排序在短序列中速度最快</li>
<li>快速排序在其他情况中速度最快</li>
<li>堆排序速度于最快算法差距不大</li>
</ul>
<h3 id="sorted"><a href="#sorted" class="headerlink" title="sorted"></a>sorted</h3><p><img src="/p5.png" class="lazyload" data-srcset="/p5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<ul>
<li>插入排序在序列已经有序的情况下最快</li>
</ul>
<p>总结：</p>
<ul>
<li>所有短序列和元素有序情况下，插入排序性能最好</li>
<li>在大部分的情况下，快速排序有较好的综合性能</li>
<li>几乎在任何情况下，堆排序的表现都比较稳定</li>
</ul>
<h1 id="pdqsort-pattern-defeating-quicksort"><a href="#pdqsort-pattern-defeating-quicksort" class="headerlink" title="pdqsort (pattern-defeating-quicksort)"></a>pdqsort (pattern-defeating-quicksort)</h1><p>是一种不稳定的混合排序算法，它的不同版本被应用在 C++ BOOST、Rust 以及 Go 1.19 中。它对常见的序列类型做了特殊的优化，使得在不同条件下都拥有不错的性能</p>
<p>结合三种排序方法的优点</p>
<ul>
<li>对于短序列(小于一定长度)，我们使用插入排序</li>
<li>其他情况，使用快速排序来保认整体性能</li>
<li>当快速排序表现不佳时，使用堆排序来保证最坏情况下时间复杂度仍然为 O(n*logn)</li>
</ul>
<p>当最终 pivot 的位置离序列两端很接近时(距离小于 length&#x2F;8)判定其表现不佳，当这种情况的次数达到 limit(即 bits.Len(length)时，切换到堆排序</p>
<h3 id="pivot的选择"><a href="#pivot的选择" class="headerlink" title="pivot的选择"></a>pivot的选择</h3><ul>
<li>使用第一个元素作为pivot（最简单的方案）<br>实现简单，但是往往效果不好，如果在sorted情况下性能会很差</li>
<li>遍历数组，寻找真正的中位数<br>遍历比对代价很高，性能不好</li>
</ul>
<p>优化-Pivot 的选择</p>
<ul>
<li>短序列(&lt;&#x3D;8)，选择固定元素</li>
<li>中序列(&lt;&#x3D;50)，采样三个元素，median of three</li>
<li>长序列(&gt;50)，:采样九个元素，median of medians</li>
</ul>
<p>同时Pivot 的采样方式使得我们有探知序列当前状态的能力</p>
<ul>
<li>如果采样的元素都是逆序排序，那我们可能推出序列已经逆序，我们只需要翻转整个序列</li>
<li>如果采样的元素都是顺序排序，那我们可能推出序列已经顺序，在前面我们已经探究出插入排序对有序序列效率更高，在这里就使用插入排序</li>
</ul>
<p>注：<strong>插入排序实际使用 partiallnsertionSort，即有限制次数的插入排序</strong>，因为插入排序在一般序列性能表现是比较差的，我们只是认为可能有顺序的可能，不是真正的有序，用partiallnsertionSort可以限制插入的次数</p>
<p>如果两次 partition 生成的 pivot 相同，即 partition 进行了无效分割,此时认为 pivot 的值为重复元素</p>
<p>优化-重复元素较多的情况(partitonEqual)<br>当检测到此时的 pivot 和上次相同时(发生在 leftSubArray)，使用partitionEqual 将重复元素排列在一起，减少重复元素对于 pivot 选择的干扰</p>
<table>
<thead>
<tr>
<th>Best</th>
<th>Avg</th>
<th>Worst</th>
</tr>
</thead>
<tbody><tr>
<td>O(n)</td>
<td>O(n * logn)</td>
<td>O(n * logn)</td>
</tr>
</tbody></table>
<p><img src="/p7.png" class="lazyload" data-srcset="/p7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>Go 框架三件套</title>
    <url>/2025/02/07/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/9.Go%20%E6%A1%86%E6%9E%B6%E4%B8%89%E4%BB%B6%E5%A5%97%E8%AF%A6%E8%A7%A3(Web%20RPC%20ORM)/Gorm%20%E6%A1%86%E6%9E%B6/</url>
    <content><![CDATA[<h2 id="Gorm-的基本使用"><a href="#Gorm-的基本使用" class="headerlink" title="Gorm 的基本使用"></a>Gorm 的基本使用</h2><p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/9.Go%20%E6%A1%86%E6%9E%B6%E4%B8%89%E4%BB%B6%E5%A5%97%E8%AF%A6%E8%A7%A3(Web%20RPC%20ORM)/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/9.Go%20%E6%A1%86%E6%9E%B6%E4%B8%89%E4%BB%B6%E5%A5%97%E8%AF%A6%E8%A7%A3(Web%20RPC%20ORM)/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>相关文档 <a href="https://gorm.io/zh_CN/docs/index.html">https://gorm.io/zh_CN/docs/index.html</a></p>
<p>gorm目前支持 MySQL、SQLServer、PostgreSQL、SQLite</p>
<p>以 MySQL 为例：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">  <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// 参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name 获取详情</span></span><br><span class="line">  dsn := <span class="string">&quot;user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line">  db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者可以更详细的配置：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">db, err := gorm.Open(mysql.New(mysql.Config&#123;</span><br><span class="line">  DSN: <span class="string">&quot;gorm:gorm@tcp(127.0.0.1:3306)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;</span>, <span class="comment">// DSN data source name</span></span><br><span class="line">  DefaultStringSize: <span class="number">256</span>, <span class="comment">// string 类型字段的默认长度</span></span><br><span class="line">  DisableDatetimePrecision: <span class="literal">true</span>, <span class="comment">// 禁用 datetime 精度，MySQL 5.6 之前的数据库不支持</span></span><br><span class="line">  DontSupportRenameIndex: <span class="literal">true</span>, <span class="comment">// 重命名索引时采用删除并新建的方式，MySQL 5.7 之前的数据库和 MariaDB 不支持重命名索引</span></span><br><span class="line">  DontSupportRenameColumn: <span class="literal">true</span>, <span class="comment">// 用 `change` 重命名列，MySQL 8 之前的数据库和 MariaDB 不支持重命名列</span></span><br><span class="line">  SkipInitializeWithVersion: <span class="literal">false</span>, <span class="comment">// 根据当前 MySQL 版本自动配置</span></span><br><span class="line">&#125;), &amp;gorm.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="创建数据"><a href="#创建数据" class="headerlink" title="创建数据"></a>创建数据</h3><p><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>我们可以使用 <code>clause.OnConflict</code> 处理数据冲突<br><code>DoNothing: true</code> 意思是遇到数据冲突不做任何改变 </p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">p:=&amp;Product&#123;Code:<span class="string">&quot;D42&quot;</span>，ID:<span class="number">1</span>&#125;</span><br><span class="line">db.Clauses(clause.OnConflict&#123;DoNothing: <span class="literal">true</span>&#125;).Create(&amp;p)</span><br></pre></td></tr></table></figure>

<p>可以使用 <code>default</code> 标签为字段定义默认值</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID      <span class="type">int64</span></span><br><span class="line">	Name    <span class="type">string</span> <span class="string">`gorm:&quot;default:galeone&quot;`</span></span><br><span class="line">	Age     <span class="type">int64</span>  <span class="string">`gorm:&quot;default:18&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><p><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>需要注意的点：</p>
<ul>
<li><p>使用 First 时，需要注意查询不到数据会返回 ErrRecordNotFound</p>
</li>
<li><p>使用 Find 查询多条数据，查询不到数据不会返回错误</p>
</li>
<li><p>当使用结构作为条件查询时，GORM 只会查询非零值字段。这意味着如果您的字段值为 0、”、false 或其他 零值，该字段不会被用于构建查询条件，使用Map 来构建查询条件。</p>
</li>
</ul>
<h3 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h3><p><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>使用 Struct 更新时，只会更新非零值，如果需要更新零值可以使用 Map 更新或使用Select 选择字段。</p>
<h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h3><h4 id="物理删除"><a href="#物理删除" class="headerlink" title="物理删除"></a>物理删除</h4><p><img src="/p5.png" class="lazyload" data-srcset="/p5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h4 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a>软删除</h4><p>GORM 提供了 gorm.DeletedAt 用于帮助用户实现软删</p>
<p>拥有软删除能力的 Model 调用 Delete 时，记录不会被从数据库中真正删除。但 GORM 会将 DeletedAt 置为当前时间并且你不能再通过正常的查询方法找到该记录。</p>
<p>使用 Unscoped 可以查询到被软删的数据</p>
<h3 id="事物"><a href="#事物" class="headerlink" title="事物"></a>事物</h3><p>Gorm 提供了 Begin、Commit、Rollback 方法用于使用事务</p>
<p><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/9.Go%20%E6%A1%86%E6%9E%B6%E4%B8%89%E4%BB%B6%E5%A5%97%E8%AF%A6%E8%A7%A3(Web%20RPC%20ORM)/p6.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/9.Go%20%E6%A1%86%E6%9E%B6%E4%B8%89%E4%BB%B6%E5%A5%97%E8%AF%A6%E8%A7%A3(Web%20RPC%20ORM)/p6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<ul>
<li>特别注意的点，db.Begin() 后会生成一个变量，我们后续的操作都是通过后面的变量</li>
</ul>
<p>Gorm 提供了 Tansaction 方法用于自动提交事务，避免用户漏写 Commit、Rollbcak</p>
<p><img src="/p7.png" class="lazyload" data-srcset="/p7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>微服务架构</title>
    <url>/2025/02/18/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/15.%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/</url>
    <content><![CDATA[<h1 id="了解微服务架构"><a href="#了解微服务架构" class="headerlink" title="了解微服务架构"></a>了解微服务架构</h1><p><img src="/p1.png" class="lazyload" data-srcset="/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<ul>
<li><p>优势：</p>
<ol>
<li>开发效率高、2. 业务独立设计、3. 自下而上、4. 故障隔离</li>
</ol>
</li>
<li><p>劣势：</p>
<ol>
<li>治理、运维难度高、2. 观测挑战、3. 安全性、4. 分布式系统的问题</li>
</ol>
</li>
</ul>
<h2 id="核心要素"><a href="#核心要素" class="headerlink" title="核心要素"></a>核心要素</h2><ul>
<li><p>服务治理</p>
<ol>
<li>服务注册、2. 服务发现、3. 负载均衡、4. 扩缩容、5. 流量治理、6. 稳定性治理</li>
</ol>
</li>
<li><p>可观测性</p>
<ol>
<li>日志采集、2. 日志分析、3. 监控打点、4. 监控大盘、5. 异常报警、6. 链路追踪</li>
</ol>
</li>
<li><p>安全</p>
<ol>
<li>身份验证、2. 认证授权、3. 访问令牌、4. 审计、5. 传输加密、5. 黑产攻击</li>
</ol>
</li>
</ul>
<h1 id="微服务架构原理及特征"><a href="#微服务架构原理及特征" class="headerlink" title="微服务架构原理及特征"></a>微服务架构原理及特征</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><ul>
<li><p><strong>服务</strong>(service)</p>
<ul>
<li>一组具有<strong>相同逻辑</strong>的<strong>运行实体</strong>。</li>
</ul>
</li>
<li><p><strong>实例</strong>(instance)</p>
<ul>
<li>一个服务中，每个运行实体即为一个实例。</li>
</ul>
</li>
<li><p>实例与进程的关系</p>
<ul>
<li>实例与进程之间没有必然对应关系，可以一个实例可以对应一个或多个进程(反之不常见)</li>
</ul>
</li>
<li><p>集群(cluster)</p>
<ul>
<li>通常指服务内部的逻辑划分，包含多个实例。</li>
</ul>
</li>
<li><p>常见的实例承载形式</p>
<ul>
<li>进程、VM、k8s pod</li>
</ul>
</li>
<li><p>有状态&#x2F;无状态服务</p>
<ul>
<li>服务的实例是否存储了可持久化的数据(例如磁盘文件)。</li>
</ul>
</li>
</ul>
<h3 id="服务间通信"><a href="#服务间通信" class="headerlink" title="服务间通信"></a>服务间通信</h3><p>对于单体服务，不同模块通信只是简单的函数调用。<br>对于微服务，服务间通信意味着网络传输。</p>
<p><img src="/p2.png" class="lazyload" data-srcset="/p2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h3 id="服务注册及发现"><a href="#服务注册及发现" class="headerlink" title="服务注册及发现"></a>服务注册及发现</h3><p>在代码层面，我们如何去调用一个服务的地址？</p>
<p>答：加一层，新增一个统一的服务注册中心，用于存储服务名到服务实例的映射，类似于 DNS，但DNS问题也很多，例如：本地 DNS 存在缓存，导致延时负载均衡问题，不支持服务实例的探活检查域名无法配置端口等等</p>
<p>下图为服务实例上线与下线过程，讲师在讲这里时非常清晰很生动</p>
<p><img src="/p3.png" class="lazyload" data-srcset="/p3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h3 id="流量特征"><a href="#流量特征" class="headerlink" title="流量特征"></a>流量特征</h3><ul>
<li>统一网关入口</li>
<li>内网通信多数采用RPC</li>
<li>网状调用链路</li>
</ul>
<p><img src="/p4.png" class="lazyload" data-srcset="/p4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h1 id="核心服务治理功能"><a href="#核心服务治理功能" class="headerlink" title="核心服务治理功能"></a>核心服务治理功能</h1><h2 id="服务发布"><a href="#服务发布" class="headerlink" title="服务发布"></a>服务发布</h2><p>服务发布(deployment)，即指让一个服务升级运行新的代码的过程</p>
<p>常见的服务发布难点：</p>
<pre><code>1. 服务不可用、2. 服务抖动、3. 服务回滚 
</code></pre>
<p>讲解中讲了两种方法，都是之前有了解过的：</p>
<ul>
<li>蓝绿发布：简单、但需要两倍资源（可以根据流量的错峰特性使用蓝绿发布）</li>
<li>金丝雀发布：过度平滑，但是在部署时进度在1%～99%时都有可能出现问题，需要回滚版本，这种维护能力需要平台级的设施提供支持。</li>
</ul>
<p><img src="/p5.png" class="lazyload" data-srcset="/p5.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="流量治理"><a href="#流量治理" class="headerlink" title="流量治理"></a>流量治理</h2><p>在微服务架构下，我们可以基于地区、集群、实例、请求等维度，对端到端流量的路由进行精确控制。</p>
<p><img src="/p6.png" class="lazyload" data-srcset="/p6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>负载均衡((Load Balance)负责分配请求在每个下游实例上的分布。</p>
<p>常见的LB策略：</p>
<ul>
<li><ol>
<li>绝对公平、2. 随机、3. 一次性哈希</li>
</ol>
</li>
</ul>
<h2 id="稳定性治理"><a href="#稳定性治理" class="headerlink" title="稳定性治理"></a>稳定性治理</h2><p>线上服务总是会出问题的，这与程序的正确性无关。</p>
<p>常见的问题：</p>
<ul>
<li><ol>
<li>网络攻击、2. 流量突增、3. 机房断电、4. 光纤被挖、5. 机械故障、6. 网络故障、 7. 机房空调故障</li>
</ol>
</li>
</ul>
<p>微服务架构中典型的稳定性治理功能：</p>
<ul>
<li><ol>
<li>限流、2. 熔断、3. 过载保护、4. 降级</li>
</ol>
</li>
</ul>
<p><img src="/p7.png" class="lazyload" data-srcset="/p7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<h1 id="重试"><a href="#重试" class="headerlink" title="重试"></a>重试</h1><p>本地函数调用可能出现的问题：</p>
<ul>
<li><ol>
<li>参数非法、2. OOM (Out Of Memory)、3. NPE (Null Pointer Exception)、4. 边界 case</li>
</ol>
</li>
<li><ol start="5">
<li>系统崩溃、6. 死循环、7. 程序异常退出</li>
</ol>
</li>
</ul>
<p>远程函数调用可能出现的问题：</p>
<ul>
<li><ol>
<li>网络抖动、2. 下游负载高导致超时、3. 下游机器宕机、4. 本地机器负载高，调度超时、5. 下游熔断、限流</li>
</ol>
</li>
</ul>
<p><strong>本地函数重试基本上是没有意义的</strong>，而远程函数重试则有意义，因为其发生请求错误的原因可能不是下游程序编写出错</p>
<h2 id="重试的意义"><a href="#重试的意义" class="headerlink" title="重试的意义"></a>重试的意义</h2><ul>
<li>降低错误率：单次错误概率为0.01，连续错误两次概率为0.0001</li>
<li>降低长尾延迟：对于偶尔耗时较长的请求，重试请求有机会提前返回</li>
<li>规避暂时性错误：网络抖动</li>
<li>避开下游故障实例：一个服务可能会有少量故障实例（如机器故障），重试可以将请求打到其他机器</li>
</ul>
<h2 id="重试的难点"><a href="#重试的难点" class="headerlink" title="重试的难点"></a>重试的难点</h2><ul>
<li><p>幂等性</p>
<ul>
<li>幂等性是指多次执行同一操作，结果与执行一次相同，确保了即使请求被多次发送，也不会引发重复操作或数据不一致的问题</li>
</ul>
</li>
<li><p>超时设置</p>
<ul>
<li>超时设置是重试机制中的关键环节，合理的超时时间可以避免系统资源被无效占用，同时也能减少重试风暴的风险</li>
</ul>
</li>
<li><p>重试风暴</p>
<ul>
<li>重试风暴是指由于重试策略配置不当，导致系统在短时间内收到大量重试请求，从而引发系统过载甚至崩溃的现象</li>
</ul>
</li>
</ul>
<h2 id="重试策略"><a href="#重试策略" class="headerlink" title="重试策略"></a>重试策略</h2><ul>
<li><p>限制重试比例</p>
<ul>
<li>设定一个重试比例阈值（例如1%），重试此处占所有请求比例不超过该阈值。</li>
</ul>
</li>
<li><p>防止链路重试</p>
<ul>
<li>链路层面的防重试风暴的核心是限制每层都发生重试，理想情况下只有最下一层发生重试，可以返回特殊的 status 表明“请求失败，但别重试”</li>
</ul>
</li>
<li><p>对冲请求（Hedged requests）</p>
<ul>
<li>对于可能超时(或延时高)的请求，重新向另一个下游实例发送一个相同的请求，并等待先到达的响应,</li>
</ul>
</li>
</ul>
<h2 id="重试效果验证"><a href="#重试效果验证" class="headerlink" title="重试效果验证"></a>重试效果验证</h2><p>讲解中有举例，字节跳动工作组有做过对应的实验并产出结论</p>
<p><img src="/p8.png" class="lazyload" data-srcset="/p8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
  <entry>
    <title>对象存储</title>
    <url>/2025/02/06/articles/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/8.%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%20TOS/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%20TOS/</url>
    <content><![CDATA[<p>我在青训营看完这章对象存储TOS感觉对理论性的知识有了一定了解吧，太理论了，让我复述一遍可能都做不到</p>
<p>我在网上查阅资料后得知</p>
<ul>
<li><p><strong>T</strong>：<strong>Tencent</strong>，表示这是腾讯云提供的服务。</p>
</li>
<li><p><strong>O</strong>：<strong>Object</strong>，表示对象存储（Object Storage），是一种存储非结构化数据的技术。</p>
</li>
<li><p><strong>S</strong>：<strong>Storage</strong>，表示存储服务。</p>
</li>
</ul>
<p>首先开头以抖音短视频为例<br><img src="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/8.%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%20TOS/p1.png" class="lazyload" data-srcset="/MarsCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/8.%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%20TOS/p1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>
<p>架构大概分为 片源 -&gt; 转码  -&gt; 审核 -&gt; 播放</p>
<p>但是短视频系统要承载非常多的用户访问量，根据未来的可能的用户数量，做了简单数学计算，结果发现存储量非常之大：</p>
<ul>
<li><p>每天: 432块4tb磁盘 </p>
</li>
<li><p>每月：12960块4tb磁盘 </p>
</li>
<li><p>每年： 157680块4tb盘</p>
</li>
</ul>
<p>对于这么大的访问量，我们需要一个合适的存储去承载数据，这个储存需要满足以下三个条件：</p>
<ul>
<li><p>海量</p>
</li>
<li><p>易用</p>
</li>
<li><p>便宜</p>
</li>
</ul>
<p>然后列举了四个存储系统</p>
<ul>
<li><p>单机存储——&gt;不支持海量，适合的数据类型（单击文件）——&gt;不行</p>
</li>
<li><p>单机数据库——&gt; 不支持海量,只支持结构化和半结构化数据——&gt;不行</p>
</li>
<li><p>分布式数据库——&gt;支持海量，但是单条记录存储的容量太少——&gt;不行</p>
</li>
<li><p>分布式存储——&gt; 大数据计算中间结果&#x2F;视频&#x2F;图片——&gt;行</p>
</li>
</ul>
<p>分布式文件系统（HDFS）</p>
<ul>
<li><p>海量：支持PB——&gt;EB海量存储 </p>
</li>
<li><p>易用：伪Posix文件接口，开发略微复杂，非云原生，搭建维护麻烦，视频、图片相关生态接入略微复杂 </p>
</li>
<li><p>便宜：使用普通x86服务器，成本低</p>
</li>
</ul>
<p>分布式对象存储TOS</p>
<ul>
<li><p>海量：支持&gt;eb海量存储</p>
</li>
<li><p>易用：RestFul HTTP接口，开发极其简单，云原生，按需申请使用</p>
</li>
<li><p>便宜：使用普通x86服务器，具备冷热数据分级存储能力，成本更低</p>
</li>
</ul>
<p>TOS 的接口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Mkdirs创建文件夹</span><br><span class="line">Append：写</span><br><span class="line">GET：下载对象</span><br><span class="line">HEAD：查看对象上传</span><br><span class="line">PUT：上传对象</span><br><span class="line">DELETE：删除对象</span><br></pre></td></tr></table></figure>

<p>TOS 中Bucket&#x2F;Object语义</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Bucket：存储对象的桶，可类比一下</span><br><span class="line">Object：对象，包含以下三个部分</span><br><span class="line">key:对象的名字，可类比于Map的key</span><br><span class="line">Data：对象的内容，例如视频、图片内容</span><br><span class="line">MetaData：对象的一些元信息</span><br></pre></td></tr></table></figure>



]]></content>
      <tags>
        <tag>字节青训营</tag>
      </tags>
  </entry>
</search>
